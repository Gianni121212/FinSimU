<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†æå¹³å°</title>

    <!-- START: PWA/è¡Œå‹•è£ç½®å„ªåŒ–æ¨™ç±¤ -->
    <meta name="theme-color" content="#6d5edc"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <!-- END: PWA/è¡Œå‹•è£ç½®å„ªåŒ–æ¨™ç±¤ -->

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --price-up: #16a34a;
            --price-down: #dc2626;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-primary); padding-bottom: 80px;
        }

        #floating-action-btn {
            position: fixed;
            top: 20px; /* è·é›¢è¦–çª—é ‚éƒ¨ 20px */
            left: 16px;
            z-index: 1001;
            background: var(--gradient);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s ease-out;
        }
        #floating-action-btn:active {
            transform: scale(0.95);
        }

        .mobile-header {
            background: var(--card-bg); padding: 12px 16px; text-align: center;
            border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
        }
        .mobile-header h1 { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        
        #login-status-container {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }
        .login-btn:active {
            background: #5a6acf;
        }
        .user-welcome {
            color: var(--text-secondary);
        }
        .logout-link {
            color: var(--primary-color);
            text-decoration: underline;
            margin-left: 8px;
            cursor: pointer;
        }
        
        main { padding: 16px; }
        .page-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background-color: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: space-around; border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .nav-button {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.7rem; color: var(--text-secondary); background: none; border: none;
            cursor: pointer; padding: 8px; border-radius: 8px; width: 80px;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-button-icon { font-size: 1.4rem; }
        .nav-button.active { color: var(--primary-color); }
        .nav-button:active { background-color: var(--bg-color); }

        .search-card {
            background: var(--card-bg); padding: 20px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .search-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .search-card-header-text {
            flex-grow: 1;
        }
        .search-card h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .search-card p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px; }

        .input-group { margin-bottom: 16px; }
        .input-group input, .input-group select {
            width: 100%; padding: 14px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; background-color: #f9fafb;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .btn-primary {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            background: var(--gradient); color: white;
        }
        .btn-primary:active { transform: scale(0.98); }

        .loading { text-align: center; padding: 40px 0; }
        .loading-spinner {
            width: 36px; height: 36px; border: 4px solid #e0e0e0;
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 12px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading p { font-size: 0.9rem; color: var(--text-secondary); }
        .error-message {
            background-color: #fee2e2; color: #991b1b; padding: 16px;
            border-radius: 8px; text-align: center; font-weight: 500;
        }

        .content-card {
            background: var(--card-bg); border-radius: 12px;
            margin-bottom: 16px; box-shadow: var(--shadow); overflow: hidden;
        }
        .card-header {
            padding: 16px; font-size: 1.1rem; font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 8px;
        }
        .card-body { padding: 16px; }

        .stock-header { text-align: center; padding: 20px 16px; }
        .stock-title { font-size: 1.5rem; font-weight: 700; }
        .stock-ticker { font-size: 1rem; color: var(--text-secondary); }
        .stock-price { font-size: 2.2rem; font-weight: bold; margin: 8px 0; }
        .stock-change { font-size: 1rem; font-weight: 500; }
        .price-up { color: var(--price-up); } .price-down { color: var(--price-down); }

        .data-list { list-style: none; }
        .data-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.9rem; border-bottom: 1px solid #f3f4f6;
        }
        .data-list-item:last-child { border-bottom: none; }
        .data-list-item .label { color: var(--text-secondary); }
        .data-list-item .value { font-weight: 600; }

        .strategy-card {
            border: 1px solid var(--border-color); border-radius: 10px;
            margin-top: 16px; padding: 16px;
        }
        .strategy-card.system-a { border-left: 4px solid #4ade80; }
        .strategy-card.system-b { border-left: 4px solid #facc15; }
        .strategy-title { font-weight: 600; margin-bottom: 12px; }
        
        .strategy-buttons { display: flex; flex-wrap: wrap; align-items: center; }
        .btn-details {
            padding: 8px 16px; font-size: 0.8rem; border-radius: 20px;
            border: 1px solid var(--primary-color); background-color: transparent;
            color: var(--primary-color); cursor: pointer;
        }
        .btn-save {
            padding: 8px 16px; font-size: 0.8rem; border-radius: 20px;
            border: 1px solid #f59e0b; background-color: transparent;
            color: #f59e0b; cursor: pointer; margin-left: 8px;
        }
        .btn-save:disabled { background-color: #f0f2f5; color: var(--text-secondary); border-color: var(--border-color); cursor: not-allowed; }
        
        .strategy-details {
            background-color: #f9fafb; padding: 12px; margin-top: 12px;
            border-radius: 8px; border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace; font-size: 0.8rem;
            white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;
        }

        .chart-preview-container {
            padding: 8px; background: var(--card-bg); border-radius: 12px;
            box-shadow: var(--shadow); cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .chart-preview-container:active { transform: scale(0.98); }
        .chart-preview-image { width: 100%; border-radius: 8px; display: block; }

        .chart-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); z-index: 2000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; padding-top: 40px;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }
        .chart-modal-content { width: 100%; height: 100%; background-color: #fff; }
        .chart-modal-iframe { width: 100%; height: 100%; border: none; }
        .chart-modal-close {
            position: absolute; top: 45px; right: 15px; width: 30px; height: 30px;
            background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%;
            font-size: 20px; font-weight: bold; color: #333; cursor: pointer;
            line-height: 30px; text-align: center; z-index: 2001;
        }

        .analysis-content h2, .analysis-content h3 {
            font-size: 1.1em; font-weight: 600; display: flex; align-items: center;
            gap: 0.6em; margin-top: 1.8em; margin-bottom: 1em;
            padding-bottom: 0.5em; border-bottom: 1px solid var(--border-color);
        }
        .analysis-content h2:first-of-type, .analysis-content h3:first-of-type { margin-top: 0; }
        .analysis-content h2::before, .analysis-content h3::before { font-size: 1.2em; }
        .analysis-content [data-title*="æœ€æ–°æ–°è"]::before { content: 'ğŸ“°'; }
        .analysis-content [data-title*="åŸºæœ¬é¢"]::before { content: 'ğŸ“Š'; }
        .analysis-content [data-title*="è¿‘æœŸè¶¨å‹¢"]::before, .analysis-content [data-title*="è¿‘æœŸè¶‹åŠ¿"]::before { content: 'ğŸ“ˆ'; }
        .analysis-content [data-title*="ç­–ç•¥è§£è®€"]::before, .analysis-content [data-title*="ç­–ç•¥è§£è¯»"]::before { content: 'ğŸ¤–'; }
        .analysis-content [data-title*="æŠ•è³‡æ©Ÿæœƒ"]::before, .analysis-content [data-title*="æŠ•èµ„æœºä¼š"]::before { content: 'ğŸ’¡'; }
        .analysis-content [data-title*="é¢¨éšªæé†’"]::before, .analysis-content [data-title*="é£é™©æé†’"]::before { content: 'âš ï¸'; }
        .analysis-content [data-title*="å¸‚å ´å½±éŸ¿"]::before { content: 'ğŸ“‰'; }
        .analysis-content [data-title*="æœºä¼šä¸é£é™©"]::before, .analysis-content [data-title*="æ©Ÿæœƒèˆ‡é¢¨éšª"]::before { content: 'ğŸ”'; }
        .analysis-content p, .analysis-content ul {
            font-size: 0.95rem; line-height: 1.75; color: #374151; margin-bottom: 1em;
        }
        .analysis-content ul { list-style-position: outside; padding-left: 1.2em; }
        .analysis-content li { margin-bottom: 0.75em; }
        .analysis-content.news-list ul { list-style: none; padding-left: 0; }
        .analysis-content.news-list li {
            padding: 1em; border-radius: 8px; background-color: #f9fafb;
            border: 1px solid var(--border-color);
        }

        .signal-type-selector {
            display: flex; gap: 8px; margin-bottom: 16px; background-color: var(--bg-color);
            padding: 6px; border-radius: 25px;
        }
        .signal-type-selector label {
            flex-grow: 1; text-align: center; cursor: pointer; padding: 10px;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
        }
        .signal-type-selector input[type="radio"] { display: none; }
        .signal-type-selector input[type="radio"]:checked + label {
            background: var(--primary-color); color: white;
            font-weight: 600; box-shadow: var(--shadow);
        }
        #signals-grid { display: flex; flex-direction: column; gap: 16px; }
        .signal-card {
            background: var(--card-bg); border-radius: 12px;
            box-shadow: var(--shadow); overflow: hidden;
        }
        .signal-card-header {
            padding: 12px 16px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border-color);
        }
        .signal-card-header .ticker { font-size: 1.2rem; font-weight: 600; }
        .signal-card-header .system {
            font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
            color: white; font-weight: 500;
        }
        .system-a-tag { background-color: #22c55e; }
        .system-b-tag { background-color: #f59e0b; }
        .signal-card-body { padding: 16px; font-size: 0.9rem; line-height: 1.6; }
        .signal-price { font-weight: bold; margin-top: 10px; }
        .signal-buy { color: var(--price-up); }
        .signal-sell { color: var(--price-down); }
        .signal-card-footer {
            background-color: #f9fafb; padding: 10px 16px; font-size: 0.8rem;
            color: var(--text-secondary); display: flex; justify-content: space-between;
            flex-wrap: wrap; gap: 8px;
        }
        .return-value, .win-rate-value { font-weight: 600; color: var(--text-primary); }

        .help-icon {
            width: 24px; height: 24px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .help-icon:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .help-modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); 
            display: flex; justify-content: center; align-items: center; padding: 16px; 
            animation: fadeInModal 0.3s ease-out; 
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .help-modal-content { 
            background-color: var(--card-bg); color: var(--text-primary); 
            border-radius: 12px; padding: 24px; width: 100%; max-width: 500px; 
            max-height: 80vh; overflow-y: auto; position: relative; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }
        .help-modal-close { 
            position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; 
            line-height: 32px; border: none; background: var(--bg-color); 
            border-radius: 50%; font-size: 1.5rem; color: var(--text-secondary); 
            cursor: pointer; text-align: center; 
        }
        #helpModalTitle { margin-bottom: 16px; color: var(--primary-color); }
        #helpModalBody .help-section { margin-bottom: 16px; }
        #helpModalBody h3 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border-color); }
        #helpModalBody p { font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); }
        #helpModalBody strong { color: var(--text-primary); font-weight: 600; }
        
        .footer {
            text-align: center; margin-top: 30px; padding: 20px;
            font-size: 0.8rem; color: var(--text-secondary);
        }
        .footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    </style>
</head>
<body>
    
    <a id="floating-action-btn" href="/login">
        <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
    </a>

    <header class="mobile-header">
        <h1>ğŸš€  è‚¡ç¥¨åˆ†æ</h1>
        <div id="login-status-container"></div>
    </header>

    <main>
        <div id="page-analysis" class="page-view active">
            <div class="search-card">
                <div class="search-card-header">
                    <div class="search-card-header-text">
                        <h2>ğŸ“ˆ æ·±åº¦è‚¡ç¥¨åˆ†æ</h2>
                        <p>æ•´åˆåŸºæœ¬é¢ã€æŠ€è¡“é¢èˆ‡ Gemini AI åˆ†æã€‚</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('analysis')">?</span>
                </div>
                <div class="input-group">
                    <input type="text" id="stock-ticker" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ, å¦‚ AAPL, 2330">
                </div>
                <button class="btn-primary" onclick="enhancedAnalyzeStock()">ğŸ” é–‹å§‹åˆ†æ</button>
            </div>
            <div id="stock-loading" style="display: none;" class="loading"><div class="loading-spinner"></div><p>ğŸ¤– æ­£åœ¨æ·±åº¦åˆ†æè‚¡ç¥¨...</p></div>
            <div id="stock-results"></div>
        </div>

        <div id="page-news" class="page-view">
            <div class="search-card">
                <div class="search-card-header">
                    <div class="search-card-header-text">
                        <h2>ğŸ“° æ™ºèƒ½æ–°èæœå°‹</h2>
                        <p>ä½¿ç”¨ Gemini AI æœå°‹æœ€æ–°è²¡ç¶“æ–°èä¸¦ç¸½çµã€‚</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('news')">?</span>
                </div>
                <div class="input-group">
                    <input type="text" id="news-query" placeholder="è¼¸å…¥é—œéµå­—, å¦‚ å°ç©é›», Fed å‡æ¯">
                </div>
                <button class="btn-primary" onclick="searchNews()">ğŸ” æœå°‹æ–°è</button>
            </div>
            <div id="news-loading" style="display: none;" class="loading"><div class="loading-spinner"></div><p>ğŸ” æ­£åœ¨æœå°‹æœ€æ–°æ–°è...</p></div>
            <div id="news-results"></div>
        </div>

        <div id="page-signals" class="page-view">
            <div class="search-card">
                <div class="search-card-header">
                     <div class="search-card-header-text">
                        <h2>ğŸ¯ ç­–ç•¥æœ€æ–°ä¿¡è™Ÿ</h2>
                        <p>ç¯©é¸æœ€æ–°å›æ¸¬ä¸­ç¬¦åˆè²·è³£æ¢ä»¶çš„ç­–ç•¥ã€‚</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('signals')">?</span>
                </div>
                <div class="input-group">
                    <label for="market-select">å¸‚å ´é¸æ“‡</label>
                    <select id="market-select" onchange="loadStrategySignals()"><option value="TW">å°è‚¡ (TW)</option><option value="US">ç¾è‚¡ (US)</option></select>
                </div>
                <div class="input-group">
                    <label>ä¿¡è™Ÿé¡å‹</label>
                    <div class="signal-type-selector">
                        <input type="radio" id="signal-type-buy" name="signal_type" value="buy" checked onchange="loadStrategySignals()"><label for="signal-type-buy">ğŸŸ¢ è²·å…¥</label>
                        <input type="radio" id="signal-type-sell" name="signal_type" value="sell" onchange="loadStrategySignals()"><label for="signal-type-sell">ğŸ”´ è³£å‡º</label>
                    </div>
                </div>
            </div>
            <div id="signals-loading" class="loading"><div class="loading-spinner"></div><p>ğŸ¤– æ­£åœ¨æœå°‹æœ€æ–°ç­–ç•¥ä¿¡è™Ÿ...</p></div>
            <div id="signals-results"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-button active" onclick="showPage('page-analysis')"><span class="nav-button-icon">ğŸ“ˆ</span><span>åˆ†æ</span></button>
        <button class="nav-button" onclick="showPage('page-news')"><span class="nav-button-icon">ğŸ“°</span><span>æ–°è</span></button>
        <button class="nav-button" onclick="showPage('page-signals')"><span class="nav-button-icon">ğŸ¯</span><span>ä¿¡è™Ÿ</span></button>
    </nav>
    
    <div class="footer">
        <p><a href="/trainer">é€²å…¥ç­–ç•¥è¨“ç·´å¹³å°</a></p>
        <p></p>
    </div>

    <div id="chartModal" class="chart-modal">
        <button id="chartModalClose" class="chart-modal-close">Ã—</button>
        <div class="chart-modal-content">
            <iframe id="chartModalIframe" class="chart-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
            <h2 id="helpModalTitle"></h2>
            <div id="helpModalBody"></div>
        </div>
    </div>

    <script>
        const helpContent = {
            analysis: {
                title: 'ğŸ’¡ æ·±åº¦è‚¡ç¥¨åˆ†æèªªæ˜',
                body: `
                    <div class="help-section">
                        <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                        <p>é€™æ˜¯å¹³å°çš„æ ¸å¿ƒåˆ†æå·¥å…·ã€‚æ‚¨åªéœ€è¼¸å…¥ä¸€æ”¯è‚¡ç¥¨ä»£è™Ÿï¼Œç³»çµ±å°‡ç‚ºæ‚¨åŸ·è¡Œå…¨æ–¹ä½çš„æ·±åº¦åˆ†æã€‚</p>
                    </div>
                    <div class="help-section">
                        <h3>åˆ†æå ±å‘ŠåŒ…å«ï¼š</h3>
                        <p><strong>å³æ™‚è‚¡åƒ¹èˆ‡åŸºæœ¬é¢ï¼š</strong> å¿«é€ŸæŒæ¡å¸‚å€¼ã€æœ¬ç›Šæ¯”ã€ROE ç­‰é—œéµæ•¸æ“šã€‚</p>
                        <p><strong>å¸¸ç”¨æŠ€è¡“æŒ‡æ¨™ï¼š</strong> æä¾› RSIã€ç§»å‹•å¹³å‡ç·šã€å¸ƒæ—é€šé“ç­‰æŒ‡æ¨™ï¼Œåˆ¤æ–·çŸ­æœŸè¶¨å‹¢ã€‚</p>
                        <p><strong>ç­–ç•¥å›æ¸¬ï¼š</strong> å±•ç¤ºç³»çµ±é å…ˆè¨“ç·´å¥½çš„å…©å¥—äº¤æ˜“ç­–ç•¥åœ¨è©²è‚¡ç¥¨ä¸Šçš„æ­·å²å›æ¸¬ç¸¾æ•ˆã€‚</p>
                        <p><strong>Gemini AI æ·±åº¦å ±å‘Šï¼š</strong> AI æœƒå³æ™‚æœå°‹æœ€æ–°ç›¸é—œæ–°èï¼Œä¸¦çµåˆæ‰€æœ‰æ•¸æ“šï¼Œç”Ÿæˆä¸€ä»½åŒ…å«æ–°èè§£è®€ã€æŠ•è³‡æ©Ÿæœƒèˆ‡é¢¨éšªæé†’çš„å®Œæ•´å ±å‘Šã€‚</p>
                    </div>
                `
            },
            news: {
                title: 'ğŸ’¡ æ™ºèƒ½æ–°èæœå°‹èªªæ˜',
                body: `
                    <div class="help-section">
                        <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                        <p>é€™æ˜¯ä¸€å€‹ç”± AI é©…å‹•çš„å¼·å¤§æ–°èå½™æ•´å·¥å…·ã€‚å‚³çµ±çš„æ–°èæœå°‹åªæœƒåˆ—å‡ºé€£çµï¼Œè€Œé€™è£¡çš„ AI æœƒç‚ºæ‚¨é–±è®€ã€ç†è§£ã€ä¸¦ç¸½çµæœå°‹çµæœã€‚</p>
                    </div>
                    <div class="help-section">
                        <h3>æ‚¨å¯ä»¥ï¼š</h3>
                        <p><strong>æœå°‹ä»»ä½•è²¡ç¶“ä¸»é¡Œï¼š</strong> ä¾‹å¦‚ã€Œå°ç©é›» ADRã€ã€ã€Œè¯æº–æœƒåˆ©ç‡æ±ºç­–ã€æˆ–ã€ŒAI æ™¶ç‰‡å¸‚å ´è¶¨å‹¢ã€ã€‚</p>
                        <p><strong>ç²å¾— AI ç¸½çµå ±å‘Šï¼š</strong> AI æœƒç‚ºæ‚¨ç”¢å‡ºä¸€ä»½çµæ§‹åŒ–çš„å ±å‘Šï¼ŒåŒ…å«ã€Œæœ€æ–°æ–°èæ‘˜è¦ã€ã€ã€Œå¸‚å ´å½±éŸ¿åˆ†æã€ä»¥åŠã€Œæ©Ÿæœƒèˆ‡é¢¨éšªã€ï¼Œå¹«æ‚¨å¿«é€ŸæŠ“ä½äº‹ä»¶é‡é»ã€‚</p>
                    </div>
                `
            },
            signals: {
                title: 'ğŸ’¡ ç­–ç•¥æœ€æ–°ä¿¡è™Ÿèªªæ˜',
                body: `
                    <div class="help-section">
                        <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                        <p>æ­¤åŠŸèƒ½æœƒè‡ªå‹•æƒææˆ‘å€‘è³‡æ–™åº«ä¸­æ‰€æœ‰ç¶“éè¨“ç·´å’Œæ­·å²å›æ¸¬çš„ç­–ç•¥ï¼Œä¸¦ç¯©é¸å‡ºåœ¨<strong>æœ€è¿‘å¹¾å€‹äº¤æ˜“æ—¥å…§</strong>å‡ºç¾ã€Œè²·å…¥ã€æˆ–ã€Œè³£å‡ºã€ä¿¡è™Ÿçš„è‚¡ç¥¨ã€‚</p>
                    </div>
                    <div class="help-section">
                        <h3>å¦‚ä½•ä½¿ç”¨ï¼š</h3>
                        <p>æ‚¨å¯ä»¥æŠŠå®ƒç•¶ä½œä¸€å€‹ç­–ç•¥çš„ã€Œé›·é”ã€ã€‚å®ƒå¹«åŠ©æ‚¨å¾æ•¸ç™¾å€‹ç­–ç•¥ä¸­å¿«é€Ÿç™¼ç¾å¸‚å ´æ©Ÿæœƒï¼Œæ‰¾åˆ°é‚£äº›æ¨¡å‹èªç‚ºè™•æ–¼é—œéµäº¤æ˜“é»ä½çš„è‚¡ç¥¨ã€‚</p>
                        <p><strong>æé†’ï¼š</strong> é€™è£¡é¡¯ç¤ºçš„ä¿¡è™ŸåŸºæ–¼æ­·å²æ•¸æ“šå›æ¸¬ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸¦éæŠ•è³‡å»ºè­°ã€‚</p>
                    </div>
                `
            }
        };

        function showHelpModal(type) {
            const modal = document.getElementById('helpModal');
            const titleEl = document.getElementById('helpModalTitle');
            const bodyEl = document.getElementById('helpModalBody');
            
            if (helpContent[type]) {
                titleEl.textContent = helpContent[type].title;
                bodyEl.innerHTML = helpContent[type].body;
                modal.style.display = 'flex';
            }
        }

        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'none';
        }

        async function checkLoginStatus() {
            const container = document.getElementById('login-status-container');
            const fab = document.getElementById('floating-action-btn');
            try {
                const response = await fetch('/api/user/status');
                const result = await response.json();
                if (result.logged_in) {
                    container.innerHTML = `<span class="user-welcome">æ­¡è¿, ${result.username}</span><a onclick="handleLogout()" class="logout-link">ç™»å‡º</a>`;
                    fab.href = '/trainer';
                    fab.innerHTML = `<span>ğŸ§¬</span> ç­–ç•¥å¹³å°`;
                } else {
                    container.innerHTML = `<a href="/login" class="login-btn">ç™»å…¥/è¨»å†Š</a>`;
                    fab.href = '/login';
                    fab.innerHTML = `<span>ğŸ”‘</span> ç™»å…¥/è¨»å†Š`;
                }
            } catch (error) {
                console.error("ç„¡æ³•æª¢æŸ¥ç™»å…¥ç‹€æ…‹:", error);
                container.innerHTML = `<a href="/login" class="login-btn">ç™»å…¥/è¨»å†Š</a>`;
                fab.href = '/login';
                fab.innerHTML = `<span>ğŸ”‘</span> ç™»å…¥/è¨»å†Š`;
            }
        }

        async function handleLogout() {
            await fetch('/api/logout');
            window.location.reload();
        }

        function postProcessAnalysisHtml(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            tempDiv.querySelectorAll('h2, h3').forEach(header => {
                header.dataset.title = header.textContent;
            });
            return tempDiv.innerHTML;
        }

        async function saveStrategyFromDashboard(button, strategyData) {
            button.disabled = true;
            button.textContent = 'å„²å­˜ä¸­...';
            try {
                const response = await fetch('/api/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(strategyData)
                });
                if (response.status === 401) {
                    alert('è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜ç­–ç•¥ã€‚å°‡ç‚ºæ‚¨å°å‘ç™»å…¥é é¢ã€‚');
                    window.location.href = `/login?next=${window.location.pathname}`;
                    return; 
                }
                const result = await response.json();
                if (result.success) {
                    button.textContent = 'âœ… å·²å„²å­˜';
                } else {
                    alert('å„²å­˜å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                    button.textContent = 'â­ å„²å­˜ç­–ç•¥';
                    button.disabled = false;
                }
            } catch (error) {
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹å…ˆç™»å…¥');
                button.textContent = 'â­ å„²å­˜ç­–ç•¥';
                button.disabled = false;
            }
        }

        function openChartModal(interactiveUrl) {
            const modal = document.getElementById('chartModal');
            const iframe = document.getElementById('chartModalIframe');
            iframe.src = interactiveUrl;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            const iframe = document.getElementById('chartModalIframe');
            if (modal) modal.style.display = 'none';
            if (iframe) iframe.src = 'about:blank';
            document.body.style.overflow = 'auto';
        }
        
        // æ–°å¢çµ±ä¸€é—œé–‰å½ˆçª—å‡½å¼
        function closeAllModals() {
            closeHelpModal();
            closeChartModal();
        }

        function showPage(pageId) {
            closeAllModals(); // åˆ‡æ›é é¢å‰å…ˆé—œé–‰æ‰€æœ‰å½ˆçª—

            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showPage('${pageId}')"]`).classList.add('active');
            if (pageId === 'page-signals') loadStrategySignals();
        }
        
        function showLoading(id) { document.getElementById(id).style.display = 'block'; }
        function hideLoading(id) { document.getElementById(id).style.display = 'none'; }
        function showError(containerId, message) { document.getElementById(containerId).innerHTML = `<div class="error-message">âŒ ${message}</div>`; }
        
        function formatNumber(num, decimals = 2) { return (num === null || num === undefined || isNaN(num)) ? 'N/A' : parseFloat(num).toFixed(decimals); }
        function formatPercent(num) { return (num === null || num === undefined || isNaN(num)) ? 'N/A' : `${parseFloat(num).toFixed(2)}%`; }
        
        async function enhancedAnalyzeStock() {
            const ticker = document.getElementById('stock-ticker').value.trim();
            if (!ticker) { showError('stock-results', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ'); return; }
            showLoading('stock-loading');
            document.getElementById('stock-results').innerHTML = '';
            try {
                const response = await fetch('/api/enhanced-analyze', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ticker: ticker })
                });
                const result = await response.json();
                if (result.success) {
                    displayEnhancedStockResults(result.data);
                } else {
                    showError('stock-results', result.message || 'åˆ†æå¤±æ•—');
                }
            } catch (error) {
                showError('stock-results', 'ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading('stock-loading');
            }
        }
        
        async function searchNews() {
            const query = document.getElementById('news-query').value.trim();
            if (!query) { showError('news-results', 'è«‹æä¾›æœå°‹é—œéµå­—'); return; }
            showLoading('news-loading');
            document.getElementById('news-results').innerHTML = '';
            try {
                const response = await fetch('/api/news/search', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const result = await response.json();
                if (result.success) {
                    displayNewsResults(result.data);
                } else {
                    showError('news-results', result.message || 'æ–°èæœå°‹å¤±æ•—');
                }
            } catch (error) {
                showError('news-results', 'ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading('news-loading');
            }
        }

        async function loadStrategySignals() {
            const market = document.getElementById('market-select').value;
            const signalType = document.querySelector('input[name="signal_type"]:checked').value;
            showLoading('signals-loading');
            document.getElementById('signals-results').innerHTML = '';
            try {
                const response = await fetch(`/api/strategy-signals?market=${market}&type=${signalType}`);
                const result = await response.json();
                if (result.success) {
                    displayStrategySignals(result.data);
                } else {
                    showError('signals-results', result.message || 'ç­–ç•¥ä¿¡è™Ÿæœå°‹å¤±æ•—');
                }
            } catch (error) {
                showError('signals-results', 'ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideLoading('signals-loading');
            }
        }

        function toggleDetails(elementId, button) {
            const detailsElement = document.getElementById(elementId);
            if (detailsElement) {
                const isHidden = detailsElement.style.display === 'none' || detailsElement.style.display === '';
                detailsElement.style.display = isHidden ? 'block' : 'none';
                button.textContent = isHidden ? 'æ”¶èµ·è©³æƒ…' : 'æŸ¥çœ‹è©³æƒ…';
            }
        }
        
        function displayEnhancedStockResults(data) {
            const container = document.getElementById('stock-results');
            const priceChangeClass = data.price_change > 0 ? 'price-up' : (data.price_change < 0 ? 'price-down' : '');
            const priceChangeIcon = data.price_change > 0 ? 'â–²' : (data.price_change < 0 ? 'â–¼' : '');
            
            const tech_html = `<div class="content-card"><div class="card-header">ğŸ“ˆ æŠ€è¡“æŒ‡æ¨™</div><div class="card-body"><ul class="data-list">
                            <li class="data-list-item"><span class="label">RSI (14)</span><span class="value">${formatNumber(data.technical_indicators.rsi)}</span></li>
                            <li class="data-list-item"><span class="label">5æ—¥å‡ç·š</span><span class="value">${formatNumber(data.technical_indicators.ma_5)}</span></li>
                            <li class="data-list-item"><span class="label">10æ—¥å‡ç·š</span><span class="value">${formatNumber(data.technical_indicators.ma_10)}</span></li>
                            <li class="data-list-item"><span class="label">20æ—¥å‡ç·š</span><span class="value">${formatNumber(data.technical_indicators.ma_20)}</span></li>
                            <li class="data-list-item"><span class="label">60æ—¥å‡ç·š</span><span class="value">${formatNumber(data.technical_indicators.ma_60)}</span></li>
                            <li class="data-list-item"><span class="label">120æ—¥å‡ç·š</span><span class="value">${formatNumber(data.technical_indicators.ma_120)}</span></li>
                            <li class="data-list-item"><span class="label">å¸ƒæ—å¸¶</span><span class="value">${formatNumber(data.technical_indicators.bb_lower)} - ${formatNumber(data.technical_indicators.bb_upper)}</span></li>
                        </ul></div></div>`;

            let html = `<div class="content-card"><div class="stock-header">
                    <h2 class="stock-title">${data.company_name}</h2><p class="stock-ticker">${data.ticker}</p>
                    <div class="stock-price ${priceChangeClass}">${formatNumber(data.current_price)}</div>
                    <div class="stock-change ${priceChangeClass}">${priceChangeIcon} ${data.price_change_str}</div>
                </div></div>
                <div class="content-card"><div class="card-header">ğŸ“Š åŸºæœ¬é¢</div><div class="card-body"><ul class="data-list">
                    <li class="data-list-item"><span class="label">å¸‚å€¼</span><span class="value">${data.market_cap_formatted || 'N/A'}</span></li>
                    <li class="data-list-item"><span class="label">æœ¬ç›Šæ¯” (PE)</span><span class="value">${formatNumber(data.pe_ratio)}</span></li>
                    <li class="data-list-item"><span class="label">æ¯è‚¡ç›ˆé¤˜ (EPS)</span><span class="value">${formatNumber(data.eps)}</span></li>
                    <li class="data-list-item"><span class="label">ROE</span><span class="value">${formatPercent(data.roe * 100)}</span></li>
                    <li class="data-list-item"><span class="label">æˆäº¤é‡</span><span class="value">${data.volume ? data.volume.toLocaleString() : 'N/A'}</span></li>
                </ul></div></div>
                ${tech_html}`;
            
            if (data.ai_strategies && (data.ai_strategies.system_a.length > 0 || data.ai_strategies.system_b.length > 0)) {
                html += `<div class="content-card"><div class="card-header">ğŸ¤– ç­–ç•¥å›æ¸¬</div><div class="card-body">
                         <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px;">${data.ai_strategies.backtest_period_description||''}</p>`;
                
                const createStrategyHtml = (s, type) => {
                    const strategyTypeName = type === 'a' 
                        ? 'ç­–ç•¥ 1 ' 
                        : 'ç­–ç•¥ 2 ';

                    let parsedGene = [];
                    try {
                        if (s.ai_strategy_gene && typeof s.ai_strategy_gene === 'string') {
                            parsedGene = JSON.parse(s.ai_strategy_gene);
                        }
                    } catch (e) {
                        console.error('è§£æç­–ç•¥åŸºå› å¤±æ•—:', s.ai_strategy_gene, e);
                    }
                    const payload = {
                        ticker: data.ticker,
                        train_start_date: data.ai_strategies.backtest_start_date,
                        train_end_date: data.ai_strategies.backtest_end_date,
                        gene: parsedGene,
                        strategy_details: s.strategy_details,
                        metrics: {
                            win_rate_pct: s.win_rate_pct,
                            total_return: s.period_return_pct / 100,
                            trade_count: s.total_trades,
                            average_trade_return: s.average_trade_return_pct / 100,
                            max_drawdown: s.max_drawdown_pct / 100,
                            max_trade_drop_pct: s.max_trade_drop_pct,
                            max_trade_gain_pct: s.max_trade_gain_pct,
                        }
                    };

                    return `
                    <div class="strategy-card system-${type}">
                        <div class="strategy-title">${strategyTypeName}</div>
                        <ul class="data-list">
                            <li class="data-list-item"><span class="label">ç¸½å ±é…¬</span><span class="value">${formatPercent(s.period_return_pct)}</span></li>
                            <li class="data-list-item"><span class="label">å¹³å‡å ±é…¬</span><span class="value">${s.formatted_metrics.average_trade_return_formatted}</span></li>
                            <li class="data-list-item"><span class="label">å‹ç‡</span><span class="value">${formatPercent(s.win_rate_pct)}</span></li>
                            <li class="data-list-item"><span class="label">æœ€å¤§å›æ’¤</span><span class="value price-down">${s.formatted_metrics.max_drawdown_formatted}</span></li>
                            <li class="data-list-item"><span class="label">å–®æ¬¡æœ€å¤§æ¼²/è·Œ</span><span class="value"><span class="price-up">${s.formatted_metrics.max_gain_formatted}</span> / <span class="price-down">${s.formatted_metrics.max_drop_formatted}</span></span></li>
                        </ul>
                        <div class="strategy-buttons">
                            <button class="btn-details" onclick="toggleDetails('details-${type}-${s.strategy_rank}', this)">æŸ¥çœ‹è©³æƒ…</button>
                            <button class="btn-save" onclick='saveStrategyFromDashboard(this, ${JSON.stringify(payload)})'>â­ å„²å­˜ç­–ç•¥</button>
                        </div>
                        <div id="details-${type}-${s.strategy_rank}" class="strategy-details" style="display:none;">${s.strategy_details||'ç„¡è©³ç´°ç­–ç•¥'}</div>
                    </div>`;
                }
                
                if (data.ai_strategies.system_a && data.ai_strategies.system_a.length > 0) {
                    html += createStrategyHtml(data.ai_strategies.system_a[0], 'a');
                }
                if (data.ai_strategies.system_b && data.ai_strategies.system_b.length > 0) {
                    html += createStrategyHtml(data.ai_strategies.system_b[0], 'b');
                }

                html += `</div></div>`;
            }

            if (data.gemini_analysis) {
                const processed_html = postProcessAnalysisHtml(marked.parse(data.gemini_analysis));
                html += `<div class="content-card"><div class="card-header">ğŸ§  Gemini AI å ±å‘Š</div>
                         <div class="card-body analysis-content">${processed_html}</div></div>`;
            }

            if (data.chart_image_url && data.chart_interactive_url) {
                const interactiveUrl = JSON.stringify(data.chart_interactive_url);
                html += `<div class="content-card">
                         <div class="card-header">ğŸ“Š æŠ€è¡“åˆ†æåœ–è¡¨</div>
                         <div class="card-body">
                             <div class="chart-preview-container" onclick='openChartModal(${interactiveUrl})'>
                                 <img src="${data.chart_image_url}" class="chart-preview-image" alt="æŠ€è¡“åˆ†æåœ–è¡¨é è¦½">
                             </div>
                             <p style="text-align:center; font-size:0.8rem; color:var(--text-secondary); margin-top:8px;">é»æ“Šåœ–è¡¨ä»¥é€²è¡Œäº’å‹•</p>
                         </div>
                     </div>`;
            }
            container.innerHTML = html;
        }

        function displayNewsResults(data) {
            const container = document.getElementById('news-results');
            const processed_html = postProcessAnalysisHtml(marked.parse(data.news_analysis));
            let html = `<div class="content-card"><div class="card-header">ğŸ” æœå°‹çµæœï¼š${data.query}</div>
                        <div class="card-body analysis-content news-list">${processed_html}</div>
                        <div style="padding:0 16px 16px;text-align:right;font-size:0.8rem;color:var(--text-secondary);">
                        æœå°‹æ™‚é–“ï¼š${new Date(data.search_time).toLocaleString()}</div></div>`;
            container.innerHTML = html;
        }
        
        function displayStrategySignals(data) {
            const container = document.getElementById('signals-results');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="error-message">ğŸ¯ ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç­–ç•¥ä¿¡è™Ÿ</div>`;
                return;
            }
            let html = '<div id="signals-grid">';
            data.forEach(signal => {
                const metrics = {
                    win_rate_pct: signal.win_rate,
                    total_return: signal.return_pct / 100,
                    trade_count: signal.total_trades,
                    average_trade_return: signal.average_trade_return_pct / 100,
                    max_drawdown: signal.max_drawdown_pct / 100,
                    max_trade_drop_pct: signal.max_trade_drop_pct,
                    max_trade_gain_pct: signal.max_trade_gain_pct,
                };

                let parsedGene = [];
                try {
                    if (signal.ai_strategy_gene) {
                        parsedGene = JSON.parse(signal.ai_strategy_gene);
                    }
                } catch(e) {
                    console.error('è§£æä¿¡è™Ÿç­–ç•¥åŸºå› å¤±æ•—:', signal.ai_strategy_gene, e);
                }

                const payload = {
                    ticker: signal.stock_ticker,
                    train_start_date: signal.game_start_date,
                    train_end_date: signal.game_end_date,
                    gene: parsedGene,
                    strategy_details: signal.strategy_details,
                    metrics: metrics
                };

                const returnColor = parseFloat(signal.return_pct) >= 0 ? 'price-up' : 'price-down';
                let price_html = '';
                if (signal.buy_price !== null) price_html += `<div class="signal-price signal-buy">è²·å…¥åƒ¹æ ¼: ${formatNumber(signal.buy_price)}</div>`;
                if (signal.sell_price !== null) price_html += `<div class="signal-price signal-sell">è³£å‡ºåƒ¹æ ¼: ${formatNumber(signal.sell_price)}</div>`;
                const cleanReason = signal.signal_reason.replace(/ğŸŸ¢|ğŸ”´|è²·å…¥:|è³£å‡º:/g, '').trim();

                html += `
                <div class="signal-card">
                    <div class="signal-card-header">
                        <div class="ticker">${signal.stock_ticker}</div>
                        <button class="btn-save" style="padding: 6px 14px;" onclick='saveStrategyFromDashboard(this, ${JSON.stringify(payload)})'>â­ å„²å­˜</button>
                    </div>
                    <div class="signal-card-body">
                        <p>${cleanReason}</p>
                        ${price_html}
                    </div>
                    <div class="signal-card-footer">
                        <span>ç¸¾æ•ˆ: <span class="return-value ${returnColor}">${formatPercent(signal.return_pct)}</span></span>
                        <span>å‹ç‡: <span class="win-rate-value">${formatPercent(signal.win_rate)}</span></span>
                        <span>${signal.processed_at_str ? new Date(signal.processed_at_str).toLocaleDateString() : ''}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            showPage('page-analysis');
            document.getElementById('stock-ticker').addEventListener('keypress', e => { if (e.key === 'Enter') enhancedAnalyzeStock(); });
            document.getElementById('news-query').addEventListener('keypress', e => { if (e.key === 'Enter') searchNews(); });
            document.getElementById('chartModalClose').addEventListener('click', closeChartModal);

            const helpModal = document.getElementById('helpModal');
            if(helpModal) {
                helpModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeHelpModal();
                    }
                });
            }
        });
    </script>
</body>
</html>
