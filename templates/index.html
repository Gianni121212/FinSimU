<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>分析平台</title>

    <!-- START: PWA/行動裝置優化標籤 -->
    <meta name="theme-color" content="#6d5edc"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <!-- END: PWA/行動裝置優化標籤 -->

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --price-up: #16a34a;
            --price-down: #dc2626;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-primary); padding-bottom: 80px;
        }

        #floating-action-btn {
            position: fixed;
            top: 20px; /* 距離視窗頂部 20px */
            left: 16px;
            z-index: 1001;
            background: var(--gradient);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.8rem;
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s ease-out;
        }
        #floating-action-btn:active {
            transform: scale(0.95);
        }

        .mobile-header {
            background: var(--card-bg); padding: 12px 16px; text-align: center;
            border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; 
        }
        .mobile-header h1 { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        
        #login-status-container {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }
        .login-btn:active {
            background: #5a6acf;
        }
        .user-welcome {
            color: var(--text-secondary);
        }
        .logout-link {
            color: var(--primary-color);
            text-decoration: underline;
            margin-left: 8px;
            cursor: pointer;
        }
        
        main { padding: 16px; }
        .page-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background-color: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: space-around; border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .nav-button {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 0.7rem; color: var(--text-secondary); background: none; border: none;
            cursor: pointer; padding: 8px; border-radius: 8px; width: 80px;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-button-icon { font-size: 1.4rem; }
        .nav-button.active { color: var(--primary-color); }
        .nav-button:active { background-color: var(--bg-color); }

        .search-card {
            background: var(--card-bg); padding: 20px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .search-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .search-card-header-text {
            flex-grow: 1;
        }
        .search-card h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .search-card p { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px; }

        .input-group { margin-bottom: 16px; }
        .input-group input, .input-group select {
            width: 100%; padding: 14px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; background-color: #f9fafb;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .btn-primary {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            background: var(--gradient); color: white;
        }
        .btn-primary:active { transform: scale(0.98); }

        .loading { text-align: center; padding: 40px 0; }
        .loading-spinner {
            width: 36px; height: 36px; border: 4px solid #e0e0e0;
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 12px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading p { font-size: 0.9rem; color: var(--text-secondary); }
        .error-message {
            background-color: #fee2e2; color: #991b1b; padding: 16px;
            border-radius: 8px; text-align: center; font-weight: 500;
        }

        .content-card {
            background: var(--card-bg); border-radius: 12px;
            margin-bottom: 16px; box-shadow: var(--shadow); overflow: hidden;
        }
        .card-header {
            padding: 16px; font-size: 1.1rem; font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 8px;
        }
        .card-body { padding: 16px; }

        .stock-header { text-align: center; padding: 20px 16px; }
        .stock-title { font-size: 1.5rem; font-weight: 700; }
        .stock-ticker { font-size: 1rem; color: var(--text-secondary); }
        .stock-price { font-size: 2.2rem; font-weight: bold; margin: 8px 0; }
        .stock-change { font-size: 1rem; font-weight: 500; }
        .price-up { color: var(--price-up); } .price-down { color: var(--price-down); }

        .data-list { list-style: none; }
        .data-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; font-size: 0.9rem; border-bottom: 1px solid #f3f4f6;
        }
        .data-list-item:last-child { border-bottom: none; }
        .data-list-item .label { color: var(--text-secondary); }
        .data-list-item .value { font-weight: 600; }

        .strategy-card {
            border: 1px solid var(--border-color); border-radius: 10px;
            margin-top: 16px; padding: 16px;
        }
        .strategy-card.system-a { border-left: 4px solid #4ade80; }
        .strategy-card.system-b { border-left: 4px solid #facc15; }
        .strategy-title { font-weight: 600; margin-bottom: 12px; }
        
        .strategy-buttons { display: flex; flex-wrap: wrap; align-items: center; }
        .btn-details {
            padding: 8px 16px; font-size: 0.8rem; border-radius: 20px;
            border: 1px solid var(--primary-color); background-color: transparent;
            color: var(--primary-color); cursor: pointer;
        }
        .btn-save {
            padding: 8px 16px; font-size: 0.8rem; border-radius: 20px;
            border: 1px solid #f59e0b; background-color: transparent;
            color: #f59e0b; cursor: pointer; margin-left: 8px;
        }
        .btn-save:disabled { background-color: #f0f2f5; color: var(--text-secondary); border-color: var(--border-color); cursor: not-allowed; }
        
        .strategy-details {
            background-color: #f9fafb; padding: 12px; margin-top: 12px;
            border-radius: 8px; border: 1px solid var(--border-color);
            font-family: 'Courier New', monospace; font-size: 0.8rem;
            white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;
        }

        .chart-preview-container {
            padding: 8px; background: var(--card-bg); border-radius: 12px;
            box-shadow: var(--shadow); cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .chart-preview-container:active { transform: scale(0.98); }
        .chart-preview-image { width: 100%; border-radius: 8px; display: block; }

        .chart-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); z-index: 2000;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; padding-top: 40px;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }
        .chart-modal-content { width: 100%; height: 100%; background-color: #fff; }
        .chart-modal-iframe { width: 100%; height: 100%; border: none; }
        .chart-modal-close {
            position: absolute; top: 45px; right: 15px; width: 30px; height: 30px;
            background-color: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%;
            font-size: 20px; font-weight: bold; color: #333; cursor: pointer;
            line-height: 30px; text-align: center; z-index: 2001;
        }

        .analysis-content h2, .analysis-content h3 {
            font-size: 1.1em; font-weight: 600; display: flex; align-items: center;
            gap: 0.6em; margin-top: 1.8em; margin-bottom: 1em;
            padding-bottom: 0.5em; border-bottom: 1px solid var(--border-color);
        }
        .analysis-content h2:first-of-type, .analysis-content h3:first-of-type { margin-top: 0; }
        .analysis-content h2::before, .analysis-content h3::before { font-size: 1.2em; }
        .analysis-content [data-title*="最新新聞"]::before { content: '📰'; }
        .analysis-content [data-title*="基本面"]::before { content: '📊'; }
        .analysis-content [data-title*="近期趨勢"]::before, .analysis-content [data-title*="近期趋势"]::before { content: '📈'; }
        .analysis-content [data-title*="策略解讀"]::before, .analysis-content [data-title*="策略解读"]::before { content: '🤖'; }
        .analysis-content [data-title*="投資機會"]::before, .analysis-content [data-title*="投资机会"]::before { content: '💡'; }
        .analysis-content [data-title*="風險提醒"]::before, .analysis-content [data-title*="风险提醒"]::before { content: '⚠️'; }
        .analysis-content [data-title*="市場影響"]::before { content: '📉'; }
        .analysis-content [data-title*="机会与风险"]::before, .analysis-content [data-title*="機會與風險"]::before { content: '🔍'; }
        .analysis-content p, .analysis-content ul {
            font-size: 0.95rem; line-height: 1.75; color: #374151; margin-bottom: 1em;
        }
        .analysis-content ul { list-style-position: outside; padding-left: 1.2em; }
        .analysis-content li { margin-bottom: 0.75em; }
        .analysis-content.news-list ul { list-style: none; padding-left: 0; }
        .analysis-content.news-list li {
            padding: 1em; border-radius: 8px; background-color: #f9fafb;
            border: 1px solid var(--border-color);
        }

        .signal-type-selector {
            display: flex; gap: 8px; margin-bottom: 16px; background-color: var(--bg-color);
            padding: 6px; border-radius: 25px;
        }
        .signal-type-selector label {
            flex-grow: 1; text-align: center; cursor: pointer; padding: 10px;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
        }
        .signal-type-selector input[type="radio"] { display: none; }
        .signal-type-selector input[type="radio"]:checked + label {
            background: var(--primary-color); color: white;
            font-weight: 600; box-shadow: var(--shadow);
        }
        #signals-grid { display: flex; flex-direction: column; gap: 16px; }
        .signal-card {
            background: var(--card-bg); border-radius: 12px;
            box-shadow: var(--shadow); overflow: hidden;
        }
        .signal-card-header {
            padding: 12px 16px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border-color);
        }
        .signal-card-header .ticker { font-size: 1.2rem; font-weight: 600; }
        .signal-card-header .system {
            font-size: 0.8rem; padding: 4px 10px; border-radius: 12px;
            color: white; font-weight: 500;
        }
        .system-a-tag { background-color: #22c55e; }
        .system-b-tag { background-color: #f59e0b; }
        .signal-card-body { padding: 16px; font-size: 0.9rem; line-height: 1.6; }
        .signal-price { font-weight: bold; margin-top: 10px; }
        .signal-buy { color: var(--price-up); }
        .signal-sell { color: var(--price-down); }
        .signal-card-footer {
            background-color: #f9fafb; padding: 10px 16px; font-size: 0.8rem;
            color: var(--text-secondary); display: flex; justify-content: space-between;
            flex-wrap: wrap; gap: 8px;
        }
        .return-value, .win-rate-value { font-weight: 600; color: var(--text-primary); }

        .help-icon {
            width: 24px; height: 24px;
            background-color: var(--bg-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .help-icon:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .help-modal { 
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); 
            display: flex; justify-content: center; align-items: center; padding: 16px; 
            animation: fadeInModal 0.3s ease-out; 
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .help-modal-content { 
            background-color: var(--card-bg); color: var(--text-primary); 
            border-radius: 12px; padding: 24px; width: 100%; max-width: 500px; 
            max-height: 80vh; overflow-y: auto; position: relative; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
        }
        .help-modal-close { 
            position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; 
            line-height: 32px; border: none; background: var(--bg-color); 
            border-radius: 50%; font-size: 1.5rem; color: var(--text-secondary); 
            cursor: pointer; text-align: center; 
        }
        #helpModalTitle { margin-bottom: 16px; color: var(--primary-color); }
        #helpModalBody .help-section { margin-bottom: 16px; }
        #helpModalBody h3 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border-color); }
        #helpModalBody p { font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); }
        #helpModalBody strong { color: var(--text-primary); font-weight: 600; }
        
        .footer {
            text-align: center; margin-top: 30px; padding: 20px;
            font-size: 0.8rem; color: var(--text-secondary);
        }
        .footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    </style>
</head>
<body>
    
    <a id="floating-action-btn" href="/login">
        <!-- 內容將由 JavaScript 動態填入 -->
    </a>

    <header class="mobile-header">
        <h1>🚀  股票分析</h1>
        <div id="login-status-container"></div>
    </header>

    <main>
        <div id="page-analysis" class="page-view active">
            <div class="search-card">
                <div class="search-card-header">
                    <div class="search-card-header-text">
                        <h2>📈 深度股票分析</h2>
                        <p>整合基本面、技術面與 Gemini AI 分析。</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('analysis')">?</span>
                </div>
                <div class="input-group">
                    <input type="text" id="stock-ticker" placeholder="輸入股票代號, 如 AAPL, 2330">
                </div>
                <button class="btn-primary" onclick="enhancedAnalyzeStock()">🔍 開始分析</button>
            </div>
            <div id="stock-loading" style="display: none;" class="loading"><div class="loading-spinner"></div><p>🤖 正在深度分析股票...</p></div>
            <div id="stock-results"></div>
        </div>

        <div id="page-news" class="page-view">
            <div class="search-card">
                <div class="search-card-header">
                    <div class="search-card-header-text">
                        <h2>📰 智能新聞搜尋</h2>
                        <p>使用 Gemini AI 搜尋最新財經新聞並總結。</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('news')">?</span>
                </div>
                <div class="input-group">
                    <input type="text" id="news-query" placeholder="輸入關鍵字, 如 台積電, Fed 升息">
                </div>
                <button class="btn-primary" onclick="searchNews()">🔍 搜尋新聞</button>
            </div>
            <div id="news-loading" style="display: none;" class="loading"><div class="loading-spinner"></div><p>🔎 正在搜尋最新新聞...</p></div>
            <div id="news-results"></div>
        </div>

        <div id="page-signals" class="page-view">
            <div class="search-card">
                <div class="search-card-header">
                     <div class="search-card-header-text">
                        <h2>🎯 策略最新信號</h2>
                        <p>篩選最新回測中符合買賣條件的策略。</p>
                    </div>
                    <span class="help-icon" onclick="showHelpModal('signals')">?</span>
                </div>
                <div class="input-group">
                    <label for="market-select">市場選擇</label>
                    <select id="market-select" onchange="loadStrategySignals()"><option value="TW">台股 (TW)</option><option value="US">美股 (US)</option></select>
                </div>
                <div class="input-group">
                    <label>信號類型</label>
                    <div class="signal-type-selector">
                        <input type="radio" id="signal-type-buy" name="signal_type" value="buy" checked onchange="loadStrategySignals()"><label for="signal-type-buy">🟢 買入</label>
                        <input type="radio" id="signal-type-sell" name="signal_type" value="sell" onchange="loadStrategySignals()"><label for="signal-type-sell">🔴 賣出</label>
                    </div>
                </div>
            </div>
            <div id="signals-loading" class="loading"><div class="loading-spinner"></div><p>🤖 正在搜尋最新策略信號...</p></div>
            <div id="signals-results"></div>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-button active" onclick="showPage('page-analysis')"><span class="nav-button-icon">📈</span><span>分析</span></button>
        <button class="nav-button" onclick="showPage('page-news')"><span class="nav-button-icon">📰</span><span>新聞</span></button>
        <button class="nav-button" onclick="showPage('page-signals')"><span class="nav-button-icon">🎯</span><span>信號</span></button>
    </nav>
    
    <div class="footer">
        <p><a href="/trainer">進入策略訓練平台</a></p>
        <p></p>
    </div>

    <div id="chartModal" class="chart-modal">
        <button id="chartModalClose" class="chart-modal-close">×</button>
        <div class="chart-modal-content">
            <iframe id="chartModalIframe" class="chart-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
            <h2 id="helpModalTitle"></h2>
            <div id="helpModalBody"></div>
        </div>
    </div>

    <script>
        const helpContent = {
            analysis: {
                title: '💡 深度股票分析說明',
                body: `
                    <div class="help-section">
                        <h3>功能介紹</h3>
                        <p>這是平台的核心分析工具。您只需輸入一支股票代號，系統將為您執行全方位的深度分析。</p>
                    </div>
                    <div class="help-section">
                        <h3>分析報告包含：</h3>
                        <p><strong>即時股價與基本面：</strong> 快速掌握市值、本益比、ROE 等關鍵數據。</p>
                        <p><strong>常用技術指標：</strong> 提供 RSI、移動平均線、布林通道等指標，判斷短期趨勢。</p>
                        <p><strong>策略回測：</strong> 展示系統預先訓練好的兩套交易策略在該股票上的歷史回測績效。</p>
                        <p><strong>Gemini AI 深度報告：</strong> AI 會即時搜尋最新相關新聞，並結合所有數據，生成一份包含新聞解讀、投資機會與風險提醒的完整報告。</p>
                    </div>
                `
            },
            news: {
                title: '💡 智能新聞搜尋說明',
                body: `
                    <div class="help-section">
                        <h3>功能介紹</h3>
                        <p>這是一個由 AI 驅動的強大新聞彙整工具。傳統的新聞搜尋只會列出連結，而這裡的 AI 會為您閱讀、理解、並總結搜尋結果。</p>
                    </div>
                    <div class="help-section">
                        <h3>您可以：</h3>
                        <p><strong>搜尋任何財經主題：</strong> 例如「台積電 ADR」、「聯準會利率決策」或「AI 晶片市場趨勢」。</p>
                        <p><strong>獲得 AI 總結報告：</strong> AI 會為您產出一份結構化的報告，包含「最新新聞摘要」、「市場影響分析」以及「機會與風險」，幫您快速抓住事件重點。</p>
                    </div>
                `
            },
            signals: {
                title: '💡 策略最新信號說明',
                body: `
                    <div class="help-section">
                        <h3>功能介紹</h3>
                        <p>此功能會自動掃描我們資料庫中所有經過訓練和歷史回測的策略，並篩選出在<strong>最近幾個交易日內</strong>出現「買入」或「賣出」信號的股票。</p>
                    </div>
                    <div class="help-section">
                        <h3>如何使用：</h3>
                        <p>您可以把它當作一個策略的「雷達」。它幫助您從數百個策略中快速發現市場機會，找到那些模型認為處於關鍵交易點位的股票。</p>
                        <p><strong>提醒：</strong> 這裡顯示的信號基於歷史數據回測，僅供參考，並非投資建議。</p>
                    </div>
                `
            }
        };

        function showHelpModal(type) {
            const modal = document.getElementById('helpModal');
            const titleEl = document.getElementById('helpModalTitle');
            const bodyEl = document.getElementById('helpModalBody');
            
            if (helpContent[type]) {
                titleEl.textContent = helpContent[type].title;
                bodyEl.innerHTML = helpContent[type].body;
                modal.style.display = 'flex';
            }
        }

        function closeHelpModal() {
            const modal = document.getElementById('helpModal');
            if (modal) modal.style.display = 'none';
        }

        async function checkLoginStatus() {
            const container = document.getElementById('login-status-container');
            const fab = document.getElementById('floating-action-btn');
            try {
                const response = await fetch('/api/user/status');
                const result = await response.json();
                if (result.logged_in) {
                    container.innerHTML = `<span class="user-welcome">歡迎, ${result.username}</span><a onclick="handleLogout()" class="logout-link">登出</a>`;
                    fab.href = '/trainer';
                    fab.innerHTML = `<span>🧬</span> 策略平台`;
                } else {
                    container.innerHTML = `<a href="/login" class="login-btn">登入/註冊</a>`;
                    fab.href = '/login';
                    fab.innerHTML = `<span>🔑</span> 登入/註冊`;
                }
            } catch (error) {
                console.error("無法檢查登入狀態:", error);
                container.innerHTML = `<a href="/login" class="login-btn">登入/註冊</a>`;
                fab.href = '/login';
                fab.innerHTML = `<span>🔑</span> 登入/註冊`;
            }
        }

        async function handleLogout() {
            await fetch('/api/logout');
            window.location.reload();
        }

        function postProcessAnalysisHtml(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            tempDiv.querySelectorAll('h2, h3').forEach(header => {
                header.dataset.title = header.textContent;
            });
            return tempDiv.innerHTML;
        }

        async function saveStrategyFromDashboard(button, strategyData) {
            button.disabled = true;
            button.textContent = '儲存中...';
            try {
                const response = await fetch('/api/strategies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(strategyData)
                });
                if (response.status === 401) {
                    alert('請先登入才能儲存策略。將為您導向登入頁面。');
                    window.location.href = `/login?next=${window.location.pathname}`;
                    return; 
                }
                const result = await response.json();
                if (result.success) {
                    button.textContent = '✅ 已儲存';
                } else {
                    alert('儲存失敗: ' + (result.message || '未知錯誤'));
                    button.textContent = '⭐ 儲存策略';
                    button.disabled = false;
                }
            } catch (error) {
                alert('儲存失敗，請先登入');
                button.textContent = '⭐ 儲存策略';
                button.disabled = false;
            }
        }

        function openChartModal(interactiveUrl) {
            const modal = document.getElementById('chartModal');
            const iframe = document.getElementById('chartModalIframe');
            iframe.src = interactiveUrl;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeChartModal() {
            const modal = document.getElementById('chartModal');
            const iframe = document.getElementById('chartModalIframe');
            if (modal) modal.style.display = 'none';
            if (iframe) iframe.src = 'about:blank';
            document.body.style.overflow = 'auto';
        }
        
        // 新增統一關閉彈窗函式
        function closeAllModals() {
            closeHelpModal();
            closeChartModal();
        }

        function showPage(pageId) {
            closeAllModals(); // 切換頁面前先關閉所有彈窗

            document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showPage('${pageId}')"]`).classList.add('active');
            if (pageId === 'page-signals') loadStrategySignals();
        }
        
        function showLoading(id) { document.getElementById(id).style.display = 'block'; }
        function hideLoading(id) { document.getElementById(id).style.display = 'none'; }
        function showError(containerId, message) { document.getElementById(containerId).innerHTML = `<div class="error-message">❌ ${message}</div>`; }
        
        function formatNumber(num, decimals = 2) { return (num === null || num === undefined || isNaN(num)) ? 'N/A' : parseFloat(num).toFixed(decimals); }
        function formatPercent(num) { return (num === null || num === undefined || isNaN(num)) ? 'N/A' : `${parseFloat(num).toFixed(2)}%`; }
        
        async function enhancedAnalyzeStock() {
            const ticker = document.getElementById('stock-ticker').value.trim();
            if (!ticker) { showError('stock-results', '請輸入股票代號'); return; }
            showLoading('stock-loading');
            document.getElementById('stock-results').innerHTML = '';
            try {
                const response = await fetch('/api/enhanced-analyze', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ticker: ticker })
                });
                const result = await response.json();
                if (result.success) {
                    displayEnhancedStockResults(result.data);
                } else {
                    showError('stock-results', result.message || '分析失敗');
                }
            } catch (error) {
                showError('stock-results', '網路連接錯誤，請稍後再試');
            } finally {
                hideLoading('stock-loading');
            }
        }
        
        async function searchNews() {
            const query = document.getElementById('news-query').value.trim();
            if (!query) { showError('news-results', '請提供搜尋關鍵字'); return; }
            showLoading('news-loading');
            document.getElementById('news-results').innerHTML = '';
            try {
                const response = await fetch('/api/news/search', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const result = await response.json();
                if (result.success) {
                    displayNewsResults(result.data);
                } else {
                    showError('news-results', result.message || '新聞搜尋失敗');
                }
            } catch (error) {
                showError('news-results', '網路連接錯誤，請稍後再試');
            } finally {
                hideLoading('news-loading');
            }
        }

        async function loadStrategySignals() {
            const market = document.getElementById('market-select').value;
            const signalType = document.querySelector('input[name="signal_type"]:checked').value;
            showLoading('signals-loading');
            document.getElementById('signals-results').innerHTML = '';
            try {
                const response = await fetch(`/api/strategy-signals?market=${market}&type=${signalType}`);
                const result = await response.json();
                if (result.success) {
                    displayStrategySignals(result.data);
                } else {
                    showError('signals-results', result.message || '策略信號搜尋失敗');
                }
            } catch (error) {
                showError('signals-results', '網路連接錯誤，請稍後再試');
            } finally {
                hideLoading('signals-loading');
            }
        }

        function toggleDetails(elementId, button) {
            const detailsElement = document.getElementById(elementId);
            if (detailsElement) {
                const isHidden = detailsElement.style.display === 'none' || detailsElement.style.display === '';
                detailsElement.style.display = isHidden ? 'block' : 'none';
                button.textContent = isHidden ? '收起詳情' : '查看詳情';
            }
        }
        
        function displayEnhancedStockResults(data) {
            const container = document.getElementById('stock-results');
            const priceChangeClass = data.price_change > 0 ? 'price-up' : (data.price_change < 0 ? 'price-down' : '');
            const priceChangeIcon = data.price_change > 0 ? '▲' : (data.price_change < 0 ? '▼' : '');
            
            const tech_html = `<div class="content-card"><div class="card-header">📈 技術指標</div><div class="card-body"><ul class="data-list">
                            <li class="data-list-item"><span class="label">RSI (14)</span><span class="value">${formatNumber(data.technical_indicators.rsi)}</span></li>
                            <li class="data-list-item"><span class="label">5日均線</span><span class="value">${formatNumber(data.technical_indicators.ma_5)}</span></li>
                            <li class="data-list-item"><span class="label">10日均線</span><span class="value">${formatNumber(data.technical_indicators.ma_10)}</span></li>
                            <li class="data-list-item"><span class="label">20日均線</span><span class="value">${formatNumber(data.technical_indicators.ma_20)}</span></li>
                            <li class="data-list-item"><span class="label">60日均線</span><span class="value">${formatNumber(data.technical_indicators.ma_60)}</span></li>
                            <li class="data-list-item"><span class="label">120日均線</span><span class="value">${formatNumber(data.technical_indicators.ma_120)}</span></li>
                            <li class="data-list-item"><span class="label">布林帶</span><span class="value">${formatNumber(data.technical_indicators.bb_lower)} - ${formatNumber(data.technical_indicators.bb_upper)}</span></li>
                        </ul></div></div>`;

            let html = `<div class="content-card"><div class="stock-header">
                    <h2 class="stock-title">${data.company_name}</h2><p class="stock-ticker">${data.ticker}</p>
                    <div class="stock-price ${priceChangeClass}">${formatNumber(data.current_price)}</div>
                    <div class="stock-change ${priceChangeClass}">${priceChangeIcon} ${data.price_change_str}</div>
                </div></div>
                <div class="content-card"><div class="card-header">📊 基本面</div><div class="card-body"><ul class="data-list">
                    <li class="data-list-item"><span class="label">市值</span><span class="value">${data.market_cap_formatted || 'N/A'}</span></li>
                    <li class="data-list-item"><span class="label">本益比 (PE)</span><span class="value">${formatNumber(data.pe_ratio)}</span></li>
                    <li class="data-list-item"><span class="label">每股盈餘 (EPS)</span><span class="value">${formatNumber(data.eps)}</span></li>
                    <li class="data-list-item"><span class="label">ROE</span><span class="value">${formatPercent(data.roe * 100)}</span></li>
                    <li class="data-list-item"><span class="label">成交量</span><span class="value">${data.volume ? data.volume.toLocaleString() : 'N/A'}</span></li>
                </ul></div></div>
                ${tech_html}`;
            
            if (data.ai_strategies && (data.ai_strategies.system_a.length > 0 || data.ai_strategies.system_b.length > 0)) {
                html += `<div class="content-card"><div class="card-header">🤖 策略回測</div><div class="card-body">
                         <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:16px;">${data.ai_strategies.backtest_period_description||''}</p>`;
                
                const createStrategyHtml = (s, type) => {
                    const strategyTypeName = type === 'a' 
                        ? '策略 1 ' 
                        : '策略 2 ';

                    let parsedGene = [];
                    try {
                        if (s.ai_strategy_gene && typeof s.ai_strategy_gene === 'string') {
                            parsedGene = JSON.parse(s.ai_strategy_gene);
                        }
                    } catch (e) {
                        console.error('解析策略基因失敗:', s.ai_strategy_gene, e);
                    }
                    const payload = {
                        ticker: data.ticker,
                        train_start_date: data.ai_strategies.backtest_start_date,
                        train_end_date: data.ai_strategies.backtest_end_date,
                        gene: parsedGene,
                        strategy_details: s.strategy_details,
                        metrics: {
                            win_rate_pct: s.win_rate_pct,
                            total_return: s.period_return_pct / 100,
                            trade_count: s.total_trades,
                            average_trade_return: s.average_trade_return_pct / 100,
                            max_drawdown: s.max_drawdown_pct / 100,
                            max_trade_drop_pct: s.max_trade_drop_pct,
                            max_trade_gain_pct: s.max_trade_gain_pct,
                        }
                    };

                    return `
                    <div class="strategy-card system-${type}">
                        <div class="strategy-title">${strategyTypeName}</div>
                        <ul class="data-list">
                            <li class="data-list-item"><span class="label">總報酬</span><span class="value">${formatPercent(s.period_return_pct)}</span></li>
                            <li class="data-list-item"><span class="label">平均報酬</span><span class="value">${s.formatted_metrics.average_trade_return_formatted}</span></li>
                            <li class="data-list-item"><span class="label">勝率</span><span class="value">${formatPercent(s.win_rate_pct)}</span></li>
                            <li class="data-list-item"><span class="label">最大回撤</span><span class="value price-down">${s.formatted_metrics.max_drawdown_formatted}</span></li>
                            <li class="data-list-item"><span class="label">單次最大漲/跌</span><span class="value"><span class="price-up">${s.formatted_metrics.max_gain_formatted}</span> / <span class="price-down">${s.formatted_metrics.max_drop_formatted}</span></span></li>
                        </ul>
                        <div class="strategy-buttons">
                            <button class="btn-details" onclick="toggleDetails('details-${type}-${s.strategy_rank}', this)">查看詳情</button>
                            <button class="btn-save" onclick='saveStrategyFromDashboard(this, ${JSON.stringify(payload)})'>⭐ 儲存策略</button>
                        </div>
                        <div id="details-${type}-${s.strategy_rank}" class="strategy-details" style="display:none;">${s.strategy_details||'無詳細策略'}</div>
                    </div>`;
                }
                
                if (data.ai_strategies.system_a && data.ai_strategies.system_a.length > 0) {
                    html += createStrategyHtml(data.ai_strategies.system_a[0], 'a');
                }
                if (data.ai_strategies.system_b && data.ai_strategies.system_b.length > 0) {
                    html += createStrategyHtml(data.ai_strategies.system_b[0], 'b');
                }

                html += `</div></div>`;
            }

            if (data.gemini_analysis) {
                const processed_html = postProcessAnalysisHtml(marked.parse(data.gemini_analysis));
                html += `<div class="content-card"><div class="card-header">🧠 Gemini AI 報告</div>
                         <div class="card-body analysis-content">${processed_html}</div></div>`;
            }

            if (data.chart_image_url && data.chart_interactive_url) {
                const interactiveUrl = JSON.stringify(data.chart_interactive_url);
                html += `<div class="content-card">
                         <div class="card-header">📊 技術分析圖表</div>
                         <div class="card-body">
                             <div class="chart-preview-container" onclick='openChartModal(${interactiveUrl})'>
                                 <img src="${data.chart_image_url}" class="chart-preview-image" alt="技術分析圖表預覽">
                             </div>
                             <p style="text-align:center; font-size:0.8rem; color:var(--text-secondary); margin-top:8px;">點擊圖表以進行互動</p>
                         </div>
                     </div>`;
            }
            container.innerHTML = html;
        }

        function displayNewsResults(data) {
            const container = document.getElementById('news-results');
            const processed_html = postProcessAnalysisHtml(marked.parse(data.news_analysis));
            let html = `<div class="content-card"><div class="card-header">🔍 搜尋結果：${data.query}</div>
                        <div class="card-body analysis-content news-list">${processed_html}</div>
                        <div style="padding:0 16px 16px;text-align:right;font-size:0.8rem;color:var(--text-secondary);">
                        搜尋時間：${new Date(data.search_time).toLocaleString()}</div></div>`;
            container.innerHTML = html;
        }
        
        function displayStrategySignals(data) {
            const container = document.getElementById('signals-results');
            if (!data || data.length === 0) {
                container.innerHTML = `<div class="error-message">🎯 目前沒有符合條件的策略信號</div>`;
                return;
            }
            let html = '<div id="signals-grid">';
            data.forEach(signal => {
                const metrics = {
                    win_rate_pct: signal.win_rate,
                    total_return: signal.return_pct / 100,
                    trade_count: signal.total_trades,
                    average_trade_return: signal.average_trade_return_pct / 100,
                    max_drawdown: signal.max_drawdown_pct / 100,
                    max_trade_drop_pct: signal.max_trade_drop_pct,
                    max_trade_gain_pct: signal.max_trade_gain_pct,
                };

                let parsedGene = [];
                try {
                    if (signal.ai_strategy_gene) {
                        parsedGene = JSON.parse(signal.ai_strategy_gene);
                    }
                } catch(e) {
                    console.error('解析信號策略基因失敗:', signal.ai_strategy_gene, e);
                }

                const payload = {
                    ticker: signal.stock_ticker,
                    train_start_date: signal.game_start_date,
                    train_end_date: signal.game_end_date,
                    gene: parsedGene,
                    strategy_details: signal.strategy_details,
                    metrics: metrics
                };

                const returnColor = parseFloat(signal.return_pct) >= 0 ? 'price-up' : 'price-down';
                let price_html = '';
                if (signal.buy_price !== null) price_html += `<div class="signal-price signal-buy">買入價格: ${formatNumber(signal.buy_price)}</div>`;
                if (signal.sell_price !== null) price_html += `<div class="signal-price signal-sell">賣出價格: ${formatNumber(signal.sell_price)}</div>`;
                const cleanReason = signal.signal_reason.replace(/🟢|🔴|買入:|賣出:/g, '').trim();

                html += `
                <div class="signal-card">
                    <div class="signal-card-header">
                        <div class="ticker">${signal.stock_ticker}</div>
                        <button class="btn-save" style="padding: 6px 14px;" onclick='saveStrategyFromDashboard(this, ${JSON.stringify(payload)})'>⭐ 儲存</button>
                    </div>
                    <div class="signal-card-body">
                        <p>${cleanReason}</p>
                        ${price_html}
                    </div>
                    <div class="signal-card-footer">
                        <span>績效: <span class="return-value ${returnColor}">${formatPercent(signal.return_pct)}</span></span>
                        <span>勝率: <span class="win-rate-value">${formatPercent(signal.win_rate)}</span></span>
                        <span>${signal.processed_at_str ? new Date(signal.processed_at_str).toLocaleDateString() : ''}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            showPage('page-analysis');
            document.getElementById('stock-ticker').addEventListener('keypress', e => { if (e.key === 'Enter') enhancedAnalyzeStock(); });
            document.getElementById('news-query').addEventListener('keypress', e => { if (e.key === 'Enter') searchNews(); });
            document.getElementById('chartModalClose').addEventListener('click', closeChartModal);

            const helpModal = document.getElementById('helpModal');
            if(helpModal) {
                helpModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeHelpModal();
                    }
                });
            }
        });
    </script>
</body>
</html>
