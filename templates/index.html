<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>股票智能助手</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0066ff;
      --secondary-color: #00cc88;
      --bg-color: #101827;
      --card-bg: rgba(16, 24, 39, 0.9);
      --text-primary: #f0f0f0;
      --text-secondary: #a0aec0;
      --border-color: rgba(255, 255, 255, 0.1);
      --shadow-small: 0 2px 5px rgba(0, 0, 0, 0.2);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-strong: 0 8px 25px rgba(0, 0, 0, 0.4);
      --transition-normal: all 0.3s ease;
      --transition-slow: all 0.5s ease;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 204, 136, 0.05) 0%, transparent 20%),
        linear-gradient(135deg, rgba(16, 24, 39, 0.97) 0%, rgba(17, 24, 39, 0.98) 100%);
      background-attachment: fixed;
    }

    .chat-container, #portfolio-section, #watchlist-section, #news-section {
      max-width: 1000px;
      margin: 30px auto;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow-medium);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      max-height: calc(100vh - 60px);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      transition: var(--transition-normal);
    }

    #portfolio-section, #watchlist-section, #news-section {
      display: none;
      overflow-y: auto;
      padding: 30px;
      height: calc(100vh - 110px);
       max-height: calc(100vh - 110px);
    }
     /* Scrollbar styling */
     #portfolio-section::-webkit-scrollbar,
     #watchlist-section::-webkit-scrollbar,
     #news-section::-webkit-scrollbar,
     .chat-messages::-webkit-scrollbar { width: 8px; }
      #portfolio-section::-webkit-scrollbar-track,
      #watchlist-section::-webkit-scrollbar-track,
      #news-section::-webkit-scrollbar-track,
      .chat-messages::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 10px; }
      #portfolio-section::-webkit-scrollbar-thumb,
      #watchlist-section::-webkit-scrollbar-thumb,
      #news-section::-webkit-scrollbar-thumb,
      .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
      #portfolio-section::-webkit-scrollbar-thumb:hover,
      #watchlist-section::-webkit-scrollbar-thumb:hover,
      #news-section::-webkit-scrollbar-thumb:hover,
      .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.4); }


    #portfolio-section.active, #watchlist-section.active, #news-section.active { display: block; }
    .chat-header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .chat-header h1 { margin: 0; font-size: 1.8rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
    .chat-header h1::before { content: "\1F4C8"; font-size: 1.8rem; }
    .chat-header-actions { display: flex; gap: 15px; }
    .chat-header-actions button { background: transparent; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; transition: var(--transition-normal); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .chat-header-actions button:hover { color: var(--primary-color); background: rgba(0, 102, 255, 0.1); transform: translateY(-2px); }
    .market-toggle-container { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px 0; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .market-type { font-weight: 500; color: var(--text-secondary); }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.1); transition: .4s; border-radius: 34px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: var(--primary-color); }
    input:checked + .toggle-slider:before { transform: translateX(26px); }
    .stock-chips { display: flex; flex-wrap: nowrap; gap: 10px; padding: 15px 20px; border-bottom: 1px solid var(--border-color); overflow-x: auto; flex-shrink: 0; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.2) rgba(0, 0, 0, 0.1); }
     .stock-chips::-webkit-scrollbar { height: 6px; }
     .stock-chips::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    .stock-chip { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: var(--transition-normal); white-space: nowrap; flex-shrink: 0; }
    .stock-chip:hover { background: rgba(0, 102, 255, 0.1); color: var(--primary-color); transform: translateY(-2px); box-shadow: var(--shadow-small); }
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .message { display: flex; flex-direction: column; max-width: 85%; animation: fadeIn 0.5s ease; }
    .message-user { align-self: flex-end; background: linear-gradient(135deg, var(--primary-color), rgba(0, 102, 255, 0.8)); color: white; border-radius: 18px 18px 4px 18px; padding: 12px 18px; box-shadow: var(--shadow-small); }
    .message-assistant { align-self: flex-start; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); border-radius: 18px 18px 18px 4px; padding: 12px 18px; box-shadow: var(--shadow-small); border: 1px solid rgba(255, 255, 255, 0.05); }
    .message-assistant.message-error { background: rgba(214, 39, 40, 0.1); border-left: 4px solid #d62728; }
    .message-assistant.message-error .message-content { color: #fcc; }
    .message-assistant.message-error strong { color: #ff7f0e; }
    .message-content { margin-bottom: 5px; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; }
    .message-content p { margin: 0 0 10px 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content ul, .message-content ol, .stock-analysis .ai-analysis-content ul, .stock-analysis .ai-analysis-content ol, .portfolio-suggestion ul, .portfolio-suggestion ol, .suggested-portfolio-card ul { margin: 10px 0 15px 0; padding-left: 25px; }
    .message-content li, .stock-analysis .ai-analysis-content li, .portfolio-suggestion li, .suggested-portfolio-card li { margin-bottom: 8px; line-height: 1.6; }
    .message-content strong, .stock-analysis .ai-analysis-content strong, .portfolio-suggestion strong, .suggested-portfolio-card strong { color: var(--primary-color); font-weight: 600; }
    .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6, .stock-analysis .ai-analysis-content h1, .stock-analysis .ai-analysis-content h2, .stock-analysis .ai-analysis-content h3, .stock-analysis .ai-analysis-content h4, .stock-analysis .ai-analysis-content h5, .stock-analysis .ai-analysis-content h6, .portfolio-suggestion h1, .portfolio-suggestion h2, .portfolio-suggestion h3, .portfolio-suggestion h4, .portfolio-suggestion h5, .portfolio-suggestion h6, .suggested-portfolio-card h1, .suggested-portfolio-card h2, .suggested-portfolio-card h3, .suggested-portfolio-card h4, .suggested-portfolio-card h5, .suggested-portfolio-card h6 { margin-top: 1.2em; margin-bottom: 0.6em; font-weight: 600; color: var(--primary-color); }
    .message-content h3, .stock-analysis .ai-analysis-content h3, .portfolio-suggestion h3, .suggested-portfolio-card h3 { font-size: 1.2em; }
    .message-content h4, .stock-analysis .ai-analysis-content h4, .portfolio-suggestion h4, .suggested-portfolio-card h4 { font-size: 1.1em; }
    .message-content table, .stock-analysis .ai-analysis-content table, .portfolio-suggestion table, .suggested-portfolio-card table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; background-color: rgba(0,0,0,0.2); font-size: 0.95em; }
    .message-content th, .message-content td, .stock-analysis .ai-analysis-content th, .stock-analysis .ai-analysis-content td, .portfolio-suggestion th, .portfolio-suggestion td, .suggested-portfolio-card th, .suggested-portfolio-card td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; vertical-align: top; }
    .message-content th, .stock-analysis .ai-analysis-content th, .portfolio-suggestion th, .suggested-portfolio-card th { background-color: rgba(0, 102, 255, 0.1); font-weight: 600; white-space: nowrap; }
    .message-time { font-size: 0.8rem; color: rgba(255, 255, 255, 0.5); align-self: flex-end; margin-top: 5px; }
    .stock-card { margin-top: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 15px; border: 1px solid rgba(0, 102, 255, 0.2); animation: slideUp 0.5s ease; }
    .stock-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
    .stock-card h4 { margin: 0 10px 5px 0; color: var(--primary-color); font-weight: 600; font-size: 1.2rem; }
    .stock-price { font-weight: 600; font-size: 1.1rem; white-space: nowrap; }
    .stock-info p, .stock-analysis p { margin-bottom: 8px; font-size: 0.95rem; }
    .stock-info strong, .stock-analysis strong { font-weight: 600; }
    .stock-analysis { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
    .stock-analysis h5 { margin-bottom: 15px; color: var(--primary-color); font-size: 1.1rem; }
    .message-assistant .stock-analysis .ai-analysis-content p { margin-bottom: 10px; }
    .stock-chart-container { width: 100%; height: 350px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-top: 15px; background-color: rgba(0,0,0,0.1); }
    .stock-chart-container iframe { width: 100%; height: 100%; border: none; }
    .chat-input-container { padding: 15px 20px; display: flex; align-items: center; gap: 15px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
    .chat-input { flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-primary); padding: 12px 20px; border-radius: 30px; outline: none; transition: var(--transition-normal); font-size: 1rem; }
    .chat-input:focus { border-color: var(--primary-color); background: rgba(0, 102, 255, 0.05); box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1); }
    .chat-send-btn { background: linear-gradient(135deg, var(--primary-color), rgba(0, 102, 255, 0.8)); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition-normal); box-shadow: var(--shadow-small); flex-shrink: 0; }
     .chat-send-btn:disabled { background: grey; cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
    .chat-send-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 102, 255, 0.5); }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(16, 24, 39, 0.95); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); z-index: 100; height: 60px; }
    .bottom-nav button { background: transparent; border: none; color: var(--text-secondary); font-size: 1.4rem; cursor: pointer; transition: var(--transition-normal); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; flex: 1; height: 100%; }
    .bottom-nav button span { font-size: 0.65rem; font-weight: 500; }
    .bottom-nav button.active { color: var(--primary-color); }
    .bottom-nav button:hover { color: var(--primary-color); transform: translateY(-2px); }
    .section-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .section-header h2 { font-size: 1.8rem; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .section-header p { color: var(--text-secondary); margin: 0; }

    /* --- Watchlist Styles (Modified v4 - Grouping) --- */
    .watchlist-table { width: 100%; border-collapse: separate; border-spacing: 0; /* Remove spacing */ }
    .watchlist-table th, .watchlist-table td { padding: 10px 15px; vertical-align: middle; text-align: left; border-bottom: 1px solid var(--border-color); /* Add bottom border */ }
    .watchlist-table th { color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; white-space: nowrap; border-bottom-width: 2px; /* Thicker border for header */ }
    .watchlist-table th.checkbox-col, .watchlist-table td.checkbox-col { width: 1%; padding-right: 5px; text-align: center; }
    /* Group Header Row Style */
    .watchlist-group-header td {
        background-color: rgba(0, 102, 255, 0.1);
        font-weight: 600;
        color: var(--primary-color);
        padding-top: 8px;
        padding-bottom: 8px;
        font-size: 0.95rem;
        border-top: 2px solid var(--primary-color); /* Add top border to group header */
        border-bottom: 1px solid var(--primary-color); /* Add bottom border to group header */
    }
    .watchlist-item { background: transparent; /* Remove item background */ transition: background-color 0.2s ease; }
    .watchlist-item:hover { background-color: rgba(0, 102, 255, 0.05); /* Hover effect */ }
    .watchlist-item td:not(.checkbox-col):not(.watchlist-actions) { cursor: pointer; }
    /* Remove item border radius */
    .watchlist-item td { border-radius: 0 !important; }
    /* Remove bottom border for last row in table */
    .watchlist-table tbody tr:last-child td { border-bottom: none; }

    .stock-name { font-weight: 600; }
    .stock-ticker { color: var(--text-secondary); font-size: 0.9rem; margin-top: 3px; }
    .price-positive { color: var(--secondary-color); }
    .price-negative { color: #ff6b6b; }
    .watchlist-actions { text-align: right; white-space: nowrap;}
    .watchlist-actions button { background: transparent; border: none; color: var(--text-secondary); padding: 5px 8px; border-radius: 5px; cursor: pointer; transition: var(--transition-normal); margin-left: 5px; font-size: 1rem; }
    .watchlist-actions button:hover { color: var(--primary-color); background: rgba(0, 102, 255, 0.1); }
    .add-stock-form { background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem;}
    .form-control, .form-select { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--text-primary); padding: 10px 15px; border-radius: 10px; outline: none; transition: var(--transition-normal); }
    .form-control:focus, .form-select:focus { border-color: var(--primary-color); background: rgba(0, 102, 255, 0.05); box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1); }
    .watchlist-bulk-actions { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 20px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .watchlist-bulk-actions .form-check { margin-bottom: 0; }
    .watchlist-bulk-actions .action-buttons { display: flex; gap: 10px; }
    .btn-danger-outline { background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; }
    .btn-danger-outline:hover:not(:disabled) { background: rgba(255, 107, 107, 0.1); color: #ff8f8f; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2); transform: translateY(-1px); }
    /* --- End Watchlist --- */

    .btn { background: linear-gradient(135deg, var(--primary-color), rgba(0, 102, 255, 0.8)); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: var(--transition-normal); font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 102, 255, 0.3); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
    .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.2); }
    .btn-secondary:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); color: var(--text-primary); box-shadow: var(--shadow-small); transform: translateY(-1px); }

    /* --- News Styles --- */
    .news-list { display: flex; flex-direction: column; gap: 15px; }
    .news-item { background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 20px; transition: var(--transition-normal); border: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; }
    .news-item:hover { background: rgba(0, 102, 255, 0.1); transform: translateY(-2px); box-shadow: var(--shadow-small); }
    .news-title { font-weight: 600; margin-bottom: 10px; font-size: 1.1rem; }
    .news-meta { display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
    .news-meta span:first-child { margin-right: 0; }
    .news-sentiment { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; }
    .sentiment-Positive { background: rgba(0, 204, 136, 0.2); color: var(--secondary-color); }
    .sentiment-Negative { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .sentiment-Neutral { background: rgba(255, 204, 0, 0.2); color: #ffcc00; }
    .news-summary { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
    .market-summary { background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 20px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.05); }
    .market-summary h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.3rem; font-weight: 600; }
    .index-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .index-item { background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 15px; }
    .index-name { font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
    .index-price { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
    .market-sentiment { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
    .sentiment-indicator { width: 15px; height: 15px; border-radius: 50%; flex-shrink: 0; }
    .sentiment-樂觀 { background-color: var(--secondary-color); }
    .sentiment-中性 { background-color: #ffcc00; }
    .sentiment-謹慎 { background-color: #ff6b6b; }
    .sentiment-未知 { background-color: grey; }
    /* --- End News --- */

    /* --- Portfolio Styles (Modified v4 - Allocation Display) --- */
    .portfolio-result { background: rgba(0, 0, 0, 0.2); border-radius: 15px; padding: 20px; margin-top: 30px; display: none; animation: slideUp 0.5s ease; }
    .portfolio-result h3 { margin-bottom: 15px; font-size: 1.5rem; }
    .portfolio-suggestion { margin-bottom: 20px; line-height: 1.6; }
    #suggested-portfolios-container { margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); display: none; }
    #suggested-portfolios-container h4 { margin-bottom: 20px; font-size: 1.3rem; color: var(--primary-color); }
    .suggested-portfolio-card { background: rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .suggested-portfolio-card h5 { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: var(--secondary-color); }
    .suggested-portfolio-card .tickers-list,
    .suggested-portfolio-card .allocations-list { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 10px; word-break: break-all; }
    .suggested-portfolio-card .tickers-list strong,
    .suggested-portfolio-card .allocations-list strong { color: var(--text-primary); }
    .suggested-portfolio-card .btn { margin-top: 15px; }
    /* --- End Portfolio --- */

    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; vertical-align: middle; margin-right: 5px; }
     .loading-inline { width: 1em; height: 1em; border-width: 2px; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .alert { padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 10px; }
    .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .text-danger { color: #ff6b6b !important; }
    .text-warning { color: #ffcc00 !important; }
    .text-success { color: var(--secondary-color) !important; }

    /* --- Responsive Design --- */
    @media (max-width: 768px) {
      body { padding-bottom: 60px; font-size: 15px; }
      .chat-container, #portfolio-section, #watchlist-section, #news-section { margin: 10px; height: calc(100vh - 70px); max-height: calc(100vh - 70px); border-radius: 15px; }
      #portfolio-section, #watchlist-section, #news-section { height: calc(100vh - 120px); max-height: calc(100vh - 120px); }
      .chat-header h1 { font-size: 1.5rem; }
      .chat-header h1::before { font-size: 1.5rem; }
      .message { max-width: 95%; }
      .form-row { flex-direction: column; gap: 15px; }
      .form-row .form-group { min-width: unset; }
      .index-list { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); }
      .stock-card-header { flex-direction: column; align-items: flex-start; }
      .stock-price { margin-top: 5px; }
      .bottom-nav { padding: 5px 0; height: 55px; }
      .bottom-nav button { font-size: 1.2rem; }
      .bottom-nav button span { font-size: 0.6rem; }
      .stock-chart-container { height: 250px; }
       .watchlist-table th, .watchlist-item td { padding: 10px 8px; font-size: 0.9rem; }
       .stock-name { font-size: 0.9rem; }
       .stock-ticker { font-size: 0.8rem; }
       .suggested-portfolio-card { padding: 15px; }
       .watchlist-bulk-actions { flex-direction: column; align-items: flex-start; }
       .watchlist-bulk-actions .action-buttons { width: 100%; justify-content: space-between; }
    }

  </style>
</head>
<body>
  <!-- 主聊天界面 -->
  <div class="chat-container" id="chat-section">
    <div class="chat-header">
      <h1>股票智能助手</h1>
      <div class="chat-header-actions">
        <button id="settings-btn" title="設定"><i class="fas fa-cog"></i></button>
        <button id="info-btn" title="關於"><i class="fas fa-info-circle"></i></button>
      </div>
    </div>
    <div class="market-toggle-container">
      <span class="market-type">台股</span>
      <label class="toggle-switch"><input type="checkbox" id="market-toggle"><span class="toggle-slider"></span></label>
      <span class="market-type">美股</span>
    </div>
    <div class="stock-chips"><!-- Stock chips --></div>
    <div class="chat-messages" id="chat-messages">
      <div class="message message-assistant">
        <div class="message-content">
          <p>你好！我是你的股票智能助手。你可以：</p>
          <ul>
            <li>輸入 <strong>#股票代碼</strong> 來查詢股票資訊 (例如：#2330 或 #AAPL)</li>
            <li>詢問我關於投資策略、技術分析或市場趨勢的問題</li>
            <li>點擊下方「投資組合」來獲取 AI 建議</li>
            <li>點擊下方「追蹤清單」來管理您關注的股票</li>
            <li>點擊下方「市場新聞」來查看最新動態</li>
          </ul>
          <p>有什麼我可以幫你的嗎？</p>
        </div>
        <div class="message-time"></div>
      </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chat-input" placeholder="輸入訊息或 #股票代碼...">
      <button class="chat-send-btn" id="chat-send-btn" disabled><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- 投資組合區塊 (Modified v4) -->
  <div id="portfolio-section">
     <div class="section-header">
       <h2><i class="fas fa-wand-magic-sparkles"></i> AI 投資組合建議</h2>
       <p>根據目前策略的 '買入' 信號，獲取 AI 建議的股票組合與資金分配</p>
     </div>
     <button class="btn mb-4" id="get-suggestion-btn"><i class="fas fa-wand-magic-sparkles"></i> 取得 AI 建議</button>

     <!-- Result area -->
     <div class="portfolio-result" id="portfolio-result">
       <h3><i class="fas fa-lightbulb"></i> AI 建議全文</h3>
       <div class="portfolio-suggestion" id="portfolio-suggestion">
         <p class="text-secondary">點擊上方按鈕以獲取建議。</p>
       </div>

       <!-- Suggested Portfolios Section -->
       <div id="suggested-portfolios-container">
           <h4><i class="fas fa-layer-group"></i> 建議組合選項</h4>
           <div id="suggested-portfolios-list">
               <p class="text-secondary">載入建議組合中...</p>
           </div>
           <div id="add-watchlist-status" class="mt-3" style="font-size: 0.9rem;"></div>
       </div>
     </div>
   </div>


  <!-- 追蹤清單區塊 (Modified v4) -->
   <div id="watchlist-section">
     <div class="section-header">
       <h2><i class="fas fa-star"></i> 追蹤清單</h2>
       <p>管理您關注的股票，隨時掌握最新行情</p>
     </div>
     <!-- Add Stock Form -->
     <div class="add-stock-form">
       <form id="add-stock-form">
         <div class="form-row align-items-end">
           <div class="form-group" style="flex-grow: 3;">
             <label class="form-label" for="stock-ticker">股票代碼 (台股可省略 .TW)</label>
             <input type="text" class="form-control" id="stock-ticker" placeholder="例如：2330 或 AAPL" required>
           </div>
           <div class="form-group" style="flex-grow: 1;">
             <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-plus"></i> 加入追蹤</button>
           </div>
         </div>
       </form>
     </div>

     <!-- Bulk Actions Bar -->
     <div class="watchlist-bulk-actions" id="watchlist-bulk-actions-bar" style="display: none;">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="watchlist-select-all">
            <label class="form-check-label" for="watchlist-select-all">全選</label>
        </div>
        <div class="action-buttons">
            <button class="btn btn-sm btn-danger-outline" id="watchlist-delete-selected" disabled><i class="fas fa-trash-alt"></i> 刪除選中</button>
            <button class="btn btn-sm btn-danger-outline" id="watchlist-delete-all"><i class="fas fa-dumpster-fire"></i> 刪除全部</button>
        </div>
     </div>
     <div id="bulk-delete-status" class="mb-3" style="font-size: 0.9rem;"></div>

     <!-- Watchlist Table -->
     <table class="watchlist-table">
       <thead>
         <tr>
           <th class="checkbox-col"></th>
           <th>股票</th>
           <th>最新價</th>
           <th>漲跌幅</th>
           <th>操作</th>
         </tr>
       </thead>
       <tbody id="watchlist-items">
         <!-- Group headers and items will be loaded here -->
         <tr><td colspan="5" class="text-center py-4">載入中...</td></tr>
       </tbody>
     </table>
   </div>


  <!-- 新聞區塊 -->
   <div id="news-section">
     <div class="section-header">
       <h2><i class="fas fa-newspaper"></i> 市場新聞</h2>
       <p>掌握最新市場動態與投資資訊</p>
     </div>
     <div class="market-summary" id="market-summary">
       <h3><i class="fas fa-chart-line"></i> 市場概況 (<span id="market-summary-market">TW</span>)</h3>
       <div class="index-list" id="index-list">
         <div class="index-item"><div class="index-name">載入中...</div></div>
       </div>
       <div class="market-sentiment">
         <div class="sentiment-indicator" id="sentiment-indicator"></div>
         <span id="sentiment-text">市場情緒: 載入中...</span>
       </div>
     </div>
     <div class="news-list" id="news-list">
       <div class="news-item"><div class="news-title">載入中...</div></div>
     </div>
   </div>


  <!-- 底部導航 -->
  <div class="bottom-nav">
    <button id="nav-chat" class="active"><i class="fas fa-comments"></i><span>聊天</span></button>
    <button id="nav-portfolio"><i class="fas fa-chart-pie"></i><span>投資組合</span></button>
    <button id="nav-watchlist"><i class="fas fa-star"></i><span>追蹤清單</span></button>
    <button id="nav-news"><i class="fas fa-newspaper"></i><span>市場新聞</span></button>
  </div>

  <!-- 設定模態框 -->
  <div class="modal fade" id="settings-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
          <h5 class="modal-title"><i class="fas fa-cog"></i> 設定</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="settings-form">
            <div class="form-group mb-3">
              <label for="font-size" class="form-label">字體大小</label>
              <select class="form-select" id="font-size"><option value="small">小</option><option value="medium">中</option><option value="large">大</option></select>
            </div>
            <div class="form-group mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="market-summary-setting"><label class="form-check-label" for="market-summary-setting">在新聞頁顯示市場概況</label></div></div>
             <div class="form-group mb-3"><label for="data-source" class="form-label">資料來源 (目前僅支援)</label><select class="form-select" id="data-source" disabled><option value="default" selected>Yahoo Finance</option></select></div>
             <div class="form-group mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="dark-mode" disabled><label class="form-check-label" for="dark-mode">深色模式 (預設)</label></div></div>
            <div class="form-group mb-3"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="price-alert" disabled><label class="form-check-label" for="price-alert">價格提醒通知 (未實作)</label></div></div>
          </form>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="save-settings"><i class="fas fa-save"></i> 儲存設定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 關於模態框 -->
  <div class="modal fade" id="info-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
         <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
          <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
            <h5 class="modal-title"><i class="fas fa-info-circle"></i> 關於股票智能助手</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>股票智能助手是一款結合AI技術的股票分析工具，旨在幫助投資者做出更明智的投資決策。</p>
            <p><strong>主要功能：</strong></p>
            <ul>
              <li>AI 驅動的股票基本面與技術面分析</li>
              <li>基於 '買入' 信號的 AI 投資組合建議 (含資金分配範例)</li>
              <li>即時市場新聞與情緒分析</li>
              <li>個人化股票追蹤清單 (支援分組與批量操作)</li>
            </ul>
            <p><strong>版本：</strong> 1.5.0 (組合建議流程優化 & 追蹤清單增強)</p>
            <p><strong>資料來源：</strong> 主要使用 Yahoo Finance API，新聞來自 Google News，策略信號來自內部回測。</p>
            <p><strong>AI 模型：</strong> Google Gemini (Flash)</p>
            <p><strong>免責聲明：</strong> 本工具提供的所有資訊僅供參考，不構成任何投資建議。投資涉及風險，請獨立判斷並諮詢專業意見。</p>
          </div>
          <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // --- DOM Elements ---
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const chatSendBtn = document.getElementById('chat-send-btn');
      const marketToggle = document.getElementById('market-toggle');
      const stockChipsContainer = document.querySelector('.stock-chips');
      const settingsBtn = document.getElementById('settings-btn');
      const infoBtn = document.getElementById('info-btn');
      const navButtons = { chat: document.getElementById('nav-chat'), portfolio: document.getElementById('nav-portfolio'), watchlist: document.getElementById('nav-watchlist'), news: document.getElementById('nav-news') };
      const sections = { chat: document.getElementById('chat-section'), portfolio: document.getElementById('portfolio-section'), watchlist: document.getElementById('watchlist-section'), news: document.getElementById('news-section') };
      const addStockForm = document.getElementById('add-stock-form');
      const stockTickerInput = document.getElementById('stock-ticker');
      // Watchlist Elements
      const watchlistItems = document.getElementById('watchlist-items');
      const watchlistBulkActionsBar = document.getElementById('watchlist-bulk-actions-bar');
      const watchlistSelectAll = document.getElementById('watchlist-select-all');
      const watchlistDeleteSelectedBtn = document.getElementById('watchlist-delete-selected');
      const watchlistDeleteAllBtn = document.getElementById('watchlist-delete-all');
      const bulkDeleteStatus = document.getElementById('bulk-delete-status');
      // Portfolio Elements
      const getSuggestionBtn = document.getElementById('get-suggestion-btn');
      const portfolioResult = document.getElementById('portfolio-result');
      const portfolioSuggestion = document.getElementById('portfolio-suggestion');
      const suggestedPortfoliosContainer = document.getElementById('suggested-portfolios-container');
      const suggestedPortfoliosList = document.getElementById('suggested-portfolios-list');
      const addWatchlistStatus = document.getElementById('add-watchlist-status');
      // News Elements
      const newsListElement = document.getElementById('news-list');
      const marketSummaryElement = document.getElementById('market-summary');
      const indexListElement = document.getElementById('index-list');
      const sentimentIndicator = document.getElementById('sentiment-indicator');
      const sentimentText = document.getElementById('sentiment-text');
      const marketSummaryMarket = document.getElementById('market-summary-market');
      // Settings Modal Elements
      const settingsModalElement = document.getElementById('settings-modal');
      const fontSizeSelect = document.getElementById('font-size');
      const marketSummarySettingSwitch = document.getElementById('market-summary-setting');
      const saveSettingsBtn = document.getElementById('save-settings');
      const initialWelcomeMessageTime = document.querySelector('.message-time');

      // --- State Variables ---
      let currentMarket = 'TW';
      let currentView = 'chat';
      let isLoading = false;
      let currentSettings = {};

      // --- Bootstrap Modals ---
      const settingsModal = new bootstrap.Modal(settingsModalElement);
      const infoModal = new bootstrap.Modal(document.getElementById('info-modal'));

      // --- Marked.js Configuration ---
      marked.setOptions({ breaks: true, gfm: true });

      // --- Utility Functions ---
      function formatTime(date = new Date()) { return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`; }
      function formatNumber(value, options = {}) { const { decimals = 2, currency = null, isPercent = false, compact = false } = options; if (value === null || value === undefined || value === 'N/A' || isNaN(value)) return 'N/A'; try { let num = parseFloat(value); if (isPercent) { return `${num.toFixed(decimals)}%`; } let formatOptions = { minimumFractionDigits: decimals, maximumFractionDigits: decimals, }; let currencySymbol = ''; if (currency === 'TWD') currencySymbol = 'NT$'; else if (currency === 'USD') currencySymbol = '$'; let formattedValue; if (compact && Math.abs(num) >= 10000) { if (currency === 'TWD') { if (Math.abs(num) >= 1e12) formattedValue = `${(num / 1e12).toFixed(1)}兆`; else if (Math.abs(num) >= 1e8) formattedValue = `${(num / 1e8).toFixed(1)}億`; else if (Math.abs(num) >= 1e4) formattedValue = `${(num / 1e4).toFixed(1)}萬`; else formattedValue = num.toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); } else { if (Math.abs(num) >= 1e12) formattedValue = `${(num / 1e12).toFixed(1)}T`; else if (Math.abs(num) >= 1e9) formattedValue = `${(num / 1e9).toFixed(1)}B`; else if (Math.abs(num) >= 1e6) formattedValue = `${(num / 1e6).toFixed(1)}M`; else if (Math.abs(num) >= 1e3) formattedValue = `${(num / 1e3).toFixed(1)}K`; else formattedValue = num.toLocaleString('en-US', formatOptions); } return currencySymbol + formattedValue; } else { const locale = (currency === 'TWD') ? 'zh-TW' : 'en-US'; formattedValue = num.toLocaleString(locale, formatOptions); return currencySymbol + formattedValue; } } catch (e) { console.warn("Formatting Error:", e); return String(value); } }
      function formatPercentageSign(value) { if (value === null || value === undefined || value === 'N/A' || isNaN(value)) return 'N/A'; const num = parseFloat(value); const sign = num > 0 ? '+' : ''; return `${sign}${num.toFixed(2)}%`; }
      function escapeHtml(unsafe) { if (!unsafe) return ''; return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, "'").replace(/'/g, "'"); }

      // --- Chat Functions ---
      function addChatMessage(content, sender = 'assistant', type = 'text', data = null) { const timeString = formatTime(); const messageElement = document.createElement('div'); messageElement.className = `message message-${sender}`; let innerHTML = ''; switch (type) { case 'loading': innerHTML = `<div class="message-content"><div class="loading"></div> 處理中...</div>`; break; case 'error': messageElement.classList.add('message-error'); const errorMessage = (typeof content === 'string' ? content : '發生未知錯誤，請稍後再試。'); innerHTML = `<div class="message-content"><p><strong><i class="fas fa-exclamation-triangle"></i> 錯誤</strong></p><p>${marked.parse(errorMessage)}</p></div><div class="message-time">${timeString}</div>`; break; case 'stock': if (!data) { innerHTML = addChatMessage('無法顯示股票資訊 (資料錯誤)', 'assistant', 'error'); } else { const stockData = data; const priceChangeClass = stockData.price_change_value >= 0 ? 'price-positive' : 'price-negative'; const chartSrc = stockData.chart_path ? `/${stockData.chart_path}` : ''; const currency = stockData.currency || (stockData.ticker && stockData.ticker.endsWith('.TW') ? 'TWD' : 'USD'); const formattedPE = formatNumber(stockData.pe_ratio); const formattedEPS = formatNumber(stockData.eps, { currency: currency }); const formattedROE = stockData.roe_display || formatNumber(stockData.roe, { isPercent: true }); const formattedRSI = formatNumber(stockData.rsi); const formattedK = formatNumber(stockData.k); const formattedD = formatNumber(stockData.d); const formattedPrice = formatNumber(stockData.current_price, { currency: currency }); const formattedMktCap = formatNumber(stockData.market_cap, { currency: currency, compact: true }); innerHTML = `<div class="message-content"><p>以下是 <strong>${stockData.company_name || 'N/A'}</strong> (${stockData.ticker || 'N/A'}) 的分析：</p><div class="stock-card"><div class="stock-card-header"><h4>${stockData.company_name || 'N/A'}</h4><span class="stock-price ${priceChangeClass}">${formattedPrice} (${stockData.price_change || '0.00%'})</span></div><div class="stock-info"><p><strong>市值:</strong> ${formattedMktCap} | <strong>P/E:</strong> ${formattedPE} | <strong>EPS:</strong> ${formattedEPS} | <strong>ROE:</strong> ${formattedROE}</p><p><strong>技術指標:</strong> RSI: ${formattedRSI} | K: ${formattedK} | D: ${formattedD}</p><p><strong>技術形態:</strong> ${stockData.patterns && stockData.patterns.length > 0 ? stockData.patterns.join(', ') : '無'}</p></div>${chartSrc ? `<div class="stock-chart-container"><iframe src="${chartSrc}" loading="lazy" title="${stockData.company_name} Chart"></iframe></div>` : '<p class="text-center my-3 text-warning">無法載入圖表</p>'}<div class="stock-analysis"><h5><i class="fas fa-brain"></i> AI 分析</h5><div class="ai-analysis-content">${marked.parse(stockData.analysis || '<p class="text-warning">無法載入分析內容</p>')}</div></div></div></div><div class="message-time">${timeString}</div>`; } break; case 'text': default: const parsedContent = (sender === 'assistant') ? marked.parse(content || '') : escapeHtml(content); innerHTML = `<div class="message-content">${parsedContent}</div><div class="message-time">${timeString}</div>`; break; } messageElement.innerHTML = innerHTML; chatMessages.appendChild(messageElement); chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' }); return messageElement; }
      function sendMessage() { const message = chatInput.value.trim(); if (!message || isLoading) return; isLoading = true; chatSendBtn.disabled = true; chatSendBtn.innerHTML = '<span class="loading loading-inline"></span>'; addChatMessage(message, 'user', 'text'); chatInput.value = ''; const loadingElement = addChatMessage('', 'assistant', 'loading'); fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ message: message, market: currentMarket }), }).then(response => { if (!response.ok) { return response.json().then(err => { throw new Error(err.error || `伺服器錯誤: ${response.statusText} (${response.status})`); }).catch(() => { throw new Error(`伺服器錯誤: ${response.statusText} (${response.status})`); }); } return response.json(); }).then(data => { chatMessages.removeChild(loadingElement); if (data.success) { addChatMessage(data.data, 'assistant', data.type, data.data); } else { addChatMessage(data.error || '收到來自伺服器的未知錯誤。', 'assistant', 'error'); } }).catch(error => { console.error('Chat API Error:', error); chatMessages.removeChild(loadingElement); addChatMessage(error.message || '請求失敗，請檢查網路連線或稍後再試。', 'assistant', 'error'); }).finally(() => { isLoading = false; chatSendBtn.disabled = false; chatSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>'; }); }

      // --- Stock Chip Functions ---
      function updateStockChips(market) { stockChipsContainer.innerHTML = ''; const stocks = market === 'TW' ? [ { ticker: '2330.TW', name: '台積電' }, { ticker: '2317.TW', name: '鴻海' }, { ticker: '2454.TW', name: '聯發科' }, { ticker: '0050.TW', name: '台灣50' }, { ticker: '2603.TW', name: '長榮' }, { ticker: '2002.TW', name: '中鋼' }, { ticker: '2881.TW', name: '富邦金' }, { ticker: '1301.TW', name: '台塑' } ] : [ { ticker: 'AAPL', name: 'Apple' }, { ticker: 'MSFT', name: 'Microsoft' }, { ticker: 'GOOGL', name: 'Google' }, { ticker: 'AMZN', name: 'Amazon' }, { ticker: 'NVDA', name: 'NVIDIA' }, { ticker: 'TSLA', name: 'Tesla' }, { ticker: 'META', name: 'Meta' }, { ticker: 'SPY', name: 'S&P 500 ETF' } ]; stocks.forEach(stock => { const chip = document.createElement('div'); chip.className = 'stock-chip'; chip.dataset.ticker = stock.ticker; chip.textContent = stock.name; chip.addEventListener('click', () => handleStockChipClick(stock.ticker)); stockChipsContainer.appendChild(chip); }); }
      function handleStockChipClick(ticker) { chatInput.value = `#${ticker}`; sendMessage(); switchView('chat'); }

      // --- View Switching ---
      function switchView(viewId) { if (currentView === viewId) return; currentView = viewId; Object.keys(sections).forEach(key => { const isTarget = key === viewId; sections[key].style.display = isTarget ? (key === 'chat' ? 'flex' : 'block') : 'none'; sections[key].classList.toggle('active', isTarget); }); Object.keys(navButtons).forEach(key => { navButtons[key].classList.toggle('active', key === viewId); }); if (viewId === 'watchlist') loadWatchlist(); if (viewId === 'news') { loadMarketNews(currentMarket); loadMarketSummary(currentMarket); } if (viewId === 'portfolio') { portfolioResult.style.display = 'none'; portfolioSuggestion.innerHTML = '<p class="text-secondary">點擊上方按鈕以獲取建議。</p>'; suggestedPortfoliosContainer.style.display = 'none'; suggestedPortfoliosList.innerHTML = ''; addWatchlistStatus.textContent = ''; } }

      // --- Watchlist Functions (Modified v4 - Grouping Display) ---
      function loadWatchlist() {
          watchlistItems.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="loading d-inline-block me-2"></div> 載入中...</td></tr>`;
          watchlistBulkActionsBar.style.display = 'none';
          watchlistSelectAll.checked = false;
          watchlistDeleteSelectedBtn.disabled = true;
          bulkDeleteStatus.textContent = '';

          fetch('/api/watchlist')
              .then(response => { if (!response.ok) { return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`); }).catch(() => { throw new Error(`HTTP error! status: ${response.status}`); }); } return response.json(); })
              .then(data => {
                  watchlistItems.innerHTML = '';
                  if (data.grouped_watchlist && data.grouped_watchlist.length > 0) {
                      watchlistBulkActionsBar.style.display = 'flex';
                      data.grouped_watchlist.forEach(group => {
                          const headerRow = document.createElement('tr');
                          headerRow.className = 'watchlist-group-header';
                          headerRow.innerHTML = `<td colspan="5">${escapeHtml(group.name)}</td>`;
                          watchlistItems.appendChild(headerRow);

                          if (group.items && group.items.length > 0) {
                              group.items.forEach(item => {
                                  const priceChangeClass = item.change >= 0 ? 'price-positive' : 'price-negative';
                                  const currency = item.ticker.includes('.TW') ? 'TWD' : 'USD';
                                  const row = document.createElement('tr');
                                  row.className = `watchlist-item`;
                                  row.dataset.ticker = item.ticker;
                                  row.innerHTML = `
                                      <td class="checkbox-col"><input class="form-check-input watchlist-select-item" type="checkbox" value="${item.ticker}" id="select-${item.ticker}"></td>
                                      <td class="stock-info-cell"><div class="stock-name">${item.name || item.ticker}</div><div class="stock-ticker">${item.ticker}</div></td>
                                      <td class="stock-info-cell">${item.error ? '<span class="text-danger">錯誤</span>' : formatNumber(item.price, { currency: currency, decimals: 2 })}</td>
                                      <td class="stock-info-cell ${priceChangeClass}">${item.error ? 'N/A' : formatPercentageSign(item.change)}</td>
                                      <td class="watchlist-actions">
                                          <button class="view-btn" title="查看詳情"><i class="fas fa-chart-line"></i></button>
                                          <button class="remove-btn" title="移除"><i class="fas fa-trash"></i></button>
                                      </td>
                                  `;
                                  row.querySelector('.view-btn').addEventListener('click', (e) => { e.stopPropagation(); handleStockChipClick(item.ticker); });
                                  row.querySelector('.remove-btn').addEventListener('click', (e) => { e.stopPropagation(); removeFromWatchlist(item.ticker, item.name); });
                                  row.querySelectorAll('.stock-info-cell').forEach(cell => { cell.addEventListener('click', () => handleStockChipClick(item.ticker)); });
                                  row.querySelector('.watchlist-select-item').addEventListener('change', updateBulkActionState);
                                  watchlistItems.appendChild(row);
                              });
                          } else {
                              const emptyRow = document.createElement('tr');
                              emptyRow.innerHTML = `<td colspan="5" class="text-center text-secondary py-2">此組合無項目</td>`;
                              watchlistItems.appendChild(emptyRow);
                          }
                      });
                      updateBulkActionState();
                  } else {
                      watchlistItems.innerHTML = '<tr><td colspan="5" class="text-center py-4">追蹤清單目前是空的。</td></tr>';
                      watchlistBulkActionsBar.style.display = 'none';
                  }
              })
              .catch(error => {
                  console.error('Load Watchlist Error:', error);
                  watchlistItems.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">無法載入追蹤清單：${error.message}</td></tr>`;
                  watchlistBulkActionsBar.style.display = 'none';
              });
      }

      function addToWatchlist(event) {
          event.preventDefault();
          let ticker = stockTickerInput.value.trim();
          if (!ticker) { alert('請輸入股票代碼'); return; }
          // Auto-append .TW for potential Taiwan stocks
          if (!ticker.includes('.') && /^\d{4,6}$/.test(ticker)) {
              console.log(`Auto-appending .TW to ${ticker}`);
              ticker = `${ticker}.TW`;
          }
          const addButton = addStockForm.querySelector('button[type="submit"]');
          const originalHtml = addButton.innerHTML;
          addButton.disabled = true;
          addButton.innerHTML = '<span class="loading loading-inline"></span> 加入中';
          fetch('/api/watchlist/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ticker: ticker, portfolio_name: null }), }).then(response => response.json()).then(data => { if (data.success) { stockTickerInput.value = ''; loadWatchlist(); } else { alert('加入失敗：' + (data.error || '未知錯誤')); } }).catch(error => { console.error('Add Watchlist Error:', error); alert('加入追蹤清單時發生錯誤'); }).finally(() => { addButton.disabled = false; addButton.innerHTML = originalHtml; });
      }
      function removeFromWatchlist(ticker, name) { const confirmName = name || ticker; if (!confirm(`確定要從追蹤清單移除 ${confirmName} (${ticker}) 嗎？`)) return; const row = watchlistItems.querySelector(`tr[data-ticker="${ticker}"]`); if (row) { row.style.opacity = '0.5'; } fetch('/api/watchlist/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ticker }), }).then(response => response.json()).then(data => { if (data.success) { loadWatchlist(); } else { alert('移除失敗：' + (data.error || '未知錯誤')); if (row) { row.style.opacity = '1'; } } }).catch(error => { console.error('Remove Watchlist Error:', error); alert('移除時發生錯誤'); if (row) { row.style.opacity = '1'; } }); }
      function updateBulkActionState() { const allCheckboxes = watchlistItems.querySelectorAll('.watchlist-select-item'); const checkedCheckboxes = watchlistItems.querySelectorAll('.watchlist-select-item:checked'); const totalCount = allCheckboxes.length; const checkedCount = checkedCheckboxes.length; if (totalCount === 0) { watchlistBulkActionsBar.style.display = 'none'; return; } watchlistBulkActionsBar.style.display = 'flex'; watchlistDeleteSelectedBtn.disabled = checkedCount === 0; if (checkedCount === 0) { watchlistSelectAll.checked = false; watchlistSelectAll.indeterminate = false; } else if (checkedCount === totalCount) { watchlistSelectAll.checked = true; watchlistSelectAll.indeterminate = false; } else { watchlistSelectAll.checked = false; watchlistSelectAll.indeterminate = true; } }
      function handleSelectAllChange() { const isChecked = watchlistSelectAll.checked; watchlistItems.querySelectorAll('.watchlist-select-item').forEach(checkbox => { checkbox.checked = isChecked; }); updateBulkActionState(); }
      function handleDeleteSelected() { const checkedCheckboxes = watchlistItems.querySelectorAll('.watchlist-select-item:checked'); const tickersToRemove = Array.from(checkedCheckboxes).map(cb => cb.value); if (tickersToRemove.length === 0) { bulkDeleteStatus.textContent = '請先勾選要刪除的項目。'; bulkDeleteStatus.className = 'mb-3 text-warning'; return; } if (!confirm(`確定要刪除選中的 ${tickersToRemove.length} 個追蹤項目嗎？`)) { return; } const originalHtml = watchlistDeleteSelectedBtn.innerHTML; watchlistDeleteSelectedBtn.disabled = true; watchlistDeleteSelectedBtn.innerHTML = `<span class="loading loading-inline"></span> 刪除中...`; bulkDeleteStatus.textContent = '處理中...'; bulkDeleteStatus.className = 'mb-3 text-secondary'; const deletePromises = tickersToRemove.map(ticker => fetch('/api/watchlist/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ticker }), }).then(response => response.json()).then(data => ({ ticker, success: data.success, message: data.message || data.error })).catch(error => ({ ticker, success: false, message: `請求錯誤: ${error}` })) ); Promise.all(deletePromises).then(results => { let successCount = 0; let errorCount = 0; results.forEach(res => { if (res.success) { successCount++; } else { errorCount++; console.error(`刪除 ${res.ticker} 失敗: ${res.message}`); } }); let statusMessage = `處理 ${tickersToRemove.length} 項：`; if (successCount > 0) statusMessage += `成功刪除 ${successCount} 項。`; if (errorCount > 0) statusMessage += ` ${errorCount} 項刪除失敗。`; bulkDeleteStatus.textContent = statusMessage.trim(); bulkDeleteStatus.className = `mb-3 ${errorCount > 0 ? 'text-danger' : 'text-success'}`; loadWatchlist(); }).finally(() => { watchlistDeleteSelectedBtn.innerHTML = originalHtml; }); }
      function handleDeleteAll() { const totalItems = watchlistItems.querySelectorAll('.watchlist-select-item').length; if (totalItems === 0) { bulkDeleteStatus.textContent = '追蹤清單已是空的。'; bulkDeleteStatus.className = 'mb-3 text-info'; return; } if (!confirm(`⚠️ 確定要刪除全部 ${totalItems} 個追蹤項目嗎？此操作無法復原！`)) { return; } const originalHtml = watchlistDeleteAllBtn.innerHTML; watchlistDeleteAllBtn.disabled = true; watchlistDeleteAllBtn.innerHTML = `<span class="loading loading-inline"></span> 清空中...`; bulkDeleteStatus.textContent = '處理中...'; bulkDeleteStatus.className = 'mb-3 text-secondary'; fetch('/api/watchlist/clear', { method: 'POST' }).then(response => response.json()).then(data => { if (data.success) { bulkDeleteStatus.textContent = data.message || '追蹤清單已清空。'; bulkDeleteStatus.className = 'mb-3 text-success'; loadWatchlist(); } else { bulkDeleteStatus.textContent = `清空失敗：${data.error || '未知錯誤'}`; bulkDeleteStatus.className = 'mb-3 text-danger'; } }).catch(error => { console.error('Clear Watchlist Error:', error); bulkDeleteStatus.textContent = '清空追蹤清單時發生網路錯誤。'; bulkDeleteStatus.className = 'mb-3 text-danger'; }).finally(() => { watchlistDeleteAllBtn.innerHTML = originalHtml; watchlistDeleteAllBtn.disabled = false; }); }

      // --- Portfolio Suggestion Functions (Modified v4) ---
      function fetchPortfolioSuggestion() { const originalHtml = getSuggestionBtn.innerHTML; getSuggestionBtn.innerHTML = '<span class="loading loading-inline"></span> 獲取建議中...'; getSuggestionBtn.disabled = true; portfolioResult.style.display = 'none'; portfolioSuggestion.innerHTML = ''; suggestedPortfoliosContainer.style.display = 'none'; suggestedPortfoliosList.innerHTML = ''; addWatchlistStatus.textContent = ''; fetch('/api/portfolio_suggestion').then(response => response.ok ? response.json() : response.json().then(err => Promise.reject(err.error || '獲取建議失敗'))).then(data => { portfolioResult.style.display = 'block'; if (data.success) { portfolioSuggestion.innerHTML = marked.parse(data.suggestion_text || '<p class="text-warning">無法載入建議文字</p>'); displaySuggestedPortfolios(data.suggested_portfolios || []); } else { portfolioSuggestion.innerHTML = `<div class="alert alert-danger">無法獲取建議：${data.error || '未知錯誤'}</div>`; suggestedPortfoliosContainer.style.display = 'none'; } }).catch(error => { console.error('Fetch Portfolio Suggestion Error:', error); portfolioSuggestion.innerHTML = `<div class="alert alert-danger">請求投資組合建議時發生錯誤: ${error}</div>`; portfolioResult.style.display = 'block'; suggestedPortfoliosContainer.style.display = 'none'; }).finally(() => { getSuggestionBtn.innerHTML = originalHtml; getSuggestionBtn.disabled = false; }); }
      function displaySuggestedPortfolios(portfolios) { suggestedPortfoliosList.innerHTML = ''; if (portfolios && portfolios.length > 0) { portfolios.forEach((portfolio, index) => { const card = document.createElement('div'); card.className = 'suggested-portfolio-card'; const tickersString = portfolio.tickers.join(', '); let allocationString = '未提供分配建議'; if (portfolio.allocations && Object.keys(portfolio.allocations).length > 0) { allocationString = Object.entries(portfolio.allocations).map(([ticker, percent]) => `${escapeHtml(ticker)}: ${percent}%`).join(', '); } card.innerHTML = `<h5>${escapeHtml(portfolio.name) || `建議組合 ${index + 1}`}</h5><p class="tickers-list"><strong>包含股票:</strong> ${escapeHtml(tickersString)}</p><p class="allocations-list"><strong>建議分配:</strong> ${allocationString}</p><button class="btn btn-sm add-portfolio-btn"><i class="fas fa-plus"></i> 將此組合加入追蹤</button>`; const addButton = card.querySelector('.add-portfolio-btn'); addButton.dataset.tickers = JSON.stringify(portfolio.tickers); addButton.dataset.portfolioName = portfolio.name || `建議組合 ${index + 1}`; addButton.addEventListener('click', handleAddPortfolioClick); suggestedPortfoliosList.appendChild(card); }); suggestedPortfoliosContainer.style.display = 'block'; } else { suggestedPortfoliosList.innerHTML = '<p class="text-secondary">AI 未能提供明確的組合選項，請參考上方建議全文。</p>'; suggestedPortfoliosContainer.style.display = 'block'; } }
      function handleAddPortfolioClick(event) { const button = event.currentTarget; const tickersJson = button.dataset.tickers; const portfolioName = button.dataset.portfolioName; if (!tickersJson || !portfolioName) { addWatchlistStatus.textContent = '錯誤：找不到要加入的股票列表或組合名稱。'; addWatchlistStatus.className = 'mt-3 text-danger'; return; } try { const tickersToAdd = JSON.parse(tickersJson); if (!Array.isArray(tickersToAdd) || tickersToAdd.length === 0) { throw new Error("無效的股票列表"); } addPortfolioToWatchlist(tickersToAdd, portfolioName, button); } catch (e) { console.error("解析股票列表錯誤:", e); addWatchlistStatus.textContent = '錯誤：解析股票列表失敗。'; addWatchlistStatus.className = 'mt-3 text-danger'; } }
      function addPortfolioToWatchlist(tickersToAdd, portfolioName, buttonElement) { const originalHtml = buttonElement.innerHTML; buttonElement.disabled = true; buttonElement.innerHTML = `<span class="loading loading-inline"></span> 加入中...`; addWatchlistStatus.textContent = `正在將 "${escapeHtml(portfolioName)}" 加入追蹤清單...`; addWatchlistStatus.className = 'mt-3 text-secondary'; document.querySelectorAll('.add-portfolio-btn').forEach(btn => btn.disabled = true); const addPromises = tickersToAdd.map(ticker => fetch('/api/watchlist/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ticker: ticker, portfolio_name: portfolioName }), }).then(response => response.json()).then(data => ({ ticker, success: data.success, added: data.added, message: data.message || data.error })).catch(error => ({ ticker, success: false, added: false, message: `請求錯誤: ${error}` })) ); Promise.all(addPromises).then(results => { let successCount = 0; let alreadyExistsCount = 0; let errorCount = 0; results.forEach(res => { if (res.success) { successCount++; if (!res.added) { alreadyExistsCount++; } } else { errorCount++; console.error(`加入 ${res.ticker} 失敗: ${res.message}`); } }); let statusMessage = `處理組合 "${escapeHtml(portfolioName)}" (${tickersToAdd.length} 項)：`; if (successCount > 0) statusMessage += `成功加入/更新 ${successCount} 項。`; if (errorCount > 0) statusMessage += ` ${errorCount} 項加入失敗。`; addWatchlistStatus.textContent = statusMessage.trim(); addWatchlistStatus.className = `mt-3 ${errorCount > 0 ? 'text-danger' : 'text-success'}`; if (currentView === 'watchlist') { loadWatchlist(); } }).finally(() => { document.querySelectorAll('.add-portfolio-btn').forEach(btn => { if (btn === buttonElement) { btn.innerHTML = originalHtml; } btn.disabled = false; }); }); }

      // --- News & Market Summary Functions ---
      function loadMarketNews(market) { newsListElement.innerHTML = `<div class="news-item"><div class="news-title"><div class="loading d-inline-block me-2"></div> 載入新聞中...</div></div>`; fetch(`/api/market_news?market=${market}`).then(response => response.ok ? response.json() : Promise.reject('Failed to load news')).then(data => { newsListElement.innerHTML = ''; if (data.news && data.news.length > 0) { data.news.forEach(item => { const sentimentClass = `sentiment-${item.sentiment || 'Neutral'}`; const newsItem = document.createElement('div'); newsItem.className = 'news-item'; newsItem.innerHTML = `<div class="news-title">${item.title}</div><div class="news-meta"><span><i class="fas fa-calendar-alt fa-xs"></i> ${item.date || 'N/A'}</span><span><i class="fas fa-building fa-xs"></i> ${item.source || 'N/A'}</span><span class="news-sentiment ${sentimentClass}">${item.sentiment || 'Neutral'}</span></div><div class="news-summary">${item.summary || ''}</div>`; newsItem.addEventListener('click', () => window.open(item.link, '_blank', 'noopener noreferrer')); newsListElement.appendChild(newsItem); }); } else { newsListElement.innerHTML = '<div class="news-item"><div class="news-title text-secondary">目前沒有相關新聞。</div></div>'; } }).catch(error => { console.error('Load News Error:', error); newsListElement.innerHTML = '<div class="news-item"><div class="news-title text-danger">無法載入新聞，請稍後再試。</div></div>'; }); }
      function loadMarketSummary(market) { indexListElement.innerHTML = `<div class="index-item"><div class="index-name"><div class="loading d-inline-block me-2"></div> 載入指數...</div></div>`; marketSummaryMarket.textContent = market === 'TW' ? '台股' : '美股'; sentimentText.textContent = '市場情緒: 載入中...'; sentimentIndicator.className = 'sentiment-indicator'; marketSummaryElement.style.display = currentSettings.market_summary ? 'block' : 'none'; if (!currentSettings.market_summary) return; fetch(`/api/market_summary?market=${market}`).then(response => response.ok ? response.json() : Promise.reject('Failed to load summary')).then(data => { indexListElement.innerHTML = ''; if (data.indices && data.indices.length > 0) { data.indices.forEach(item => { const priceChangeClass = item.change >= 0 ? 'price-positive' : 'price-negative'; const currency = item.symbol.includes('.TW') || item.symbol === '^TWII' ? 'TWD' : (item.symbol === '^VIX' ? null : 'USD'); const indexItem = document.createElement('div'); indexItem.className = `index-item ${item.error ? 'border border-danger' : ''}`; indexItem.innerHTML = `<div class="index-name">${item.name || item.symbol}</div><div class="index-price ${priceChangeClass}">${item.error ? '<span class="text-danger">錯誤</span>' : formatNumber(item.price, { currency: null, decimals: item.symbol === '^VIX' ? 2 : 2 })}</div><div class="${priceChangeClass}">${item.error ? 'N/A' : formatPercentageSign(item.change)}</div>`; indexListElement.appendChild(indexItem); }); } else { indexListElement.innerHTML = '<div class="index-item"><div class="index-name text-warning">無法載入指數數據</div></div>'; } const sentimentBackend = data.sentiment || '未知'; sentimentIndicator.className = `sentiment-indicator sentiment-${sentimentBackend}`; sentimentText.textContent = `市場情緒: ${sentimentBackend}`; }).catch(error => { console.error('Load Market Summary Error:', error); indexListElement.innerHTML = '<div class="index-item"><div class="index-name text-danger">無法載入指數</div></div>'; sentimentText.textContent = '市場情緒: 未知'; }); }

      // --- Settings Functions ---
      function loadAndApplySettings() { fetch('/api/settings').then(response => response.ok ? response.json() : Promise.reject('Failed to load settings')).then(data => { if (data.settings) { currentSettings = data.settings; applySettings(currentSettings); fontSizeSelect.value = currentSettings.font_size || 'medium'; marketSummarySettingSwitch.checked = currentSettings.market_summary !== undefined ? currentSettings.market_summary : true; } else { console.warn("No settings found in response, using defaults."); applyDefaultsAndUI(); } }).catch(error => { console.error('Load Settings Error:', error); alert('無法載入設定，將使用預設值。'); applyDefaultsAndUI(); }); }
      function applyDefaultsAndUI() { currentSettings = { dark_mode: true, font_size: 'medium', price_alert: false, market_summary: true, data_source: 'default' }; applySettings(currentSettings); fontSizeSelect.value = currentSettings.font_size; marketSummarySettingSwitch.checked = currentSettings.market_summary; }
      function applySettings(settings) { let fontSize = '16px'; if (settings.font_size === 'small') fontSize = '14px'; else if (settings.font_size === 'large') fontSize = '18px'; document.documentElement.style.fontSize = fontSize; if (marketSummaryElement) { marketSummaryElement.style.display = settings.market_summary ? 'block' : 'none'; if (currentView === 'news' && marketSummaryElement.style.display === 'block') { loadMarketSummary(currentMarket); } } }
      function saveSettings() { const settingsToSave = { font_size: fontSizeSelect.value, market_summary: marketSummarySettingSwitch.checked, dark_mode: currentSettings.dark_mode !== undefined ? currentSettings.dark_mode : true, price_alert: currentSettings.price_alert !== undefined ? currentSettings.price_alert : false, data_source: currentSettings.data_source || 'default' }; const originalHtml = saveSettingsBtn.innerHTML; saveSettingsBtn.disabled = true; saveSettingsBtn.innerHTML = '<span class="loading loading-inline"></span> 儲存中'; fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settingsToSave), }).then(response => response.json()).then(data => { if (data.success) { settingsModal.hide(); currentSettings = settingsToSave; applySettings(currentSettings); } else { let errorMsg = '儲存設定失敗'; if (data.error && typeof data.error === 'string') { errorMsg += `：${data.error}`; } else if (data.details) { errorMsg += `：${JSON.stringify(data.details)}`; } alert(errorMsg); } }).catch(error => { console.error('Save Settings Error:', error); alert('儲存設定時發生網路錯誤。'); }).finally(() => { saveSettingsBtn.disabled = false; saveSettingsBtn.innerHTML = originalHtml; }); }

      // --- Event Listeners ---
      marketToggle.addEventListener('change', function() { currentMarket = this.checked ? 'US' : 'TW'; updateStockChips(currentMarket); if (currentView === 'news') { loadMarketNews(currentMarket); loadMarketSummary(currentMarket); } });
      chatSendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
      chatInput.addEventListener('input', () => { chatSendBtn.disabled = chatInput.value.trim() === ''; });
      Object.keys(navButtons).forEach(key => { navButtons[key].addEventListener('click', () => switchView(key)); });
      settingsBtn.addEventListener('click', () => settingsModal.show());
      infoBtn.addEventListener('click', () => infoModal.show());
      saveSettingsBtn.addEventListener('click', saveSettings);
      addStockForm.addEventListener('submit', addToWatchlist);
      getSuggestionBtn.addEventListener('click', fetchPortfolioSuggestion);
      watchlistSelectAll.addEventListener('change', handleSelectAllChange);
      watchlistDeleteSelectedBtn.addEventListener('click', handleDeleteSelected);
      watchlistDeleteAllBtn.addEventListener('click', handleDeleteAll);

      // --- Initialization ---
      function init() { if(initialWelcomeMessageTime) { initialWelcomeMessageTime.textContent = formatTime(); } updateStockChips(currentMarket); loadAndApplySettings(); switchView('chat'); chatSendBtn.disabled = chatInput.value.trim() === ''; }
      init();
    });
  </script>
</body>
</html>