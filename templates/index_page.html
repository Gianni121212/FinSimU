<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™ºèƒ½æŠ•è³‡ç¾…ç›¤</title>

    <meta name="theme-color" content="#1a202c"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #1a202c;
            --card-bg: rgba(23, 25, 35, 0.6);
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --accent-color: #00B5D8;
            --accent-gradient: linear-gradient(45deg, #00B5D8, #764ba2);
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(0,0,0,0.2);
            --success-color: #38A169;
            --error-color: #E53E3E;
            --positive-text: #48bb78;
            --negative-text: #f56565;
            --hint-color: #3182ce;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans TC', 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding-bottom: 0;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(315deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.3) 50%, rgba(0, 181, 216, 0.2) 100%);
            background-size: 200% 200%;
            animation: gradient-animation 15s ease infinite;
            z-index: -1;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            padding: 16px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .page-header-sticky-wrapper {
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-shrink: 0;
        }

        .page-header {
            background: rgba(26, 32, 44, 0.95);
            padding-top: calc(12px + env(safe-area-inset-top));
            padding-top: calc(12px + constant(safe-area-inset-top));
            padding-left: 16px;
            padding-right: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h1 { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .header-actions a {
            font-size: 0.8rem;
            color: var(--text-primary);
            text-decoration: none;
            background-color: var(--input-bg);
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .header-actions a:hover { background-color: rgba(0,0,0,0.4); }

        .page-view { display: none; animation: fadeIn 0.5s ease-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bottom-nav {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding-bottom: env(safe-area-inset-bottom);
            padding-bottom: constant(safe-area-inset-bottom);
            height: calc(70px + env(safe-area-inset-bottom));
            height: calc(70px + constant(safe-area-inset-bottom));
            flex-shrink: 0;
        }
        .nav-button {
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; font-size: 0.7rem; color: var(--text-secondary);
            background: none; border: none; cursor: pointer;
            padding: 8px; border-radius: 8px; width: 80px;
            transition: color 0.2s;
        }
        .nav-button-icon { font-size: 1.4rem; }
        .nav-button.active { color: var(--accent-color); }

        .card {
            background: var(--card-bg); padding: 20px;
            border-radius: 16px; margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .card-header { 
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .card-header p { font-size: 0.85rem; color: var(--text-secondary); }
        
        .help-icon {
            width: 24px; height: 24px;
            background-color: var(--input-bg);
            border-radius: 50%; border: 1px solid var(--border-color);
            display: flex; justify-content: center; align-items: center;
            color: var(--text-secondary); font-weight: bold; cursor: pointer;
            font-size: 1rem; margin-left: 10px; flex-shrink: 0;
            transition: background-color 0.2s, color 0.2s;
        }
        .help-icon:hover { background-color: var(--accent-color); color: white; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 14px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; color: var(--text-primary);
            background-color: var(--input-bg);
            transition: all 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 181, 216, 0.3);
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            background: var(--accent-gradient); color: white;
            transition: all 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0, 181, 216, 0.25); }
        .btn:active { transform: translateY(0); box-shadow: none; }
        .btn:disabled { background: #4a5568; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .batch-actions-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
        }
        .btn-secondary:not(:disabled):hover {
            background: var(--input-bg);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }
        .btn-delete-batch {
            border-color: var(--error-color);
            color: var(--error-color);
        }
        .btn-delete-batch:not(:disabled):hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        /* === MODIFIED: Simplified Weight Control Styles === */
        .weight-control-group {
            margin-bottom: 16px;
        }
        .weight-control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .weight-control-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .weight-control-inputs input[type="range"] {
            flex-grow: 1;
        }
        .weight-control-inputs input[type="number"] {
            width: 70px;
            padding: 8px; /* Reduced padding */
            text-align: center;
            font-size: 0.9rem; /* Smaller font */
            background-color: var(--input-bg); /* Match other inputs */
            border: 1px solid var(--border-color); /* Match other inputs */
            border-radius: 6px; /* Match other inputs */
            color: var(--text-primary); /* Match other inputs */
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .weight-control-inputs input[type="number"]::-webkit-outer-spin-button,
        .weight-control-inputs input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }
        .weight-control-inputs input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 181, 216, 0.3);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #2d3748; border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 18px; width: 18px; border-radius: 50%; background: var(--accent-color); cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            margin-top: -6px; box-shadow: 0 0 10px rgba(0, 181, 216, 0.5);
        }
        #weight_total { color: var(--text-secondary); font-weight: 500; text-align: center; margin-top: 10px; }

        .loading { text-align: center; padding: 40px 0; display: none; }
        .spinner { width: 36px; height: 36px; border: 4px solid var(--input-bg); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loading p { font-size: 0.9rem; color: var(--text-secondary); }

        .progress-container { display: none; text-align: center; margin-top: 20px; }
        .progress-bar-wrapper {
            background-color: var(--input-bg);
            border-radius: 8px; padding: 4px; border: 1px solid var(--border-color); margin-bottom: 8px;
        }
        .progress-bar {
            width: 0%; height: 10px; background: var(--accent-gradient);
            border-radius: 4px; transition: width 0.4s ease-out;
        }
        #progress-text { font-size: 0.9rem; color: var(--text-secondary); }

        .result-card { 
            background: var(--card-bg); border-radius: 12px; margin-bottom: 20px; 
            border: 1px solid var(--border-color); backdrop-filter: blur(10px);
        }
        .result-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .result-header h3 { font-size: 1.1rem; font-weight: 600; color: var(--accent-color); }
        .result-body { padding: 16px; }
        
        .data-list { list-style: none; }
        .data-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); }
        .data-list-item:last-child { border-bottom: none; }
        .data-list-item .label { color: var(--text-secondary); }
        .data-list-item .value { font-weight: 600; }
        .value.positive { color: var(--positive-text); } .value.negative { color: var(--negative-text); }
        
        .data-list-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 16px;
        }

        .description { background-color: var(--input-bg); padding: 12px; border-radius: 8px; margin-top: 16px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.8rem; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); }

        .chart-preview-container { border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; cursor: pointer; margin-top: 16px; background: rgba(0,0,0,0.2); }
        .chart-preview-image { width: 100%; border-radius: 4px; display: block; }
        
        .chart-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.85); 
            z-index: 2000; display: none; 
            flex-direction: column; 
            padding-top: env(safe-area-inset-top);
            padding-top: constant(safe-area-inset-top);
            box-sizing: border-box; 
            cursor: pointer;
        }
        .chart-modal-content { 
            width: 100%; height: 100%; 
            background-color: #fff; 
            overflow: hidden; 
            cursor: default;
        }
        .chart-modal-iframe { width: 100%; height: 100%; border: none; }
        .chart-modal-close { 
            position: absolute; 
            top: calc(10px + env(safe-area-inset-top));
            top: calc(10px + constant(safe-area-inset-top));
            right: 10px; 
            width: 32px; height: 32px; 
            background-color: rgba(0, 0, 0, 0.5); 
            border: none; border-radius: 50%; 
            font-size: 20px; font-weight: bold; color: #fff; 
            cursor: pointer; line-height: 32px; text-align: center; 
            z-index: 2001; 
        }

        /* === MODIFIED: Reverted to original Strategy Card styles === */
        .strategy-list { display: flex; flex-direction: column; gap: 16px; }
        .strategy-list-card { 
            background: var(--card-bg); border-radius: 12px; 
            border: 1px solid var(--border-color); backdrop-filter: blur(10px);
            border-left: 4px solid var(--accent-color); overflow: hidden; 
        }
        .strategy-list-header { padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .strategy-list-header-info { flex-grow: 1; }
        .strategy-list-header-info h3 { font-size: 1.2rem; font-weight: 600; }
        .strategy-list-header-info p { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
        .strategy-list-chevron { font-size: 1.5rem; color: var(--text-secondary); transition: transform 0.3s ease-in-out; }
        .strategy-list-header.expanded .strategy-list-chevron { transform: rotate(180deg); }
        .strategy-list-content { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in, padding 0.4s ease-in-out; padding: 0 16px; }
        .strategy-list-content.expanded { max-height: 600px; opacity: 1; padding: 16px; border-top: 1px solid var(--border-color); }
        .strategy-list-body { padding: 0; }
        .strategy-list-footer { padding-top: 16px; margin-top: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; justify-content: flex-end; }
        .strategy-list-footer button { padding: 8px 12px; font-size: 0.8rem; border-radius: 20px; border: 1px solid; cursor: pointer; background: transparent; transition: background-color 0.2s, color 0.2s; }
        .btn-backtest { border-color: var(--positive-text); color: var(--positive-text); }
        .btn-backtest:hover { background-color: var(--positive-text); color: white; }
        .btn-delete { border-color: var(--negative-text); color: var(--negative-text); }
        .btn-delete:hover { background-color: var(--negative-text); color: white; }
        .strategy-select-checkbox { transform: scale(1.5); margin-right: 16px; cursor: pointer; accent-color: var(--accent-color); }

        
        .message-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; border-left: 5px solid; }
        .error { background: rgba(229, 62, 62, 0.2); border-color: var(--error-color); color: #feb2b2; }
        .success { background: rgba(56, 161, 105, 0.2); border-color: var(--success-color); color: #9ae6b4; }
        .hint-bar { background: rgba(49, 130, 206, 0.2); border-color: var(--hint-color); color: #90cdf4; }

        .help-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; padding: 16px; animation: fadeInModal 0.3s ease-out; backdrop-filter: blur(5px); }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .help-modal-content { 
            background: var(--card-bg); color: var(--text-primary); 
            border-radius: 12px; padding: 24px; width: 100%; max-width: 500px; 
            max-height: 80vh; overflow-y: auto; position: relative; 
            border: 1px solid var(--border-color);
        }
        .help-modal-close { position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; line-height: 32px; border: none; background: var(--input-bg); border-radius: 50%; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; text-align: center; }
        #helpModalTitle { margin-bottom: 16px; color: var(--accent-color); }
        #helpModalBody .help-section { margin-bottom: 16px; }
        #helpModalBody h3 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border-color); }
        #helpModalBody p { font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); }
        #helpModalBody strong { color: var(--text-primary); font-weight: 600; }
        #helpModalBody ul { list-style-position: inside; padding-left: 8px; }
        #helpModalBody li { margin-bottom: 8px; }

        .allocator-selected-item {
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--input-bg); border-radius: 8px;
            padding: 10px 15px; margin-bottom: 8px; font-size: 0.95rem;
            border: 1px solid var(--border-color);
        }
        .remove-strategy-btn {
            background-color: rgba(239, 68, 68, 0.2); color: #ef4444;
            border: 1px solid rgba(254, 202, 202, 0.5); border-radius: 50%;
            width: 24px; height: 24px; font-weight: bold; cursor: pointer;
            line-height: 22px; text-align: center; transition: all 0.2s;
        }
        .remove-strategy-btn:hover { background-color: #ef4444; color: white; }

        #allocation-results .result-card { animation: fadeIn 0.5s ease-out; }
        
        .allocation-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .allocation-item-card {
            background-color: var(--card-bg); border-radius: 12px; padding: 16px;
            border: 1px solid var(--border-color);
            border-left: 5px solid; backdrop-filter: blur(10px);
        }
        .allocation-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }
        .allocation-item-header .ticker { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        .allocation-item-header .percentage { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }
        .allocator-result-bar-container { width: 100%; background-color: var(--input-bg); border-radius: 8px; margin: 4px 0; }
        .allocator-result-bar { height: 8px; border-radius: 8px; background: var(--accent-gradient); transition: width 0.8s ease-out; }
        .allocation-role {
            font-size: 0.8rem; font-weight: 500; padding: 4px 10px; border-radius: 16px;
            color: white; display: inline-flex; align-items: center; gap: 6px; margin-top: 4px;
        }
        .role-growth { background-color: #22c55e; }
        .role-satellite { background-color: #f59e0b; }
        .role-stable { background-color: #3b82f6; }

        .allocation-justification {
            font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin-top: 10px;
        }

        .signal-type-selector {
            display: flex; gap: 8px; margin-bottom: 16px; background-color: var(--input-bg);
            padding: 6px; border-radius: 25px; border: 1px solid var(--border-color);
        }
        .signal-type-selector label {
            flex-grow: 1; text-align: center; cursor: pointer; padding: 10px;
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
            color: var(--text-secondary);
        }
        .signal-type-selector input[type="radio"] { display: none; }
        .signal-type-selector input[type="radio"]:checked + label {
            background: var(--accent-color); color: white;
            font-weight: 600; box-shadow: 0 4px 12px rgba(0, 181, 216, 0.2);
        }
        #signals-grid { display: flex; flex-direction: column; gap: 16px; }
        .signal-card {
            background: var(--card-bg); border-radius: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px); overflow: hidden;
        }
        .signal-card-header {
            padding: 12px 16px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid var(--border-color);
        }
        .signal-card-header .ticker { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .signal-card-body { padding: 16px; font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); }
        .signal-price { font-weight: bold; margin-top: 10px; }
        .signal-buy { color: var(--positive-text); }
        .signal-sell { color: var(--negative-text); }
        .signal-card-footer {
            background-color: var(--input-bg); padding: 10px 16px; font-size: 0.8rem;
            color: var(--text-secondary); display: flex; justify-content: space-between;
            flex-wrap: wrap; gap: 8px; border-top: 1px solid var(--border-color);
        }
        .signal-card-footer .value { font-weight: 600; color: var(--text-primary); }

        #lookup-results-container {
            margin-top: 20px;
        }
        #lookup-results-container .loading {
            padding: 20px 0;
        }
        #lookup-results-container .result-card {
             animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>

    <div class="container" id="app-container">
        <div class="page-header-sticky-wrapper">
            <header class="page-header">
                <h1>ğŸ§¬ ç­–ç•¥è¨“ç·´å¹³å°</h1>
                <div class="header-actions">
                    <a href="javascript:void(0);" onclick="handleLogout()">ç™»å‡º</a>
                </div>
            </header>
        </div>

        <main>
            <div id="page-trainer" class="page-view active">
                <div class="card">
                    <div class="card-header">
                        <div><h2>ğŸ“ˆ åŸºæœ¬è¨­å®š</h2></div>
                        <span class="help-icon" onclick="showHelpModal('trainer')">?</span>
                    </div>
                    <div class="form-group"><label for="ticker">è‚¡ç¥¨ä»£è™Ÿ</label><input type="text" id="ticker" placeholder="ä¾‹ï¼šAAPL, 2330.TW"></div>
                    <div class="form-grid"><div class="form-group"><label for="start_date">é–‹å§‹æ—¥æœŸ</label><input type="date" id="start_date"></div><div class="form-group"><label for="end_date">çµæŸæ—¥æœŸ</label><input type="date" id="end_date"></div></div>
                    <div class="form-group"><label for="min_trades">æœ€å°‘äº¤æ˜“æ¬¡æ•¸ (1-20)</label><input type="number" id="min_trades" value="4" min="1" max="20" oninput="validateInput(this)"></div>
                </div>

                <div class="card">
                     <div class="card-header">
                        <div><h2>âš–ï¸ è¨“ç·´æ¬Šé‡è¨­å®š</h2></div>
                        <span class="help-icon" onclick="showHelpModal('weights')">?</span>
                     </div>
                     <div class="weight-control-group">
                        <label class="weight-control-label">ç¸½å ±é…¬ç‡</label>
                        <div class="weight-control-inputs">
                            <input type="range" id="total_return_weight" min="0" max="1" step="0.01" value="0.35" oninput="updateWeight('total_return', this.value)">
                            <input type="number" id="total_return_input" min="0" max="1" step="0.01" value="0.35" oninput="updateSlider('total_return', this.value)">
                        </div>
                    </div>
                    <div class="weight-control-group">
                        <label class="weight-control-label">å¹³å‡äº¤æ˜“å ±é…¬</label>
                        <div class="weight-control-inputs">
                            <input type="range" id="avg_trade_return_weight" min="0" max="1" step="0.01" value="0.30" oninput="updateWeight('avg_trade_return', this.value)">
                            <input type="number" id="avg_trade_return_input" min="0" max="1" step="0.01" value="0.30" oninput="updateSlider('avg_trade_return', this.value)">
                        </div>
                    </div>
                    <div class="weight-control-group">
                        <label class="weight-control-label">å‹ç‡</label>
                        <div class="weight-control-inputs">
                            <input type="range" id="win_rate_weight" min="0" max="1" step="0.01" value="0.30" oninput="updateWeight('win_rate', this.value)">
                            <input type="number" id="win_rate_input" min="0" max="1" step="0.01" value="0.30" oninput="updateSlider('win_rate', this.value)">
                        </div>
                    </div>
                    <div class="weight-control-group">
                        <label class="weight-control-label">å›æ’¤æ‡²ç½°</label>
                        <div class="weight-control-inputs">
                            <input type="range" id="drawdown_weight" min="0" max="1" step="0.01" value="0.05" oninput="updateWeight('drawdown', this.value)">
                            <input type="number" id="drawdown_input" min="0" max="1" step="0.01" value="0.05" oninput="updateSlider('drawdown', this.value)">
                        </div>
                    </div>
                    <div id="weight_total">æ¬Šé‡ç¸½å’Œ: 1.00</div>
                </div>
                <button class="btn" id="train-btn" onclick="startTraining()">ğŸš€ é–‹å§‹è¨“ç·´</button>
                <div class="progress-container" id="progress">
                    <p id="progress-text">æ­£åœ¨åˆå§‹åŒ–å¼•æ“...</p>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progress-bar-inner"></div>
                    </div>
                </div>
                <div id="results"></div>
            </div>

            <div id="page-explorer" class="page-view">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>ğŸ”­ æ¢ç´¢ç­–ç•¥åº«</h2>
                            <p>æŸ¥è©¢è³‡æ–™åº«ä¸­é‡å°ç‰¹å®šè‚¡ç¥¨å·²å­˜åœ¨çš„æœ€ä½³ç­–ç•¥ã€‚</p>
                        </div>
                        <span class="help-icon" onclick="showHelpModal('explorer')">?</span>
                    </div>
                    <div class="form-group">
                        <label for="lookup-ticker">è‚¡ç¥¨ä»£è™Ÿ</label>
                        <input type="text" id="lookup-ticker" placeholder="è¼¸å…¥ä»£è™Ÿå¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥è©¢">
                    </div>
                    <button class="btn" id="lookup-btn" onclick="lookupStrategy()">ğŸ” é–‹å§‹æŸ¥è©¢</button>
                    <div id="lookup-results-container"></div>
                </div>
            </div>
            
            <div id="page-backtester" class="page-view">
                <div class="card">
                    <div class="card-header">
                        <div>
                             <h2>âš™ï¸ æ‰‹å‹•ç­–ç•¥å›æ¸¬</h2>
                             <p>è¼¸å…¥ç­–ç•¥åŸºå› ï¼Œé©—è­‰å…¶ç¸¾æ•ˆè¡¨ç¾ã€‚</p>
                        </div>
                        <span class="help-icon" onclick="showHelpModal('backtester')">?</span>
                    </div>
                    <div class="form-group"><label for="manual-ticker">è‚¡ç¥¨ä»£è™Ÿ</label><input type="text" id="manual-ticker" placeholder="ä¾‹ï¼š2330.TW, AAPL"></div>
                    <div class="form-group"><label for="manual-gene">ç­–ç•¥åŸºå›  (JSON æ ¼å¼)</label><input type="text" id="manual-gene" placeholder="è«‹è²¼ä¸Šæˆ–å¾ç­–ç•¥æ¸…å–®å¸¶å…¥çš„åŸºå› ..."></div>
                    <div class="form-group"><label for="manual-duration">å›æ¸¬æ™‚é•· (æœˆ)</label><input type="number" id="manual-duration" value="36" min="1" max="120" oninput="validateInput(this)"></div>
                    <button class="btn" id="backtest-btn" onclick="startManualBacktest()">ğŸš€ é–‹å§‹å›æ¸¬</button>
                </div>
                <div class="loading" id="backtest-loading"><div class="spinner"></div><p>ğŸ”„ æ­£åœ¨åŸ·è¡Œå›æ¸¬...</p></div>
                <div id="manual-backtest-results"></div>
            </div>

            <div id="page-strategies" class="page-view">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>ğŸ“– æˆ‘çš„ç­–ç•¥æ¸…å–®</h2>
                            <p>åœ¨æ­¤ç®¡ç†ã€æ¯”è¼ƒä¸¦æ“ä½œæ‚¨å„²å­˜çš„æ‰€æœ‰ç­–ç•¥ã€‚</p>
                        </div>
                        <span class="help-icon" onclick="showHelpModal('strategies')">?</span>
                    </div>
                    <div class="batch-actions-container">
                        <button class="btn" id="proceed-allocator-btn" onclick="proceedToAllocator()" disabled>è³‡é‡‘é…ç½® (å·²é¸ <span id="selected-strategy-count">0</span> é …)</button>
                        <button class="btn btn-secondary btn-delete-batch" id="batch-delete-btn" onclick="batchDeleteStrategies()" disabled>åˆªé™¤é¸å–</button>
                    </div>

                    <div id="strategy-list-status"></div>
                    <div id="strategy-list-container"></div>
                </div>
            </div>
            
            <div id="page-signals" class="page-view">
                <div class="card">
                    <div class="card-header">
                         <div>
                            <h2>ğŸ¯ ç­–ç•¥æœ€æ–°ä¿¡è™Ÿ</h2>
                            <p>ç¯©é¸æœ€æ–°å›æ¸¬ä¸­ç¬¦åˆè²·è³£æ¢ä»¶çš„ç­–ç•¥ã€‚</p>
                        </div>
                        <span class="help-icon" onclick="showHelpModal('signals')">?</span>
                    </div>
                    <div class="form-group">
                        <label for="market-select">å¸‚å ´é¸æ“‡</label>
                        <select id="market-select" class="form-group" onchange="loadStrategySignals()">
                            <option value="TW">å°è‚¡ (TW)</option>
                            <option value="US">ç¾è‚¡ (US)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¿¡è™Ÿé¡å‹</label>
                        <div class="signal-type-selector">
                            <input type="radio" id="signal-type-buy" name="signal_type" value="buy" checked onchange="loadStrategySignals()">
                            <label for="signal-type-buy">ğŸŸ¢ è²·å…¥</label>
                            <input type="radio" id="signal-type-sell" name="signal_type" value="sell" onchange="loadStrategySignals()">
                            <label for="signal-type-sell">ğŸ”´ è³£å‡º</label>
                        </div>
                    </div>
                </div>
                <div id="signals-loading" class="loading"><div class="spinner"></div><p>ğŸ¤– æ­£åœ¨æœå°‹æœ€æ–°ç­–ç•¥ä¿¡è™Ÿ...</p></div>
                <div id="signals-results"></div>
            </div>

            <div id="page-allocator" class="page-view">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2>ğŸ’¼ æ™ºèƒ½è³‡é‡‘é…ç½®</h2>
                            <p>åŸºæ–¼ä¸‰å¤§è¦ç´ ï¼Œç‚ºæ‚¨çš„ç­–ç•¥çµ„åˆå»ºè­°è³‡é‡‘æ¯”ä¾‹ã€‚</p>
                        </div>
                        <span class="help-icon" onclick="showHelpModal('allocator')">?</span>
                    </div>
                    <div class="form-group">
                        <label>å·²é¸ç­–ç•¥</label>
                        <div id="allocator-strategy-list">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="risk-profile">æ‚¨çš„é¢¨éšªåå¥½</label>
                        <select id="risk-profile">
                            <option value="å‡è¡¡å‹" selected>å‡è¡¡å‹ (å¹³è¡¡é¢¨éšªèˆ‡å›å ±)</option>
                            <option value="ä¿å®ˆå‹">ä¿å®ˆå‹ (å„ªå…ˆè€ƒæ…®ä½é¢¨éšª)</option>
                            <option value="ç©æ¥µå‹">ç©æ¥µå‹ (å„ªå…ˆè¿½æ±‚é«˜å›å ±)</option>
                        </select>
                    </div>
                    <button class="btn" id="start-allocation-btn" onclick="startAllocation()">ğŸš€ é–‹å§‹æ™ºèƒ½é…ç½®</button>
                </div>
                
                <div id="allocation-loading" class="progress-container" style="display:none;">
                    <p id="allocation-progress-text">æ­£åœ¨åˆå§‹åŒ–åˆ†æå¼•æ“...</p>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="allocation-progress-bar-inner"></div>
                    </div>
                </div>

                <div id="allocation-results">
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-button active" onclick="showPage('page-trainer')"><span class="nav-button-icon">ğŸ§¬</span><span>è¨“ç·´å™¨</span></button>
            <button class="nav-button" onclick="showPage('page-explorer')"><span class="nav-button-icon">ğŸ”­</span><span>ç­–ç•¥åº«</span></button>
            <button class="nav-button" onclick="showPage('page-backtester')"><span class="nav-button-icon">âš™ï¸</span><span>å›æ¸¬</span></button>
            <button class="nav-button" onclick="showPage('page-strategies')"><span class="nav-button-icon">ğŸ“–</span><span>æˆ‘çš„ç­–ç•¥</span></button>
            <button class="nav-button" onclick="showPage('page-signals')"><span class="nav-button-icon">ğŸ¯</span><span>ä¿¡è™Ÿ</span></button>
            <button class="nav-button" onclick="showPage('page-allocator')"><span class="nav-button-icon">ğŸ“Š</span><span>é…ç½®</span></button>
        </nav>
    </div>

    <div id="helpModal" class="help-modal" style="display: none;">
        <div class="help-modal-content">
            <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
            <h2 id="helpModalTitle"></h2>
            <div id="helpModalBody"></div>
        </div>
    </div>
    
    <div id="chartModal" class="chart-modal">
        <button id="chartModalClose" class="chart-modal-close">Ã—</button>
        <div class="chart-modal-content">
            <iframe id="chartModalIframe" class="chart-modal-iframe" src="about:blank"></iframe>
        </div>
    </div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js').catch(err => console.log('SW reg failed: ', err));
        });
    }

    let isLoadingStrategies = false;
    let progressInterval = null;
    let selectedStrategiesForAllocation = [];

    const helpContent = {
        trainer: {
            title: 'ğŸ’¡ è¨“ç·´å™¨åŠŸèƒ½èªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>é€™è£¡æ˜¯ç­–ç•¥çš„æ ¸å¿ƒè¨“ç·´å€ã€‚æ‚¨åªéœ€è¨­å®šç›®æ¨™è‚¡ç¥¨å’Œæ­·å²æ•¸æ“šç¯„åœï¼Œç³»çµ±å°‡ä½¿ç”¨nsga-2æ¼”ç®—æ³•ï¼Œè‡ªå‹•è¨“ç·´å‡ºå…©ç¨®ä¸åŒé¢¨æ ¼çš„æœ€ä½³äº¤æ˜“ç­–ç•¥ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>æ“ä½œèªªæ˜</h3>
                    <p><strong>è‚¡ç¥¨ä»£è™Ÿ:</strong> è¼¸å…¥æ‚¨æƒ³åˆ†æçš„è‚¡ç¥¨ä»£è™Ÿï¼Œä¾‹å¦‚ AAPL (ç¾è‚¡) æˆ– 2330 (å°è‚¡)ã€‚</p>
                    <p><strong>é–‹å§‹/çµæŸæ—¥æœŸ:</strong> è¨­å®šç³»çµ±åˆ†æå’Œå­¸ç¿’çš„æ­·å²æ•¸æ“šå€é–“ï¼Œå»ºè­°è‡³å°‘ä¸€å¹´ä»¥ç²å¾—è¼ƒç©©å®šçš„çµæœã€‚</p>
                    <p><strong>æœ€å°‘äº¤æ˜“æ¬¡æ•¸:</strong> è¨­å®šç­–ç•¥åœ¨å›æ¸¬æœŸé–“å…§æœ€å°‘éœ€è¦é”æˆçš„äº¤æ˜“æ¬¡æ•¸ã€‚æ•¸å€¼è¶Šé«˜ï¼Œç­–ç•¥è¶Šåå‘çŸ­ç·šäº¤æ˜“ã€‚</p>
                    <p><strong>é–‹å§‹è¨“ç·´æŒ‰éˆ•:</strong> è¨­å®šå®Œæˆå¾Œï¼Œé»æ“Šæ­¤æŒ‰éˆ•å•Ÿå‹•è¨“ç·´ã€‚éç¨‹å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼Œè«‹è€å¿ƒç­‰å€™ã€‚</p>
                </div>
            `
        },
        explorer: {
            title: 'ğŸ’¡ ç­–ç•¥åº«åŠŸèƒ½èªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>ç­–ç•¥åº«æ˜¯æ‚¨æ¢ç´¢å’Œç™¼ç¾å·²å­˜åœ¨çš„é«˜æ•ˆç­–ç•¥çš„åœ°æ–¹ã€‚æ‚¨å¯ä»¥æŸ¥è©¢è³‡æ–™åº«ä¸­ï¼Œé‡å°ä»»ä¸€è‚¡ç¥¨å·²ç¶“è¢«è¨“ç·´å’Œå„²å­˜çš„æœ€ä½³ç­–ç•¥ï¼ˆåŒ…å«å…©ç¨®ä¸åŒé¢¨æ ¼ï¼‰ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>æ“ä½œèªªæ˜</h3>
                    <p><strong>è‚¡ç¥¨ä»£è™Ÿ:</strong> è¼¸å…¥æ‚¨æ„Ÿèˆˆè¶£çš„è‚¡ç¥¨ä»£è™Ÿï¼ˆä¾‹å¦‚ï¼šTSLA, 2330.TWï¼‰ã€‚</p>
                    <p><strong>é–‹å§‹æŸ¥è©¢:</strong> é»æ“ŠæŒ‰éˆ•å¾Œï¼Œç³»çµ±æœƒç«‹å³å¾å¾Œç«¯è³‡æ–™åº«ä¸­å°‹æ‰¾èˆ‡è©²è‚¡ç¥¨ç›¸é—œçš„Rank 1ç­–ç•¥ã€‚</p>
                    <p><strong>æŸ¥è©¢çµæœ:</strong> å¦‚æœæ‰¾åˆ°ç­–ç•¥ï¼Œå°‡æœƒä»¥å¡ç‰‡å½¢å¼å±•ç¤ºå…¶è©³ç´°çš„ç¸¾æ•ˆæŒ‡æ¨™ã€‚æ‚¨å¯ä»¥ç›´æ¥é»æ“Šã€Œâ­ åŠ å…¥æˆ‘çš„æ¸…å–®ã€å°‡å…¶ä¿å­˜åˆ°æ‚¨çš„å€‹äººç­–ç•¥ä¸­ï¼Œä»¥ä¾¿å¾ŒçºŒé€²è¡Œå›æ¸¬æˆ–è³‡é‡‘é…ç½®ã€‚</p>
                    <p><strong>æç¤º:</strong> åœ¨é–‹å§‹ä¸€æ¬¡å…¨æ–°çš„ã€è€—æ™‚çš„è¨“ç·´ä¹‹å‰ï¼Œå…ˆä¾†é€™è£¡æŸ¥è©¢ï¼Œä¹Ÿè¨±èƒ½å¹«æ‚¨ç¯€çœå¯¶è²´çš„æ™‚é–“ï¼</p>
                </div>
            `
        },
        weights: {
            title: 'ğŸ’¡ è¨“ç·´æ¬Šé‡è¨­å®šèªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>é€™äº›æ‹‰æ¡¿ç”¨ä¾†èª¿æ•´ç³»çµ±åœ¨è¨“ç·´éç¨‹ä¸­å°‹æ‰¾æœ€ä½³ç­–ç•¥çš„ã€Œåå¥½ã€ã€‚ç¸½å’Œå¿…é ˆç‚º1.00ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>å„é …æ¬Šé‡èªªæ˜</h3>
                    <p><strong>ç¸½å ±é…¬ç‡:</strong> èª¿é«˜æ­¤é …æ¬Šé‡ï¼Œç³»çµ±æœƒå„ªå…ˆå°‹æ‰¾<strong>æœ€çµ‚ç²åˆ©æœ€é«˜</strong>çš„ç­–ç•¥ï¼Œå³ä½¿é€™æ„å‘³è‘—éç¨‹ä¸­æœ‰è¼ƒå¤§çš„é¢¨éšªæˆ–è¼ƒä½çš„å‹ç‡ã€‚</p>
                    <p><strong>å¹³å‡äº¤æ˜“å ±é…¬:</strong> èª¿é«˜æ­¤é …æ¬Šé‡ï¼Œç³»çµ±æœƒå‚¾å‘æ–¼å°‹æ‰¾<strong>å–®æ¬¡äº¤æ˜“å“è³ªé«˜</strong>çš„ç­–ç•¥ã€‚é€™é¡ç­–ç•¥å¯èƒ½äº¤æ˜“æ¬¡æ•¸ä¸å¤šï¼Œä½†æ¯ä¸€æ¬¡å‡ºæ‰‹éƒ½åŠ›æ±‚è¼ƒå¤§çš„ç²åˆ©ç©ºé–“ã€‚</p>
                    <p><strong>å‹ç‡:</strong> èª¿é«˜æ­¤é …æ¬Šé‡ï¼Œç³»çµ±æœƒå„ªå…ˆå°‹æ‰¾<strong>äº¤æ˜“æˆåŠŸç‡æœ€é«˜</strong>çš„ç­–ç•¥ã€‚é€™é¡ç­–ç•¥å¯èƒ½æ¯æ¬¡ç²åˆ©ä¸å¤šï¼Œä½†èƒ½æä¾›æ›´ç©©å®šçš„ã€æŒçºŒçš„å°é¡ç›ˆåˆ©ï¼Œé©åˆä¸å–œæ­¡çœ‹åˆ°è™§æäº¤æ˜“çš„ç”¨æˆ¶ã€‚</p>
                    <p><strong>å›æ’¤æ‡²ç½°:</strong> ã€Œæœ€å¤§å›æ’¤ã€æ˜¯æŒ‡ç­–ç•¥å¾æœ€é«˜é»å›è½åˆ°æœ€ä½é»çš„æœ€å¤§å¹…åº¦ã€‚èª¿é«˜æ­¤é …æ¬Šé‡ï¼Œç³»çµ±æœƒ<strong>æ¥µåŠ›é¿å…ç”¢ç”Ÿå·¨å¤§è™§æ</strong>çš„ç­–ç•¥ï¼Œå„ªå…ˆå°‹æ‰¾è³‡ç”¢æ›²ç·šæ›´å¹³æ»‘ã€é¢¨éšªæ›´ä½çš„æ–¹æ¡ˆï¼Œé©åˆç©©å¥å‹å’Œä¿å®ˆå‹çš„ç”¨æˆ¶ã€‚</p>
                </div>
            `
        },
        backtester: {
            title: 'ğŸ’¡ æ‰‹å‹•å›æ¸¬åŠŸèƒ½èªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>é€™å€‹å·¥å…·è®“æ‚¨å¯ä»¥å°å­˜åœ¨çš„ç­–ç•¥åŸºå› ï¼Œåœ¨æŒ‡å®šçš„è‚¡ç¥¨å’Œæ™‚é–“ç¯„åœå…§é€²è¡Œç¸¾æ•ˆé©—è­‰ã€‚éå¸¸é©åˆç”¨ä¾†ç¢ºèªä¸€å€‹ç­–ç•¥çš„ç©©å¥æ€§ã€æ¸¬è©¦å®ƒåœ¨ä¸åŒè‚¡ç¥¨ä¸Šçš„è¡¨ç¾ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>æ“ä½œèªªæ˜</h3>
                    <p><strong>è‚¡ç¥¨ä»£è™Ÿ:</strong> è¼¸å…¥æ‚¨æƒ³ç”¨ä¾†å›æ¸¬æ­¤ç­–ç•¥çš„è‚¡ç¥¨ä»£è™Ÿã€‚</p>
                    <p><strong>ç­–ç•¥åŸºå› :</strong>å‰å¾€ã€Œæˆ‘çš„ç­–ç•¥ã€é é¢ï¼Œå±•é–‹ä»»ä¸€ç­–ç•¥çš„è©³æƒ…ï¼Œé»æ“Šå³ä¸‹è§’çš„ã€Œâš™ï¸ å›æ¸¬ã€æŒ‰éˆ•ï¼Œç³»çµ±å°±æœƒè‡ªå‹•å°‡æ‚¨å¸¶åˆ°æ­¤è™•ä¸¦å¡«å…¥åŸºå› ã€‚</p>
                    <p><strong>å›æ¸¬æ™‚é•· (æœˆ):</strong> è¨­å®šå¾ä»Šå¤©å¾€å‰æ¨ç®—çš„å›æ¸¬æ™‚é–“é•·åº¦ã€‚ä¾‹å¦‚ï¼Œè¼¸å…¥36ä»£è¡¨å›æ¸¬éå»ä¸‰å¹´çš„æ•¸æ“šã€‚</p>
                    <p><strong>é–‹å§‹å›æ¸¬æŒ‰éˆ•:</strong> é»æ“Šå¾Œï¼Œç³»çµ±æœƒç«‹å³ä½¿ç”¨æ‚¨æä¾›çš„åŸºå› å’Œè‚¡ç¥¨æ•¸æ“šé€²è¡Œå›æ¸¬ï¼Œä¸¦ç”Ÿæˆè©³ç´°çš„ç¸¾æ•ˆå ±å‘Šå’Œåœ–è¡¨ã€‚</p>
                </div>
            `
        },
        strategies: {
            title: 'ğŸ’¡ æˆ‘çš„ç­–ç•¥æ¸…å–®èªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½èˆ‡æ“ä½œ</h3>
                    <p>é€™è£¡æ˜¯æ‚¨æ‰€æœ‰å·²å„²å­˜ç­–ç•¥çš„ç®¡ç†ä¸­å¿ƒã€‚æ‚¨å¯ä»¥ä¸€ç›®äº†ç„¶åœ°æ¯”è¼ƒå„ç­–ç•¥çš„é—œéµæŒ‡æ¨™ï¼Œä¸¦é€²è¡Œæ‰¹æ¬¡æ“ä½œã€‚</p>
                    <ul>
                        <li><strong>æŸ¥çœ‹è©³æƒ…:</strong> é»æ“Šå¡ç‰‡ä»»ä¸€è™•å¯å±•é–‹æˆ–æ”¶åˆï¼ŒæŸ¥çœ‹åŒ…å«å¤æ™®æ¯”ç‡åœ¨å…§çš„å…¨éƒ¨ç¸¾æ•ˆæ•¸æ“šå’Œç­–ç•¥æè¿°ã€‚</li>
                        <li><strong>æ‰¹æ¬¡æ“ä½œ:</strong> ä½¿ç”¨å·¦å´çš„é¸æ¡†å‹¾é¸å¤šå€‹ç­–ç•¥å¾Œï¼Œé ‚éƒ¨çš„ã€Œè³‡é‡‘é…ç½®ã€å’Œã€Œåˆªé™¤é¸å–ã€æŒ‰éˆ•ä¾¿æœƒå•Ÿç”¨ã€‚</li>
                        <li><strong>å–®ç¨æ“ä½œ:</strong> å±•é–‹å¡ç‰‡å¾Œï¼Œå¯å°å–®ä¸€ç­–ç•¥é€²è¡Œå¿«é€Ÿå›æ¸¬æˆ–åˆªé™¤ã€‚</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>ç¸¾æ•ˆæŒ‡æ¨™è©³è§£</h3>
                    <ul>
                        <li><strong>ç¸½å ±é…¬:</strong> ç­–ç•¥åœ¨æ•´å€‹è¨“ç·´æœŸé–“çš„ç¸½é«”ç›ˆåˆ©æˆ–è™§æç™¾åˆ†æ¯”ã€‚é€™æ˜¯æœ€ç›´è§€çš„ç²åˆ©èƒ½åŠ›æŒ‡æ¨™ã€‚</li>
                        <li><strong>å‹ç‡:</strong> ç²åˆ©äº¤æ˜“æ¬¡æ•¸ä½”ç¸½äº¤æ˜“æ¬¡æ•¸çš„æ¯”ä¾‹ã€‚é«˜å‹ç‡ä»£è¡¨ç­–ç•¥çš„ç©©å®šæ€§è¼ƒå¥½ã€‚</li>
                        <li><strong>æœ€å¤§å›æ’¤:</strong> ç­–ç•¥è³‡é‡‘å¾æœ€é«˜é»å›è½åˆ°æœ€ä½é»çš„æœ€å¤§å¹…åº¦ã€‚é€™å€‹æ•¸å€¼è¶Šä½ï¼Œä»£è¡¨ç­–ç•¥çš„é¢¨éšªæ§åˆ¶èƒ½åŠ›è¶Šå¼·ï¼ŒæŠ—é¢¨éšªèƒ½åŠ›è¶Šé«˜ã€‚</li>
                        <li><strong>å¤æ™®æ¯”ç‡:</strong> è¡¡é‡ç­–ç•¥æ¯æ‰¿å—ä¸€å–®ä½é¢¨éšªï¼Œèƒ½å¤ å¸¶ä¾†å¤šå°‘è¶…é¡å ±é…¬ã€‚æ•¸å€¼è¶Šé«˜ï¼Œä»£è¡¨ç­–ç•¥çš„é¢¨éšªèª¿æ•´å¾Œæ”¶ç›Šè¶Šå¥½ï¼ŒCPå€¼è¶Šé«˜ã€‚</li>
                        <li><strong>å¹³å‡äº¤æ˜“å ±é…¬:</strong> æ¯æ¬¡äº¤æ˜“çš„å¹³å‡ç›ˆè™§ç™¾åˆ†æ¯”ã€‚é«˜æ•¸å€¼ä»£è¡¨ç­–ç•¥å‚¾å‘æ–¼æ•æ‰è¼ƒå¤§çš„å–®æ¬¡æ³¢å‹•ã€‚</li>
                    </ul>
                </div>
            `
        },
        signals: {
            title: 'ğŸ’¡ ç­–ç•¥æœ€æ–°ä¿¡è™Ÿèªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>æ­¤åŠŸèƒ½æœƒè‡ªå‹•æƒææˆ‘å€‘è³‡æ–™åº«ä¸­æ‰€æœ‰ç¶“éè¨“ç·´å’Œæ­·å²å›æ¸¬çš„ç­–ç•¥ï¼Œä¸¦ç¯©é¸å‡ºåœ¨<strong>æœ€è¿‘å¹¾å€‹äº¤æ˜“æ—¥å…§</strong>å‡ºç¾ã€Œè²·å…¥ã€æˆ–ã€Œè³£å‡ºã€ä¿¡è™Ÿçš„è‚¡ç¥¨ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>å¦‚ä½•ä½¿ç”¨ï¼š</h3>
                    <p>æ‚¨å¯ä»¥æŠŠå®ƒç•¶ä½œä¸€å€‹ç­–ç•¥çš„ã€Œé›·é”ã€ã€‚å®ƒå¹«åŠ©æ‚¨å¾æ•¸ç™¾å€‹ç­–ç•¥ä¸­å¿«é€Ÿç™¼ç¾å¸‚å ´æ©Ÿæœƒï¼Œæ‰¾åˆ°é‚£äº›æ¨¡å‹èªç‚ºè™•æ–¼é—œéµäº¤æ˜“é»ä½çš„è‚¡ç¥¨ã€‚</p>
                    <p>é»æ“Šå¡ç‰‡å³ä¸Šè§’çš„ã€Œâ­ å„²å­˜ã€æŒ‰éˆ•ï¼Œå³å¯å°‡è©²ç­–ç•¥ä¿å­˜åˆ°ã€Œæˆ‘çš„ç­–ç•¥ã€æ¸…å–®ä¸­é€²è¡Œå¾ŒçºŒè¿½è¹¤æˆ–å›æ¸¬ã€‚</p>
                    <p><strong>æé†’ï¼š</strong> é€™è£¡é¡¯ç¤ºçš„ä¿¡è™ŸåŸºæ–¼æ­·å²æ•¸æ“šå›æ¸¬ï¼Œåƒ…ä¾›åƒè€ƒï¼Œä¸¦éæŠ•è³‡å»ºè­°ã€‚</p>
                </div>
            `
        },
        allocator: {
            title: 'ğŸ’¡ æ™ºèƒ½è³‡é‡‘é…ç½®èªªæ˜',
            body: `
                <div class="help-section">
                    <h3>åŠŸèƒ½ä»‹ç´¹</h3>
                    <p>é€™æ˜¯æœ¬å¹³å°çš„<strong>æ ¸å¿ƒæ±ºç­–è¼”åŠ©åŠŸèƒ½</strong>ã€‚å®ƒä¸åƒ…æ˜¯ç°¡å–®çš„æ•¸å­¸è¨ˆç®—ï¼Œè€Œæ˜¯ä¸€å€‹ç¶œåˆåˆ†æç³»çµ±ï¼Œæ—¨åœ¨ç‚ºæ‚¨æä¾›ä¸€å€‹æ›´å…¨é¢ã€æ›´è²¼è¿‘å¸‚å ´ç¾æ³çš„è³‡é‡‘é…ç½®å»ºè­°ã€‚</p>
                </div>
                <div class="help-section">
                    <h3>ä¸‰å¤§åˆ†æå¼•æ“</h3>
                    <p>ç•¶æ‚¨é»æ“Šé–‹å§‹é…ç½®å¾Œï¼Œç³»çµ±æœƒåŒæ­¥å•Ÿç”¨ä¸‰å¤§å¼•æ“ï¼š</p>
                    <ul>
                        <li><strong>â‘  é‡åŒ–åˆ†æå¼•æ“:</strong> æ·±å…¥åˆ†ææ‚¨æ‰€é¸ç­–ç•¥çš„å„é …æ­·å²ç¸¾æ•ˆæŒ‡æ¨™ï¼ˆç¸½å ±é…¬ã€å‹ç‡ã€æœ€å¤§å›æ’¤ã€å¤æ™®æ¯”ç‡ç­‰ï¼‰ã€‚</li>
                        <li><strong>â‘¡ é¢¨éšªåå¥½å¼•æ“:</strong> æ ¹æ“šæ‚¨é¸æ“‡çš„ã€Œç©æ¥µå‹ã€ã€ã€Œå‡è¡¡å‹ã€æˆ–ã€Œä¿å®ˆå‹ã€ï¼Œç‚ºä¸åŒçš„ç¸¾æ•ˆæŒ‡æ¨™è³¦äºˆä¸åŒçš„æ±ºç­–æ¬Šé‡ã€‚</li>
                        <li><strong>â‘¢ AIå¸‚å ´æ´å¯Ÿå¼•æ“:</strong> é€é Gemini AI å°æ‚¨é¸æ“‡çš„è‚¡ç¥¨é€²è¡Œå³æ™‚çš„Googleæ–°èæœå°‹èˆ‡åˆ†æï¼Œåˆ¤æ–·å…¶ç•¶å‰çš„å¸‚å ´æƒ…ç·’æ˜¯åå¤š(Bullish)ã€ä¸­ç«‹(Neutral)é‚„æ˜¯åç©º(Bearish)ã€‚</li>
                    </ul>
                </div>
                 <div class="help-section">
                    <h3>æ±ºç­–æµç¨‹</h3>
                    <p>æœ€çµ‚çš„é…ç½®æ¯”ä¾‹ï¼Œæ˜¯å°‡ã€Œé‡åŒ–åˆ†æã€èˆ‡ã€Œé¢¨éšªåå¥½ã€è¨ˆç®—å‡ºçš„åŸºç¤åˆ†æ•¸ï¼Œå†ç”±ã€ŒAIå¸‚å ´æ´å¯Ÿã€çš„çµæœé€²è¡Œå‹•æ…‹åŠ æ¬Šèª¿æ•´å¾Œå¾—å‡ºçš„ã€‚é€™æ„å‘³è‘—ï¼Œä¸€å€‹æ­·å²æ•¸æ“šæ¼‚äº®çš„ç­–ç•¥ï¼Œå¦‚æœè¿‘æœŸæœ‰é‡å¤§åˆ©ç©ºæ¶ˆæ¯ï¼Œå…¶å»ºè­°çš„é…ç½®æ¯”ä¾‹ä¹Ÿå¯èƒ½æœƒè¢«é©åº¦èª¿ä½ã€‚</p>
                </div>
            `
        }
    };

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            const response = await fetch('/api/user/status');
            const result = await response.json();
            if (result.logged_in) {
                document.getElementById('app-container').style.display = 'flex';
                initializeTrainerPage();
            } else {
                window.location.href = '/login';
            }
        } catch (error) {
            document.body.innerHTML = '<div style="padding:20px; text-align:center;">ç„¡æ³•é€£æ¥å¾Œç«¯ï¼Œè«‹ç¢ºèªæœå‹™å·²å•Ÿå‹•ã€‚</div>';
        }

        const chartModal = document.getElementById('chartModal');
        const chartModalContent = chartModal.querySelector('.chart-modal-content');
        
        document.getElementById('chartModalClose').addEventListener('click', closeChartModal);
        
        chartModal.addEventListener('click', function() {
            closeChartModal();
        });
        
        chartModalContent.addEventListener('click', function(event) {
            event.stopPropagation();
        });
        
        document.getElementById('helpModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHelpModal();
            }
        });
    });

    function showHelpModal(type) {
        const modal = document.getElementById('helpModal');
        const titleEl = document.getElementById('helpModalTitle');
        const bodyEl = document.getElementById('helpModalBody');
        
        if (helpContent[type]) {
            titleEl.textContent = helpContent[type].title;
            bodyEl.innerHTML = helpContent[type].body;
            modal.style.display = 'flex';
        }
    }

    function closeHelpModal() {
        const modal = document.getElementById('helpModal');
        modal.style.display = 'none';
    }

    function initializeTrainerPage() {
        const today = new Date();
        const oneYearAgo = new Date(today);
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        document.getElementById('start_date').valueAsDate = oneYearAgo;
        document.getElementById('end_date').valueAsDate = today;
        updateTotalWeight();
    }

    async function handleLogout() {
        await fetch('/api/logout');
        window.location.href = '/login';
    }

    function showPage(pageId) {
        document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-button[onclick="showPage('${pageId}')"]`).classList.add('active');
        
        if (pageId === 'page-strategies') {
            loadSavedStrategies();
        }
        if (pageId === 'page-signals') {
            loadStrategySignals();
        }
        if (pageId !== 'page-allocator') {
            document.getElementById('allocation-results').innerHTML = '';
        }
    }

    function showMessage(containerId, message, type = 'error') {
        const container = document.getElementById(containerId);
        if (!container) return;
        const msgType = type === 'error' ? 'error' : 'success';
        container.innerHTML = `<div class="message-box ${msgType}">${message}</div>`;
    }
    
    function formatPercent(num, decimals = 1) {
        if (num === null || num === undefined || isNaN(num)) return 'N/A';
        return `${parseFloat(num).toFixed(decimals)}%`;
    }
    function formatNumber(num, decimals = 2) {
        if (num === null || num === undefined || isNaN(num)) return 'N/A';
        return parseFloat(num).toFixed(decimals);
    }

    function validateInput(element) {
        const min = parseFloat(element.min);
        const max = parseFloat(element.max);
        let value = parseFloat(element.value);
        if (isNaN(value)) {
            if (element.value === '') return;
            value = min;
        }
        if (value > max) value = max;
        if (value < min) value = min;
        element.value = value;
    }

    function openChartModal(interactiveUrl) {
        if (!interactiveUrl) return;
        const modal = document.getElementById('chartModal');
        const iframe = document.getElementById('chartModalIframe');
        iframe.src = interactiveUrl;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeChartModal() {
        const modal = document.getElementById('chartModal');
        const iframe = document.getElementById('chartModalIframe');
        modal.style.display = 'none';
        iframe.src = 'about:blank';
        document.body.style.overflow = 'auto';
    }

    // === MODIFIED: Simplified Weight Update functions ===
    function updateWeight(type, value) {
        const floatValue = parseFloat(value);
        document.getElementById(type + '_input').value = floatValue.toFixed(2);
        document.getElementById(type + '_weight').value = floatValue;
        updateTotalWeight();
    }
    
    function updateSlider(type, value) {
        const floatValue = parseFloat(value);
        if(isNaN(floatValue) || floatValue < 0) return;
        if(floatValue > 1) {
            document.getElementById(type + '_input').value = 1;
            value = 1;
        };
        document.getElementById(type + '_weight').value = value;
        updateTotalWeight();
    }

    function updateTotalWeight() {
        const total = ['total_return_weight', 'avg_trade_return_weight', 'win_rate_weight', 'drawdown_weight']
            .reduce((sum, id) => sum + parseFloat(document.getElementById(id).value), 0);
        const totalElement = document.getElementById('weight_total');
        totalElement.textContent = `æ¬Šé‡ç¸½å’Œ: ${total.toFixed(2)}`;
        totalElement.style.color = Math.abs(total - 1.0) > 0.01 ? 'var(--negative-text)' : 'var(--positive-text)';
    }
    
    function resetTrainingUI() {
        const btn = document.getElementById('train-btn');
        const progressContainer = document.getElementById('progress');
        progressContainer.style.display = 'none';
        btn.disabled = false;
        btn.textContent = 'ğŸš€ é–‹å§‹è¨“ç·´';
    }

    async function startTraining() {
        const btn = document.getElementById('train-btn');
        const progressContainer = document.getElementById('progress');
        const progressBar = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        const resultsContainer = document.getElementById('results');
        const ticker = document.getElementById('ticker').value.trim();

        if (!ticker) { 
            showMessage('results', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚', 'error'); 
            return; 
        }

        btn.disabled = true;
        btn.textContent = 'ğŸ”„ åŸ·è¡Œä¸­...';
        resultsContainer.innerHTML = '';
        progressContainer.style.display = 'block';
        progressBar.style.transition = 'width 0.5s ease-out';
        progressBar.style.width = '10%';
        progressText.textContent = "æ­£åœ¨å°‡æ‚¨çš„è¨“ç·´ä»»å‹™åŠ å…¥ä½‡åˆ—...";

        try {
            const payload = {
                ticker,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                custom_weights: {
                    total_return_weight: parseFloat(document.getElementById('total_return_weight').value),
                    avg_trade_return_weight: parseFloat(document.getElementById('avg_trade_return_weight').value),
                    win_rate_weight: parseFloat(document.getElementById('win_rate_weight').value),
                    trade_count_weight: 0,
                    drawdown_weight: parseFloat(document.getElementById('drawdown_weight').value)
                },
                basic_params: {
                    min_trades: parseInt(document.getElementById('min_trades').value)
                }
            };

            const response = await fetch('/api/train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status === 202) {
                const result = await response.json();
                if (result.success && result.task_id) {
                    progressBar.style.width = '20%';
                    progressText.textContent = "âœ… ä»»å‹™å·²æäº¤ï¼æ­£åœ¨ç­‰å¾…ä¼ºæœå™¨åˆ†é…è³‡æº...";
                    checkTaskStatus(result.task_id);
                } else {
                    showMessage('results', `æäº¤ä»»å‹™å¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                    resetTrainingUI();
                }
            } else {
                const errorResult = await response.json();
                showMessage('results', `æäº¤å¤±æ•—: ${errorResult.errors ? errorResult.errors.join(', ') : 'ä¼ºæœå™¨éŒ¯èª¤'}`, 'error');
                resetTrainingUI();
            }
        } catch (error) {
            showMessage('results', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
            resetTrainingUI();
        }
    }

    function checkTaskStatus(taskId) {
        const progressBar = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');

        const intervalId = setInterval(async () => {
            try {
                const response = await fetch(`/api/task_status/${taskId}`);
                if (!response.ok) {
                    throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }
                const data = await response.json();

                switch (data.status) {
                    case 'QUEUED':
                        progressBar.style.width = '30%';
                        progressText.textContent = "â³ ä»»å‹™æ­£åœ¨æ’éšŠä¸­ï¼Œè«‹ç¨å€™...";
                        break;
                    case 'STARTED':
                        progressBar.style.width = '50%';
                        progressText.textContent = "ğŸš€å·²é–‹å§‹ç‚ºæ‚¨åŸ·è¡Œè¨“ç·´ï¼Œè«‹ç¨å¾Œ...";
                        break;
                    case 'SUCCESS':
                        clearInterval(intervalId);
                        progressBar.style.width = '100%';
                        progressText.textContent = "ğŸ‰ è¨“ç·´å®Œæˆï¼";
                        
                        const trainingResult = data.result;
                        if (trainingResult && trainingResult.success) {
                            renderTrainingResults(trainingResult);
                        } else {
                            const errorMessage = trainingResult.errors ? trainingResult.errors.join(', ') : 'è¿”å›çš„çµæœæ ¼å¼éŒ¯èª¤';
                            showMessage('results', `è¨“ç·´å¤±æ•—: ${errorMessage}`, 'error');
                        }
                        setTimeout(resetTrainingUI, 1500);
                        break;
                    case 'FAILURE':
                        clearInterval(intervalId);
                        showMessage('results', `è¨“ç·´ä»»å‹™åŸ·è¡Œå¤±æ•—: ${data.result}`, 'error');
                        resetTrainingUI();
                        break;
                    case 'NOT_FOUND':
                        clearInterval(intervalId);
                        showMessage('results', 'ä»»å‹™IDéºå¤±æˆ–ç„¡æ•ˆï¼Œè«‹é‡è©¦ã€‚', 'error');
                        resetTrainingUI();
                        break;
                }
            } catch (error) {
                clearInterval(intervalId);
                showMessage('results', 'æŸ¥è©¢ä»»å‹™ç‹€æ…‹æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚', 'error');
                resetTrainingUI();
            }
        }, 5000);
    }

    function renderTrainingResults(result) {
        const contentDiv = document.getElementById('results');
        let html = `<div class="message-box success"><strong>è¨“ç·´æˆåŠŸï¼</strong> è‚¡ç¥¨: ${result.ticker} | æœŸé–“: ${result.training_period}</div>`;
        
        result.results.forEach((strategy) => {
            const metrics = strategy.metrics;
            const strategyData = {
                ticker: result.ticker,
                train_start_date: result.training_period.split(' ~ ')[0],
                train_end_date: result.training_period.split(' ~ ')[1],
                gene: strategy.gene, metrics,
                strategy_details: strategy.description
            };
            const chartHtml = strategy.chart_image_url
                ? `<div class="chart-preview-container" onclick='openChartModal("${strategy.chart_interactive_url}")'><img src="${strategy.chart_image_url}" class="chart-preview-image"><p style="text-align:center;font-size:0.8rem;color:var(--text-secondary);margin-top:8px;">é»æ“Šåœ–è¡¨ä»¥é€²è¡Œäº’å‹•</p></div>`
                : '<p class="message-box error">åœ–è¡¨ç”Ÿæˆå¤±æ•—ã€‚</p>';
            
            html += `
            <div class="result-card" data-strategy-json='${JSON.stringify(strategyData)}'>
                <div class="result-header"><h3>${strategy.strategy_type_name || `ç­–ç•¥æ’å #${strategy.rank}`}</h3></div>
                <div class="result-body">
                    <div class="data-list-grid">
                        <div class="data-list-item"><span class="label">ç¸½å ±é…¬ç‡</span><span class="value positive">${(metrics.total_return * 100).toFixed(2)}%</span></div>
                        <div class="data-list-item"><span class="label">å‹ç‡</span><span class="value positive">${(metrics.win_rate_pct || 0).toFixed(1)}%</span></div>
                        <div class="data-list-item"><span class="label">å¹³å‡äº¤æ˜“å ±é…¬</span><span class="value positive">${(metrics.average_trade_return * 100).toFixed(3)}%</span></div>
                        <div class="data-list-item"><span class="label">æœ€å¤§å›æ’¤</span><span class="value negative">${(metrics.max_drawdown * 100).toFixed(2)}%</span></div>
                        <div class="data-list-item"><span class="label">å¤æ™®æ¯”ç‡</span><span class="value">${(metrics.sharpe_ratio || 0).toFixed(2)}</span></div>
                        <div class="data-list-item"><span class="label">äº¤æ˜“æ¬¡æ•¸</span><span class="value">${metrics.trade_count || 0}</span></div>
                        <div class="data-list-item" style="grid-column: 1 / -1;"><span class="label">æœ€å¤§å–®ç­†ç²åˆ©/è™§æ</span>
                            <span class="value">
                                <span class="positive">${(metrics.max_trade_gain_pct || 0).toFixed(2)}%</span> / <span class="negative">${(metrics.max_trade_drop_pct || 0).toFixed(2)}%</span>
                            </span>
                        </div>
                    </div>
                    ${chartHtml}
                    <div class="description">${strategy.description}</div>
                    <div style="margin-top:16px; display:flex; gap:8px;">
                        <button style="flex:1;" class="btn" onclick='saveStrategy(this)'>â­ å„²å­˜ç­–ç•¥</button>
                    </div>
                </div>
            </div>`;
        });
        contentDiv.innerHTML = html;
    }
    
    async function startManualBacktest() {
        const btn = document.getElementById('backtest-btn');
        const loading = document.getElementById('backtest-loading');
        const resultsDiv = document.getElementById('manual-backtest-results');
        
        const ticker = document.getElementById('manual-ticker').value.trim();
        const geneStr = document.getElementById('manual-gene').value.trim();
        const duration = document.getElementById('manual-duration').value;
        
        resultsDiv.innerHTML = '';
        if (!ticker || !geneStr) { showMessage('manual-backtest-results', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½'); return; }
        
        let gene;
        try { 
            gene = JSON.parse(geneStr); 
        } catch (e) { 
            showMessage('manual-backtest-results', 'ç„¡æ•ˆçš„åŸºå› æ ¼å¼ã€‚åŸºå› æ‡‰ç‚ºä¸€å€‹ JSON é™£åˆ—ï¼Œä¾‹å¦‚ [1, 2, 3]ã€‚'); 
            return; 
        }

        btn.disabled = true;
        btn.textContent = 'ğŸ”„ æ­£åœ¨å›æ¸¬...';
        loading.style.display = 'block';

        try {
            const response = await fetch('/api/manual-backtest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, gene, duration_months: parseInt(duration) })
            });
            const result = await response.json();
            if (result.success) {
                renderManualBacktestResult(result);
            } else {
                showMessage('manual-backtest-results', result.error || 'å›æ¸¬å¤±æ•—');
            }
        } catch (error) {
            showMessage('manual-backtest-results', 'ç¶²è·¯éŒ¯èª¤: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸš€ é–‹å§‹å›æ¸¬';
            loading.style.display = 'none';
        }
    }

    function renderManualBacktestResult(result) {
        const resultsDiv = document.getElementById('manual-backtest-results');
        const metrics = result.metrics;
        const hintHtml = result.signal_status ? `<div class="message-box hint-bar">ğŸ’¡ ${result.signal_status}</div>` : '';
        
        const chartHtml = result.chart_image_url
            ? `<div class="chart-preview-container" onclick='openChartModal("${result.chart_interactive_url}")'><img src="${result.chart_image_url}" class="chart-preview-image"><p style="text-align:center;font-size:0.8rem;color:var(--text-secondary);margin-top:8px;">é»æ“Šåœ–è¡¨ä»¥é€²è¡Œäº’å‹•</p></div>`
            : '<p class="message-box error">åœ–è¡¨ç”Ÿæˆå¤±æ•—ã€‚</p>';
            
        const html = `
            <div class="message-box success"><strong>å›æ¸¬æˆåŠŸï¼</strong> ${result.ticker} | ${result.backtest_period}</div>
            ${hintHtml}
            <div class="result-card">
                <div class="result-body">
                    <div class="data-list-grid">
                       <div class="data-list-item"><span class="label">ç¸½å ±é…¬ç‡</span><span class="value positive">${(metrics.total_return * 100).toFixed(2)}%</span></div>
                       <div class="data-list-item"><span class="label">å‹ç‡</span><span class="value positive">${(metrics.win_rate_pct || 0).toFixed(1)}%</span></div>
                       <div class="data-list-item"><span class="label">å¹³å‡äº¤æ˜“å ±é…¬</span><span class="value positive">${(metrics.average_trade_return * 100).toFixed(3)}%</span></div>
                       <div class="data-list-item"><span class="label">æœ€å¤§å›æ’¤</span><span class="value negative">${(metrics.max_drawdown * 100 || 0).toFixed(2)}%</span></div>
                       <div class="data-list-item"><span class="label">å¤æ™®æ¯”ç‡</span><span class="value">${(metrics.sharpe_ratio || 0).toFixed(2)}</span></div>
                       <div class="data-list-item"><span class="label">äº¤æ˜“æ¬¡æ•¸</span><span class="value">${metrics.trade_count || 0}</span></div>
                       <div class="data-list-item" style="grid-column: 1 / -1;">
                           <span class="label">æœ€å¤§å–®ç­†ç²åˆ©/è™§æ</span>
                           <span class="value">
                               <span class="positive">${(metrics.max_trade_gain_pct * 1 || 0).toFixed(2)}%</span> / <span class="negative">${(metrics.max_trade_drop_pct * 1 || 0).toFixed(2)}%</span>
                           </span>
                       </div>
                    </div>
                    ${chartHtml}
                </div>
            </div>`;
        resultsDiv.innerHTML = html;
    }

    async function saveStrategy(button) {
        const card = button.closest('.result-card');
        const strategyData = JSON.parse(card.dataset.strategyJson);
        button.textContent = 'å„²å­˜ä¸­...';
        button.disabled = true;
        try {
            const response = await fetch('/api/strategies', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(strategyData)
            });
            if(response.ok) {
                button.textContent = 'âœ… å·²å„²å­˜';
            } else {
                const result = await response.json();
                alert(`å„²å­˜å¤±æ•—: ${result.message}`);
                button.textContent = 'â­ å„²å­˜ç­–ç•¥';
                button.disabled = false;
            }
        } catch (err) {
            alert(`ç¶²è·¯éŒ¯èª¤: ${err}`);
            button.textContent = 'â­ å„²å­˜ç­–ç•¥';
            button.disabled = false;
        }
    }
    
    async function saveStrategyFromSignalCard(button, strategyData) {
        button.disabled = true;
        button.textContent = 'å„²å­˜ä¸­...';
        try {
            const response = await fetch('/api/strategies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(strategyData)
            });
            const result = await response.json();
            if (result.success) {
                button.textContent = 'âœ… å·²å„²å­˜';
            } else {
                alert('å„²å­˜å¤±æ•—: ' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));
                button.textContent = 'â­ å„²å­˜';
                button.disabled = false;
            }
        } catch (error) {
            alert('å„²å­˜è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
            button.textContent = 'â­ å„²å­˜';
            button.disabled = false;
        }
    }
    
    async function loadSavedStrategies() {
        if (isLoadingStrategies) return;
        isLoadingStrategies = true;
        const container = document.getElementById('strategy-list-container');
        const statusDiv = document.getElementById('strategy-list-status');
        container.innerHTML = '';
        statusDiv.innerHTML = '<div class="loading" style="display:block;"><div class="spinner"></div><p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ç­–ç•¥...</p></div>';
        updateBatchActionButtonsState();

        try {
            const response = await fetch('/api/strategies');
            if (!response.ok) { throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.statusText}`); }
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'ç„¡æ³•ç²å–ç­–ç•¥');
            statusDiv.innerHTML = '';
            if (!result.strategies || result.strategies.length === 0) {
                statusDiv.innerHTML = '<p class="message-box hint-bar">æ‚¨çš„æ¸…å–®ä¸­æ²’æœ‰ä»»ä½•ç­–ç•¥ã€‚</p>';
            } else {
                renderStrategyList(result.strategies);
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="message-box error"><strong>è¼‰å…¥å¤±æ•—:</strong> ${error.message}</div>`;
        } finally {
            isLoadingStrategies = false;
        }
    }

    // === MODIFIED: renderStrategyList reverted to original simpler layout ===
    function renderStrategyList(strategies) {
        const container = document.getElementById('strategy-list-container');
        const cardsHtml = strategies.map(s => {
            const totalReturn = parseFloat(s.total_return);
            const avgTradeReturn = parseFloat(s.avg_trade_return);
            const geneString = JSON.stringify(s.gene);

            return `
            <div class="strategy-list-card" id="strategy-row-${s.id}" data-id="${s.id}" data-ticker="${s.ticker || 'N/A'}">
                <div class="strategy-list-header">
                    <input type="checkbox" class="strategy-select-checkbox" onchange="updateBatchActionButtonsState()">
                    <div class="strategy-list-header-info" onclick="toggleStrategyCard(this.parentElement)">
                        <h3>${s.ticker || 'N/A'}</h3>
                        <p>è¨“ç·´æœŸé–“: ${s.train_start_date || 'N/A'} ~ ${s.train_end_date || 'N/A'}</p>
                    </div>
                    <span class="strategy-list-chevron" onclick="toggleStrategyCard(this.parentElement)">â–¼</span>
                </div>
                <div class="strategy-list-content">
                    <div class="strategy-list-body">
                        <ul class="data-list">
                            <li class="data-list-item"><span class="label">ç¸½å ±é…¬</span><span class="value ${totalReturn > 0 ? 'positive' : 'negative'}">${(totalReturn * 100).toFixed(2)}%</span></li>
                            <li class="data-list-item"><span class="label">å¹³å‡äº¤æ˜“å ±é…¬</span><span class="value ${avgTradeReturn > 0 ? 'positive' : 'negative'}">${(avgTradeReturn * 100).toFixed(3)}%</span></li>
                            <li class="data-list-item"><span class="label">å‹ç‡</span><span class="value">${parseFloat(s.win_rate).toFixed(1)}%</span></li>
                            <li class="data-list-item"><span class="label">æœ€å¤§å›æ’¤</span><span class="value negative">${(parseFloat(s.max_drawdown) * 100).toFixed(2)}%</span></li>
                            <li class="data-list-item"><span class="label">å¤æ™®æ¯”ç‡</span><span class="value">${parseFloat(s.sharpe_ratio || 0).toFixed(2)}</span></li>
                            <li class="data-list-item"><span class="label">äº¤æ˜“æ•¸</span><span class="value">${s.trade_count}</span></li>
                            <li class="data-list-item"><span class="label">æœ€å¤§å–®ç­†ç²åˆ©/è™§æ</span><span class="value">${s.max_trade_extremes || 'N/A'}</span></li>
                        </ul>
                        <div class="description">${s.strategy_details || 'ç„¡è©³ç´°æè¿°'}</div>
                    </div>
                    <div class="strategy-list-footer">
                        <button class="btn-backtest" onclick='quickBacktest(${JSON.stringify(s.ticker)}, ${geneString})'>âš™ï¸ å›æ¸¬</button>
                        <button class="btn-delete" onclick='deleteStrategy(${s.id})'>ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
        container.innerHTML = `<div class="strategy-list">${cardsHtml}</div>`;
    }

    function toggleStrategyCard(headerElement) {
        const content = headerElement.nextElementSibling;
        if (content && content.classList.contains('strategy-list-content')) {
            headerElement.classList.toggle('expanded');
            content.classList.toggle('expanded');
        }
    }

    function quickBacktest(ticker, gene) {
        if (!ticker || !gene) return;
        showPage('page-backtester');
        document.getElementById('manual-ticker').value = ticker;
        document.getElementById('manual-gene').value = JSON.stringify(gene);
        document.getElementById('manual-backtest-results').innerHTML = '<div class="message-box hint-bar">å·²ç‚ºæ‚¨å¡«å…¥ç­–ç•¥è³‡æ–™ï¼Œè«‹é»æ“Šã€Œé–‹å§‹å›æ¸¬ã€ã€‚</div>';
    }

    async function deleteStrategy(strategyId) {
        if (!confirm('æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­–ç•¥å—ï¼Ÿ')) return;
        try {
            const response = await fetch(`/api/strategies/${strategyId}`, { method: 'DELETE' });
            if (response.ok) {
                const row = document.getElementById(`strategy-row-${strategyId}`);
                if (row) {
                    row.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        row.remove();
                        updateBatchActionButtonsState();
                    }, 500);
                }
            } else {
                const result = await response.json();
                alert(`åˆªé™¤å¤±æ•—: ${result.message}`);
            }
        } catch (error) {
            alert(`åˆªé™¤æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: ${error.message}`);
        }
    }

    function updateBatchActionButtonsState() {
        const checkboxes = document.querySelectorAll('#strategy-list-container .strategy-select-checkbox:checked');
        const count = checkboxes.length;
        
        const allocatorBtn = document.getElementById('proceed-allocator-btn');
        const deleteBtn = document.getElementById('batch-delete-btn');
        const countSpan = document.getElementById('selected-strategy-count');
        
        countSpan.textContent = count;
        allocatorBtn.disabled = count === 0;
        deleteBtn.disabled = count === 0;
    }

    // === BATCH DELETE FUNCTION (WITH FIX) ===
    async function batchDeleteStrategies() {
        const checkboxes = document.querySelectorAll('#strategy-list-container .strategy-select-checkbox:checked');
        const count = checkboxes.length;
        if (count === 0) return;

        if (!confirm(`æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ ${count} å€‹é¸å–çš„ç­–ç•¥å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
            return;
        }

        const strategyIds = Array.from(checkboxes).map(cb => parseInt(cb.closest('.strategy-list-card').dataset.id, 10));

        try {
            const response = await fetch('/api/strategies/batch-delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strategy_ids: strategyIds })
            });

            if (response.ok) {
                strategyIds.forEach(id => {
                    const row = document.getElementById(`strategy-row-${id}`);
                    if (row) row.remove();
                });
                updateBatchActionButtonsState();
                if (document.querySelectorAll('#strategy-list-container .strategy-list-card').length === 0) {
                     document.getElementById('strategy-list-status').innerHTML = '<p class="message-box hint-bar">æ‚¨çš„æ¸…å–®ä¸­æ²’æœ‰ä»»ä½•ç­–ç•¥ã€‚</p>';
                }
            } else {
                const result = await response.json();
                alert(`æ‰¹æ¬¡åˆªé™¤å¤±æ•—: ${result.message}`);
            }
        } catch (error) {
            alert(`æ‰¹æ¬¡åˆªé™¤æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: ${error.message}`);
        }
    }

    function proceedToAllocator() {
        const checked = document.querySelectorAll('#strategy-list-container .strategy-select-checkbox:checked');
        selectedStrategiesForAllocation = [];
        const seenTickers = new Set();
        let duplicatesFound = false;

        checked.forEach(checkbox => {
            const card = checkbox.closest('.strategy-list-card');
            const ticker = card.dataset.ticker;
            
            if (seenTickers.has(ticker)) {
                checkbox.checked = false;
                duplicatesFound = true;
            } else {
                seenTickers.add(ticker);
                selectedStrategiesForAllocation.push({
                    id: card.dataset.id,
                    ticker: ticker,
                });
            }
        });

        if (duplicatesFound) {
            alert('å·²ç‚ºæ‚¨è‡ªå‹•å–æ¶ˆé‡è¤‡é¸æ“‡çš„åŒæ”¯è‚¡ç¥¨ç­–ç•¥ã€‚ç³»çµ±æœƒä»¥ç¬¬ä¸€å€‹é¸ä¸­çš„ç‚ºæº–ã€‚');
            updateBatchActionButtonsState();
        }
        
        if(selectedStrategiesForAllocation.length > 0) {
            populateAllocatorPage();
            showPage('page-allocator');
        } else {
             alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ä¸é‡è¤‡çš„ç­–ç•¥ã€‚');
        }
    }

    function populateAllocatorPage() {
        const listContainer = document.getElementById('allocator-strategy-list');
        const startBtn = document.getElementById('start-allocation-btn');

        if (selectedStrategiesForAllocation.length === 0) {
            listContainer.innerHTML = '<p class="message-box hint-bar">è«‹è¿”å›ã€Œæˆ‘çš„ç­–ç•¥ã€é é¢å‹¾é¸ç­–ç•¥ã€‚</p>';
            startBtn.disabled = true;
            return;
        }
        
        startBtn.disabled = false;
        listContainer.innerHTML = selectedStrategiesForAllocation.map(s => `
            <div class="allocator-selected-item" id="allocator-item-${s.id}">
                <strong>${s.ticker}</strong>
                <button class="remove-strategy-btn" onclick="removeStrategyFromAllocator('${s.id}')">&times;</button>
            </div>
        `).join('');
    }

    function removeStrategyFromAllocator(strategyIdToRemove) {
        selectedStrategiesForAllocation = selectedStrategiesForAllocation.filter(s => s.id !== strategyIdToRemove);

        const originalCheckbox = document.querySelector(`#strategy-row-${strategyIdToRemove} .strategy-select-checkbox`);
        if (originalCheckbox) {
            originalCheckbox.checked = false;
        }

        populateAllocatorPage();
        updateBatchActionButtonsState();
        document.getElementById('allocation-results').innerHTML = '';
    }

     async function startAllocation() {
        const btn = document.getElementById('start-allocation-btn');
        const progressContainer = document.getElementById('allocation-loading');
        const progressBar = document.getElementById('allocation-progress-bar-inner');
        const progressText = document.getElementById('allocation-progress-text');
        const resultsDiv = document.getElementById('allocation-results');
        
        if (selectedStrategiesForAllocation.length === 0) {
            showMessage('allocation-results', 'æ²’æœ‰é¸æ“‡ä»»ä½•ç­–ç•¥é€²è¡Œé…ç½®ã€‚', 'error');
            return;
        }

        const riskProfile = document.getElementById('risk-profile').value;
        const strategyIds = selectedStrategiesForAllocation.map(s => s.id);

        btn.disabled = true;
        btn.textContent = 'ğŸ”„ è¨ˆç®—ä¸­...';
        progressContainer.style.display = 'block';
        resultsDiv.innerHTML = '';

        progressBar.style.transition = 'none';
        progressBar.style.width = '0%';
        progressBar.offsetHeight;
        progressBar.style.transition = 'width 16s cubic-bezier(0.25, 0.1, 0.25, 1)';
        progressBar.style.width = '90%';

        const progressMessages = ["åˆ†æç­–ç•¥æ­·å²ç¸¾æ•ˆ...", "AI æ­£åœ¨ç²å–å¸‚å ´æ–°è...", "è©•ä¼°é¢¨éšªåå¥½...", "è¨ˆç®—æœ€ä½³è³‡é‡‘æ¬Šé‡..."];
        let messageIndex = 0;
        progressText.textContent = progressMessages[messageIndex];

        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(() => {
            if (messageIndex < progressMessages.length - 1) {
                messageIndex++;
                progressText.textContent = progressMessages[messageIndex];
            } else {
                clearInterval(progressInterval);
            }
        }, 1800);

        setTimeout(() => {
            clearInterval(progressInterval);
            progressText.textContent = "å³å°‡å®Œæˆ...";
        }, 7500);

        try {
            const response = await fetch('/api/capital-allocation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strategy_ids: strategyIds, risk_profile: riskProfile })
            });

            progressBar.style.transition = 'width 0.5s ease-out';
            progressBar.style.width = '95%';

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
            }

            const result = await response.json();
            if (result.success) {
                renderAllocationResults(result.data);
            } else {
                showMessage('allocation-results', result.message || 'é…ç½®å¤±æ•—', 'error');
            }

        } catch (error) {
            showMessage('allocation-results', `ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
        } finally {
            clearInterval(progressInterval);

            progressBar.style.transition = 'width 0.4s ease-out';
            progressBar.style.width = '100%';
            progressText.textContent = "é…ç½®å®Œæˆï¼";

            setTimeout(() => {
                progressContainer.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'ğŸš€ é–‹å§‹æ™ºèƒ½é…ç½®';
            }, 1000);
        }
    }
    
    const roleDetailsMap = {
        'æ ¸å¿ƒå¢é•·': { icon: 'ğŸš€', cssClass: 'role-growth', color: '#22c55e' },
        'ç©©å®šåŸºçŸ³': { icon: 'ğŸ›¡ï¸', cssClass: 'role-stable', color: '#3b82f6' },
        'è¡›æ˜Ÿé…ç½®': { icon: 'ğŸ›°ï¸', cssClass: 'role-satellite', color: '#f59e0b' },
        'æœªçŸ¥è§’è‰²': { icon: 'ğŸ’¼', cssClass: 'role-stable', color: '#a0aec0' }
    };

    function renderAllocationResults(data) {
        const resultsDiv = document.getElementById('allocation-results');
        
        if (!data || !data.allocations || data.allocations.length === 0) {
            resultsDiv.innerHTML = '<p class="message-box error">ç„¡æ³•ç”Ÿæˆé…ç½®å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            return;
        }

        const allocations = data.allocations;
        const reasoning = data.reasoning;
        const overallSummary = reasoning.overall_summary;
        const perStockAnalysis = reasoning.per_stock_analysis;

        const summaryHtml = `
            <div class="message-box hint-bar" style="margin-bottom: 20px;">
                <h4 style="margin-bottom:8px; color: #90cdf4;">ğŸ’¡ æ•´é«”ç­–ç•¥ç¸½çµ</h4>
                <p style="font-size: 0.95rem; line-height: 1.7; color: var(--text-secondary);">${overallSummary}</p>
            </div>
        `;
        
        const allocationCardsHtml = allocations.map(alloc => {
            const percentage = alloc.percentage;
            const ticker = alloc.ticker;
            const analysis = perStockAnalysis.find(a => a.ticker === ticker) || {};
            const roleName = analysis.role_in_portfolio || 'æœªçŸ¥è§’è‰²';
            const roleStyle = roleDetailsMap[roleName] || roleDetailsMap['æœªçŸ¥è§’è‰²'];
            const justification = analysis.justification || "ç„¡è©³ç´°åˆ†æã€‚";

            return `
            <div class="allocation-item-card" style="border-left-color: ${roleStyle.color};">
                <div class="allocation-item-header">
                    <div>
                        <div class="ticker">${ticker}</div>
                        <div class="allocation-role ${roleStyle.cssClass}">
                           ${roleStyle.icon} <span>${roleName}</span>
                        </div>
                    </div>
                    <div class="percentage">${percentage}%</div>
                </div>
                <div class="allocator-result-bar-container">
                    <div class="allocator-result-bar" data-percentage="${percentage}" style="width: 0;"></div>
                </div>
                <p class="allocation-justification">${justification}</p>
            </div>
            `;
        }).join('');

        const finalHtml = `
            <div class="result-card">
                <div class="result-header"><h3>ğŸ“Š è³‡é‡‘é…ç½®å»ºè­°</h3></div>
                <div class="result-body">
                    ${summaryHtml}
                    <div class="allocation-grid">
                        ${allocationCardsHtml}
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.innerHTML = finalHtml;

        setTimeout(() => {
            document.querySelectorAll('.allocator-result-bar').forEach(bar => {
                const targetWidth = bar.dataset.percentage;
                bar.style.width = `${targetWidth}%`;
            });
        }, 100);
    }
    
    async function lookupStrategy() {
        const btn = document.getElementById('lookup-btn');
        const ticker = document.getElementById('lookup-ticker').value.trim();
        const resultsContainer = document.getElementById('lookup-results-container');

        if (!ticker) {
            resultsContainer.innerHTML = `<div class="message-box error">è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚</div>`;
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `<div class="spinner" style="width:20px; height:20px; border-width:3px; margin: 0 auto;"></div>`;
        resultsContainer.innerHTML = `<div class="loading" style="display:block;"><p>æ­£åœ¨æŸ¥è©¢è³‡æ–™åº«...</p></div>`;

        try {
            const response = await fetch(`/api/lookup-strategy?ticker=${encodeURIComponent(ticker)}`);
            const result = await response.json();

            if (result.success) {
                if (result.found) {
                    renderLookupResults(result.strategies);
                } else {
                    resultsContainer.innerHTML = `<div class="message-box hint-bar">${result.message}</div>`;
                }
            } else {
                resultsContainer.innerHTML = `<div class="message-box error">${result.message}</div>`;
            }
        } catch (error) {
            resultsContainer.innerHTML = `<div class="message-box error">æŸ¥è©¢æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤: ${error.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ” é–‹å§‹æŸ¥è©¢';
        }
    }

    function renderLookupResults(strategies) {
        const resultsContainer = document.getElementById('lookup-results-container');
        let html = '';

        strategies.forEach(strategy => {
            const metrics = strategy.metrics;
            const strategyData = strategy; 
            
            html += `
            <div class="result-card" data-strategy-json='${JSON.stringify(strategyData)}'>
                <div class="result-header">
                    <h3>${strategy.strategy_type_name}</h3>
                    <div style="font-size:0.8rem; color: var(--text-secondary);">è¨“ç·´æœŸé–“: ${strategy.train_start_date} ~ ${strategy.train_end_date}</div>
                </div>
                <div class="result-body">
                    <div class="data-list-grid">
                        <div class="data-list-item"><span class="label">ç¸½å ±é…¬ç‡</span><span class="value positive">${(metrics.total_return * 100).toFixed(2)}%</span></div>
                        <div class="data-list-item"><span class="label">å‹ç‡</span><span class="value positive">${(metrics.win_rate_pct || 0).toFixed(1)}%</span></div>
                        <div class="data-list-item"><span class="label">å¹³å‡äº¤æ˜“å ±é…¬</span><span class="value positive">${(metrics.average_trade_return * 100).toFixed(3)}%</span></div>
                        <div class="data-list-item"><span class="label">æœ€å¤§å›æ’¤</span><span class="value negative">${(metrics.max_drawdown * 100).toFixed(2)}%</span></div>
                        <div class="data-list-item"><span class="label">å¤æ™®æ¯”ç‡</span><span class="value">${(metrics.sharpe_ratio || 0).toFixed(2)}</span></div>
                        <div class="data-list-item"><span class="label">äº¤æ˜“æ¬¡æ•¸</span><span class="value">${metrics.trade_count || 0}</span></div>
                        <div class="data-list-item" style="grid-column: 1 / -1;">
                            <span class="label">æœ€å¤§å–®ç­†ç²åˆ©/è™§æ</span>
                            <span class="value">
                                <span class="positive">${(metrics.max_trade_gain_pct || 0).toFixed(2)}%</span> / <span class="negative">${(metrics.max_trade_drop_pct || 0).toFixed(2)}%</span>
                            </span>
                        </div>
                    </div>
                    <div class="description">${strategy.strategy_details}</div>
                    <div style="margin-top:16px;">
                        <button class="btn" onclick='saveStrategyFromLookup(this)'>â­ åŠ å…¥æˆ‘çš„æ¸…å–®</button>
                    </div>
                </div>
            </div>`;
        });
        resultsContainer.innerHTML = html;
    }

    async function saveStrategyFromLookup(button) {
        const card = button.closest('.result-card');
        const strategyData = JSON.parse(card.dataset.strategyJson);
        button.textContent = 'å„²å­˜ä¸­...';
        button.disabled = true;
        try {
            const response = await fetch('/api/strategies', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(strategyData)
            });
            if(response.ok) {
                button.textContent = 'âœ… å·²åŠ å…¥æ¸…å–®';
            } else {
                const result = await response.json();
                alert(`åŠ å…¥å¤±æ•—: ${result.message}`);
                button.textContent = 'â­ åŠ å…¥æˆ‘çš„æ¸…å–®';
                button.disabled = false;
            }
        } catch (err) {
            alert(`ç¶²è·¯éŒ¯èª¤: ${err}`);
            button.textContent = 'â­ åŠ å…¥æˆ‘çš„æ¸…å–®';
            button.disabled = false;
        }
    }

    async function loadStrategySignals() {
        const market = document.getElementById('market-select').value;
        const signalType = document.querySelector('input[name="signal_type"]:checked').value;
        const loadingDiv = document.getElementById('signals-loading');
        const resultsDiv = document.getElementById('signals-results');

        loadingDiv.style.display = 'block';
        resultsDiv.innerHTML = '';

        try {
            const response = await fetch(`/api/strategy-signals?market=${market}&type=${signalType}`);
            const result = await response.json();
            if (result.success) {
                displayStrategySignals(result.data);
            } else {
                showMessage('signals-results', result.message || 'ç­–ç•¥ä¿¡è™Ÿæœå°‹å¤±æ•—', 'error');
            }
        } catch (error) {
            showMessage('signals-results', 'ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function displayStrategySignals(data) {
        const container = document.getElementById('signals-results');
        if (!data || data.length === 0) {
            container.innerHTML = `<div class="message-box hint-bar">ğŸ¯ ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç­–ç•¥ä¿¡è™Ÿ</div>`;
            return;
        }
        let html = '<div id="signals-grid">';
        data.forEach(signal => {
            const metrics = {
                win_rate_pct: signal.win_rate,
                total_return: signal.return_pct / 100,
                trade_count: signal.total_trades,
                average_trade_return: signal.average_trade_return_pct / 100,
                max_drawdown: signal.max_drawdown_pct / 100,
                sharpe_ratio: signal.sharpe_ratio || 0.0,
                max_trade_drop_pct: signal.max_trade_drop_pct,
                max_trade_gain_pct: signal.max_trade_gain_pct,
            };

            let parsedGene = [];
            try {
                if (signal.ai_strategy_gene) {
                    parsedGene = JSON.parse(signal.ai_strategy_gene);
                }
            } catch(e) {
                console.error('è§£æä¿¡è™Ÿç­–ç•¥åŸºå› å¤±æ•—:', signal.ai_strategy_gene, e);
            }

            const payload = {
                ticker: signal.stock_ticker,
                train_start_date: signal.game_start_date,
                train_end_date: signal.game_end_date,
                gene: parsedGene,
                strategy_details: signal.strategy_details,
                metrics: metrics
            };

            const returnColorClass = parseFloat(signal.return_pct) >= 0 ? 'positive' : 'negative';
            const avgReturnColorClass = parseFloat(signal.average_trade_return_pct) >= 0 ? 'positive' : 'negative';
            
            let price_html = '';
            if (signal.buy_price !== null) price_html += `<div class="signal-price signal-buy">è²·å…¥åƒ¹æ ¼: ${formatNumber(signal.buy_price)}</div>`;
            if (signal.sell_price !== null) price_html += `<div class="signal-price signal-sell">è³£å‡ºåƒ¹æ ¼: ${formatNumber(signal.sell_price)}</div>`;
            const cleanReason = signal.signal_reason.replace(/ğŸŸ¢|ğŸ”´|è²·å…¥:|è³£å‡º:/g, '').trim();

            html += `
            <div class="signal-card">
                <div class="signal-card-header">
                    <div class="ticker">${signal.stock_ticker}</div>
                    <button class="btn" style="padding: 6px 14px; font-size: 0.8rem; width: auto;" onclick='saveStrategyFromSignalCard(this, ${JSON.stringify(payload)})'>â­ å„²å­˜</button>
                </div>
                <div class="signal-card-body">
                    <p>${cleanReason}</p>
                    ${price_html}
                </div>
                <div class="signal-card-footer">
                    <span>ç¸¾æ•ˆ: <span class="value ${returnColorClass}">${formatPercent(signal.return_pct)}</span></span>
                    <span>å¹³å‡å ±é…¬: <span class="value ${avgReturnColorClass}">${formatPercent(signal.average_trade_return_pct, 2)}</span></span>
                    <span>å‹ç‡: <span class="value">${formatPercent(signal.win_rate)}</span></span>
                    
                </div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }
</script>
</body>
</html>
