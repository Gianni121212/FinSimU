<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockSimU - Trade Stocks</title>
    <style>
        /* ============================================= */
        /*                CSS 規則開始                  */
        /* ============================================= */

        /* 全局樣式和佈局基礎 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f0f2f5;
            color: #1f2937;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .page-container {
            display: flex;
            width: 100%;
        }

        /* --- 側邊欄樣式 --- */
        .sidebar {
            width: 260px;
            background-color: #ffffff;
            padding: 25px 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            box-sizing: border-box;
            z-index: 10;
        }

        .sidebar-header { display: flex; align-items: center; margin-bottom: 35px; padding-left: 5px; }
        .logo-img { width: 36px; height: 36px; border-radius: 6px; margin-right: 12px; }
        .app-title { font-size: 22px; color: #1e40af; font-weight: 700; margin: 0; }
        .sidebar-nav ul { list-style-type: none; padding: 0; margin: 0; }
        .sidebar-nav .nav-item a { display: flex; align-items: center; padding: 12px 15px; color: #4b5563; text-decoration: none; border-radius: 6px; margin-bottom: 8px; transition: background-color 0.2s ease, color 0.2s ease; font-size: 15px; font-weight: 500; }
        .sidebar-nav .nav-item .nav-icon { margin-right: 12px; color: #6b7280; transition: color 0.2s ease; }
        .sidebar-nav .nav-item a:hover { background-color: #f3f4f6; color: #1e40af; }
        .sidebar-nav .nav-item a:hover .nav-icon { color: #1e40af; }
        .sidebar-nav .nav-item.active a { background-color: #e0e7ff; color: #3b82f6; font-weight: 600; }
        .sidebar-nav .nav-item.active .nav-icon { color: #3b82f6; }
        .sidebar-user-profile { margin-top: auto; padding: 20px 10px; border-top: 1px solid #e5e7eb; display: flex; align-items: center; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .user-details { display: flex; flex-direction: column; line-height: 1.3; }
        .user-name { font-size: 14px; font-weight: 600; color: #1f2937; }
        .user-status { font-size: 12px; color: #6b7280; }
        .sidebar-footer { padding: 15px 10px; border-top: 1px solid #e5e7eb; }
        .footer-link { display: flex; align-items: center; color: #4b5563; text-decoration: none; font-size: 14px; padding: 8px 5px; border-radius: 6px; transition: background-color 0.2s ease, color 0.2s ease; }
        .footer-link:hover { background-color: #f3f4f6; color: #1f2937; }
        .footer-link .nav-icon { margin-right: 10px; }

        /* --- 主內容區樣式 (Trade Stocks Page) --- */
        .trade-main-content {
            flex-grow: 1;
            padding: 25px 30px;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
            box-sizing: border-box;
        }

        .trade-header { margin-bottom: 20px; }
        .trade-header h1 { font-size: 26px; font-weight: 700; color: #111827; margin: 0 0 6px 0; }
        .trade-header p { font-size: 14px; color: #6b7280; margin: 0; max-width: 700px; }

        .search-bar-container { margin-bottom: 20px; background-color: #ffffff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input-wrapper { position: relative; display: flex; align-items: center; }
        .search-input-wrapper .search-icon { position: absolute; left: 12px; color: #9ca3af; }
        .search-input-wrapper input[type="text"] { width: 100%; padding: 10px 12px 10px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .search-input-wrapper input[type="text"]:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .trading-interface {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* --- 左側: 股票列表區域 --- */
        .stock-list-panel {
            width: 330px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            padding: 8px;
        }

        .stock-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.15s ease; }
        .stock-item:last-child { border-bottom: none; }
        .stock-item:hover { background-color: #f9fafb; }
        .stock-item.selected { background-color: #eff6ff; border-left: 3px solid #3b82f6; padding-left: 7px;}

        .stock-info { flex-grow: 1; }
        .stock-info .name { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-info .ticker { font-size: 12px; color: #6b7280; }
        .stock-price-info { text-align: right; }
        .stock-price-info .price { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-price-info .change { font-size: 12px; }
        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }


        /* --- 右側: 股票詳情與交易區域 --- */
        .stock-details-panel {
            flex-grow: 1;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 20px 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .stock-details-content.hidden { display: none; }


        .detail-header { display: flex; align-items: center; margin-bottom: 20px; }
        .detail-name-ticker .name { font-size: 20px; font-weight: 600; color: #111827; margin: 0 0 3px 0; }
        .detail-name-ticker .price-shares { font-size: 14px; color: #6b7280; }
        #current-stock-price { font-weight: 500; }
        #owned-shares { font-weight: 500; }


        .trade-actions-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .trade-tab { flex: 1; text-align: center; padding: 12px 10px; cursor: pointer; font-size: 15px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease; background-color: #f9fafb; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .trade-tab:not(:last-child) { border-right: 1px solid #e5e7eb; }
        .trade-tab:hover { color: #374151; background-color: #f3f4f6; }
        .trade-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background-color: #ffffff; border-right-color: transparent; }
        .trade-tab.active + .trade-tab { border-left-color: transparent; }


        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 5px; }
        .form-group input[type="number"], .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            background-color: #fff;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            font-family: inherit; /* Ensure textarea uses the same font */
        }
        .form-group textarea {
            min-height: 70px; /* Set a minimum height for textarea */
            resize: vertical; /* Allow vertical resizing */
        }
        .form-group input[type="number"]:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.1em; padding-right: 2.5rem; }
        .form-group select option { padding: 8px 12px; }


        .trade-summary { margin-top: 15px; margin-bottom: 20px; font-size: 13px; color: #4b5563; }
        .trade-summary div { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .trade-summary span:last-child { font-weight: 500; color: #1f2937; }

        .submit-trade-button { width: 100%; background-color: #10b981; color: white; padding: 12px; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; }
        .submit-trade-button.sell { background-color: #ef4444; }
        .submit-trade-button:hover { opacity: 0.9; }

        .trade-note { font-size: 11px; color: #6b7280; margin-top: 15px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .trade-note svg { flex-shrink: 0; margin-top: 1px;}


        /* --- 輔助樣式 --- */
        .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mb-6 { margin-bottom: 1.5rem; }


        /* Placeholder if no stock selected */
        .no-stock-selected-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: #9ca3af; }
        .no-stock-selected-placeholder.hidden { display: none; }
        .no-stock-selected-placeholder svg { margin-bottom: 15px; }
        .no-stock-selected-placeholder p { font-size: 15px; }

        /* ============================================= */
        /*                CSS 規則結束                  */
        /* ============================================= */
    </style>
</head>
<body>
    <div class="page-container">
        <!-- 側邊欄 (Sidebar) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="https://placehold.co/36x36/1e40af/white?text=SU" alt="StockSimU Logo" class="logo-img">
                <h1 class="app-title">StockSimU</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item"><a href="dashboard.html"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>Dashboard</span></a></li>
                    <li class="nav-item active"><a href="#"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M16.83 11.295l-2.121-2.121a1 1 0 00-1.414 0L9.707 12.76a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l3.586-3.586a1 1 0 000-1.414zM5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm13 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM8 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg><span>Trade Stocks</span></a></li>
                    <li class="nav-item"><a href="my_portfolio.html"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 11H8v-2h4v2zm4-3H8V9h8v3zm0-4h-2V6h2v2z"/></svg><span>My Portfolio</span></a></li>
                    <li class="nav-item"><a href="ai_reports.html"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8-4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm0-4H7V7h10v2z"/></svg><span>AI Reports</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-user-profile"><img src="https://placehold.co/32x32/7c3aed/white?text=Q" alt="User qqq" class="user-avatar"><div class="user-details"><span class="user-name">qqq</span><span class="user-status">Conservative</span></div></div>
            <div class="sidebar-footer"><a href="#" class="footer-link"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg><span>Reset & Logout</span></a></div>
        </aside>

        <!-- 主內容區 (Trade Stocks Main Content) -->
        <main class="trade-main-content">
            <div class="trade-header">
                <h1>Stock Trading Terminal</h1>
                <p>Search for stocks, view market data, and place your virtual trades.</p>
            </div>

            <div class="search-bar-container">
                <div class="search-input-wrapper">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                    <input type="text" id="stock-search-input" placeholder="Search stocks by name or ticker (e.g., AAPL, Apple)">
                </div>
            </div>

            <div class="trading-interface">
                <aside class="stock-list-panel" id="stock-list-panel">
                    <div class="stock-item" data-ticker="AAPL" data-name="Apple Inc." data-price="170.34" data-change="0.50" data-change-type="positive">
                        <div class="stock-info"><span class="name">Apple Inc.</span><span class="ticker">AAPL</span></div>
                        <div class="stock-price-info"><span class="price">$170.34</span><span class="change text-green-600">↗ 0.50%</span></div>
                    </div>
                    <div class="stock-item" data-ticker="MSFT" data-name="Microsoft Corp." data-price="420.72" data-change="-0.20" data-change-type="negative">
                        <div class="stock-info"><span class="name">Microsoft Corp.</span><span class="ticker">MSFT</span></div>
                        <div class="stock-price-info"><span class="price">$420.72</span><span class="change text-red-600">↘ -0.20%</span></div>
                    </div>
                    <div class="stock-item" data-ticker="GOOGL" data-name="Alphabet Inc. (A)" data-price="155.22" data-change="1.10" data-change-type="positive">
                        <div class="stock-info"><span class="name">Alphabet Inc. (A)</span><span class="ticker">GOOGL</span></div>
                        <div class="stock-price-info"><span class="price">$155.22</span><span class="change text-green-600">↗ 1.10%</span></div>
                    </div>
                </aside>

                <section class="stock-details-panel">
                    <div id="stock-details-content" class="stock-details-content hidden">
                        <div class="detail-header">
                            <div class="detail-name-ticker">
                                <h2 class="name" id="detail-stock-name">Stock Name (TICKER)</h2>
                                <p class="price-shares">
                                    Current Price: <span id="current-stock-price">$0.00</span>
                                      |   You own: <span id="owned-shares">0</span> shares
                                </p>
                            </div>
                        </div>

                        <div class="trade-actions-tabs">
                            <button class="trade-tab active" id="buy-tab" onclick="switchTab('buy')">Buy STOCK</button>
                            <button class="trade-tab" id="sell-tab" onclick="switchTab('sell')">Sell STOCK</button>
                        </div>

                        <form id="trade-form">
                            <div class="form-group">
                                <label for="shares-input">Number of Shares</label>
                                <input type="number" id="shares-input" name="shares" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="mood-select">Your Mood (at time of trade)</label>
                                <select id="mood-select" name="mood">
                                    <option value="">Select your current mood</option>
                                    <option value="excited">🥳 Excited</option>
                                    <option value="confident">😎 Confident</option>
                                    <option value="neutral">😐 Neutral</option>
                                    <option value="anxious">😟 Anxious</option>
                                    <option value="fearful">😨 Fearful (FOMO/FUD)</option>
                                    <option value="impulsive">⚡️ Impulsive</option>
                                </select>
                            </div>
                            <!-- New Textarea for Reason -->
                            <div class="form-group">
                                <label for="reason-input">Reason for Trade (Optional)</label>
                                <textarea id="reason-input" name="reason" rows="3" placeholder="e.g., Strong earnings report, technical breakout, diversification..."></textarea>
                            </div>

                            <div class="trade-summary">
                                <div><span id="summary-cost-label">Total Cost (Est.):</span> <span id="summary-total-cost">$0.00</span></div>
                                <div><span id="summary-balance-label">Cash Balance after Trade:</span> <span id="summary-cash-after-trade">$0.00</span></div>
                            </div>

                            <button type="submit" class="submit-trade-button" id="submit-trade-btn">Buy Shares</button>
                        </form>
                        <p class="trade-note">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="14" height="14"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm8-4a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V4.75A.75.75 0 018 4zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                            Prices are indicative. Trades execute at current market price.
                        </p>
                    </div>
                    <div class="no-stock-selected-placeholder" id="no-stock-selected-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="48" height="48"><path d="M11.25 3A1.25 1.25 0 0010 4.25V8.5h-3.75a.75.75 0 000 1.5h3.75V12a2.25 2.25 0 002.25 2.25h3A2.25 2.25 0 0017.75 12V9.75H19a.75.75 0 000-1.5h-1.25V4.25A1.25 1.25 0 0016.5 3h-5.25zm1.5 3.75V8.5h2.25V6.75h-2.25zm-3 6V20.75A1.25 1.25 0 0011.25 22H16a.75.75 0 000-1.5h-4.75V12.75h-1.5zM3.5 6.75A.75.75 0 014.25 6H7.5V4.25A1.25 1.25 0 006.25 3h-3A1.25 1.25 0 002 4.25v15.5A1.25 1.25 0 003.25 21h3A1.25 1.25 0 007.5 19.75V17H6a.75.75 0 000 1.5h1.5V21A2.75 2.75 0 0010.75 24h6.5A2.75 2.75 0 0020 21.25V3.75A2.75 2.75 0 0017.25 1H6.75A2.75 2.75 0 004 3.75v1.5H1.25a.75.75 0 000 1.5H4V6.75z" /></svg>
                        <p>Select a stock from the list to view details and trade.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- Global State / Data (Simulated) ---
        let currentSelectedStock = null;
        let userCashBalance = 100000;
        let userPortfolio = {};

        // --- DOM Elements ---
        const stockListPanel = document.getElementById('stock-list-panel');
        const stockDetailsContent = document.getElementById('stock-details-content');
        const noStockPlaceholder = document.getElementById('no-stock-selected-placeholder');
        const detailStockNameEl = document.getElementById('detail-stock-name');
        const currentStockPriceEl = document.getElementById('current-stock-price');
        const ownedSharesEl = document.getElementById('owned-shares');
        const buyTab = document.getElementById('buy-tab');
        const sellTab = document.getElementById('sell-tab');
        const sharesInput = document.getElementById('shares-input');
        const moodSelect = document.getElementById('mood-select');
        const reasonInput = document.getElementById('reason-input'); // New element
        const tradeForm = document.getElementById('trade-form');
        const submitTradeBtn = document.getElementById('submit-trade-btn');
        const summaryCostLabel = document.getElementById('summary-cost-label');
        const summaryTotalCostEl = document.getElementById('summary-total-cost');
        const summaryBalanceLabel = document.getElementById('summary-balance-label');
        const summaryCashAfterTradeEl = document.getElementById('summary-cash-after-trade');

        function formatCurrency(amount) { return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }
        function showNoStockSelected() { stockDetailsContent.classList.add('hidden'); noStockPlaceholder.classList.remove('hidden'); }
        function showStockDetails() { stockDetailsContent.classList.remove('hidden'); noStockPlaceholder.classList.add('hidden'); }

        function updateTradeSummary() {
            if (!currentSelectedStock) return;
            const shares = parseInt(sharesInput.value) || 0;
            const price = parseFloat(currentSelectedStock.price);
            const totalCost = shares * price;
            const isBuying = !submitTradeBtn.classList.contains('sell');
            summaryTotalCostEl.textContent = formatCurrency(totalCost);
            if (isBuying) {
                summaryCostLabel.textContent = 'Total Cost (Est.):';
                summaryBalanceLabel.textContent = 'Cash Balance after Buy:';
                summaryCashAfterTradeEl.textContent = formatCurrency(userCashBalance - totalCost);
            } else {
                summaryCostLabel.textContent = 'Total Proceeds (Est.):';
                summaryBalanceLabel.textContent = 'Cash Balance after Sell:';
                summaryCashAfterTradeEl.textContent = formatCurrency(userCashBalance + totalCost);
            }
        }

        function switchTab(tabType) {
            if (!currentSelectedStock) return;
            const stockTicker = currentSelectedStock.ticker;
            const isBuying = tabType === 'buy';
            buyTab.classList.toggle('active', isBuying);
            sellTab.classList.toggle('active', !isBuying);
            submitTradeBtn.textContent = isBuying ? `Buy Shares` : `Sell Shares`;
            submitTradeBtn.classList.toggle('sell', !isBuying);
            buyTab.textContent = `Buy ${stockTicker}`;
            sellTab.textContent = `Sell ${stockTicker}`;
            updateTradeSummary();
        }

        stockListPanel.addEventListener('click', function(event) {
            const stockItem = event.target.closest('.stock-item');
            if (!stockItem) return;
            const currentlySelected = stockListPanel.querySelector('.stock-item.selected');
            if (currentlySelected) { currentlySelected.classList.remove('selected'); }
            stockItem.classList.add('selected');
            currentSelectedStock = {
                name: stockItem.dataset.name,
                ticker: stockItem.dataset.ticker,
                price: parseFloat(stockItem.dataset.price),
            };
            detailStockNameEl.textContent = `${currentSelectedStock.name} (${currentSelectedStock.ticker})`;
            currentStockPriceEl.textContent = formatCurrency(currentSelectedStock.price);
            ownedSharesEl.textContent = userPortfolio[currentSelectedStock.ticker]?.shares || 0;
            showStockDetails();
            switchTab('buy');
            sharesInput.value = 1;
            moodSelect.value = ""; // Reset mood
            reasonInput.value = ""; // Reset reason
            updateTradeSummary();
        });

        sharesInput.addEventListener('input', updateTradeSummary);
        sharesInput.addEventListener('change', updateTradeSummary);

        tradeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            if (!currentSelectedStock) { alert("Please select a stock first."); return; }
            const shares = parseInt(sharesInput.value);
            const mood = moodSelect.value;
            const reason = reasonInput.value.trim(); // Get the reason
            const isBuying = !submitTradeBtn.classList.contains('sell');
            const stockPrice = currentSelectedStock.price;
            const totalTransactionValue = shares * stockPrice;

            if (shares <= 0) { alert("Number of shares must be greater than 0."); return; }
            if (!mood) { alert("Please select your mood for this trade."); return; }
            // Reason is optional, so no validation for it being empty

            let alertMessage = `Successfully ${isBuying ? 'bought' : 'sold'} ${shares} share(s) of ${currentSelectedStock.ticker}. Mood: ${mood}.`;
            if (reason) {
                alertMessage += ` Reason: ${reason}.`;
            } else {
                alertMessage += ` No reason provided.`;
            }


            if (isBuying) {
                if (totalTransactionValue > userCashBalance) { alert("Not enough cash balance."); return; }
                userCashBalance -= totalTransactionValue;
                if (userPortfolio[currentSelectedStock.ticker]) {
                    const existingShares = userPortfolio[currentSelectedStock.ticker].shares;
                    const existingAvgCost = userPortfolio[currentSelectedStock.ticker].avgCost;
                    userPortfolio[currentSelectedStock.ticker].avgCost = ((existingAvgCost * existingShares) + totalTransactionValue) / (existingShares + shares);
                    userPortfolio[currentSelectedStock.ticker].shares += shares;
                } else {
                    userPortfolio[currentSelectedStock.ticker] = { shares: shares, avgCost: stockPrice };
                }
            } else {
                const owned = userPortfolio[currentSelectedStock.ticker]?.shares || 0;
                if (shares > owned) { alert(`You don't own enough shares. You own ${owned}.`); return; }
                userCashBalance += totalTransactionValue;
                userPortfolio[currentSelectedStock.ticker].shares -= shares;
                if (userPortfolio[currentSelectedStock.ticker].shares === 0) { delete userPortfolio[currentSelectedStock.ticker]; }
            }
            alert(alertMessage); // Show alert with mood and reason
            ownedSharesEl.textContent = userPortfolio[currentSelectedStock.ticker]?.shares || 0;
            updateTradeSummary();
            reasonInput.value = ""; // Clear reason input after successful trade
            console.log("Updated Portfolio:", userPortfolio);
            console.log("Updated Cash Balance:", userCashBalance);
        });

        document.addEventListener('DOMContentLoaded', () => {
            const preSelectedStockItem = stockListPanel.querySelector('.stock-item.selected');
            if (preSelectedStockItem) {
                preSelectedStockItem.click();
            } else {
                const firstStock = stockListPanel.querySelector('.stock-item'); // Try to select first if none pre-selected
                if (firstStock) {
                    firstStock.click();
                } else {
                    showNoStockSelected();
                }
            }
        });
    </script>
</body>
</html>