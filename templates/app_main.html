<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSimU - 主控台</title>

    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <!-- 你可以根據需要添加更多尺寸的 apple-touch-icon -->
    <!-- 例如: <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon-180x180.png') }}"> -->


    <style>
        /* ============================================= */
        /*                Global CSS Start               */
        /* ============================================= */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f0f2f5;
            color: #1f2937;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .page-container { display: flex; width: 100%; }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 260px; background-color: #ffffff; padding: 25px 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            height: 100vh; position: fixed; left: 0; top: 0;
            transform: translateX(0); /* For RWD transition */
            transition: transform 0.3s ease-in-out; /* For RWD transition */
            overflow-y: auto; box-sizing: border-box; z-index: 1001; /* Ensure sidebar is on top */
        }
        /* RWD: Sidebar hidden by default on small screens */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }

        .sidebar-header { display: flex; align-items: center; margin-bottom: 35px; padding-left: 5px; justify-content: space-between;} /* Changed to space-between */
        .logo-img { width: 36px; height: 36px; border-radius: 6px; margin-right: 12px; }
        .app-title { font-size: 22px; color: #1e40af; font-weight: 700; margin: 0; }
        
        /* Hamburger Icon for RWD */
        .hamburger-menu {
            display: none; /* Hidden by default */
            cursor: pointer;
            padding: 10px;
            z-index: 1002; /* Above sidebar */
            position: fixed; /* Or absolute relative to main-content-view */
            top: 15px;
            left: 15px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hamburger-menu svg { width: 24px; height: 24px; color: #3b82f6;}

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
        }
        /* Close button inside sidebar for RWD */
        .sidebar-close-button {
            display: none; /* Hidden by default */
            background: none; border: none; font-size: 24px; color: #6b7280;
            cursor: pointer; padding: 5px; align-self: flex-end; /* Position to the right */
        }
        @media (max-width: 768px) {
            .sidebar-close-button {
                display: block;
            }
        }


        .sidebar-nav ul { list-style-type: none; padding: 0; margin: 0; }
        .sidebar-nav .nav-item a {
            display: flex; align-items: center; padding: 12px 15px; color: #4b5563;
            text-decoration: none; border-radius: 6px; margin-bottom: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 15px; font-weight: 500;
        }
        .sidebar-nav .nav-item .nav-icon { margin-right: 12px; color: #6b7280; transition: color 0.2s ease; width: 20px; height:20px; flex-shrink: 0; }
        .sidebar-nav .nav-item a:hover { background-color: #f3f4f6; color: #1e40af; }
        .sidebar-nav .nav-item a:hover .nav-icon { color: #1e40af; }
        .sidebar-nav .nav-item.active a { background-color: #e0e7ff; color: #3b82f6; font-weight: 600; }
        .sidebar-nav .nav-item.active .nav-icon { color: #3b82f6; }
        .sidebar-user-profile {
            margin-top: auto; padding: 20px 10px; border-top: 1px solid #e5e7eb;
            display: flex; align-items: center;
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .user-details { display: flex; flex-direction: column; line-height: 1.3; }
        .user-name { font-size: 14px; font-weight: 600; color: #1f2937; }
        .user-status { font-size: 12px; color: #6b7280; }
        .sidebar-footer { padding: 15px 10px; border-top: 1px solid #e5e7eb; }
        .footer-link {
            display: flex; align-items: center; color: #4b5563; text-decoration: none;
            font-size: 14px; padding: 8px 5px; border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .footer-link:hover { background-color: #f3f4f6; color: #1f2937; }
        .footer-link .nav-icon { margin-right: 10px; width: 18px; height: 18px; flex-shrink: 0;}

        .main-content-view {
            flex-grow: 1; padding: 25px 30px; margin-left: 260px; /* Default margin */
            display: flex; flex-direction: column; max-height: 100vh;
            box-sizing: border-box; overflow-y: auto;
            transition: margin-left 0.3s ease-in-out; /* For RWD transition */
        }
        /* RWD: Main content full width when sidebar is closed */
        @media (max-width: 768px) {
            .main-content-view {
                margin-left: 0;
                padding: 25px 15px; /* Adjust padding for smaller screens */
            }
        }

        .view-section { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        .page-header { margin-bottom: 25px; }
        .page-header h1 { font-size: 26px; font-weight: 700; color: #111827; margin: 0 0 6px 0; }
        .page-header p.subtitle { font-size: 14px; color: #6b7280; margin: 0; }
        @media (max-width: 768px) {
            .page-header h1 { font-size: 22px; }
            .page-header p.subtitle { font-size: 13px; }
        }


        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .font-semibold { font-weight: 600; }

        /* --- Dashboard CSS --- */
        .summary-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { /* On very small screens, make cards stack */
            .summary-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        .summary-card { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .summary-card .label { font-size: 14px; color: #6b7280; margin-bottom: 8px; display: block;}
        .summary-card .value { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 5px;}
        .summary-card .sub-text { font-size: 13px; color: #4b5563; }
        .quick-actions-section { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .quick-actions-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .quick-action-button, .action-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px 10px; background-color: #f9fafb; border: 1px solid #e5e7eb;
            border-radius: 8px; font-size: 14px; font-weight: 500; color: #374151;
            cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            text-align: center; gap: 8px;
        }
        .action-button { flex-direction: row; width: auto; padding: 10px 20px;}
        .quick-action-button svg, .action-button svg { color: #3b82f6; width: 20px; height: 20px; }
        .action-button svg {width: 16px; height:16px;}
        .quick-action-button:hover, .action-button:hover:not(:disabled) { background-color: #eff6ff; border-color: #bfdbfe; transform: translateY(-2px); }
        .quick-action-button:active, .action-button:active:not(:disabled) { transform: translateY(0px); }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: translateY(0px); opacity: 0.7;}

        .recent-activity-container { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .recent-activity-container h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }

        /* --- Trade Stocks CSS --- */
        .trade-header { margin-bottom: 20px; }
        .trade-header h1 { font-size: 26px; font-weight: 700; color: #111827; margin: 0 0 6px 0; }
        .trade-header p { font-size: 14px; color: #6b7280; margin: 0; max-width: 700px; }
        .search-bar-container { margin-bottom: 20px; background-color: #ffffff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input-wrapper { position: relative; display: flex; align-items: center; }
        .search-input-wrapper .search-icon { position: absolute; left: 12px; color: #9ca3af; width:18px; height:18px;}
        .search-input-wrapper input[type="text"] { width: 100%; padding: 10px 12px 10px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .search-input-wrapper input[type="text"]:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .trading-interface {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
            height: calc(100vh - 230px); /* Adjust based on your header/search bar height */
        }
        @media (max-width: 992px) { /* Tablet and below, stack panels */
            .trading-interface {
                flex-direction: column;
                height: auto; /* Allow content to determine height */
                overflow: visible;
            }
            .stock-list-panel {
                width: 100%; /* Full width */
                max-height: 300px; /* Limit height and make scrollable */
                margin-bottom: 20px;
            }
            .stock-details-panel {
                width: 100%;
                min-height: 400px; /* Ensure enough space for content */
            }
        }

        .stock-list-panel { width: 330px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; padding: 8px; height: 100%;}
        .stock-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.15s ease; }
        .stock-item:last-child { border-bottom: none; }
        .stock-item:hover { background-color: #f9fafb; }
        .stock-item.selected { background-color: #eff6ff; border-left: 3px solid #3b82f6; padding-left: 7px;}
        .stock-info { flex-grow: 1; }
        .stock-info .name { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-info .ticker { font-size: 12px; color: #6b7280; }
        .stock-price-info { text-align: right; }
        .stock-price-info .price { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-price-info .change { font-size: 12px; }
        .stock-details-panel { flex-grow: 1; background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 20px 25px; overflow-y: auto; display: flex; flex-direction: column; height: 100%;}
        .stock-details-content.hidden { display: none; }
        .detail-header { display: flex; align-items: center; margin-bottom: 20px; }
        .detail-name-ticker .name { font-size: 20px; font-weight: 600; color: #111827; margin: 0 0 3px 0; }
        .detail-name-ticker .price-shares { font-size: 14px; color: #6b7280; }
        .trade-actions-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .trade-tab { flex: 1; text-align: center; padding: 12px 10px; cursor: pointer; font-size: 15px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease; background-color: #f9fafb; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .trade-tab:not(:last-child) { border-right: 1px solid #e5e7eb; }
        .trade-tab:hover { color: #374151; background-color: #f3f4f6; }
        .trade-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background-color: #ffffff; border-right-color: transparent; }
        .trade-tab.active + .trade-tab { border-left-color: transparent; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 5px; }
        .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; background-color: #fff; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; font-family: inherit; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .form-group input[type="number"]:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.1em; padding-right: 2.5rem; }
        .form-group select option { padding: 8px 12px; }
        .trade-summary { margin-top: 15px; margin-bottom: 20px; font-size: 13px; color: #4b5563; }
        .trade-summary div { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .trade-summary span:last-child { font-weight: 500; color: #1f2937; }
        .submit-trade-button { width: 100%; background-color: #10b981; color: white; padding: 12px; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; }
        .submit-trade-button.sell { background-color: #ef4444; }
        .submit-trade-button:hover:not(:disabled) { opacity: 0.9; }
        .submit-trade-button:disabled { background-color: #9ca3af; cursor: not-allowed;}
        .trade-note { font-size: 11px; color: #6b7280; margin-top: 15px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .trade-note svg { flex-shrink: 0; margin-top: 1px; width:14px; height:14px;}
        .no-stock-selected-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: #9ca3af; }
        .no-stock-selected-placeholder.hidden { display: none; }
        .no-stock-selected-placeholder svg { margin-bottom: 15px; width: 48px; height: 48px;}

        /* --- AI Stock Analysis Page Specific Styles --- */
        #view-ai_stock_analysis .analysis-input-bar {
            display: flex; flex-wrap: wrap; /* Allow wrapping for checkbox */
            gap: 10px; align-items: center; margin-bottom: 20px;
            background-color: #ffffff; padding:15px; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #view-ai_stock_analysis .analysis-input-bar input[type="text"] {
            flex-grow: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
        }
        #view-ai_stock_analysis .analysis-input-bar input[type="text"]:focus {
             outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Styling for the GA checkbox and its label */
        .ga-checkbox-container {
            display: flex; align-items: center; gap: 6px; 
            font-size: 13px; color: #374151; margin-top: 5px; /* Adjust margin as needed */
            width: 100%; /* Make it take full width on smaller screens if input bar wraps */
        }
        .ga-checkbox-container input[type="checkbox"] { accent-color: #1e40af; }

        #ai-stock-analysis-output-area {
            display: none; background-color: #ffffff; padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-top: 0;
        }
        @media (max-width: 768px) {
            #view-ai_stock_analysis .analysis-input-bar {
                flex-direction: column;
                align-items: stretch;
            }
            #ai-stock-analysis-submit-btn { /* Ensure button is full width on mobile */
                width: 100% !important; margin-top: 10px; /* Add some space if checkbox is above */
            }
            .ga-checkbox-container { margin-bottom: 10px; } /* Space before button on mobile */
            #ai-stock-analysis-output-area { padding: 15px; }
        }

        #ai-stock-analysis-output-area h2 { font-size: 20px; color: #111827; margin-bottom:5px; }
        #ai-stock-analysis-output-area h4 { font-size: 15px; color: #1e40af; margin-top: 20px; margin-bottom: 8px; border-bottom: 1px solid #e0e7ff; padding-bottom: 4px;}
        #ai-stock-analysis-output-area .key-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom:20px; font-size:13px; }
        #ai-stock-analysis-output-area .metric-item { background-color:#f9fafb; padding:10px 12px; border-radius:6px; border: 1px solid #f3f4f6;}
        #ai-stock-analysis-output-area .metric-item strong { color: #374151; }
        #ai-stock-analysis-output-area .ai-conclusion { background-color: #f3f4f6; padding: 15px; border-radius: 6px; font-size: 14px; line-height: 1.65; white-space: pre-wrap; margin-bottom:20px; color: #374151;}
        #ai-stock-analysis-output-area .ai-conclusion strong { color: #1e40af;}
        #ai-stock-analysis-output-area .ai-conclusion em { font-style: italic; color: #059669;}
        #ai-stock-analysis-output-area .ai-conclusion ul { list-style-position: inside; padding-left: 0; margin-top: 8px;}
        #ai-stock-analysis-output-area .ai-conclusion li { margin-bottom: 4px;}
        #ai-stock-analysis-output-area .news-list { list-style-type: none; padding-left: 0; font-size: 13px; }
        #ai-stock-analysis-output-area .news-list li { margin-bottom: 8px; padding: 8px; background-color:#f9fafb; border-radius:4px; border: 1px solid #f3f4f6;}
        #ai-stock-analysis-output-area .news-list a { color: #3b82f6; text-decoration:none; font-weight:500;}
        #ai-stock-analysis-output-area .news-list a:hover { text-decoration:underline;}
        #ai-stock-analysis-output-area .news-list .news-source { color:#6b7280; font-size:11px; margin-left: 5px;}
        #ai-stock-analysis-output-area .chart-iframe { width: 100%; height: 450px; border: none; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } 
        #ai-stock-analysis-output-area .chart-disclaimer { font-size:11px; color:#9ca3af; text-align:center; margin-top:5px;}
        /* GA Signal Info in AI Analysis Output */
        .ga-signal-output {
            background-color: #eef2ff; /* Light blue-indigo background */
            border: 1px solid #c7d2fe;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 15px; /* Space from previous section */
            color: #374151;
        }
        .ga-signal-output strong { color: #1e40af; }
        .ga-signal-output .signal-buy { color: #16a34a; font-weight: bold; }
        .ga-signal-output .signal-sell { color: #dc2626; font-weight: bold; }
        .ga-signal-output .signal-neutral { color: #555; font-weight: bold; }
        .ga-signal-output .signal-error, .ga-signal-output .signal-na { color: #9ca3af; font-style: italic;}


        /* --- My Portfolio CSS --- */
        .portfolio-overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { 
            .portfolio-overview-grid {
                grid-template-columns: 1fr;
            }
        }
        .overview-metric-card { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .overview-metric-card .label { font-size: 14px; color: #6b7280; margin-bottom: 6px; display: block; }
        .overview-metric-card .value { font-size: 24px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .overview-metric-card .change { font-size: 13px; }
        .holdings-section { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow-x: auto; }
        .holdings-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }
        .holdings-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .holdings-table th, .holdings-table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; white-space: nowrap; }
        .holdings-table th { font-weight: 500; color: #6b7280; background-color: #f9fafb; }
        .holdings-table td { color: #374151; }
        .holdings-table tr:last-child td { border-bottom: none; }
        .holdings-table .align-right { text-align: right; }
        .holdings-table .stock-name-cell .ticker { display: block; font-size: 12px; color: #6b7280; margin-top: 2px; }
        .empty-portfolio { text-align: center; padding: 40px 20px; color: #6b7280; }
        .empty-portfolio svg { width: 48px; height: 48px; margin-bottom: 15px; color: #9ca3af; }
        .empty-portfolio p { font-size: 16px; margin-bottom: 15px; }
        .empty-portfolio .action-button { background-color: #3b82f6; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background-color 0.2s ease; display: inline-block; }
        .empty-portfolio .action-button:hover { background-color: #2563eb; }

        /* --- AI Reports CSS --- */
        .report-section { background-color: #ffffff; border-radius: 8px; padding: 25px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 25px; }
        @media (max-width: 768px) {
            .report-section { padding: 20px 15px; }
        }
        .report-section .section-header { display: flex; align-items: center; margin-bottom: 10px; }
        .report-section .section-icon { width: 24px; height: 24px; margin-right: 12px; color: #3b82f6; }
        .report-section .section-icon.brain { color: #7c3aed; }
        .report-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0; }
        .report-section .description { font-size: 14px; color: #4b5563; margin-bottom: 20px; line-height: 1.6; }
        .disclaimer { font-size: 13px; color: #6b7280; margin-top: 10px; display: flex; align-items: flex-start; gap: 6px; }
        .disclaimer svg { width: 16px; height: 16px; color: #f59e0b; flex-shrink: 0; margin-top: 2px; }
        .report-output-area { margin-top: 20px; padding: 15px; border: 1px dashed #d1d5db; border-radius: 6px; background-color: #f9fafb; min-height: 100px; font-size: 14px; color: #4b5563; display: none; white-space: pre-wrap; overflow-x: auto; }
        .report-output-area strong { color: #1e40af;}
        .report-output-area em { font-style: italic; color: #059669;}
        .report-output-area ul { list-style-position: inside; padding-left: 0; margin-top: 8px;}
        .report-output-area li { margin-bottom: 4px;}

        /* --- GA Potential Buys Section (Dashboard) --- */
        #ga-picks-section {
            background-color: #ffffff; border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        #ga-picks-section .description { font-size: 13px; color: #4b5563; margin-bottom: 15px; line-height: 1.5;}
        #ga-potential-buys-output ul { list-style-type: none; padding-left: 0; margin-top: 15px;}
        #ga-potential-buys-output li {
            padding: 10px 12px; border-bottom: 1px solid #f0f2f5;
            font-size: 14px; color: #374151;
        }
        #ga-potential-buys-output li:last-child { border-bottom: none; }
        #ga-potential-buys-output li strong { color: #1e40af; font-size: 15px; }
        /* Modified small tag for GA buy reason display */
        #ga-potential-buys-output li small.ga-buy-reason { 
            color: #555; display: block; margin-top: 4px; font-size: 12px; 
            line-height: 1.4; /* Improved readability for longer reasons */
        }
        #ga-potential-buys-output .disclaimer-note { 
             font-size:11px; color:#888; margin-top:15px; text-align:center;
        }


        /* ============================================= */
        /*                Global CSS End                 */
        /* ============================================= */
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Overlay for RWD sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1000; /* Below sidebar, above content */
        }
        .sidebar-overlay.active {
            display: block;
        }

    </style>
</head>
<body>
    <div class="page-container">
        <!-- Hamburger Menu for RWD -->
        <div class="hamburger-menu" id="hamburger-menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
        </div>
        <!-- Overlay for RWD sidebar -->
        <div class="sidebar-overlay" id="sidebar-overlay-el"></div>

        <!-- 側邊欄 (Sidebar) -->
        <aside class="sidebar" id="app-sidebar">
            <div class="sidebar-header">
                <div style="display: flex; align-items: center;">
                    <img src="https://placehold.co/36x36/1e40af/white?text=FU" alt="FinSimU Logo" class="logo-img">
                    <h1 class="app-title">FinSimU</h1>
                </div>
                <button class="sidebar-close-button" id="sidebar-close-btn" aria-label="關閉側邊欄">&times;</button>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item" id="nav-dashboard"><a href="#dashboard" data-view="dashboard"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>主控台</span></a></li>
                    <li class="nav-item" id="nav-trade"><a href="#trade_stocks" data-view="trade_stocks"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.83 11.295l-2.121-2.121a1 1 0 00-1.414 0L9.707 12.76a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l3.586-3.586a1 1 0 000-1.414zM5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm13 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM8 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg><span>股票交易</span></a></li>
                    <li class="nav-item" id="nav-ai_stock_analysis"><a href="#ai_stock_analysis" data-view="ai_stock_analysis">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.9999 1.5C12.5246 1.5 12.9649 1.91558 12.9962 2.43709L12.9999 2.5V5.26009C14.4194 5.40532 15.7626 5.96253 16.8499 6.86009L18.9357 5.30412C19.3957 4.98336 20.0242 5.08019 20.345 5.54022C20.6231 5.94469 20.5522 6.49019 20.1935 6.81694L20.1057 6.89412L18.2287 8.41155C18.9138 9.47108 19.3451 10.6962 19.4804 12H21.4999C22.0208 12 22.4639 12.3882 22.4952 12.899L22.4999 13C22.4999 13.5523 22.0522 14 21.4999 14H19.4804C19.3451 15.3038 18.9138 16.5289 18.2287 17.5884L20.1057 19.1059C20.5522 19.4478 20.6231 20.0553 20.345 20.4598C20.0936 20.8106 19.6212 20.9448 19.2082 20.8239L19.1326 20.7935L18.9357 20.6959L16.8499 19.1399C15.7626 20.0375 14.4194 20.5947 12.9999 20.7399V23.5C12.9999 24.0246 12.5843 24.4649 12.0628 24.4962L11.9999 24.5C11.4476 24.5 10.9999 24.0523 10.9999 23.5V20.7399C9.58047 20.5947 8.23723 20.0375 7.14991 19.1399L5.06422 20.6959C4.60419 21.0166 3.97561 20.9198 3.65491 20.4598C3.37681 20.0553 3.44773 19.5098 3.80637 19.1831L3.89422 19.1059L5.77122 17.5884C5.08612 16.5289 4.65482 15.3038 4.51953 14H2.49991C1.97902 14 1.53591 13.6118 1.50463 13.101L1.49991 13C1.49991 12.4477 1.94762 12 2.49991 12H4.51953C4.65482 10.6962 5.08612 9.47108 5.77122 8.41155L3.89422 6.89412C3.44773 6.55223 3.37681 5.94469 3.65491 5.54022C3.90626 5.18939 4.37871 5.05521 4.79173 5.17608L4.86733 5.20651L5.06422 5.30412L7.14991 6.86009C8.23723 5.96253 9.58047 5.40532 10.9999 5.26009V2.5C10.9999 1.97536 11.4155 1.53501 11.937 1.50373L11.9999 1.5ZM11.9999 7.5C9.51462 7.5 7.49991 9.51472 7.49991 12C7.49991 14.4853 9.51462 16.5 11.9999 16.5C14.4852 16.5 16.4999 14.4853 16.4999 12C16.4999 9.51472 14.4852 7.5 11.9999 7.5Z"></path>
                        </svg><span>AI 個股分析</span></a>
                    </li>
                    <li class="nav-item" id="nav-portfolio"><a href="#my_portfolio" data-view="my_portfolio"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 11H8v-2h4v2zm4-3H8V9h8v3zm0-4h-2V6h2v2z"/></svg><span>我的投資組合</span></a></li>
                    <li class="nav-item" id="nav-reports"><a href="#ai_reports" data-view="ai_reports"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg><span>AI 報告</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-user-profile">
                <img src="https://placehold.co/32x32/7c3aed/white?text=S" alt="用戶頭像" class="user-avatar" id="sidebar-user-avatar-img">
                <div class="user-details">
                    <span class="user-name" id="sidebar-user-name">訪客</span>
                    <span class="user-status" id="sidebar-user-style">市場: <span class="user-market-type-display">N/A</span></span>
                </div>
            </div>
            <div class="sidebar-footer">
                <a href="#" class="footer-link" id="logout-link">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                    <span>登出</span>
                </a>
            </div>
        </aside>

        <!-- 主內容容器 -->
        <div class="main-content-view" id="main-content-area">

            <!-- Dashboard 內容 -->
            <section id="view-dashboard" class="view-section">
                <header class="page-header"><h1>主控台 (<span class="user-market-type-display">N/A</span> 市場)</h1><p class="subtitle">歡迎回來, <span id="dashboard-username" class="font-semibold">用戶</span>! 以下是您選定市場的交易表現摘要。</p></header>
                <div class="summary-cards-grid" id="dashboard-summary-cards">
                    <div class="summary-card"><span class="label">投資組合總值 (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-portfolio-value">$0.00</div><div class="sub-text" id="dashboard-total-pl">總盈虧: $0.00 (0.00%)</div></div>
                    <div class="summary-card"><span class="label">今日盈虧 (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-today-pl">$0.00</div><div class="sub-text" id="dashboard-today-pl-percent">0.00%</div></div>
                    <div class="summary-card"><span class="label">現金餘額 (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-cash-balance">$0.00</div><div class="sub-text" id="dashboard-buying-power">可用購買力</div></div>
                </div>
                <section class="quick-actions-section">
                    <h2>快速操作</h2>
                    <div class="quick-actions-grid">
                        <button class="quick-action-button" data-view-target="trade_stocks"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.505 2.374A4.5 4.5 0 017.75 1.5h4.5A4.5 4.5 0 0116.5 6v1.148A4.504 4.504 0 0113.01 9.5H10V6.5a.5.5 0 00-.5-.5H8.75V4.5h-1.5v2H6.5a.5.5 0 000 1h.75v2.5H6.5a.5.5 0 000 1h.75V12H6.5a.5.5 0 000 1h.75v2.5H6.5a.5.5 0 000 1h.75v1.5H4.25A2.25 2.25 0 012 15.75V6A4.5 4.5 0 013.505 2.374zM13.01 11H10V9.5h3.01a3.001 3.001 0 010 6H10v-1.5h3.01a1.5 1.5 0 100-3z"/></svg><span>股票交易</span></button>
                        <button class="quick-action-button" data-view-target="ai_stock_analysis"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.5 3.5A1.5 1.5 0 018 2h4a1.5 1.5 0 011.5 1.5v2.5A1.5 1.5 0 0112 7.5H8A1.5 1.5 0 016.5 6V3.5zm4.25 5.521A4.502 4.502 0 0012.5 8H16a2 2 0 012 2v5.5a2 2 0 01-2 2H8a2 2 0 01-2-2V10c0-.31.034-.612.1-.901A4.502 4.502 0 0010.75 9.021zM8 10.5A1.5 1.5 0 006.5 12v4A1.5 1.5 0 008 17.5h4A1.5 1.5 0 0013.5 16v-4A1.5 1.5 0 0012 10.5H8z" clip-rule="evenodd"></path><path d="M3 6.5A1.5 1.5 0 014.5 5h2.5A1.5 1.5 0 018.5 6.5v1A1.5 1.5 0 017 9H4.5A1.5 1.5 0 013 7.5v-1zM14.5 5A1.5 1.5 0 0013 6.5v1A1.5 1.5 0 0014.5 9H17a1.5 1.5 0 001.5-1.5v-1A1.5 1.5 0 0017 5h-2.5z"></path></svg><span>AI 個股分析</span></button>
                        <button class="quick-action-button" data-view-target="my_portfolio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 014.5 2h11A1.5 1.5 0 0117 3.5v13A1.5 1.5 0 0115.5 18h-11A1.5 1.5 0 013 16.5v-13zM4.5 4v2.5h11V4H4.5zm0 4v2.5h11V8H4.5zm0 4v2.5h5V12H4.5z"/></svg><span>我的投資組合</span></button>
                        <button class="quick-action-button" data-view-target="ai_reports"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg><span>AI 報告</span></button>
                    </div>
                </section>
                <!-- GA Potential Buys Section -->
                <section class="quick-actions-section" id="ga-picks-section">
                    <h2>AI 策略潛力股 (<span class="user-market-type-display">N/A</span> 市場)</h2>
                    <p class="description">
                        探索我們的 GA 優化策略目前在您指定的市場中識別出的潛在買入機會。
                        這些建議基於歷史數據模式，不構成財務建議。數據為預先計算，可能非即時。
                    </p>
                    <button class="action-button" id="fetch-ga-potential-buys-btn" style="background-color: #4f46e5; color:white;">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px; color:white;">
                            <path fill-rule="evenodd" d="M9.965 2.026a.75.75 0 01.53.22l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L12.94 10 9.465 6.535a.75.75 0 01.22-.53zm-4.5 0A.75.75 0 016 2.246l4.25 4.25a.75.75 0 010 1.06L6 11.796a.75.75 0 11-1.06-1.06L8.44 7.5 4.965 4.035A.75.75 0 015.465 2.026z" clip-rule="evenodd" />
                        </svg>
                        查看 GA 潛力買入股
                    </button>
                    <div id="ga-potential-buys-output" style="margin-top: 20px;">
                        <!-- Results will be displayed here -->
                    </div>
                </section>
                <!-- End of GA Potential Buys Section -->
                <div class="recent-activity-container">
                    <h2>近期活動 (<span class="user-market-type-display">N/A</span> 市場)</h2>
                    <ul id="dashboard-recent-activity" style="list-style: none; padding: 0; font-size: 14px; color: #4b5563;"><li style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">尚無近期活動。</li></ul>
                </div>
            </section>

            <!-- Trade Stocks 內容 -->
            <section id="view-trade_stocks" class="view-section">
                <div class="trade-header"><h1>股票交易終端 (<span class="user-market-type-display">N/A</span> 市場)</h1><p>在您指定的市場中搜索股票，查看即時數據並進行虛擬交易。</p></div>
                <div class="search-bar-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                        <input type="text" id="ts-stock-search-input" placeholder="按名稱或代號搜索股票 (例如: AAPL 或 2330.TW)">
                    </div>
                </div>
                <div class="trading-interface">
                    <aside class="stock-list-panel" id="ts-stock-list-panel"><div class="stock-item" style="justify-content: center; color: #9ca3af;">請搜索股票以在此處顯示。</div></aside>
                    <section class="stock-details-panel">
                        <div id="ts-stock-details-content" class="stock-details-content hidden">
                            <div class="detail-header">
                                <div class="detail-name-ticker">
                                    <h2 class="name" id="ts-detail-stock-name">股票名稱 (代號)</h2>
                                    <p class="price-shares">當前價格: <span id="ts-current-stock-price" class="font-semibold">$0.00</span>&nbsp;&nbsp;|&nbsp;&nbsp; 您持有 (<span class="user-market-type-display">N/A</span>): <span id="ts-owned-shares" class="font-semibold">0</span> 股</p>
                                </div>
                            </div>
                            <div class="trade-actions-tabs"><button class="trade-tab active" id="ts-buy-tab">買入 STOCK</button><button class="trade-tab" id="ts-sell-tab">賣出 STOCK</button></div>
                            <form id="ts-trade-form">
                                <div class="form-group"><label for="ts-shares-input">股數</label><input type="number" id="ts-shares-input" name="shares" value="1" min="1"></div>
                                <div class="form-group">
                                    <label for="ts-mood-select">您交易時的心情</label>
                                    <select id="ts-mood-select" name="mood">
                                        <option value="">選擇您當前的心情</option><option value="excited">🥳 興奮</option><option value="confident">😎 自信</option><option value="neutral">😐 平靜</option><option value="anxious">😟 焦慮</option><option value="fearful">😨 恐懼 (FOMO/FUD)</option><option value="impulsive">⚡️ 衝動</option><option value="analytical">🧐 分析</option><option value="bored">😴 無聊</option>
                                    </select>
                                </div>
                                <div class="form-group"><label for="ts-reason-input">交易原因 (可選)</label><textarea id="ts-reason-input" name="reason" rows="2" placeholder="例如：強勁的財報、技術性突破、分散投資..."></textarea></div>
                                <div class="trade-summary">
                                    <div><span id="ts-summary-cost-label">預計總成本:</span> <span id="ts-summary-total-cost">$0.00</span></div>
                                    <div><span id="ts-summary-balance-label">交易後現金餘額 (<span class="user-market-type-display">N/A</span>):</span> <span id="ts-summary-cash-after-trade">$0.00</span></div>
                                </div>
                                <button type="submit" class="submit-trade-button" id="ts-submit-trade-btn">買入股票</button>
                            </form>
                            <p class="trade-note"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm8-4a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V4.75A.75.75 0 018 4zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>價格為指示性。交易將以當前市價執行。可能會收取少量手續費。</p>
                        </div>
                        <div class="no-stock-selected-placeholder" id="ts-no-stock-selected-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.25 3A1.25 1.25 0 0010 4.25V8.5h-3.75a.75.75 0 000 1.5h3.75V12a2.25 2.25 0 002.25 2.25h3A2.25 2.25 0 0017.75 12V9.75H19a.75.75 0 000-1.5h-1.25V4.25A1.25 1.25 0 0016.5 3h-5.25zm1.5 3.75V8.5h2.25V6.75h-2.25zm-3 6V20.75A1.25 1.25 0 0011.25 22H16a.75.75 0 000-1.5h-4.75V12.75h-1.5zM3.5 6.75A.75.75 0 014.25 6H7.5V4.25A1.25 1.25 0 006.25 3h-3A1.25 1.25 0 002 4.25v15.5A1.25 1.25 0 003.25 21h3A1.25 1.25 0 007.5 19.75V17H6a.75.75 0 000 1.5h1.5V21A2.75 2.75 0 0010.75 24h6.5A2.75 2.75 0 0020 21.25V3.75A2.75 2.75 0 0017.25 1H6.75A2.75 2.75 0 004 3.75v1.5H1.25a.75.75 0 000 1.5H4V6.75z" /></svg><p>請從列表中選擇一支股票以查看詳細信息並進行交易。</p></div>
                    </section>
                </div>
            </section>

            <!-- AI Stock Analysis View Section -->
            <section id="view-ai_stock_analysis" class="view-section">
                <header class="page-header">
                    <h1>AI 即時個股分析</h1>
                    <p class="subtitle">輸入股票代號，獲取由 AI 生成的即時個股分析報告、技術圖表與相關新聞，並可選擇檢查 GA 策略信號。</p>
                </header>

                <div class="analysis-input-bar">
                    <input type="text" id="ai-stock-analysis-ticker-input" placeholder="輸入股票代號 (例: 2330.TW 或 AAPL)">
                    <div class="ga-checkbox-container">
                        <input type="checkbox" id="ai-stock-analysis-include-ga" name="includeGa">
                        <label for="ai-stock-analysis-include-ga">同時檢查 GA 策略信號?</label>
                    </div>
                    <button id="ai-stock-analysis-submit-btn" class="action-button" style="background-color: #1e40af; color:white;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px;">
                            <path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/>
                        </svg>
                        分析個股
                    </button>
                </div>
                <div id="ai-stock-analysis-output-area" style="display: none;">
                    <!-- Analysis results will be displayed here -->
                </div>
            </section>

            <!-- My Portfolio 內容 -->
            <section id="view-my_portfolio" class="view-section">
                <header class="page-header"><h1>我的投資組合 (<span class="user-market-type-display">N/A</span> 市場)</h1><p class="subtitle">您在指定市場的當前投資和表現概覽。</p></header>
                <section class="portfolio-overview-grid" id="mp-portfolio-overview-grid"></section>
                <section class="holdings-section">
                    <h2>目前持股 (<span class="user-market-type-display">N/A</span> 市場)</h2>
                    <table class="holdings-table">
                        <thead><tr><th>股票</th><th class="align-right">股數</th><th class="align-right">平均成本</th><th class="align-right">當前價格</th><th class="align-right">市值</th><th class="align-right">今日變動</th><th class="align-right">總盈虧 (%)</th></tr></thead>
                        <tbody id="mp-holdings-table-body"></tbody>
                    </table>
                    <div class="empty-portfolio" id="mp-empty-portfolio-message" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 2.25a.75.75 0 000 1.5H3v10.5a3 3 0 003 3h1.21l-2.12 2.121a.75.75 0 001.06 1.061l2.374-2.373.87.87a.75.75 0 001.061-1.06l-.87-.87 2.373-2.374a.75.75 0 00-1.06-1.06L10.29 16.5H6a1.5 1.5 0 01-1.5-1.5V3.75H2.25a.75.75 0 000-1.5H.75A.75.75 0 000 3v12a3 3 0 003 3h4.586l-1.72 1.72a.75.75 0 001.06 1.061l2.122-2.122 2.121 2.122a.75.75 0 001.06-1.06L10.586 18H15a3 3 0 003-3V3.75H15.75a.75.75 0 000 1.5H18v10.5a1.5 1.5 0 01-1.5 1.5h-1.21l2.12-2.121a.75.75 0 00-1.06-1.061l-2.374 2.373-.87-.87a.75.75 0 00-1.061 1.06l.87.87-2.373 2.374a.75.75 0 001.06 1.06L13.71 16.5H18a3 3 0 003-3V3a.75.75 0 00-.75-.75h-2.25a.75.75 0 000-1.5H21a.75.75 0 00.75-.75V.75A.75.75 0 0021 0H3a.75.75 0 00-.75.75v1.5A.75.75 0 003 3h1.586L2.865 4.72a.75.75 0 001.061 1.06L6 4.061V15a1.5 1.5 0 01-1.5 1.5H3a3 3 0 00-3-3V3a.75.75 0 00.75-.75z" clip-rule="evenodd" /></svg><p>您的 (<span class="user-market-type-display">N/A</span>) 投資組合目前為空。</p><a href="#trade_stocks" data-view="trade_stocks" class="action-button empty-portfolio-trade-link">開始交易</a></div>
                </section>
            </section>

            <!-- AI Reports 內容 -->
            <section id="view-ai_reports" class="view-section">
                <header class="page-header"><h1>AI 洞察報告 (<span class="user-market-type-display">N/A</span> 市場)</h1><p class="subtitle">利用 AI 理解您在指定市場的交易模式並獲得個性化反饋。</p></header>
                <section class="report-section">
                    <div class="section-header"><svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a.375.375 0 01-.375-.375V6.75A3.75 3.75 0 0010.5 3H5.625a.375.375 0 01-.375-.375V1.875c0-1.036-.84-1.875-1.875-1.875H1.875A1.875 1.875 0 000 1.875v17.25c0 1.035.84 1.875 1.875 1.875h1.875c1.035 0 1.875-.84 1.875-1.875V6.75h1.875a.375.375 0 01.375.375v1.875c0 1.036.84 1.875 1.875 1.875H15V12h1.5a.75.75 0 01.75.75v6A.75.75 0 0116.5 19.5h-12A.75.75 0 013.75 18.75V4.125A1.875 1.875 0 005.625 6H9V4.125A1.875 1.875 0 007.125 2.25H5.625V1.5zM12.75 9V6.375A2.25 2.25 0 0010.5 4.125H5.625A.375.375 0 015.25 3.75V1.875a.375.375 0 01.375-.375h.008a.875.875 0 01.867.866V3.75h3a.75.75 0 00.75-.75V1.875a.375.375 0 01.375-.375h2.25a.375.375 0 01.375.375v2.25a2.25 2.25 0 002.25 2.25H15v2.625a2.25 2.25 0 00-2.25-2.25h-2.25z" clip-rule="evenodd" /><path d="M7.125 15a.75.75 0 01.75-.75h8.25a.75.75 0 010 1.5H7.875a.75.75 0 01-.75-.75zM7.125 17.25a.75.75 0 01.75-.75H12a.75.75 0 010 1.5H7.875a.75.75 0 01-.75-.75z"/></svg><h2>AI 投資報告</h2></div>
                    <p class="description">生成一份個性化的投資報告，總結您的交易表現，點出行為偏差，並提供改進建議。此報告幫助您反思策略並做出更明智的決策。</p>
                    <button class="action-button" id="generate-investment-report-btn">生成投資報告</button>
                    <div class="report-output-area" id="investment-report-output">報告輸出將顯示於此...</div>
                </section>
                <section class="report-section">
                     <div class="section-header"><svg class="section-icon brain" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.25 4.151a.75.75 0 00-1.06-.042L10.07 7.037a3.75 3.75 0 00-3.36 3.36l-2.928 3.12a.75.75 0 00.042 1.061l.53.53a.75.75 0 001.06 0l2.928-3.12a3.751 3.751 0 005.494-1.748l1.758 2.636a.75.75 0 001.29-.866L14.6 9.508a3.733 3.733 0 001.757-2.417l3.087-1.234a.75.75 0 00-.126-1.418l-3.535-.59a3.737 3.737 0 00-1.53-.098zM12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" /><path fill-rule="evenodd" d="M4.5 4.125A2.625 2.625 0 017.125 1.5h9.75A2.625 2.625 0 0119.5 4.125v15.75A2.625 2.625 0 0116.875 22.5h-9.75A2.625 2.625 0 014.5 19.875V4.125zm2.625-.375c-.207 0-.398.044-.57.125V19.875c0 .207.044.398.125.57h9.75a.875.875 0 00.875-.875V4.125a.875.875 0 00-.875-.875h-9.75z" clip-rule="evenodd" /></svg><h2>AI 行為分析</h2></div>
                    <p class="description">洞察您的投資行為模式，例如風險趨避、損失規避、過度自信或其他偏差。理解這些模式對於改善您的決策過程至關重要。</p>
                    <button class="action-button" id="generate-behavioral-report-btn">分析我的行為</button>
                     <div class="disclaimer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg><span>AI 生成的洞察僅供教育目的，可能不完全準確。</span></div>
                    <div class="report-output-area" id="behavioral-analysis-output">分析輸出將顯示於此...</div>
                </section>
            </section>

        </div> <!-- End of main-content-area -->
    </div> <!-- End of page-container -->

    <script>
        // =============================================
        //                JavaScript Start
        // =============================================
        console.log("FinSimU 主應用 JS 已載入 - V10.5 (PWA, RWD, GA Precalc, GA OnDemand)");

        let currentUser = null;
        let userMarketType = 'N/A';
        let currentSelectedStockTrade = null;

        const mainContentArea = document.getElementById('main-content-area');
        const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
        const viewSections = document.querySelectorAll('.view-section');
        const sidebarUserNameEl = document.getElementById('sidebar-user-name');
        const sidebarUserStyleEl = document.getElementById('sidebar-user-style');
        const sidebarUserAvatarImgEl = document.getElementById('sidebar-user-avatar-img');
        const logoutLink = document.getElementById('logout-link');
        const userMarketTypeDisplays = document.querySelectorAll('.user-market-type-display');

        const dashboardUsernameEl = document.getElementById('dashboard-username');
        const dashboardPortfolioValueEl = document.getElementById('dashboard-portfolio-value');
        const dashboardTotalPlEl = document.getElementById('dashboard-total-pl');
        const dashboardTodayPlEl = document.getElementById('dashboard-today-pl');
        const dashboardTodayPlPercentEl = document.getElementById('dashboard-today-pl-percent');
        const dashboardCashBalanceEl = document.getElementById('dashboard-cash-balance');
        const dashboardRecentActivityUl = document.getElementById('dashboard-recent-activity');
        const quickActionButtons = document.querySelectorAll('.quick-action-button');

        const tsStockListPanel = document.getElementById('ts-stock-list-panel');
        const tsStockDetailsContent = document.getElementById('ts-stock-details-content');
        const tsNoStockPlaceholder = document.getElementById('ts-no-stock-selected-placeholder');
        const tsDetailStockNameEl = document.getElementById('ts-detail-stock-name');
        const tsCurrentStockPriceEl = document.getElementById('ts-current-stock-price');
        const tsOwnedSharesEl = document.getElementById('ts-owned-shares');
        const tsBuyTab = document.getElementById('ts-buy-tab');
        const tsSellTab = document.getElementById('ts-sell-tab');
        const tsSharesInput = document.getElementById('ts-shares-input');
        const tsMoodSelect = document.getElementById('ts-mood-select');
        const tsReasonInput = document.getElementById('ts-reason-input');
        const tsTradeForm = document.getElementById('ts-trade-form');
        const tsSubmitTradeBtn = document.getElementById('ts-submit-trade-btn');
        const tsSummaryCostLabel = document.getElementById('ts-summary-cost-label');
        const tsSummaryTotalCostEl = document.getElementById('ts-summary-total-cost');
        const tsSummaryBalanceLabel = document.getElementById('ts-summary-balance-label');
        const tsSummaryCashAfterTradeEl = document.getElementById('ts-summary-cash-after-trade');
        const tsStockSearchInput = document.getElementById('ts-stock-search-input');

        const mpPortfolioOverviewGridEl = document.getElementById('mp-portfolio-overview-grid');
        const mpHoldingsTableBodyEl = document.getElementById('mp-holdings-table-body');
        const mpEmptyPortfolioMessageEl = document.getElementById('mp-empty-portfolio-message');

        const generateInvestmentReportBtn = document.getElementById('generate-investment-report-btn');
        const investmentReportOutputEl = document.getElementById('investment-report-output');
        const generateBehavioralReportBtn = document.getElementById('generate-behavioral-report-btn');
        const behavioralAnalysisOutputEl = document.getElementById('behavioral-analysis-output');

        const aiStockAnalysisTickerInput = document.getElementById('ai-stock-analysis-ticker-input');
        const aiStockAnalysisIncludeGaCheckbox = document.getElementById('ai-stock-analysis-include-ga'); // New Checkbox
        const aiStockAnalysisSubmitBtn = document.getElementById('ai-stock-analysis-submit-btn');
        const aiStockAnalysisOutputArea = document.getElementById('ai-stock-analysis-output-area');

        const fetchGaPotentialBuysBtn = document.getElementById('fetch-ga-potential-buys-btn');
        const gaPotentialBuysOutputEl = document.getElementById('ga-potential-buys-output');

        // RWD Sidebar Elements
        const appSidebar = document.getElementById('app-sidebar');
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay-el');


        function formatCurrency(amount, includeSymbol = true, currencyCode = userMarketType) {
            const symbol = includeSymbol ? (currencyCode === 'US' ? '$' : 'NT$') : '';
            if (typeof amount !== 'number' || isNaN(amount)) return `${symbol}0.00`;
            let numStr = amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            if (currencyCode === 'TW' && numStr.endsWith('.00')) { // 台幣整數不顯示小數點
                numStr = numStr.substring(0, numStr.length - 3);
            }
            return symbol + numStr;
        }
        function formatPercentage(value, includeArrow = true) {
            if (typeof value !== 'number' || isNaN(value)) return '0.00%';
            const arrow = includeArrow ? (value >= 0 ? '↗ ' : '↘ ') : '';
            return arrow + Math.abs(value).toFixed(2) + '%';
        }
        function getHexColorFromString(str) {
            if (!str) return '7c3aed'; let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            let color = ''; for (let i = 0; i < 3; i++) { const value = (hash >> (i * 8)) & 0xFF; color += ('00' + value.toString(16)).slice(-2); }
            const r = parseInt(color.slice(0,2), 16), g = parseInt(color.slice(2,4), 16), b = parseInt(color.slice(4,6), 16);
            // Ensure contrast against white background
            return ((r * 0.299 + g * 0.587 + b * 0.114) > 150 && r > 50 && g > 50 && b > 50) ? color : '7c3aed'; // Avoid too dark colors
        }

        async function fetchAPI(url, method = 'GET', body = null) {
            const options = { method: method, headers: { 'Content-Type': 'application/json' }};
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(url, options);
                let responseData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    responseData = await response.json().catch(() => ({ message: `從 ${url} 收到的JSON回應無效`, _isParseError: true}));
                } else {
                    const textResponse = await response.text();
                    responseData = { message: `非JSON回應: ${textResponse.substring(0,100)}...`, _isParseError: true, _rawText: textResponse };
                }

                if (!response.ok) {
                    console.error(`API 錯誤 ${response.status} for ${url}:`, responseData.message || response.statusText, responseData._rawText || '');
                    // 前端錯誤提示統一中文化
                    let userMessage = `錯誤: ${responseData.message || response.statusText || '請求失敗'}`;
                    if (response.status === 401) {
                        userMessage = "您的登入已過期或無效，請重新登入。";
                        alert(userMessage);
                        window.location.href = "{{ url_for('finsimu_login_route') }}";
                    } else if (response.status === 503){
                         userMessage = "服務暫時不可用，請稍後再試。";
                         alert(userMessage);
                    } else if (responseData.message && responseData.message.includes("blocked")) { // Gemini block
                        userMessage = `AI 請求被阻擋，可能是內容安全或政策原因。(${responseData.message})`;
                        alert(userMessage);
                    }
                    else {
                        alert(userMessage);
                    }
                    return null;
                }
                return responseData;
            } catch (error) {
                console.error(`網路或解析錯誤 for ${url}:`, error);
                alert('網路錯誤。請檢查您的連接或伺服器日誌。');
                return null;
            }
        }

        function updateUserMarketTypeDisplays() {
            userMarketTypeDisplays.forEach(el => el.textContent = userMarketType);
            // 更新頁面標題中的市場類型
            const currentHash = window.location.hash.substring(1) || 'dashboard';
            const viewName = (document.querySelector(`.sidebar-nav .nav-item a[data-view="${currentHash}"] span`)?.textContent || currentHash.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
            document.title = `FinSimU - ${viewName} (${userMarketType})`;
        }

        function switchView(viewId) {
            console.log("嘗試切換到視圖:", viewId);
            if (!currentUser && viewId !== 'login' && viewId !== 'register') { console.warn("受保護視圖，但目前用戶未設定。"); return; }

            viewSections.forEach(section => section.classList.remove('active'));
            const targetView = document.getElementById(`view-${viewId}`);
            if (targetView) { targetView.classList.add('active'); }
            else { console.error("目標視圖未找到:", `view-${viewId}`); if (viewId !== 'dashboard') switchView('dashboard'); return; }

            navItems.forEach(item => { item.classList.remove('active'); if (item.querySelector(`a[data-view="${viewId}"]`)) item.classList.add('active'); });
            
            updateUserMarketTypeDisplays(); // 更新市場類型顯示和標題

            if (!currentUser && viewId !== 'login' && viewId !== 'register') return; // 如果未登錄且不是登錄/註冊頁，則不載入數據

            if (viewId === 'dashboard') loadDashboardData();
            else if (viewId === 'trade_stocks') loadTradeStocksView();
            else if (viewId === 'ai_stock_analysis') loadAiStockAnalysisView();
            else if (viewId === 'my_portfolio') loadMyPortfolioData();
            else if (viewId === 'ai_reports') loadAiReportsView();

            // 清理其他視圖的特定內容
            if (viewId !== 'ai_stock_analysis' && aiStockAnalysisOutputArea) {
                aiStockAnalysisOutputArea.innerHTML = '';
                aiStockAnalysisOutputArea.style.display = 'none';
                if(aiStockAnalysisTickerInput) aiStockAnalysisTickerInput.value = '';
                if(aiStockAnalysisIncludeGaCheckbox) aiStockAnalysisIncludeGaCheckbox.checked = false;
            }
            if (viewId !== 'dashboard' && gaPotentialBuysOutputEl) {
                 gaPotentialBuysOutputEl.innerHTML = ''; // 清除 GA 潛力股列表
            }
            // RWD: 小螢幕下切換視圖時關閉側邊欄
            if (window.innerWidth <= 768 && appSidebar && appSidebar.classList.contains('open')) {
                toggleSidebar(false);
            }
        }

        function updateSidebarUser() {
            if (!currentUser || !sidebarUserNameEl || !sidebarUserStyleEl || !sidebarUserAvatarImgEl) return;
            sidebarUserNameEl.textContent = currentUser.name;
            sidebarUserStyleEl.innerHTML = `投資風格: ${currentUser.investmentStyle} <br>市場: <span class="user-market-type-display">${userMarketType}</span>`;
            const firstLetter = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'S';
            sidebarUserAvatarImgEl.src = `https://placehold.co/32x32/${getHexColorFromString(currentUser.name)}/ffffff?text=${firstLetter}`;
        }

        async function loadDashboardData() {
            if (!currentUser) { console.warn("loadDashboardData: currentUser 未設定。"); return; }
            if (dashboardUsernameEl) dashboardUsernameEl.textContent = currentUser.name;

            const portfolioData = await fetchAPI(`{{ url_for('portfolio_data_api') }}`);

            if (portfolioData && portfolioData.success) {
                const overview = portfolioData.overview;
                if(dashboardPortfolioValueEl) dashboardPortfolioValueEl.textContent = formatCurrency(overview.totalPortfolioValue);
                if(dashboardTotalPlEl) { dashboardTotalPlEl.textContent = `總盈虧: ${formatCurrency(overview.totalOverallPL)} (${formatPercentage(overview.totalOverallPLPercent, false)})`; dashboardTotalPlEl.className = `sub-text ${overview.totalOverallPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardTodayPlEl) { dashboardTodayPlEl.textContent = formatCurrency(overview.todayTotalPL); dashboardTodayPlEl.className = `value ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardTodayPlPercentEl) { dashboardTodayPlPercentEl.textContent = formatPercentage(overview.todayTotalPLPercent); dashboardTodayPlPercentEl.className = `sub-text ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardCashBalanceEl) dashboardCashBalanceEl.textContent = formatCurrency(overview.cashBalance);
                if (currentUser.account) currentUser.account.cashBalance = overview.cashBalance; // 更新本地副本
            } else { // API 失敗或無數據時的回退顯示
                const currentAccountData = currentUser.account; // 嘗試使用本地數據
                if(dashboardPortfolioValueEl && currentAccountData) dashboardPortfolioValueEl.textContent = formatCurrency(currentAccountData.cashBalance); // 若無持股，組合價值即現金
                if(dashboardTotalPlEl) dashboardTotalPlEl.textContent = "總盈虧: N/A";
                if(dashboardTodayPlEl) dashboardTodayPlEl.textContent = "N/A";
                if(dashboardTodayPlPercentEl) dashboardTodayPlPercentEl.textContent = "N/A";
                if(dashboardCashBalanceEl && currentAccountData) dashboardCashBalanceEl.textContent = formatCurrency(currentAccountData.cashBalance);
            }

            if(dashboardRecentActivityUl && currentUser.account && currentUser.account.tradeHistory) {
                const tradeHistory = currentUser.account.tradeHistory;
                dashboardRecentActivityUl.innerHTML = ''; // 清空
                if (tradeHistory.length === 0) { dashboardRecentActivityUl.innerHTML = `<li style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">尚無 ${userMarketType} 市場的近期活動。</li>`; }
                else {
                    tradeHistory.slice(0, 5).forEach(trade => { // 只顯示最近5條
                        const li = document.createElement('li'); li.style.padding = '8px 0'; li.style.borderBottom = '1px solid #f3f4f6';
                        const tradeActionChinese = trade.type === 'buy' ? '買入' : '賣出';
                        li.innerHTML = `<span class="${trade.type === 'buy' ? 'text-green-600' : 'text-red-600'}">${tradeActionChinese.toUpperCase()}</span> ${trade.shares} 股 <strong>${trade.name || trade.ticker}</strong> @ ${formatCurrency(trade.price)} <span style="float: right; color: #9ca3af; font-size: 12px;">${new Date(trade.timestamp).toLocaleDateString()}</span>`;
                        dashboardRecentActivityUl.appendChild(li);
                    });
                }
            }
            updateUserMarketTypeDisplays();
            if (gaPotentialBuysOutputEl) gaPotentialBuysOutputEl.innerHTML = ''; // 切換到 dashboard 時清空 GA picks
        }

        async function loadTradeStocksView() {
            await searchAndRenderStocks(""); // 初始載入時顯示提示或空列表
            if (currentSelectedStockTrade && currentSelectedStockTrade.ticker) { // 如果之前有選中的股票
                await selectStockForTrading(currentSelectedStockTrade.ticker);
            } else {
                tsShowNoStockSelected();
            }
            updateUserMarketTypeDisplays();
        }

        async function searchAndRenderStocks(searchTerm) {
            if (!tsStockListPanel) return;
            tsStockListPanel.innerHTML = '<div class="stock-item" style="justify-content: center; color: #9ca3af;">搜索中...</div>';
            const data = await fetchAPI(`{{ url_for('search_stocks_api') }}?q=${encodeURIComponent(searchTerm)}`);
            tsStockListPanel.innerHTML = ''; // 清空
            if (data && data.success && data.stocks && data.stocks.length > 0) {
                data.stocks.forEach(stock => {
                    const item = document.createElement('div'); item.className = 'stock-item'; item.dataset.ticker = stock.ticker; item.stockData = stock; // 存儲股票數據
                    const stockDisplayMarket = stock.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US'); // 根據ticker判斷顯示貨幣
                    item.innerHTML = `<div class="stock-info"><span class="name">${stock.name}</span><span class="ticker">${stock.ticker}</span></div><div class="stock-price-info"><span class="price">${typeof stock.price === 'number' ? formatCurrency(stock.price, true, stockDisplayMarket) : 'N/A'}</span><span class="change ${stock.change >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(stock.change)}</span></div>`;
                    item.addEventListener('click', () => selectStockForTrading(stock.ticker));
                    tsStockListPanel.appendChild(item);
                });
            } else { tsStockListPanel.innerHTML = `<div class="stock-item" style="justify-content: center; color: #9ca3af;">您的 ${userMarketType} 市場中未找到符合條件的股票。請嘗試其他關鍵字。</div>`; }
        }

        async function selectStockForTrading(ticker) {
            const quoteData = await fetchAPI(`{{ url_for('stock_quote_api', ticker='__TICKER__') }}`.replace('__TICKER__', ticker));
            if (!quoteData || !quoteData.success) { alert(`無法獲取 ${ticker} 的詳細資訊`); tsShowNoStockSelected(); return; }
            currentSelectedStockTrade = quoteData.data;
            const stockDisplayMarket = ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US'); // 根據ticker判斷顯示貨幣

            // 更新列表選中狀態
            tsStockListPanel.querySelectorAll('.stock-item').forEach(item => item.classList.remove('selected'));
            const newSelectedItemEl = tsStockListPanel.querySelector(`.stock-item[data-ticker="${ticker}"]`);
            if (newSelectedItemEl) newSelectedItemEl.classList.add('selected');

            if(tsDetailStockNameEl) tsDetailStockNameEl.textContent = `${currentSelectedStockTrade.name} (${currentSelectedStockTrade.ticker})`;
            if(tsCurrentStockPriceEl) tsCurrentStockPriceEl.textContent = formatCurrency(currentSelectedStockTrade.current_price, true, stockDisplayMarket);
            if(tsOwnedSharesEl && currentUser && currentUser.account && currentUser.account.portfolio) { // 確保 portfolio 存在
                 tsOwnedSharesEl.textContent = currentUser.account.portfolio[ticker]?.shares || 0;
            } else if(tsOwnedSharesEl) { // currentUser 或 account 或 portfolio 不存在時
                tsOwnedSharesEl.textContent = 0;
            }

            tsShowStockDetails(); tsSwitchTab('buy'); // 預設為買入標籤
            if(tsSharesInput) tsSharesInput.value = 1; if(tsMoodSelect) tsMoodSelect.value = ""; if(tsReasonInput) tsReasonInput.value = ""; // 重置表單
            tsUpdateTradeSummary();
            updateUserMarketTypeDisplays();
        }

        function tsShowNoStockSelected() { if(tsStockDetailsContent) tsStockDetailsContent.classList.add('hidden'); if(tsNoStockPlaceholder) tsNoStockPlaceholder.classList.remove('hidden'); }
        function tsShowStockDetails() { if(tsStockDetailsContent) tsStockDetailsContent.classList.remove('hidden'); if(tsNoStockPlaceholder) tsNoStockPlaceholder.classList.add('hidden'); }

        function tsUpdateTradeSummary() {
            if (!currentSelectedStockTrade || !tsSharesInput || !tsSummaryTotalCostEl || !tsSummaryCashAfterTradeEl || typeof currentSelectedStockTrade.current_price !== 'number' || !currentUser || !currentUser.account) return;
            const shares = Math.max(0, parseInt(tsSharesInput.value)) || 0; // 確保股數為正整數
            const price = parseFloat(currentSelectedStockTrade.current_price);
            const totalValue = shares * price;
            const isBuying = tsSubmitTradeBtn && !tsSubmitTradeBtn.classList.contains('sell');
            const currentCashForAccount = currentUser.account.cashBalance; // 使用本地存儲的餘額進行預估
            const stockDisplayMarket = currentSelectedStockTrade.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');

            if(tsSummaryTotalCostEl) tsSummaryTotalCostEl.textContent = formatCurrency(totalValue, true, stockDisplayMarket);
            if (isBuying) {
                if(tsSummaryCostLabel) tsSummaryCostLabel.textContent = '預計總成本:';
                if(tsSummaryBalanceLabel) tsSummaryBalanceLabel.innerHTML = `買入後現金餘額 (<span class="user-market-type-display">${userMarketType}</span>):`;
                if(tsSummaryCashAfterTradeEl) tsSummaryCashAfterTradeEl.textContent = formatCurrency(currentCashForAccount - totalValue);
            } else { // Selling
                if(tsSummaryCostLabel) tsSummaryCostLabel.textContent = '預計總收益:';
                if(tsSummaryBalanceLabel) tsSummaryBalanceLabel.innerHTML = `賣出後現金餘額 (<span class="user-market-type-display">${userMarketType}</span>):`;
                if(tsSummaryCashAfterTradeEl) tsSummaryCashAfterTradeEl.textContent = formatCurrency(currentCashForAccount + totalValue);
            }
            updateUserMarketTypeDisplays();
        }

        function tsSwitchTab(tabType) {
            if (!currentSelectedStockTrade || !tsBuyTab || !tsSellTab || !tsSubmitTradeBtn) return;
            const stockTicker = currentSelectedStockTrade.ticker;
            const isBuying = tabType === 'buy';
            tsBuyTab.classList.toggle('active', isBuying); tsSellTab.classList.toggle('active', !isBuying);
            tsSubmitTradeBtn.textContent = isBuying ? `買入 ${stockTicker}` : `賣出 ${stockTicker}`;
            tsSubmitTradeBtn.classList.toggle('sell', !isBuying); // 切換按鈕顏色
            tsBuyTab.textContent = `買入 ${stockTicker}`; tsSellTab.textContent = `賣出 ${stockTicker}`;
            tsUpdateTradeSummary(); // 更新摘要
        }

        if(tsStockSearchInput) {
            let searchTimeout;
            tsStockSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const searchTerm = e.target.value.trim();
                const placeholderText = userMarketType === 'TW' ? "搜索台股 (例如: 2330.TW)" : "搜索美股 (例如: AAPL)";
                
                if (searchTerm.length === 0) { if(tsStockListPanel) tsStockListPanel.innerHTML = `<div class="stock-item" style="justify-content: center; color: #9ca3af;">${userMarketType ? placeholderText : '請輸入股票名稱或代號。'}</div>`; return; }
                searchTimeout = setTimeout(() => { searchAndRenderStocks(searchTerm); }, 300); // 延遲搜索以避免過多請求
            });
        }

        if(tsTradeForm) {
            tsTradeForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!currentSelectedStockTrade) { alert("請先選擇一支股票。"); return; }
                const shares = parseInt(tsSharesInput.value); const mood = tsMoodSelect.value; const reason = tsReasonInput.value.trim();
                const isBuying = !tsSubmitTradeBtn.classList.contains('sell');
                if (shares <= 0) { alert("股數必須大於 0。"); return; }
                if (!mood) { alert("請選擇您交易時的心情。"); return; }

                // 再次檢查市場類型是否匹配
                if (userMarketType === 'TW' && !currentSelectedStockTrade.ticker.endsWith('.TW')) {
                    alert(`您目前在台股市場。您只能交易以 .TW 結尾的股票。 ${currentSelectedStockTrade.ticker} 不是有效的台股交易標的。`);
                    return;
                }
                if (userMarketType === 'US' && currentSelectedStockTrade.ticker.endsWith('.TW')) {
                     alert(`您目前在美股市場。您不能交易 .TW 股票。 ${currentSelectedStockTrade.ticker} 不是有效的美股交易標的。`);
                    return;
                }

                const latestQuote = await fetchAPI(`{{ url_for('stock_quote_api', ticker='__TICKER__') }}`.replace('__TICKER__', currentSelectedStockTrade.ticker));
                if (!latestQuote || !latestQuote.success || latestQuote.data.current_price == null) { alert(`無法確認 ${currentSelectedStockTrade.ticker} 的當前價格。交易已取消。`); return; }
                const priceAtTrade = parseFloat(latestQuote.data.current_price);
                const totalTransactionValue = shares * priceAtTrade;
                const stockDisplayMarket = currentSelectedStockTrade.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');

                if (!confirm(`確認${isBuying ? '買入' : '賣出'} ${shares} 股 ${currentSelectedStockTrade.ticker} (您的 ${userMarketType} 市場帳戶) @ ${formatCurrency(priceAtTrade, true, stockDisplayMarket)} (總計: ${formatCurrency(totalTransactionValue, true, stockDisplayMarket)})?`)) return;

                tsSubmitTradeBtn.disabled = true; tsSubmitTradeBtn.textContent = '處理中...';
                const tradeResult = await fetchAPI("{{ url_for('trade_api') }}", 'POST', { type: isBuying ? 'buy' : 'sell', ticker: currentSelectedStockTrade.ticker, shares: shares, mood: mood, reason: reason });
                tsSubmitTradeBtn.disabled = false; tsSwitchTab(isBuying ? 'buy' : 'sell'); // 重置按鈕狀態

                if (tradeResult && tradeResult.success) {
                    alert(tradeResult.message); // 顯示成功訊息
                    await fetchUserSession(false); // 更新用戶 session 數據 (不強制切換視圖)
                    if(currentSelectedStockTrade && tsOwnedSharesEl && currentUser.account && currentUser.account.portfolio) { // 確保這些元素和數據存在
                         tsOwnedSharesEl.textContent = currentUser.account.portfolio[currentSelectedStockTrade.ticker]?.shares || 0;
                    }
                    tsUpdateTradeSummary(); // 更新交易摘要
                    if(tsReasonInput) tsReasonInput.value = ""; if(tsMoodSelect) tsMoodSelect.value = ""; if(tsSharesInput) tsSharesInput.value = 1; // 重置表單
                    
                    // 如果當前在 Dashboard 或 Portfolio 頁面，刷新數據
                    const currentView = window.location.hash.substring(1) || 'dashboard';
                    if (currentView === 'dashboard') loadDashboardData();
                    if (currentView === 'my_portfolio') loadMyPortfolioData();

                } else { alert('交易失敗: ' + (tradeResult ? tradeResult.message : '未知錯誤。')); }
            });
        }
        if (tsBuyTab) tsBuyTab.addEventListener('click', () => tsSwitchTab('buy'));
        if (tsSellTab) tsSellTab.addEventListener('click', () => tsSwitchTab('sell'));
        if (tsSharesInput) { tsSharesInput.addEventListener('input', tsUpdateTradeSummary); tsSharesInput.addEventListener('change', tsUpdateTradeSummary); }

        async function loadMyPortfolioData() {
            if (!currentUser || !mpPortfolioOverviewGridEl || !mpHoldingsTableBodyEl || !mpEmptyPortfolioMessageEl) return;

            const data = await fetchAPI(`{{ url_for('portfolio_data_api') }}`);
            if (!data || !data.success) { mpHoldingsTableBodyEl.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#9ca3af;">無法載入投資組合。</td></tr>`; return; }

            const { overview, holdings, marketType } = data;
            userMarketType = marketType; // 更新全局市場類型
            updateUserMarketTypeDisplays(); // 更新所有相關顯示

            mpHoldingsTableBodyEl.innerHTML = ''; // 清空表格
            if (holdings.length === 0) {
                mpEmptyPortfolioMessageEl.style.display = 'block'; // 顯示空組合訊息
                const emptyPortfolioTradeLink = mpEmptyPortfolioMessageEl.querySelector('.empty-portfolio-trade-link');
                if (emptyPortfolioTradeLink) { 
                    emptyPortfolioTradeLink.replaceWith(emptyPortfolioTradeLink.cloneNode(true)); // 移除舊監聽器
                    mpEmptyPortfolioMessageEl.querySelector('.empty-portfolio-trade-link').addEventListener('click', (e) => { e.preventDefault(); switchView('trade_stocks'); }); 
                }
            } else {
                mpEmptyPortfolioMessageEl.style.display = 'none'; // 隱藏空組合訊息
                holdings.forEach(h => {
                    const row = mpHoldingsTableBodyEl.insertRow();
                    const stockDisplayMarket = h.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');
                    row.innerHTML = `<td class="stock-name-cell">${h.name || h.ticker} <span class="ticker">${h.ticker}</span></td><td class="align-right">${h.shares}</td><td class="align-right">${formatCurrency(h.avgCost, true, stockDisplayMarket)}</td><td class="align-right">${formatCurrency(h.currentPrice, true, stockDisplayMarket)}</td><td class="align-right">${formatCurrency(h.marketValue, true, stockDisplayMarket)}</td><td class="align-right ${h.todayChangePercent >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(h.todayChangePercent)}</td><td class="align-right ${h.totalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(h.totalPL, true, stockDisplayMarket)} (${formatPercentage(h.totalPLPercent, false)})</td>`;
                });
            }
            // 更新投資組合概覽卡片
            mpPortfolioOverviewGridEl.innerHTML = `
                <div class="overview-metric-card"><span class="label">總投資組合價值 (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value">${formatCurrency(overview.totalPortfolioValue)}</div><div class="change ${overview.totalOverallPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(overview.totalOverallPLPercent, true).replace(' ', ` ${formatCurrency(overview.totalOverallPL, false)} `)} 總盈虧</div></div>
                <div class="overview-metric-card"><span class="label">今日盈虧 (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(overview.todayTotalPL)}</div><div class="change ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(overview.todayTotalPLPercent)}</div></div>
                <div class="overview-metric-card"><span class="label">現金餘額 (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value">${formatCurrency(overview.cashBalance)}</div><div class="change" style="color: #6b7280;">可用於交易</div>`;
        }

        function loadAiReportsView() {
            if(investmentReportOutputEl) { investmentReportOutputEl.textContent = '點擊按鈕以生成報告...'; investmentReportOutputEl.style.display = 'none'; }
            if(behavioralAnalysisOutputEl) { behavioralAnalysisOutputEl.textContent = '點擊按鈕以生成分析...'; behavioralAnalysisOutputEl.style.display = 'none'; }
            updateUserMarketTypeDisplays();
        }

        async function generateAIReport(reportType) {
            let outputArea, loadingText, button;
            if (reportType === 'investment') { outputArea = investmentReportOutputEl; loadingText = '正在生成投資報告...'; button = generateInvestmentReportBtn; }
            else if (reportType === 'behavioral') { outputArea = behavioralAnalysisOutputEl; loadingText = '正在分析行為模式...'; button = generateBehavioralReportBtn; }
            else return;
            if (!outputArea || !button) return;
            outputArea.style.display = 'block'; outputArea.textContent = loadingText; button.disabled = true; button.style.opacity = 0.7;
            const reportData = await fetchAPI("{{ url_for('generate_ai_report_api') }}", 'POST', { reportType: reportType });
            if (reportData && reportData.success) {
                // 簡單的 Markdown 轉 HTML (粗體、斜體、項目符號)
                let htmlContent = reportData.report_content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*[\*-]\s+(.*)/gm, '<li>$1</li>');
                if (htmlContent.includes('<li>')) { htmlContent = '<ul>' + htmlContent.replace(/<\/li>(\s*<li>)/g, '</li>$1') + '</ul>'; htmlContent = htmlContent.replace(/<\/li>\s*<br>/g, '</li>');} // 包裹列表
                htmlContent = htmlContent.replace(/\n/g, '<br>'); // 換行符轉 <br>
                outputArea.innerHTML = htmlContent;
            } else { outputArea.textContent = '無法生成報告: ' + (reportData ? reportData.message : '未知的伺服器錯誤。'); }
            button.disabled = false; button.style.opacity = 1;
        }
        if (generateInvestmentReportBtn) generateInvestmentReportBtn.addEventListener('click', () => generateAIReport('investment'));
        if (generateBehavioralReportBtn) generateBehavioralReportBtn.addEventListener('click', () => generateAIReport('behavioral'));

        function loadAiStockAnalysisView() {
            console.log("載入 AI 個股分析視圖...");
            if (aiStockAnalysisOutputArea) { aiStockAnalysisOutputArea.innerHTML = ''; aiStockAnalysisOutputArea.style.display = 'none'; }
            if (aiStockAnalysisTickerInput) {
                aiStockAnalysisTickerInput.value = ''; // 清空輸入框
                aiStockAnalysisTickerInput.placeholder = "輸入股票代號 (例: 2330.TW 或 AAPL)"; // 預設提示
            }
            if (aiStockAnalysisIncludeGaCheckbox) { // 重置 GA 複選框
                aiStockAnalysisIncludeGaCheckbox.checked = false;
            }
        }

        if (aiStockAnalysisSubmitBtn) {
            aiStockAnalysisSubmitBtn.addEventListener('click', async () => {
                const ticker = aiStockAnalysisTickerInput.value.trim().toUpperCase();
                const includeGa = aiStockAnalysisIncludeGaCheckbox.checked; // 獲取 GA 檢查選項
                if (!ticker) { alert('請輸入股票代號。'); return; }

                aiStockAnalysisSubmitBtn.disabled = true;
                aiStockAnalysisSubmitBtn.innerHTML = `<svg class="animate-spin nav-icon" style="width:16px; height:16px; margin-right: 6px; vertical-align: middle;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>分析中...`;
                aiStockAnalysisOutputArea.innerHTML = '<p style="text-align:center; color:#6b7280;">正在獲取 AI 個股分析報告，請稍候...</p>';
                aiStockAnalysisOutputArea.style.display = 'block';

                try {
                    const response = await fetchAPI("{{ url_for('api_analyze_stock_on_demand') }}", 'POST', { 
                        ticker: ticker,
                        include_ga: includeGa // 將 include_ga 參數傳遞給後端
                    });

                    if (response && response.success && response.data) {
                        const stockData = response.data;
                        let newsHtml = '<h4>相關新聞</h4>';
                        if (stockData.news && stockData.news.length > 0) {
                            newsHtml += '<ul class="news-list">';
                            stockData.news.slice(0, 5).forEach(n => { newsHtml += `<li><a href="${n.link}" target="_blank" rel="noopener noreferrer">${n.title}</a> <span class="news-source">(${n.source} - ${n.date})</span></li>`; });
                            newsHtml += '</ul>';
                        } else { newsHtml += '<p style="font-size:13px; color:#6b7280;">暫無相關新聞。</p>'; }

                        const formatDisplay = (value, unit = '', precision = 2, isPercentVal = false) => {
                            if (value === null || typeof value === 'undefined' || String(value).toUpperCase() === 'N/A') return 'N/A';
                            if (typeof value === 'number') { return isPercentVal ? (value * 100).toFixed(precision) + '%' : value.toFixed(precision) + unit; }
                            if (isPercentVal && String(value).endsWith('%')) return value; // 如果本身就是百分比字符串
                            return String(value) + unit;
                        };
                        const formatCurrencyOnDemand = (value, currencyCode = 'USD') => { // 用於個股分析頁面的貨幣格式化
                             if (value === null || typeof value === 'undefined' || String(value).toUpperCase() === 'N/A') return 'N/A';
                             const num = Number(value); if (isNaN(num)) return 'N/A';
                             const symbol = currencyCode === 'TWD' ? 'NT$' : '$'; let numStr;
                             // 根據數值大小自動添加單位 (兆、億、萬 for TWD)
                             if (Math.abs(num) >= 1e12) numStr = (num / 1e12).toFixed(1) + '兆';
                             else if (Math.abs(num) >= 1e8) numStr = (num / 1e8).toFixed(1) + '億';
                             else if (Math.abs(num) >= 1e4 && currencyCode === 'TWD') numStr = (num / 1e4).toFixed(1) + '萬';
                             else numStr = num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                             if (currencyCode === 'TWD' && numStr.includes('.') && numStr.endsWith('00') && !numStr.includes('兆') && !numStr.includes('億') && !numStr.includes('萬') ) { // 台幣整數不顯示小數點
                                numStr = numStr.substring(0, numStr.lastIndexOf('.00'));
                             }
                             return symbol + numStr;
                        };
                        const formatAIAnalysisText = (text) => { // 格式化 AI 分析文本 (Markdown -> HTML)
                            if (!text) return '無法生成 AI 分析報告。';
                            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); // 粗體和斜體
                            html = html.replace(/(\n|^)\s*[\*-]\s+(.*)/g, '$1<li>$2</li>'); // 項目符號
                            html = html.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); // 包裹列表
                            html = html.replace(/\n/g, '<br>').replace(/<br>\s*<ul>/g, '<ul>').replace(/<\/ul>\s*<br>/g, '</ul>'); // 換行和列表整理
                            return html;
                        };
                        
                        let gaSignalHtml = ''; // 初始化 GA 信號 HTML
                        if (stockData.ga_signal_info) { // 如果後端返回了 GA 信號信息
                            gaSignalHtml = `<hr style="margin: 20px 0; border-top: 1px solid #eee;"><h4>GA 策略信號評估</h4>`;
                            gaSignalHtml += `<div class="ga-signal-output">`;
                            let signalClass = 'signal-neutral';
                            if (stockData.ga_signal_info.signal === 'BUY') signalClass = 'signal-buy';
                            else if (stockData.ga_signal_info.signal === 'SELL') signalClass = 'signal-sell'; // 如果將來有賣出信號
                            else if (stockData.ga_signal_info.signal === 'ERROR' || stockData.ga_signal_info.signal === 'N/A') signalClass = 'signal-error';

                            gaSignalHtml += `<p><strong>當前信號:</strong> <span class="${signalClass}">${stockData.ga_signal_info.signal || 'N/A'}</span></p>`;
                            gaSignalHtml += `<p><strong>判斷依據:</strong> ${stockData.ga_signal_info.reason || 'N/A'}</p>`;
                            // 可以選擇性顯示基因，例如用於調試
                            // if (stockData.ga_signal_info.gene_used) {
                            //    gaSignalHtml += `<p style="font-size:0.8em;color:#777;"><em>(策略基因: ${JSON.stringify(stockData.ga_signal_info.gene_used)})</em></p>`;
                            // }
                            gaSignalHtml += `</div>`;
                        }

                        aiStockAnalysisOutputArea.innerHTML = `
                            <h2>${stockData.company_name || stockData.ticker} (${stockData.ticker}) - AI 即時分析</h2>
                            <p style="font-size: 13px; color: #6b7280; margin-top:0; margin-bottom:15px;">目前價格: ${formatCurrencyOnDemand(stockData.current_price, stockData.currency)} | 日漲跌: <span class="${parseFloat(stockData.price_change_value) >= 0 ? 'text-green-600' : 'text-red-600'}">${stockData.price_change || 'N/A'}</span> | 成交量: ${stockData.volume ? stockData.volume.toLocaleString() : 'N/A'}</p>
                            <div class="key-metrics-grid">
                                <div class="metric-item"><strong>本益比:</strong> ${formatDisplay(stockData.pe_ratio)}</div><div class="metric-item"><strong>市值:</strong> ${formatCurrencyOnDemand(stockData.market_cap, stockData.currency)}</div>
                                <div class="metric-item"><strong>每股盈餘 (EPS):</strong> ${formatCurrencyOnDemand(stockData.eps, stockData.currency)}</div><div class="metric-item"><strong>股東權益報酬率 (ROE):</strong> ${stockData.roe_display || 'N/A'}</div>
                                <div class="metric-item"><strong>淨利率:</strong> ${stockData.net_profit_margin || 'N/A'}</div><div class="metric-item"><strong>流動比率:</strong> ${stockData.current_ratio || 'N/A'}</div>
                            </div>
                            <h4>AI 分析結論</h4><div class="ai-conclusion">${formatAIAnalysisText(stockData.analysis)}</div>
                            ${newsHtml}
                            <h4>技術分析圖 (簡化版)</h4>
                            ${stockData.chart_url ? `<iframe src="${stockData.chart_url}" class="chart-iframe" title="股票 ${stockData.ticker} 的技術圖表"></iframe>` : '<p style="font-size:13px; color:#6b7280;">無法載入技術圖表 (或功能暫未開放)。</p>'}
                            <p class="chart-disclaimer">圖表資料來自 Yahoo Finance (若有)。</p>
                            ${gaSignalHtml}`; // 在此處添加 GA 信號的 HTML
                    } else { aiStockAnalysisOutputArea.innerHTML = `<p style="color: #dc2626; text-align:center;">分析失敗: ${response ? response.message : '無法連接伺服器或功能尚未實作。'}</p>`; }
                } catch (error) { 
                    console.error("獲取 AI 個股分析時發生錯誤:", error); 
                    aiStockAnalysisOutputArea.innerHTML = '<p style="color: #dc2626; text-align:center;">請求分析時發生網路錯誤。</p>';
                } finally {
                    aiStockAnalysisSubmitBtn.disabled = false;
                    aiStockAnalysisSubmitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px;"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg>分析個股`;
                }
            });
        }

        function handleHashNavigation() {
            let hash = window.location.hash.substring(1);
            const defaultView = 'dashboard';
            const validViews = ['dashboard', 'trade_stocks', 'ai_stock_analysis', 'my_portfolio', 'ai_reports'];
            if (!validViews.includes(hash)) { // 如果 hash 無效，則設為預設視圖
                hash = defaultView;
                if (window.location.hash !== `#${hash}`) { window.location.hash = hash; return; } // 觸發 hashchange
            }
            if (currentUser || hash === 'login' || hash === 'register') { // 如果已登錄，或目標是登錄/註冊頁
                switchView(hash); 
            }
            else { console.log("延遲視圖切換，等待用戶 session。"); }
        }
        navItems.forEach(item => {
            const link = item.querySelector('a');
            if (link) {
                link.addEventListener('click', (event) => {
                    // event.preventDefault(); // 不需要了，因為 switchView 會處理 hash
                    const viewId = link.dataset.view;
                    if (viewId) { if(window.location.hash !== `#${viewId}`) { window.location.hash = viewId; } else { switchView(viewId); /* 如果 hash 相同，強制切換 */ }}
                });
            }
        });
        window.addEventListener('hashchange', handleHashNavigation);

        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm("您確定要登出嗎？您的模擬進度將會儲存。")) {
                    const logoutResult = await fetchAPI("{{ url_for('logout_api') }}", 'POST');
                    if (logoutResult && logoutResult.success) { currentUser = null; alert("您已成功登出。"); window.location.href = "{{ url_for('finsimu_login_route') }}"; }
                    else { alert("登出失敗。請再試一次。"); }
                }
            });
        }
        async function fetchUserSession(doSwitchViewOnLoad = true) {
            console.log("正在獲取用戶 session (單一市場)...");
            const sessionData = await fetchAPI("{{ url_for('get_user_session_api') }}");
            if (sessionData && sessionData.loggedIn && sessionData.currentUser) {
                currentUser = sessionData.currentUser;
                userMarketType = currentUser.marketType || 'N/A'; // 從 session 獲取市場類型

                console.log("用戶 session 已載入:", currentUser);
                console.log("用戶市場類型:", userMarketType);

                updateSidebarUser(); // 更新側邊欄用戶信息
                updateUserMarketTypeDisplays(); // 更新所有市場類型顯示
                if(doSwitchViewOnLoad) handleHashNavigation(); // 根據 hash 切換視圖
                return true;
            } else {
                // 如果不在登錄或註冊頁，則重定向到登錄頁
                const currentPath = window.location.pathname;
                let loginPath = "{{ url_for('finsimu_login_route') }}"; // 獲取登錄路由
                let registerPath = "{{ url_for('finsimu_register_route') }}"; // 獲取註冊路由

                // 簡化路徑比較 (只比較文件名部分)
                if (loginPath.includes('/')) loginPath = loginPath.substring(loginPath.lastIndexOf('/') + 1) || loginPath;
                if (registerPath.includes('/')) registerPath = registerPath.substring(registerPath.lastIndexOf('/') + 1) || registerPath;
                
                const currentFile = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);

                const onAuthPage = currentFile === loginPath || currentFile === registerPath;
                
                if (!onAuthPage) {
                    console.log("無活動 session。從:", window.location.pathname, "重定向到登錄頁");
                    window.location.href = "{{ url_for('finsimu_login_route') }}";
                } else {
                    console.log("無活動 session，但已在認證頁面。");
                }
                return false;
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM 完全載入 - V10.5 (PWA, RWD, GA Precalc, GA OnDemand)");
            const sessionIsValid = await fetchUserSession(true); // 傳 true 以在載入時切換視圖
            if (sessionIsValid && currentUser) {
                // 為快速操作按鈕添加事件監聽器
                quickActionButtons.forEach(button => button.addEventListener('click', () => {
                    const targetView = button.dataset.viewTarget; if (targetView) window.location.hash = targetView;
                }));
                // 更新搜索框的 placeholder
                if(tsStockSearchInput && userMarketType) {
                     tsStockSearchInput.placeholder = userMarketType === 'TW' ? "搜索台股 (例如: 2330.TW)" : "搜索美股 (例如: AAPL)";
                }
                 if(aiStockAnalysisTickerInput && userMarketType) { // 也更新 AI 分析頁的 placeholder
                    aiStockAnalysisTickerInput.placeholder = "輸入股票代號 (例: 2330.TW 或 AAPL)";
                }
            }

            // RWD Sidebar Toggle Logic
            if (hamburgerMenuBtn && appSidebar && sidebarCloseBtn && sidebarOverlay) {
                hamburgerMenuBtn.addEventListener('click', () => toggleSidebar(true));
                sidebarCloseBtn.addEventListener('click', () => toggleSidebar(false));
                sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
            }
        });

        function toggleSidebar(open) {
            if (appSidebar && sidebarOverlay && mainContentArea) {
                appSidebar.classList.toggle('open', open);
                sidebarOverlay.classList.toggle('active', open);
            }
        }


        if (fetchGaPotentialBuysBtn) {
            fetchGaPotentialBuysBtn.addEventListener('click', async () => {
                if (!currentUser || !userMarketType) {
                    alert("請先登入並確保已設定您的市場偏好。");
                    return;
                }

                gaPotentialBuysOutputEl.innerHTML = '<p style="text-align:center; color:#6b7280;">正在搜索 GA 潛力買入股，請稍候...</p>';
                fetchGaPotentialBuysBtn.disabled = true;
                fetchGaPotentialBuysBtn.style.opacity = 0.7;
                const btnIcon = fetchGaPotentialBuysBtn.querySelector('svg');
                if(btnIcon) btnIcon.classList.add('animate-spin');


                try {
                    const response = await fetchAPI(`{{ url_for('get_ga_potential_buys') }}?marketType=${userMarketType}`);

                    if (response && response.success) {
                        if (response.stocks && response.stocks.length > 0) {
                            let html = `<h4 style="margin-bottom:10px; color:#111827;">GA 識別的 ${response.marketType} 市場潛力買入股:</h4><ul>`;
                            response.stocks.forEach(stock => {
                                html += `<li style="padding: 8px 10px; border-bottom: 1px solid #f0f2f5;">
                                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                                <div>
                                                    <strong style="color: #1e40af; font-size:15px;">${stock.name || stock.ticker} (${stock.ticker})</strong><br>
                                                    <small class="ga-buy-reason">判斷依據: ${stock.reason || 'GA買入信號（無詳細原因）'}</small>
                                                </div>
                                                <span style="font-weight:500; font-size:14px; white-space:nowrap; margin-left:10px;">${stock.current_price !== null ? formatCurrency(stock.current_price, true, response.marketType) : 'N/A'}</span>
                                            </div>
                                         </li>`;
                            });
                            html += `</ul><p class="disclaimer-note">免責聲明：這些是基於自動化策略信號（使用歷史數據）的結果，並非財務建議。數據截至最近的市場收盤。顯示的股票來自預先訓練的 AI 觀察列表。</p>`;
                            gaPotentialBuysOutputEl.innerHTML = html;
                        } else {
                            gaPotentialBuysOutputEl.innerHTML = `<p style="text-align:center; color:#6b7280;">目前在 ${response.marketType} 市場的觀察列表中未識別到強烈的 GA 買入信號。</p>`;
                        }
                    } else {
                        gaPotentialBuysOutputEl.innerHTML = `<p style="color: #dc2626; text-align:center;">無法獲取 GA 潛力買入股: ${response ? response.message : '伺服器錯誤或 GA 引擎不可用。'}</p>`;
                    }
                } catch (error) {
                    console.error("獲取 GA 潛力買入股時發生錯誤:", error);
                    gaPotentialBuysOutputEl.innerHTML = '<p style="color: #dc2626; text-align:center;">獲取 GA 潛力買入股時發生網路錯誤。</p>';
                } finally {
                    fetchGaPotentialBuysBtn.disabled = false;
                    fetchGaPotentialBuysBtn.style.opacity = 1;
                    if(btnIcon) btnIcon.classList.remove('animate-spin');
                }
            });
        }
        // =============================================
        //                JavaScript End
        // =============================================
    </script>

    <!-- Service Worker Registration Script -->
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
          .then(function(registration) {
            console.log('FinSimU ServiceWorker 註冊成功, 範圍:', registration.scope);
          }, function(err) {
            console.error('FinSimU ServiceWorker 註冊失敗:', err);
          });
      });
    }
    </script>
</body>
</html>
