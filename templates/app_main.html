<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSimU - ä¸»æ§å°</title>

    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <!-- ä½ å¯ä»¥æ ¹æ“šéœ€è¦æ·»åŠ æ›´å¤šå°ºå¯¸çš„ apple-touch-icon -->
    <!-- ä¾‹å¦‚: <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon-180x180.png') }}"> -->


    <style>
        /* ============================================= */
        /*                Global CSS Start               */
        /* ============================================= */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            background-color: #f0f2f5;
            color: #1f2937;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .page-container { display: flex; width: 100%; }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 260px; background-color: #ffffff; padding: 25px 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            height: 100vh; position: fixed; left: 0; top: 0;
            transform: translateX(0); /* For RWD transition */
            transition: transform 0.3s ease-in-out; /* For RWD transition */
            overflow-y: auto; box-sizing: border-box; z-index: 1001; /* Ensure sidebar is on top */
        }
        /* RWD: Sidebar hidden by default on small screens */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }

        .sidebar-header { display: flex; align-items: center; margin-bottom: 35px; padding-left: 5px; justify-content: space-between;} /* Changed to space-between */
        .logo-img { width: 36px; height: 36px; border-radius: 6px; margin-right: 12px; }
        .app-title { font-size: 22px; color: #1e40af; font-weight: 700; margin: 0; }
        
        /* Hamburger Icon for RWD */
        .hamburger-menu {
            display: none; /* Hidden by default */
            cursor: pointer;
            padding: 10px;
            z-index: 1002; /* Above sidebar */
            position: fixed; /* Or absolute relative to main-content-view */
            top: 15px;
            left: 15px;
            background-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .hamburger-menu svg { width: 24px; height: 24px; color: #3b82f6;}

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
        }
        /* Close button inside sidebar for RWD */
        .sidebar-close-button {
            display: none; /* Hidden by default */
            background: none; border: none; font-size: 24px; color: #6b7280;
            cursor: pointer; padding: 5px; align-self: flex-end; /* Position to the right */
        }
        @media (max-width: 768px) {
            .sidebar-close-button {
                display: block;
            }
        }


        .sidebar-nav ul { list-style-type: none; padding: 0; margin: 0; }
        .sidebar-nav .nav-item a {
            display: flex; align-items: center; padding: 12px 15px; color: #4b5563;
            text-decoration: none; border-radius: 6px; margin-bottom: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 15px; font-weight: 500;
        }
        .sidebar-nav .nav-item .nav-icon { margin-right: 12px; color: #6b7280; transition: color 0.2s ease; width: 20px; height:20px; flex-shrink: 0; }
        .sidebar-nav .nav-item a:hover { background-color: #f3f4f6; color: #1e40af; }
        .sidebar-nav .nav-item a:hover .nav-icon { color: #1e40af; }
        .sidebar-nav .nav-item.active a { background-color: #e0e7ff; color: #3b82f6; font-weight: 600; }
        .sidebar-nav .nav-item.active .nav-icon { color: #3b82f6; }
        .sidebar-user-profile {
            margin-top: auto; padding: 20px 10px; border-top: 1px solid #e5e7eb;
            display: flex; align-items: center;
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .user-details { display: flex; flex-direction: column; line-height: 1.3; }
        .user-name { font-size: 14px; font-weight: 600; color: #1f2937; }
        .user-status { font-size: 12px; color: #6b7280; }
        .sidebar-footer { padding: 15px 10px; border-top: 1px solid #e5e7eb; }
        .footer-link {
            display: flex; align-items: center; color: #4b5563; text-decoration: none;
            font-size: 14px; padding: 8px 5px; border-radius: 6px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .footer-link:hover { background-color: #f3f4f6; color: #1f2937; }
        .footer-link .nav-icon { margin-right: 10px; width: 18px; height: 18px; flex-shrink: 0;}

        .main-content-view {
            flex-grow: 1; padding: 25px 30px; margin-left: 260px; /* Default margin */
            display: flex; flex-direction: column; max-height: 100vh;
            box-sizing: border-box; overflow-y: auto;
            transition: margin-left 0.3s ease-in-out; /* For RWD transition */
        }
        /* RWD: Main content full width when sidebar is closed */
        @media (max-width: 768px) {
            .main-content-view {
                margin-left: 0;
                padding: 25px 15px; /* Adjust padding for smaller screens */
            }
        }

        .view-section { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        .page-header { margin-bottom: 25px; }
        .page-header h1 { font-size: 26px; font-weight: 700; color: #111827; margin: 0 0 6px 0; }
        .page-header p.subtitle { font-size: 14px; color: #6b7280; margin: 0; }
        @media (max-width: 768px) {
            .page-header h1 { font-size: 22px; }
            .page-header p.subtitle { font-size: 13px; }
        }


        .text-green-600 { color: #059669; }
        .text-red-600 { color: #dc2626; }
        .font-semibold { font-weight: 600; }

        /* --- Dashboard CSS --- */
        .summary-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { /* On very small screens, make cards stack */
            .summary-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        .summary-card { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .summary-card .label { font-size: 14px; color: #6b7280; margin-bottom: 8px; display: block;}
        .summary-card .value { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 5px;}
        .summary-card .sub-text { font-size: 13px; color: #4b5563; }
        .quick-actions-section { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .quick-actions-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .quick-action-button, .action-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px 10px; background-color: #f9fafb; border: 1px solid #e5e7eb;
            border-radius: 8px; font-size: 14px; font-weight: 500; color: #374151;
            cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            text-align: center; gap: 8px;
        }
        .action-button { flex-direction: row; width: auto; padding: 10px 20px;}
        .quick-action-button svg, .action-button svg { color: #3b82f6; width: 20px; height: 20px; }
        .action-button svg {width: 16px; height:16px;}
        .quick-action-button:hover, .action-button:hover:not(:disabled) { background-color: #eff6ff; border-color: #bfdbfe; transform: translateY(-2px); }
        .quick-action-button:active, .action-button:active:not(:disabled) { transform: translateY(0px); }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: translateY(0px); opacity: 0.7;}

        .recent-activity-container { background-color: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .recent-activity-container h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }

        /* --- Trade Stocks CSS --- */
        .trade-header { margin-bottom: 20px; }
        .trade-header h1 { font-size: 26px; font-weight: 700; color: #111827; margin: 0 0 6px 0; }
        .trade-header p { font-size: 14px; color: #6b7280; margin: 0; max-width: 700px; }
        .search-bar-container { margin-bottom: 20px; background-color: #ffffff; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .search-input-wrapper { position: relative; display: flex; align-items: center; }
        .search-input-wrapper .search-icon { position: absolute; left: 12px; color: #9ca3af; width:18px; height:18px;}
        .search-input-wrapper input[type="text"] { width: 100%; padding: 10px 12px 10px 40px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .search-input-wrapper input[type="text"]:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .trading-interface {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
            height: calc(100vh - 230px); /* Adjust based on your header/search bar height */
        }
        @media (max-width: 992px) { /* Tablet and below, stack panels */
            .trading-interface {
                flex-direction: column;
                height: auto; /* Allow content to determine height */
                overflow: visible;
            }
            .stock-list-panel {
                width: 100%; /* Full width */
                max-height: 300px; /* Limit height and make scrollable */
                margin-bottom: 20px;
            }
            .stock-details-panel {
                width: 100%;
                min-height: 400px; /* Ensure enough space for content */
            }
        }

        .stock-list-panel { width: 330px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; padding: 8px; height: 100%;}
        .stock-item { display: flex; align-items: center; padding: 12px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background-color 0.15s ease; }
        .stock-item:last-child { border-bottom: none; }
        .stock-item:hover { background-color: #f9fafb; }
        .stock-item.selected { background-color: #eff6ff; border-left: 3px solid #3b82f6; padding-left: 7px;}
        .stock-info { flex-grow: 1; }
        .stock-info .name { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-info .ticker { font-size: 12px; color: #6b7280; }
        .stock-price-info { text-align: right; }
        .stock-price-info .price { font-size: 15px; font-weight: 500; color: #111827; display: block; margin-bottom: 2px; }
        .stock-price-info .change { font-size: 12px; }
        .stock-details-panel { flex-grow: 1; background-color: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); padding: 20px 25px; overflow-y: auto; display: flex; flex-direction: column; height: 100%;}
        .stock-details-content.hidden { display: none; }
        .detail-header { display: flex; align-items: center; margin-bottom: 20px; }
        .detail-name-ticker .name { font-size: 20px; font-weight: 600; color: #111827; margin: 0 0 3px 0; }
        .detail-name-ticker .price-shares { font-size: 14px; color: #6b7280; }
        .trade-actions-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; }
        .trade-tab { flex: 1; text-align: center; padding: 12px 10px; cursor: pointer; font-size: 15px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease; background-color: #f9fafb; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .trade-tab:not(:last-child) { border-right: 1px solid #e5e7eb; }
        .trade-tab:hover { color: #374151; background-color: #f3f4f6; }
        .trade-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background-color: #ffffff; border-right-color: transparent; }
        .trade-tab.active + .trade-tab { border-left-color: transparent; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 5px; }
        .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; background-color: #fff; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; font-family: inherit; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .form-group input[type="number"]:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1.1em; padding-right: 2.5rem; }
        .form-group select option { padding: 8px 12px; }
        .trade-summary { margin-top: 15px; margin-bottom: 20px; font-size: 13px; color: #4b5563; }
        .trade-summary div { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .trade-summary span:last-child { font-weight: 500; color: #1f2937; }
        .submit-trade-button { width: 100%; background-color: #10b981; color: white; padding: 12px; border: none; border-radius: 6px; font-size: 15px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; }
        .submit-trade-button.sell { background-color: #ef4444; }
        .submit-trade-button:hover:not(:disabled) { opacity: 0.9; }
        .submit-trade-button:disabled { background-color: #9ca3af; cursor: not-allowed;}
        .trade-note { font-size: 11px; color: #6b7280; margin-top: 15px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .trade-note svg { flex-shrink: 0; margin-top: 1px; width:14px; height:14px;}
        .no-stock-selected-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: #9ca3af; }
        .no-stock-selected-placeholder.hidden { display: none; }
        .no-stock-selected-placeholder svg { margin-bottom: 15px; width: 48px; height: 48px;}

        /* --- AI Stock Analysis Page Specific Styles --- */
        #view-ai_stock_analysis .analysis-input-bar {
            display: flex; flex-wrap: wrap; /* Allow wrapping for checkbox */
            gap: 10px; align-items: center; margin-bottom: 20px;
            background-color: #ffffff; padding:15px; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #view-ai_stock_analysis .analysis-input-bar input[type="text"] {
            flex-grow: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
        }
        #view-ai_stock_analysis .analysis-input-bar input[type="text"]:focus {
             outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Styling for the GA checkbox and its label */
        .ga-checkbox-container {
            display: flex; align-items: center; gap: 6px; 
            font-size: 13px; color: #374151; margin-top: 5px; /* Adjust margin as needed */
            width: 100%; /* Make it take full width on smaller screens if input bar wraps */
        }
        .ga-checkbox-container input[type="checkbox"] { accent-color: #1e40af; }

        #ai-stock-analysis-output-area {
            display: none; background-color: #ffffff; padding: 20px 25px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-top: 0;
        }
        @media (max-width: 768px) {
            #view-ai_stock_analysis .analysis-input-bar {
                flex-direction: column;
                align-items: stretch;
            }
            #ai-stock-analysis-submit-btn { /* Ensure button is full width on mobile */
                width: 100% !important; margin-top: 10px; /* Add some space if checkbox is above */
            }
            .ga-checkbox-container { margin-bottom: 10px; } /* Space before button on mobile */
            #ai-stock-analysis-output-area { padding: 15px; }
        }

        #ai-stock-analysis-output-area h2 { font-size: 20px; color: #111827; margin-bottom:5px; }
        #ai-stock-analysis-output-area h4 { font-size: 15px; color: #1e40af; margin-top: 20px; margin-bottom: 8px; border-bottom: 1px solid #e0e7ff; padding-bottom: 4px;}
        #ai-stock-analysis-output-area .key-metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom:20px; font-size:13px; }
        #ai-stock-analysis-output-area .metric-item { background-color:#f9fafb; padding:10px 12px; border-radius:6px; border: 1px solid #f3f4f6;}
        #ai-stock-analysis-output-area .metric-item strong { color: #374151; }
        #ai-stock-analysis-output-area .ai-conclusion { background-color: #f3f4f6; padding: 15px; border-radius: 6px; font-size: 14px; line-height: 1.65; white-space: pre-wrap; margin-bottom:20px; color: #374151;}
        #ai-stock-analysis-output-area .ai-conclusion strong { color: #1e40af;}
        #ai-stock-analysis-output-area .ai-conclusion em { font-style: italic; color: #059669;}
        #ai-stock-analysis-output-area .ai-conclusion ul { list-style-position: inside; padding-left: 0; margin-top: 8px;}
        #ai-stock-analysis-output-area .ai-conclusion li { margin-bottom: 4px;}
        #ai-stock-analysis-output-area .news-list { list-style-type: none; padding-left: 0; font-size: 13px; }
        #ai-stock-analysis-output-area .news-list li { margin-bottom: 8px; padding: 8px; background-color:#f9fafb; border-radius:4px; border: 1px solid #f3f4f6;}
        #ai-stock-analysis-output-area .news-list a { color: #3b82f6; text-decoration:none; font-weight:500;}
        #ai-stock-analysis-output-area .news-list a:hover { text-decoration:underline;}
        #ai-stock-analysis-output-area .news-list .news-source { color:#6b7280; font-size:11px; margin-left: 5px;}
        #ai-stock-analysis-output-area .chart-iframe { width: 100%; height: 450px; border: none; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } 
        #ai-stock-analysis-output-area .chart-disclaimer { font-size:11px; color:#9ca3af; text-align:center; margin-top:5px;}
        /* GA Signal Info in AI Analysis Output */
        .ga-signal-output {
            background-color: #eef2ff; /* Light blue-indigo background */
            border: 1px solid #c7d2fe;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 15px; /* Space from previous section */
            color: #374151;
        }
        .ga-signal-output strong { color: #1e40af; }
        .ga-signal-output .signal-buy { color: #16a34a; font-weight: bold; }
        .ga-signal-output .signal-sell { color: #dc2626; font-weight: bold; }
        .ga-signal-output .signal-neutral { color: #555; font-weight: bold; }
        .ga-signal-output .signal-error, .ga-signal-output .signal-na { color: #9ca3af; font-style: italic;}


        /* --- My Portfolio CSS --- */
        .portfolio-overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        @media (max-width: 600px) { 
            .portfolio-overview-grid {
                grid-template-columns: 1fr;
            }
        }
        .overview-metric-card { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .overview-metric-card .label { font-size: 14px; color: #6b7280; margin-bottom: 6px; display: block; }
        .overview-metric-card .value { font-size: 24px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .overview-metric-card .change { font-size: 13px; }
        .holdings-section { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow-x: auto; }
        .holdings-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0 0 15px 0; }
        .holdings-table { width: 100%; border-collapse: collapse; min-width: 700px; }
        .holdings-table th, .holdings-table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; white-space: nowrap; }
        .holdings-table th { font-weight: 500; color: #6b7280; background-color: #f9fafb; }
        .holdings-table td { color: #374151; }
        .holdings-table tr:last-child td { border-bottom: none; }
        .holdings-table .align-right { text-align: right; }
        .holdings-table .stock-name-cell .ticker { display: block; font-size: 12px; color: #6b7280; margin-top: 2px; }
        .empty-portfolio { text-align: center; padding: 40px 20px; color: #6b7280; }
        .empty-portfolio svg { width: 48px; height: 48px; margin-bottom: 15px; color: #9ca3af; }
        .empty-portfolio p { font-size: 16px; margin-bottom: 15px; }
        .empty-portfolio .action-button { background-color: #3b82f6; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background-color 0.2s ease; display: inline-block; }
        .empty-portfolio .action-button:hover { background-color: #2563eb; }

        /* --- AI Reports CSS --- */
        .report-section { background-color: #ffffff; border-radius: 8px; padding: 25px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 25px; }
        @media (max-width: 768px) {
            .report-section { padding: 20px 15px; }
        }
        .report-section .section-header { display: flex; align-items: center; margin-bottom: 10px; }
        .report-section .section-icon { width: 24px; height: 24px; margin-right: 12px; color: #3b82f6; }
        .report-section .section-icon.brain { color: #7c3aed; }
        .report-section h2 { font-size: 18px; font-weight: 600; color: #111827; margin: 0; }
        .report-section .description { font-size: 14px; color: #4b5563; margin-bottom: 20px; line-height: 1.6; }
        .disclaimer { font-size: 13px; color: #6b7280; margin-top: 10px; display: flex; align-items: flex-start; gap: 6px; }
        .disclaimer svg { width: 16px; height: 16px; color: #f59e0b; flex-shrink: 0; margin-top: 2px; }
        .report-output-area { margin-top: 20px; padding: 15px; border: 1px dashed #d1d5db; border-radius: 6px; background-color: #f9fafb; min-height: 100px; font-size: 14px; color: #4b5563; display: none; white-space: pre-wrap; overflow-x: auto; }
        .report-output-area strong { color: #1e40af;}
        .report-output-area em { font-style: italic; color: #059669;}
        .report-output-area ul { list-style-position: inside; padding-left: 0; margin-top: 8px;}
        .report-output-area li { margin-bottom: 4px;}

        /* --- GA Potential Buys Section (Dashboard) --- */
        #ga-picks-section {
            background-color: #ffffff; border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        #ga-picks-section .description { font-size: 13px; color: #4b5563; margin-bottom: 15px; line-height: 1.5;}
        #ga-potential-buys-output ul { list-style-type: none; padding-left: 0; margin-top: 15px;}
        #ga-potential-buys-output li {
            padding: 10px 12px; border-bottom: 1px solid #f0f2f5;
            font-size: 14px; color: #374151;
        }
        #ga-potential-buys-output li:last-child { border-bottom: none; }
        #ga-potential-buys-output li strong { color: #1e40af; font-size: 15px; }
        /* Modified small tag for GA buy reason display */
        #ga-potential-buys-output li small.ga-buy-reason { 
            color: #555; display: block; margin-top: 4px; font-size: 12px; 
            line-height: 1.4; /* Improved readability for longer reasons */
        }
        #ga-potential-buys-output .disclaimer-note { 
             font-size:11px; color:#888; margin-top:15px; text-align:center;
        }


        /* ============================================= */
        /*                Global CSS End                 */
        /* ============================================= */
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Overlay for RWD sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1000; /* Below sidebar, above content */
        }
        .sidebar-overlay.active {
            display: block;
        }

    </style>
</head>
<body>
    <div class="page-container">
        <!-- Hamburger Menu for RWD -->
        <div class="hamburger-menu" id="hamburger-menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
        </div>
        <!-- Overlay for RWD sidebar -->
        <div class="sidebar-overlay" id="sidebar-overlay-el"></div>

        <!-- å´é‚Šæ¬„ (Sidebar) -->
        <aside class="sidebar" id="app-sidebar">
            <div class="sidebar-header">
                <div style="display: flex; align-items: center;">
                    <img src="https://placehold.co/36x36/1e40af/white?text=FU" alt="FinSimU Logo" class="logo-img">
                    <h1 class="app-title">FinSimU</h1>
                </div>
                <button class="sidebar-close-button" id="sidebar-close-btn" aria-label="é—œé–‰å´é‚Šæ¬„">&times;</button>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item" id="nav-dashboard"><a href="#dashboard" data-view="dashboard"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg><span>ä¸»æ§å°</span></a></li>
                    <li class="nav-item" id="nav-trade"><a href="#trade_stocks" data-view="trade_stocks"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.83 11.295l-2.121-2.121a1 1 0 00-1.414 0L9.707 12.76a1 1 0 000 1.414l2.121 2.121a1 1 0 001.414 0l3.586-3.586a1 1 0 000-1.414zM5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2zm13 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM8 8.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm0 5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/></svg><span>è‚¡ç¥¨äº¤æ˜“</span></a></li>
                    <li class="nav-item" id="nav-ai_stock_analysis"><a href="#ai_stock_analysis" data-view="ai_stock_analysis">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.9999 1.5C12.5246 1.5 12.9649 1.91558 12.9962 2.43709L12.9999 2.5V5.26009C14.4194 5.40532 15.7626 5.96253 16.8499 6.86009L18.9357 5.30412C19.3957 4.98336 20.0242 5.08019 20.345 5.54022C20.6231 5.94469 20.5522 6.49019 20.1935 6.81694L20.1057 6.89412L18.2287 8.41155C18.9138 9.47108 19.3451 10.6962 19.4804 12H21.4999C22.0208 12 22.4639 12.3882 22.4952 12.899L22.4999 13C22.4999 13.5523 22.0522 14 21.4999 14H19.4804C19.3451 15.3038 18.9138 16.5289 18.2287 17.5884L20.1057 19.1059C20.5522 19.4478 20.6231 20.0553 20.345 20.4598C20.0936 20.8106 19.6212 20.9448 19.2082 20.8239L19.1326 20.7935L18.9357 20.6959L16.8499 19.1399C15.7626 20.0375 14.4194 20.5947 12.9999 20.7399V23.5C12.9999 24.0246 12.5843 24.4649 12.0628 24.4962L11.9999 24.5C11.4476 24.5 10.9999 24.0523 10.9999 23.5V20.7399C9.58047 20.5947 8.23723 20.0375 7.14991 19.1399L5.06422 20.6959C4.60419 21.0166 3.97561 20.9198 3.65491 20.4598C3.37681 20.0553 3.44773 19.5098 3.80637 19.1831L3.89422 19.1059L5.77122 17.5884C5.08612 16.5289 4.65482 15.3038 4.51953 14H2.49991C1.97902 14 1.53591 13.6118 1.50463 13.101L1.49991 13C1.49991 12.4477 1.94762 12 2.49991 12H4.51953C4.65482 10.6962 5.08612 9.47108 5.77122 8.41155L3.89422 6.89412C3.44773 6.55223 3.37681 5.94469 3.65491 5.54022C3.90626 5.18939 4.37871 5.05521 4.79173 5.17608L4.86733 5.20651L5.06422 5.30412L7.14991 6.86009C8.23723 5.96253 9.58047 5.40532 10.9999 5.26009V2.5C10.9999 1.97536 11.4155 1.53501 11.937 1.50373L11.9999 1.5ZM11.9999 7.5C9.51462 7.5 7.49991 9.51472 7.49991 12C7.49991 14.4853 9.51462 16.5 11.9999 16.5C14.4852 16.5 16.4999 14.4853 16.4999 12C16.4999 9.51472 14.4852 7.5 11.9999 7.5Z"></path>
                        </svg><span>AI å€‹è‚¡åˆ†æ</span></a>
                    </li>
                    <li class="nav-item" id="nav-portfolio"><a href="#my_portfolio" data-view="my_portfolio"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 11H8v-2h4v2zm4-3H8V9h8v3zm0-4h-2V6h2v2z"/></svg><span>æˆ‘çš„æŠ•è³‡çµ„åˆ</span></a></li>
                    <li class="nav-item" id="nav-reports"><a href="#ai_reports" data-view="ai_reports"><svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg><span>AI å ±å‘Š</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-user-profile">
                <img src="https://placehold.co/32x32/7c3aed/white?text=S" alt="ç”¨æˆ¶é ­åƒ" class="user-avatar" id="sidebar-user-avatar-img">
                <div class="user-details">
                    <span class="user-name" id="sidebar-user-name">è¨ªå®¢</span>
                    <span class="user-status" id="sidebar-user-style">å¸‚å ´: <span class="user-market-type-display">N/A</span></span>
                </div>
            </div>
            <div class="sidebar-footer">
                <a href="#" class="footer-link" id="logout-link">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
                    <span>ç™»å‡º</span>
                </a>
            </div>
        </aside>

        <!-- ä¸»å…§å®¹å®¹å™¨ -->
        <div class="main-content-view" id="main-content-area">

            <!-- Dashboard å…§å®¹ -->
            <section id="view-dashboard" class="view-section">
                <header class="page-header"><h1>ä¸»æ§å° (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h1><p class="subtitle">æ­¡è¿å›ä¾†, <span id="dashboard-username" class="font-semibold">ç”¨æˆ¶</span>! ä»¥ä¸‹æ˜¯æ‚¨é¸å®šå¸‚å ´çš„äº¤æ˜“è¡¨ç¾æ‘˜è¦ã€‚</p></header>
                <div class="summary-cards-grid" id="dashboard-summary-cards">
                    <div class="summary-card"><span class="label">æŠ•è³‡çµ„åˆç¸½å€¼ (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-portfolio-value">$0.00</div><div class="sub-text" id="dashboard-total-pl">ç¸½ç›ˆè™§: $0.00 (0.00%)</div></div>
                    <div class="summary-card"><span class="label">ä»Šæ—¥ç›ˆè™§ (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-today-pl">$0.00</div><div class="sub-text" id="dashboard-today-pl-percent">0.00%</div></div>
                    <div class="summary-card"><span class="label">ç¾é‡‘é¤˜é¡ (<span class="user-market-type-display">N/A</span>)</span><div class="value" id="dashboard-cash-balance">$0.00</div><div class="sub-text" id="dashboard-buying-power">å¯ç”¨è³¼è²·åŠ›</div></div>
                </div>
                <section class="quick-actions-section">
                    <h2>å¿«é€Ÿæ“ä½œ</h2>
                    <div class="quick-actions-grid">
                        <button class="quick-action-button" data-view-target="trade_stocks"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.505 2.374A4.5 4.5 0 017.75 1.5h4.5A4.5 4.5 0 0116.5 6v1.148A4.504 4.504 0 0113.01 9.5H10V6.5a.5.5 0 00-.5-.5H8.75V4.5h-1.5v2H6.5a.5.5 0 000 1h.75v2.5H6.5a.5.5 0 000 1h.75V12H6.5a.5.5 0 000 1h.75v2.5H6.5a.5.5 0 000 1h.75v1.5H4.25A2.25 2.25 0 012 15.75V6A4.5 4.5 0 013.505 2.374zM13.01 11H10V9.5h3.01a3.001 3.001 0 010 6H10v-1.5h3.01a1.5 1.5 0 100-3z"/></svg><span>è‚¡ç¥¨äº¤æ˜“</span></button>
                        <button class="quick-action-button" data-view-target="ai_stock_analysis"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.5 3.5A1.5 1.5 0 018 2h4a1.5 1.5 0 011.5 1.5v2.5A1.5 1.5 0 0112 7.5H8A1.5 1.5 0 016.5 6V3.5zm4.25 5.521A4.502 4.502 0 0012.5 8H16a2 2 0 012 2v5.5a2 2 0 01-2 2H8a2 2 0 01-2-2V10c0-.31.034-.612.1-.901A4.502 4.502 0 0010.75 9.021zM8 10.5A1.5 1.5 0 006.5 12v4A1.5 1.5 0 008 17.5h4A1.5 1.5 0 0013.5 16v-4A1.5 1.5 0 0012 10.5H8z" clip-rule="evenodd"></path><path d="M3 6.5A1.5 1.5 0 014.5 5h2.5A1.5 1.5 0 018.5 6.5v1A1.5 1.5 0 017 9H4.5A1.5 1.5 0 013 7.5v-1zM14.5 5A1.5 1.5 0 0013 6.5v1A1.5 1.5 0 0014.5 9H17a1.5 1.5 0 001.5-1.5v-1A1.5 1.5 0 0017 5h-2.5z"></path></svg><span>AI å€‹è‚¡åˆ†æ</span></button>
                        <button class="quick-action-button" data-view-target="my_portfolio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 014.5 2h11A1.5 1.5 0 0117 3.5v13A1.5 1.5 0 0115.5 18h-11A1.5 1.5 0 013 16.5v-13zM4.5 4v2.5h11V4H4.5zm0 4v2.5h11V8H4.5zm0 4v2.5h5V12H4.5z"/></svg><span>æˆ‘çš„æŠ•è³‡çµ„åˆ</span></button>
                        <button class="quick-action-button" data-view-target="ai_reports"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg><span>AI å ±å‘Š</span></button>
                    </div>
                </section>
                <!-- GA Potential Buys Section -->
                <section class="quick-actions-section" id="ga-picks-section">
                    <h2>AI ç­–ç•¥æ½›åŠ›è‚¡ (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h2>
                    <p class="description">
                        æ¢ç´¢æˆ‘å€‘çš„ GA å„ªåŒ–ç­–ç•¥ç›®å‰åœ¨æ‚¨æŒ‡å®šçš„å¸‚å ´ä¸­è­˜åˆ¥å‡ºçš„æ½›åœ¨è²·å…¥æ©Ÿæœƒã€‚
                        é€™äº›å»ºè­°åŸºæ–¼æ­·å²æ•¸æ“šæ¨¡å¼ï¼Œä¸æ§‹æˆè²¡å‹™å»ºè­°ã€‚æ•¸æ“šç‚ºé å…ˆè¨ˆç®—ï¼Œå¯èƒ½éå³æ™‚ã€‚
                    </p>
                    <button class="action-button" id="fetch-ga-potential-buys-btn" style="background-color: #4f46e5; color:white;">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px; color:white;">
                            <path fill-rule="evenodd" d="M9.965 2.026a.75.75 0 01.53.22l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L12.94 10 9.465 6.535a.75.75 0 01.22-.53zm-4.5 0A.75.75 0 016 2.246l4.25 4.25a.75.75 0 010 1.06L6 11.796a.75.75 0 11-1.06-1.06L8.44 7.5 4.965 4.035A.75.75 0 015.465 2.026z" clip-rule="evenodd" />
                        </svg>
                        æŸ¥çœ‹ GA æ½›åŠ›è²·å…¥è‚¡
                    </button>
                    <div id="ga-potential-buys-output" style="margin-top: 20px;">
                        <!-- Results will be displayed here -->
                    </div>
                </section>
                <!-- End of GA Potential Buys Section -->
                <div class="recent-activity-container">
                    <h2>è¿‘æœŸæ´»å‹• (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h2>
                    <ul id="dashboard-recent-activity" style="list-style: none; padding: 0; font-size: 14px; color: #4b5563;"><li style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">å°šç„¡è¿‘æœŸæ´»å‹•ã€‚</li></ul>
                </div>
            </section>

            <!-- Trade Stocks å…§å®¹ -->
            <section id="view-trade_stocks" class="view-section">
                <div class="trade-header"><h1>è‚¡ç¥¨äº¤æ˜“çµ‚ç«¯ (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h1><p>åœ¨æ‚¨æŒ‡å®šçš„å¸‚å ´ä¸­æœç´¢è‚¡ç¥¨ï¼ŒæŸ¥çœ‹å³æ™‚æ•¸æ“šä¸¦é€²è¡Œè™›æ“¬äº¤æ˜“ã€‚</p></div>
                <div class="search-bar-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                        <input type="text" id="ts-stock-search-input" placeholder="æŒ‰åç¨±æˆ–ä»£è™Ÿæœç´¢è‚¡ç¥¨ (ä¾‹å¦‚: AAPL æˆ– 2330.TW)">
                    </div>
                </div>
                <div class="trading-interface">
                    <aside class="stock-list-panel" id="ts-stock-list-panel"><div class="stock-item" style="justify-content: center; color: #9ca3af;">è«‹æœç´¢è‚¡ç¥¨ä»¥åœ¨æ­¤è™•é¡¯ç¤ºã€‚</div></aside>
                    <section class="stock-details-panel">
                        <div id="ts-stock-details-content" class="stock-details-content hidden">
                            <div class="detail-header">
                                <div class="detail-name-ticker">
                                    <h2 class="name" id="ts-detail-stock-name">è‚¡ç¥¨åç¨± (ä»£è™Ÿ)</h2>
                                    <p class="price-shares">ç•¶å‰åƒ¹æ ¼: <span id="ts-current-stock-price" class="font-semibold">$0.00</span>&nbsp;&nbsp;|&nbsp;&nbsp; æ‚¨æŒæœ‰ (<span class="user-market-type-display">N/A</span>): <span id="ts-owned-shares" class="font-semibold">0</span> è‚¡</p>
                                </div>
                            </div>
                            <div class="trade-actions-tabs"><button class="trade-tab active" id="ts-buy-tab">è²·å…¥ STOCK</button><button class="trade-tab" id="ts-sell-tab">è³£å‡º STOCK</button></div>
                            <form id="ts-trade-form">
                                <div class="form-group"><label for="ts-shares-input">è‚¡æ•¸</label><input type="number" id="ts-shares-input" name="shares" value="1" min="1"></div>
                                <div class="form-group">
                                    <label for="ts-mood-select">æ‚¨äº¤æ˜“æ™‚çš„å¿ƒæƒ…</label>
                                    <select id="ts-mood-select" name="mood">
                                        <option value="">é¸æ“‡æ‚¨ç•¶å‰çš„å¿ƒæƒ…</option><option value="excited">ğŸ¥³ èˆˆå¥®</option><option value="confident">ğŸ˜ è‡ªä¿¡</option><option value="neutral">ğŸ˜ å¹³éœ</option><option value="anxious">ğŸ˜Ÿ ç„¦æ…®</option><option value="fearful">ğŸ˜¨ ææ‡¼ (FOMO/FUD)</option><option value="impulsive">âš¡ï¸ è¡å‹•</option><option value="analytical">ğŸ§ åˆ†æ</option><option value="bored">ğŸ˜´ ç„¡èŠ</option>
                                    </select>
                                </div>
                                <div class="form-group"><label for="ts-reason-input">äº¤æ˜“åŸå›  (å¯é¸)</label><textarea id="ts-reason-input" name="reason" rows="2" placeholder="ä¾‹å¦‚ï¼šå¼·å‹çš„è²¡å ±ã€æŠ€è¡“æ€§çªç ´ã€åˆ†æ•£æŠ•è³‡..."></textarea></div>
                                <div class="trade-summary">
                                    <div><span id="ts-summary-cost-label">é è¨ˆç¸½æˆæœ¬:</span> <span id="ts-summary-total-cost">$0.00</span></div>
                                    <div><span id="ts-summary-balance-label">äº¤æ˜“å¾Œç¾é‡‘é¤˜é¡ (<span class="user-market-type-display">N/A</span>):</span> <span id="ts-summary-cash-after-trade">$0.00</span></div>
                                </div>
                                <button type="submit" class="submit-trade-button" id="ts-submit-trade-btn">è²·å…¥è‚¡ç¥¨</button>
                            </form>
                            <p class="trade-note"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm8-4a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0V4.75A.75.75 0 018 4zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>åƒ¹æ ¼ç‚ºæŒ‡ç¤ºæ€§ã€‚äº¤æ˜“å°‡ä»¥ç•¶å‰å¸‚åƒ¹åŸ·è¡Œã€‚å¯èƒ½æœƒæ”¶å–å°‘é‡æ‰‹çºŒè²»ã€‚</p>
                        </div>
                        <div class="no-stock-selected-placeholder" id="ts-no-stock-selected-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.25 3A1.25 1.25 0 0010 4.25V8.5h-3.75a.75.75 0 000 1.5h3.75V12a2.25 2.25 0 002.25 2.25h3A2.25 2.25 0 0017.75 12V9.75H19a.75.75 0 000-1.5h-1.25V4.25A1.25 1.25 0 0016.5 3h-5.25zm1.5 3.75V8.5h2.25V6.75h-2.25zm-3 6V20.75A1.25 1.25 0 0011.25 22H16a.75.75 0 000-1.5h-4.75V12.75h-1.5zM3.5 6.75A.75.75 0 014.25 6H7.5V4.25A1.25 1.25 0 006.25 3h-3A1.25 1.25 0 002 4.25v15.5A1.25 1.25 0 003.25 21h3A1.25 1.25 0 007.5 19.75V17H6a.75.75 0 000 1.5h1.5V21A2.75 2.75 0 0010.75 24h6.5A2.75 2.75 0 0020 21.25V3.75A2.75 2.75 0 0017.25 1H6.75A2.75 2.75 0 004 3.75v1.5H1.25a.75.75 0 000 1.5H4V6.75z" /></svg><p>è«‹å¾åˆ—è¡¨ä¸­é¸æ“‡ä¸€æ”¯è‚¡ç¥¨ä»¥æŸ¥çœ‹è©³ç´°ä¿¡æ¯ä¸¦é€²è¡Œäº¤æ˜“ã€‚</p></div>
                    </section>
                </div>
            </section>

            <!-- AI Stock Analysis View Section -->
            <section id="view-ai_stock_analysis" class="view-section">
                <header class="page-header">
                    <h1>AI å³æ™‚å€‹è‚¡åˆ†æ</h1>
                    <p class="subtitle">è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼Œç²å–ç”± AI ç”Ÿæˆçš„å³æ™‚å€‹è‚¡åˆ†æå ±å‘Šã€æŠ€è¡“åœ–è¡¨èˆ‡ç›¸é—œæ–°èï¼Œä¸¦å¯é¸æ“‡æª¢æŸ¥ GA ç­–ç•¥ä¿¡è™Ÿã€‚</p>
                </header>

                <div class="analysis-input-bar">
                    <input type="text" id="ai-stock-analysis-ticker-input" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (ä¾‹: 2330.TW æˆ– AAPL)">
                    <div class="ga-checkbox-container">
                        <input type="checkbox" id="ai-stock-analysis-include-ga" name="includeGa">
                        <label for="ai-stock-analysis-include-ga">åŒæ™‚æª¢æŸ¥ GA ç­–ç•¥ä¿¡è™Ÿ?</label>
                    </div>
                    <button id="ai-stock-analysis-submit-btn" class="action-button" style="background-color: #1e40af; color:white;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px;">
                            <path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/>
                        </svg>
                        åˆ†æå€‹è‚¡
                    </button>
                </div>
                <div id="ai-stock-analysis-output-area" style="display: none;">
                    <!-- Analysis results will be displayed here -->
                </div>
            </section>

            <!-- My Portfolio å…§å®¹ -->
            <section id="view-my_portfolio" class="view-section">
                <header class="page-header"><h1>æˆ‘çš„æŠ•è³‡çµ„åˆ (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h1><p class="subtitle">æ‚¨åœ¨æŒ‡å®šå¸‚å ´çš„ç•¶å‰æŠ•è³‡å’Œè¡¨ç¾æ¦‚è¦½ã€‚</p></header>
                <section class="portfolio-overview-grid" id="mp-portfolio-overview-grid"></section>
                <section class="holdings-section">
                    <h2>ç›®å‰æŒè‚¡ (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h2>
                    <table class="holdings-table">
                        <thead><tr><th>è‚¡ç¥¨</th><th class="align-right">è‚¡æ•¸</th><th class="align-right">å¹³å‡æˆæœ¬</th><th class="align-right">ç•¶å‰åƒ¹æ ¼</th><th class="align-right">å¸‚å€¼</th><th class="align-right">ä»Šæ—¥è®Šå‹•</th><th class="align-right">ç¸½ç›ˆè™§ (%)</th></tr></thead>
                        <tbody id="mp-holdings-table-body"></tbody>
                    </table>
                    <div class="empty-portfolio" id="mp-empty-portfolio-message" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 2.25a.75.75 0 000 1.5H3v10.5a3 3 0 003 3h1.21l-2.12 2.121a.75.75 0 001.06 1.061l2.374-2.373.87.87a.75.75 0 001.061-1.06l-.87-.87 2.373-2.374a.75.75 0 00-1.06-1.06L10.29 16.5H6a1.5 1.5 0 01-1.5-1.5V3.75H2.25a.75.75 0 000-1.5H.75A.75.75 0 000 3v12a3 3 0 003 3h4.586l-1.72 1.72a.75.75 0 001.06 1.061l2.122-2.122 2.121 2.122a.75.75 0 001.06-1.06L10.586 18H15a3 3 0 003-3V3.75H15.75a.75.75 0 000 1.5H18v10.5a1.5 1.5 0 01-1.5 1.5h-1.21l2.12-2.121a.75.75 0 00-1.06-1.061l-2.374 2.373-.87-.87a.75.75 0 00-1.061 1.06l.87.87-2.373 2.374a.75.75 0 001.06 1.06L13.71 16.5H18a3 3 0 003-3V3a.75.75 0 00-.75-.75h-2.25a.75.75 0 000-1.5H21a.75.75 0 00.75-.75V.75A.75.75 0 0021 0H3a.75.75 0 00-.75.75v1.5A.75.75 0 003 3h1.586L2.865 4.72a.75.75 0 001.061 1.06L6 4.061V15a1.5 1.5 0 01-1.5 1.5H3a3 3 0 00-3-3V3a.75.75 0 00.75-.75z" clip-rule="evenodd" /></svg><p>æ‚¨çš„ (<span class="user-market-type-display">N/A</span>) æŠ•è³‡çµ„åˆç›®å‰ç‚ºç©ºã€‚</p><a href="#trade_stocks" data-view="trade_stocks" class="action-button empty-portfolio-trade-link">é–‹å§‹äº¤æ˜“</a></div>
                </section>
            </section>

            <!-- AI Reports å…§å®¹ -->
            <section id="view-ai_reports" class="view-section">
                <header class="page-header"><h1>AI æ´å¯Ÿå ±å‘Š (<span class="user-market-type-display">N/A</span> å¸‚å ´)</h1><p class="subtitle">åˆ©ç”¨ AI ç†è§£æ‚¨åœ¨æŒ‡å®šå¸‚å ´çš„äº¤æ˜“æ¨¡å¼ä¸¦ç²å¾—å€‹æ€§åŒ–åé¥‹ã€‚</p></header>
                <section class="report-section">
                    <div class="section-header"><svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0016.5 9h-1.875a.375.375 0 01-.375-.375V6.75A3.75 3.75 0 0010.5 3H5.625a.375.375 0 01-.375-.375V1.875c0-1.036-.84-1.875-1.875-1.875H1.875A1.875 1.875 0 000 1.875v17.25c0 1.035.84 1.875 1.875 1.875h1.875c1.035 0 1.875-.84 1.875-1.875V6.75h1.875a.375.375 0 01.375.375v1.875c0 1.036.84 1.875 1.875 1.875H15V12h1.5a.75.75 0 01.75.75v6A.75.75 0 0116.5 19.5h-12A.75.75 0 013.75 18.75V4.125A1.875 1.875 0 005.625 6H9V4.125A1.875 1.875 0 007.125 2.25H5.625V1.5zM12.75 9V6.375A2.25 2.25 0 0010.5 4.125H5.625A.375.375 0 015.25 3.75V1.875a.375.375 0 01.375-.375h.008a.875.875 0 01.867.866V3.75h3a.75.75 0 00.75-.75V1.875a.375.375 0 01.375-.375h2.25a.375.375 0 01.375.375v2.25a2.25 2.25 0 002.25 2.25H15v2.625a2.25 2.25 0 00-2.25-2.25h-2.25z" clip-rule="evenodd" /><path d="M7.125 15a.75.75 0 01.75-.75h8.25a.75.75 0 010 1.5H7.875a.75.75 0 01-.75-.75zM7.125 17.25a.75.75 0 01.75-.75H12a.75.75 0 010 1.5H7.875a.75.75 0 01-.75-.75z"/></svg><h2>AI æŠ•è³‡å ±å‘Š</h2></div>
                    <p class="description">ç”Ÿæˆä¸€ä»½å€‹æ€§åŒ–çš„æŠ•è³‡å ±å‘Šï¼Œç¸½çµæ‚¨çš„äº¤æ˜“è¡¨ç¾ï¼Œé»å‡ºè¡Œç‚ºåå·®ï¼Œä¸¦æä¾›æ”¹é€²å»ºè­°ã€‚æ­¤å ±å‘Šå¹«åŠ©æ‚¨åæ€ç­–ç•¥ä¸¦åšå‡ºæ›´æ˜æ™ºçš„æ±ºç­–ã€‚</p>
                    <button class="action-button" id="generate-investment-report-btn">ç”ŸæˆæŠ•è³‡å ±å‘Š</button>
                    <div class="report-output-area" id="investment-report-output">å ±å‘Šè¼¸å‡ºå°‡é¡¯ç¤ºæ–¼æ­¤...</div>
                </section>
                <section class="report-section">
                     <div class="section-header"><svg class="section-icon brain" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.25 4.151a.75.75 0 00-1.06-.042L10.07 7.037a3.75 3.75 0 00-3.36 3.36l-2.928 3.12a.75.75 0 00.042 1.061l.53.53a.75.75 0 001.06 0l2.928-3.12a3.751 3.751 0 005.494-1.748l1.758 2.636a.75.75 0 001.29-.866L14.6 9.508a3.733 3.733 0 001.757-2.417l3.087-1.234a.75.75 0 00-.126-1.418l-3.535-.59a3.737 3.737 0 00-1.53-.098zM12 12.75a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" /><path fill-rule="evenodd" d="M4.5 4.125A2.625 2.625 0 017.125 1.5h9.75A2.625 2.625 0 0119.5 4.125v15.75A2.625 2.625 0 0116.875 22.5h-9.75A2.625 2.625 0 014.5 19.875V4.125zm2.625-.375c-.207 0-.398.044-.57.125V19.875c0 .207.044.398.125.57h9.75a.875.875 0 00.875-.875V4.125a.875.875 0 00-.875-.875h-9.75z" clip-rule="evenodd" /></svg><h2>AI è¡Œç‚ºåˆ†æ</h2></div>
                    <p class="description">æ´å¯Ÿæ‚¨çš„æŠ•è³‡è¡Œç‚ºæ¨¡å¼ï¼Œä¾‹å¦‚é¢¨éšªè¶¨é¿ã€æå¤±è¦é¿ã€éåº¦è‡ªä¿¡æˆ–å…¶ä»–åå·®ã€‚ç†è§£é€™äº›æ¨¡å¼å°æ–¼æ”¹å–„æ‚¨çš„æ±ºç­–éç¨‹è‡³é—œé‡è¦ã€‚</p>
                    <button class="action-button" id="generate-behavioral-report-btn">åˆ†ææˆ‘çš„è¡Œç‚º</button>
                     <div class="disclaimer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg><span>AI ç”Ÿæˆçš„æ´å¯Ÿåƒ…ä¾›æ•™è‚²ç›®çš„ï¼Œå¯èƒ½ä¸å®Œå…¨æº–ç¢ºã€‚</span></div>
                    <div class="report-output-area" id="behavioral-analysis-output">åˆ†æè¼¸å‡ºå°‡é¡¯ç¤ºæ–¼æ­¤...</div>
                </section>
            </section>

        </div> <!-- End of main-content-area -->
    </div> <!-- End of page-container -->

    <script>
        // =============================================
        //                JavaScript Start
        // =============================================
        console.log("FinSimU ä¸»æ‡‰ç”¨ JS å·²è¼‰å…¥ - V10.5 (PWA, RWD, GA Precalc, GA OnDemand)");

        let currentUser = null;
        let userMarketType = 'N/A';
        let currentSelectedStockTrade = null;

        const mainContentArea = document.getElementById('main-content-area');
        const navItems = document.querySelectorAll('.sidebar-nav .nav-item');
        const viewSections = document.querySelectorAll('.view-section');
        const sidebarUserNameEl = document.getElementById('sidebar-user-name');
        const sidebarUserStyleEl = document.getElementById('sidebar-user-style');
        const sidebarUserAvatarImgEl = document.getElementById('sidebar-user-avatar-img');
        const logoutLink = document.getElementById('logout-link');
        const userMarketTypeDisplays = document.querySelectorAll('.user-market-type-display');

        const dashboardUsernameEl = document.getElementById('dashboard-username');
        const dashboardPortfolioValueEl = document.getElementById('dashboard-portfolio-value');
        const dashboardTotalPlEl = document.getElementById('dashboard-total-pl');
        const dashboardTodayPlEl = document.getElementById('dashboard-today-pl');
        const dashboardTodayPlPercentEl = document.getElementById('dashboard-today-pl-percent');
        const dashboardCashBalanceEl = document.getElementById('dashboard-cash-balance');
        const dashboardRecentActivityUl = document.getElementById('dashboard-recent-activity');
        const quickActionButtons = document.querySelectorAll('.quick-action-button');

        const tsStockListPanel = document.getElementById('ts-stock-list-panel');
        const tsStockDetailsContent = document.getElementById('ts-stock-details-content');
        const tsNoStockPlaceholder = document.getElementById('ts-no-stock-selected-placeholder');
        const tsDetailStockNameEl = document.getElementById('ts-detail-stock-name');
        const tsCurrentStockPriceEl = document.getElementById('ts-current-stock-price');
        const tsOwnedSharesEl = document.getElementById('ts-owned-shares');
        const tsBuyTab = document.getElementById('ts-buy-tab');
        const tsSellTab = document.getElementById('ts-sell-tab');
        const tsSharesInput = document.getElementById('ts-shares-input');
        const tsMoodSelect = document.getElementById('ts-mood-select');
        const tsReasonInput = document.getElementById('ts-reason-input');
        const tsTradeForm = document.getElementById('ts-trade-form');
        const tsSubmitTradeBtn = document.getElementById('ts-submit-trade-btn');
        const tsSummaryCostLabel = document.getElementById('ts-summary-cost-label');
        const tsSummaryTotalCostEl = document.getElementById('ts-summary-total-cost');
        const tsSummaryBalanceLabel = document.getElementById('ts-summary-balance-label');
        const tsSummaryCashAfterTradeEl = document.getElementById('ts-summary-cash-after-trade');
        const tsStockSearchInput = document.getElementById('ts-stock-search-input');

        const mpPortfolioOverviewGridEl = document.getElementById('mp-portfolio-overview-grid');
        const mpHoldingsTableBodyEl = document.getElementById('mp-holdings-table-body');
        const mpEmptyPortfolioMessageEl = document.getElementById('mp-empty-portfolio-message');

        const generateInvestmentReportBtn = document.getElementById('generate-investment-report-btn');
        const investmentReportOutputEl = document.getElementById('investment-report-output');
        const generateBehavioralReportBtn = document.getElementById('generate-behavioral-report-btn');
        const behavioralAnalysisOutputEl = document.getElementById('behavioral-analysis-output');

        const aiStockAnalysisTickerInput = document.getElementById('ai-stock-analysis-ticker-input');
        const aiStockAnalysisIncludeGaCheckbox = document.getElementById('ai-stock-analysis-include-ga'); // New Checkbox
        const aiStockAnalysisSubmitBtn = document.getElementById('ai-stock-analysis-submit-btn');
        const aiStockAnalysisOutputArea = document.getElementById('ai-stock-analysis-output-area');

        const fetchGaPotentialBuysBtn = document.getElementById('fetch-ga-potential-buys-btn');
        const gaPotentialBuysOutputEl = document.getElementById('ga-potential-buys-output');

        // RWD Sidebar Elements
        const appSidebar = document.getElementById('app-sidebar');
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay-el');


        function formatCurrency(amount, includeSymbol = true, currencyCode = userMarketType) {
            const symbol = includeSymbol ? (currencyCode === 'US' ? '$' : 'NT$') : '';
            if (typeof amount !== 'number' || isNaN(amount)) return `${symbol}0.00`;
            let numStr = amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            if (currencyCode === 'TW' && numStr.endsWith('.00')) { // å°å¹£æ•´æ•¸ä¸é¡¯ç¤ºå°æ•¸é»
                numStr = numStr.substring(0, numStr.length - 3);
            }
            return symbol + numStr;
        }
        function formatPercentage(value, includeArrow = true) {
            if (typeof value !== 'number' || isNaN(value)) return '0.00%';
            const arrow = includeArrow ? (value >= 0 ? 'â†— ' : 'â†˜ ') : '';
            return arrow + Math.abs(value).toFixed(2) + '%';
        }
        function getHexColorFromString(str) {
            if (!str) return '7c3aed'; let hash = 0;
            for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            let color = ''; for (let i = 0; i < 3; i++) { const value = (hash >> (i * 8)) & 0xFF; color += ('00' + value.toString(16)).slice(-2); }
            const r = parseInt(color.slice(0,2), 16), g = parseInt(color.slice(2,4), 16), b = parseInt(color.slice(4,6), 16);
            // Ensure contrast against white background
            return ((r * 0.299 + g * 0.587 + b * 0.114) > 150 && r > 50 && g > 50 && b > 50) ? color : '7c3aed'; // Avoid too dark colors
        }

        async function fetchAPI(url, method = 'GET', body = null) {
            const options = { method: method, headers: { 'Content-Type': 'application/json' }};
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(url, options);
                let responseData;
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    responseData = await response.json().catch(() => ({ message: `å¾ ${url} æ”¶åˆ°çš„JSONå›æ‡‰ç„¡æ•ˆ`, _isParseError: true}));
                } else {
                    const textResponse = await response.text();
                    responseData = { message: `éJSONå›æ‡‰: ${textResponse.substring(0,100)}...`, _isParseError: true, _rawText: textResponse };
                }

                if (!response.ok) {
                    console.error(`API éŒ¯èª¤ ${response.status} for ${url}:`, responseData.message || response.statusText, responseData._rawText || '');
                    // å‰ç«¯éŒ¯èª¤æç¤ºçµ±ä¸€ä¸­æ–‡åŒ–
                    let userMessage = `éŒ¯èª¤: ${responseData.message || response.statusText || 'è«‹æ±‚å¤±æ•—'}`;
                    if (response.status === 401) {
                        userMessage = "æ‚¨çš„ç™»å…¥å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€‚";
                        alert(userMessage);
                        window.location.href = "{{ url_for('finsimu_login_route') }}";
                    } else if (response.status === 503){
                         userMessage = "æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                         alert(userMessage);
                    } else if (responseData.message && responseData.message.includes("blocked")) { // Gemini block
                        userMessage = `AI è«‹æ±‚è¢«é˜»æ“‹ï¼Œå¯èƒ½æ˜¯å…§å®¹å®‰å…¨æˆ–æ”¿ç­–åŸå› ã€‚(${responseData.message})`;
                        alert(userMessage);
                    }
                    else {
                        alert(userMessage);
                    }
                    return null;
                }
                return responseData;
            } catch (error) {
                console.error(`ç¶²è·¯æˆ–è§£æéŒ¯èª¤ for ${url}:`, error);
                alert('ç¶²è·¯éŒ¯èª¤ã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£æ¥æˆ–ä¼ºæœå™¨æ—¥èªŒã€‚');
                return null;
            }
        }

        function updateUserMarketTypeDisplays() {
            userMarketTypeDisplays.forEach(el => el.textContent = userMarketType);
            // æ›´æ–°é é¢æ¨™é¡Œä¸­çš„å¸‚å ´é¡å‹
            const currentHash = window.location.hash.substring(1) || 'dashboard';
            const viewName = (document.querySelector(`.sidebar-nav .nav-item a[data-view="${currentHash}"] span`)?.textContent || currentHash.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
            document.title = `FinSimU - ${viewName} (${userMarketType})`;
        }

        function switchView(viewId) {
            console.log("å˜—è©¦åˆ‡æ›åˆ°è¦–åœ–:", viewId);
            if (!currentUser && viewId !== 'login' && viewId !== 'register') { console.warn("å—ä¿è­·è¦–åœ–ï¼Œä½†ç›®å‰ç”¨æˆ¶æœªè¨­å®šã€‚"); return; }

            viewSections.forEach(section => section.classList.remove('active'));
            const targetView = document.getElementById(`view-${viewId}`);
            if (targetView) { targetView.classList.add('active'); }
            else { console.error("ç›®æ¨™è¦–åœ–æœªæ‰¾åˆ°:", `view-${viewId}`); if (viewId !== 'dashboard') switchView('dashboard'); return; }

            navItems.forEach(item => { item.classList.remove('active'); if (item.querySelector(`a[data-view="${viewId}"]`)) item.classList.add('active'); });
            
            updateUserMarketTypeDisplays(); // æ›´æ–°å¸‚å ´é¡å‹é¡¯ç¤ºå’Œæ¨™é¡Œ

            if (!currentUser && viewId !== 'login' && viewId !== 'register') return; // å¦‚æœæœªç™»éŒ„ä¸”ä¸æ˜¯ç™»éŒ„/è¨»å†Šé ï¼Œå‰‡ä¸è¼‰å…¥æ•¸æ“š

            if (viewId === 'dashboard') loadDashboardData();
            else if (viewId === 'trade_stocks') loadTradeStocksView();
            else if (viewId === 'ai_stock_analysis') loadAiStockAnalysisView();
            else if (viewId === 'my_portfolio') loadMyPortfolioData();
            else if (viewId === 'ai_reports') loadAiReportsView();

            // æ¸…ç†å…¶ä»–è¦–åœ–çš„ç‰¹å®šå…§å®¹
            if (viewId !== 'ai_stock_analysis' && aiStockAnalysisOutputArea) {
                aiStockAnalysisOutputArea.innerHTML = '';
                aiStockAnalysisOutputArea.style.display = 'none';
                if(aiStockAnalysisTickerInput) aiStockAnalysisTickerInput.value = '';
                if(aiStockAnalysisIncludeGaCheckbox) aiStockAnalysisIncludeGaCheckbox.checked = false;
            }
            if (viewId !== 'dashboard' && gaPotentialBuysOutputEl) {
                 gaPotentialBuysOutputEl.innerHTML = ''; // æ¸…é™¤ GA æ½›åŠ›è‚¡åˆ—è¡¨
            }
            // RWD: å°è¢å¹•ä¸‹åˆ‡æ›è¦–åœ–æ™‚é—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768 && appSidebar && appSidebar.classList.contains('open')) {
                toggleSidebar(false);
            }
        }

        function updateSidebarUser() {
            if (!currentUser || !sidebarUserNameEl || !sidebarUserStyleEl || !sidebarUserAvatarImgEl) return;
            sidebarUserNameEl.textContent = currentUser.name;
            sidebarUserStyleEl.innerHTML = `æŠ•è³‡é¢¨æ ¼: ${currentUser.investmentStyle} <br>å¸‚å ´: <span class="user-market-type-display">${userMarketType}</span>`;
            const firstLetter = currentUser.name ? currentUser.name.charAt(0).toUpperCase() : 'S';
            sidebarUserAvatarImgEl.src = `https://placehold.co/32x32/${getHexColorFromString(currentUser.name)}/ffffff?text=${firstLetter}`;
        }

        async function loadDashboardData() {
            if (!currentUser) { console.warn("loadDashboardData: currentUser æœªè¨­å®šã€‚"); return; }
            if (dashboardUsernameEl) dashboardUsernameEl.textContent = currentUser.name;

            const portfolioData = await fetchAPI(`{{ url_for('portfolio_data_api') }}`);

            if (portfolioData && portfolioData.success) {
                const overview = portfolioData.overview;
                if(dashboardPortfolioValueEl) dashboardPortfolioValueEl.textContent = formatCurrency(overview.totalPortfolioValue);
                if(dashboardTotalPlEl) { dashboardTotalPlEl.textContent = `ç¸½ç›ˆè™§: ${formatCurrency(overview.totalOverallPL)} (${formatPercentage(overview.totalOverallPLPercent, false)})`; dashboardTotalPlEl.className = `sub-text ${overview.totalOverallPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardTodayPlEl) { dashboardTodayPlEl.textContent = formatCurrency(overview.todayTotalPL); dashboardTodayPlEl.className = `value ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardTodayPlPercentEl) { dashboardTodayPlPercentEl.textContent = formatPercentage(overview.todayTotalPLPercent); dashboardTodayPlPercentEl.className = `sub-text ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}`; }
                if(dashboardCashBalanceEl) dashboardCashBalanceEl.textContent = formatCurrency(overview.cashBalance);
                if (currentUser.account) currentUser.account.cashBalance = overview.cashBalance; // æ›´æ–°æœ¬åœ°å‰¯æœ¬
            } else { // API å¤±æ•—æˆ–ç„¡æ•¸æ“šæ™‚çš„å›é€€é¡¯ç¤º
                const currentAccountData = currentUser.account; // å˜—è©¦ä½¿ç”¨æœ¬åœ°æ•¸æ“š
                if(dashboardPortfolioValueEl && currentAccountData) dashboardPortfolioValueEl.textContent = formatCurrency(currentAccountData.cashBalance); // è‹¥ç„¡æŒè‚¡ï¼Œçµ„åˆåƒ¹å€¼å³ç¾é‡‘
                if(dashboardTotalPlEl) dashboardTotalPlEl.textContent = "ç¸½ç›ˆè™§: N/A";
                if(dashboardTodayPlEl) dashboardTodayPlEl.textContent = "N/A";
                if(dashboardTodayPlPercentEl) dashboardTodayPlPercentEl.textContent = "N/A";
                if(dashboardCashBalanceEl && currentAccountData) dashboardCashBalanceEl.textContent = formatCurrency(currentAccountData.cashBalance);
            }

            if(dashboardRecentActivityUl && currentUser.account && currentUser.account.tradeHistory) {
                const tradeHistory = currentUser.account.tradeHistory;
                dashboardRecentActivityUl.innerHTML = ''; // æ¸…ç©º
                if (tradeHistory.length === 0) { dashboardRecentActivityUl.innerHTML = `<li style="padding: 8px 0; border-bottom: 1px solid #f3f4f6;">å°šç„¡ ${userMarketType} å¸‚å ´çš„è¿‘æœŸæ´»å‹•ã€‚</li>`; }
                else {
                    tradeHistory.slice(0, 5).forEach(trade => { // åªé¡¯ç¤ºæœ€è¿‘5æ¢
                        const li = document.createElement('li'); li.style.padding = '8px 0'; li.style.borderBottom = '1px solid #f3f4f6';
                        const tradeActionChinese = trade.type === 'buy' ? 'è²·å…¥' : 'è³£å‡º';
                        li.innerHTML = `<span class="${trade.type === 'buy' ? 'text-green-600' : 'text-red-600'}">${tradeActionChinese.toUpperCase()}</span> ${trade.shares} è‚¡ <strong>${trade.name || trade.ticker}</strong> @ ${formatCurrency(trade.price)} <span style="float: right; color: #9ca3af; font-size: 12px;">${new Date(trade.timestamp).toLocaleDateString()}</span>`;
                        dashboardRecentActivityUl.appendChild(li);
                    });
                }
            }
            updateUserMarketTypeDisplays();
            if (gaPotentialBuysOutputEl) gaPotentialBuysOutputEl.innerHTML = ''; // åˆ‡æ›åˆ° dashboard æ™‚æ¸…ç©º GA picks
        }

        async function loadTradeStocksView() {
            await searchAndRenderStocks(""); // åˆå§‹è¼‰å…¥æ™‚é¡¯ç¤ºæç¤ºæˆ–ç©ºåˆ—è¡¨
            if (currentSelectedStockTrade && currentSelectedStockTrade.ticker) { // å¦‚æœä¹‹å‰æœ‰é¸ä¸­çš„è‚¡ç¥¨
                await selectStockForTrading(currentSelectedStockTrade.ticker);
            } else {
                tsShowNoStockSelected();
            }
            updateUserMarketTypeDisplays();
        }

        async function searchAndRenderStocks(searchTerm) {
            if (!tsStockListPanel) return;
            tsStockListPanel.innerHTML = '<div class="stock-item" style="justify-content: center; color: #9ca3af;">æœç´¢ä¸­...</div>';
            const data = await fetchAPI(`{{ url_for('search_stocks_api') }}?q=${encodeURIComponent(searchTerm)}`);
            tsStockListPanel.innerHTML = ''; // æ¸…ç©º
            if (data && data.success && data.stocks && data.stocks.length > 0) {
                data.stocks.forEach(stock => {
                    const item = document.createElement('div'); item.className = 'stock-item'; item.dataset.ticker = stock.ticker; item.stockData = stock; // å­˜å„²è‚¡ç¥¨æ•¸æ“š
                    const stockDisplayMarket = stock.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US'); // æ ¹æ“štickeråˆ¤æ–·é¡¯ç¤ºè²¨å¹£
                    item.innerHTML = `<div class="stock-info"><span class="name">${stock.name}</span><span class="ticker">${stock.ticker}</span></div><div class="stock-price-info"><span class="price">${typeof stock.price === 'number' ? formatCurrency(stock.price, true, stockDisplayMarket) : 'N/A'}</span><span class="change ${stock.change >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(stock.change)}</span></div>`;
                    item.addEventListener('click', () => selectStockForTrading(stock.ticker));
                    tsStockListPanel.appendChild(item);
                });
            } else { tsStockListPanel.innerHTML = `<div class="stock-item" style="justify-content: center; color: #9ca3af;">æ‚¨çš„ ${userMarketType} å¸‚å ´ä¸­æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ã€‚è«‹å˜—è©¦å…¶ä»–é—œéµå­—ã€‚</div>`; }
        }

        async function selectStockForTrading(ticker) {
            const quoteData = await fetchAPI(`{{ url_for('stock_quote_api', ticker='__TICKER__') }}`.replace('__TICKER__', ticker));
            if (!quoteData || !quoteData.success) { alert(`ç„¡æ³•ç²å– ${ticker} çš„è©³ç´°è³‡è¨Š`); tsShowNoStockSelected(); return; }
            currentSelectedStockTrade = quoteData.data;
            const stockDisplayMarket = ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US'); // æ ¹æ“štickeråˆ¤æ–·é¡¯ç¤ºè²¨å¹£

            // æ›´æ–°åˆ—è¡¨é¸ä¸­ç‹€æ…‹
            tsStockListPanel.querySelectorAll('.stock-item').forEach(item => item.classList.remove('selected'));
            const newSelectedItemEl = tsStockListPanel.querySelector(`.stock-item[data-ticker="${ticker}"]`);
            if (newSelectedItemEl) newSelectedItemEl.classList.add('selected');

            if(tsDetailStockNameEl) tsDetailStockNameEl.textContent = `${currentSelectedStockTrade.name} (${currentSelectedStockTrade.ticker})`;
            if(tsCurrentStockPriceEl) tsCurrentStockPriceEl.textContent = formatCurrency(currentSelectedStockTrade.current_price, true, stockDisplayMarket);
            if(tsOwnedSharesEl && currentUser && currentUser.account && currentUser.account.portfolio) { // ç¢ºä¿ portfolio å­˜åœ¨
                 tsOwnedSharesEl.textContent = currentUser.account.portfolio[ticker]?.shares || 0;
            } else if(tsOwnedSharesEl) { // currentUser æˆ– account æˆ– portfolio ä¸å­˜åœ¨æ™‚
                tsOwnedSharesEl.textContent = 0;
            }

            tsShowStockDetails(); tsSwitchTab('buy'); // é è¨­ç‚ºè²·å…¥æ¨™ç±¤
            if(tsSharesInput) tsSharesInput.value = 1; if(tsMoodSelect) tsMoodSelect.value = ""; if(tsReasonInput) tsReasonInput.value = ""; // é‡ç½®è¡¨å–®
            tsUpdateTradeSummary();
            updateUserMarketTypeDisplays();
        }

        function tsShowNoStockSelected() { if(tsStockDetailsContent) tsStockDetailsContent.classList.add('hidden'); if(tsNoStockPlaceholder) tsNoStockPlaceholder.classList.remove('hidden'); }
        function tsShowStockDetails() { if(tsStockDetailsContent) tsStockDetailsContent.classList.remove('hidden'); if(tsNoStockPlaceholder) tsNoStockPlaceholder.classList.add('hidden'); }

        function tsUpdateTradeSummary() {
            if (!currentSelectedStockTrade || !tsSharesInput || !tsSummaryTotalCostEl || !tsSummaryCashAfterTradeEl || typeof currentSelectedStockTrade.current_price !== 'number' || !currentUser || !currentUser.account) return;
            const shares = Math.max(0, parseInt(tsSharesInput.value)) || 0; // ç¢ºä¿è‚¡æ•¸ç‚ºæ­£æ•´æ•¸
            const price = parseFloat(currentSelectedStockTrade.current_price);
            const totalValue = shares * price;
            const isBuying = tsSubmitTradeBtn && !tsSubmitTradeBtn.classList.contains('sell');
            const currentCashForAccount = currentUser.account.cashBalance; // ä½¿ç”¨æœ¬åœ°å­˜å„²çš„é¤˜é¡é€²è¡Œé ä¼°
            const stockDisplayMarket = currentSelectedStockTrade.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');

            if(tsSummaryTotalCostEl) tsSummaryTotalCostEl.textContent = formatCurrency(totalValue, true, stockDisplayMarket);
            if (isBuying) {
                if(tsSummaryCostLabel) tsSummaryCostLabel.textContent = 'é è¨ˆç¸½æˆæœ¬:';
                if(tsSummaryBalanceLabel) tsSummaryBalanceLabel.innerHTML = `è²·å…¥å¾Œç¾é‡‘é¤˜é¡ (<span class="user-market-type-display">${userMarketType}</span>):`;
                if(tsSummaryCashAfterTradeEl) tsSummaryCashAfterTradeEl.textContent = formatCurrency(currentCashForAccount - totalValue);
            } else { // Selling
                if(tsSummaryCostLabel) tsSummaryCostLabel.textContent = 'é è¨ˆç¸½æ”¶ç›Š:';
                if(tsSummaryBalanceLabel) tsSummaryBalanceLabel.innerHTML = `è³£å‡ºå¾Œç¾é‡‘é¤˜é¡ (<span class="user-market-type-display">${userMarketType}</span>):`;
                if(tsSummaryCashAfterTradeEl) tsSummaryCashAfterTradeEl.textContent = formatCurrency(currentCashForAccount + totalValue);
            }
            updateUserMarketTypeDisplays();
        }

        function tsSwitchTab(tabType) {
            if (!currentSelectedStockTrade || !tsBuyTab || !tsSellTab || !tsSubmitTradeBtn) return;
            const stockTicker = currentSelectedStockTrade.ticker;
            const isBuying = tabType === 'buy';
            tsBuyTab.classList.toggle('active', isBuying); tsSellTab.classList.toggle('active', !isBuying);
            tsSubmitTradeBtn.textContent = isBuying ? `è²·å…¥ ${stockTicker}` : `è³£å‡º ${stockTicker}`;
            tsSubmitTradeBtn.classList.toggle('sell', !isBuying); // åˆ‡æ›æŒ‰éˆ•é¡è‰²
            tsBuyTab.textContent = `è²·å…¥ ${stockTicker}`; tsSellTab.textContent = `è³£å‡º ${stockTicker}`;
            tsUpdateTradeSummary(); // æ›´æ–°æ‘˜è¦
        }

        if(tsStockSearchInput) {
            let searchTimeout;
            tsStockSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const searchTerm = e.target.value.trim();
                const placeholderText = userMarketType === 'TW' ? "æœç´¢å°è‚¡ (ä¾‹å¦‚: 2330.TW)" : "æœç´¢ç¾è‚¡ (ä¾‹å¦‚: AAPL)";
                
                if (searchTerm.length === 0) { if(tsStockListPanel) tsStockListPanel.innerHTML = `<div class="stock-item" style="justify-content: center; color: #9ca3af;">${userMarketType ? placeholderText : 'è«‹è¼¸å…¥è‚¡ç¥¨åç¨±æˆ–ä»£è™Ÿã€‚'}</div>`; return; }
                searchTimeout = setTimeout(() => { searchAndRenderStocks(searchTerm); }, 300); // å»¶é²æœç´¢ä»¥é¿å…éå¤šè«‹æ±‚
            });
        }

        if(tsTradeForm) {
            tsTradeForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!currentSelectedStockTrade) { alert("è«‹å…ˆé¸æ“‡ä¸€æ”¯è‚¡ç¥¨ã€‚"); return; }
                const shares = parseInt(tsSharesInput.value); const mood = tsMoodSelect.value; const reason = tsReasonInput.value.trim();
                const isBuying = !tsSubmitTradeBtn.classList.contains('sell');
                if (shares <= 0) { alert("è‚¡æ•¸å¿…é ˆå¤§æ–¼ 0ã€‚"); return; }
                if (!mood) { alert("è«‹é¸æ“‡æ‚¨äº¤æ˜“æ™‚çš„å¿ƒæƒ…ã€‚"); return; }

                // å†æ¬¡æª¢æŸ¥å¸‚å ´é¡å‹æ˜¯å¦åŒ¹é…
                if (userMarketType === 'TW' && !currentSelectedStockTrade.ticker.endsWith('.TW')) {
                    alert(`æ‚¨ç›®å‰åœ¨å°è‚¡å¸‚å ´ã€‚æ‚¨åªèƒ½äº¤æ˜“ä»¥ .TW çµå°¾çš„è‚¡ç¥¨ã€‚ ${currentSelectedStockTrade.ticker} ä¸æ˜¯æœ‰æ•ˆçš„å°è‚¡äº¤æ˜“æ¨™çš„ã€‚`);
                    return;
                }
                if (userMarketType === 'US' && currentSelectedStockTrade.ticker.endsWith('.TW')) {
                     alert(`æ‚¨ç›®å‰åœ¨ç¾è‚¡å¸‚å ´ã€‚æ‚¨ä¸èƒ½äº¤æ˜“ .TW è‚¡ç¥¨ã€‚ ${currentSelectedStockTrade.ticker} ä¸æ˜¯æœ‰æ•ˆçš„ç¾è‚¡äº¤æ˜“æ¨™çš„ã€‚`);
                    return;
                }

                const latestQuote = await fetchAPI(`{{ url_for('stock_quote_api', ticker='__TICKER__') }}`.replace('__TICKER__', currentSelectedStockTrade.ticker));
                if (!latestQuote || !latestQuote.success || latestQuote.data.current_price == null) { alert(`ç„¡æ³•ç¢ºèª ${currentSelectedStockTrade.ticker} çš„ç•¶å‰åƒ¹æ ¼ã€‚äº¤æ˜“å·²å–æ¶ˆã€‚`); return; }
                const priceAtTrade = parseFloat(latestQuote.data.current_price);
                const totalTransactionValue = shares * priceAtTrade;
                const stockDisplayMarket = currentSelectedStockTrade.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');

                if (!confirm(`ç¢ºèª${isBuying ? 'è²·å…¥' : 'è³£å‡º'} ${shares} è‚¡ ${currentSelectedStockTrade.ticker} (æ‚¨çš„ ${userMarketType} å¸‚å ´å¸³æˆ¶) @ ${formatCurrency(priceAtTrade, true, stockDisplayMarket)} (ç¸½è¨ˆ: ${formatCurrency(totalTransactionValue, true, stockDisplayMarket)})?`)) return;

                tsSubmitTradeBtn.disabled = true; tsSubmitTradeBtn.textContent = 'è™•ç†ä¸­...';
                const tradeResult = await fetchAPI("{{ url_for('trade_api') }}", 'POST', { type: isBuying ? 'buy' : 'sell', ticker: currentSelectedStockTrade.ticker, shares: shares, mood: mood, reason: reason });
                tsSubmitTradeBtn.disabled = false; tsSwitchTab(isBuying ? 'buy' : 'sell'); // é‡ç½®æŒ‰éˆ•ç‹€æ…‹

                if (tradeResult && tradeResult.success) {
                    alert(tradeResult.message); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    await fetchUserSession(false); // æ›´æ–°ç”¨æˆ¶ session æ•¸æ“š (ä¸å¼·åˆ¶åˆ‡æ›è¦–åœ–)
                    if(currentSelectedStockTrade && tsOwnedSharesEl && currentUser.account && currentUser.account.portfolio) { // ç¢ºä¿é€™äº›å…ƒç´ å’Œæ•¸æ“šå­˜åœ¨
                         tsOwnedSharesEl.textContent = currentUser.account.portfolio[currentSelectedStockTrade.ticker]?.shares || 0;
                    }
                    tsUpdateTradeSummary(); // æ›´æ–°äº¤æ˜“æ‘˜è¦
                    if(tsReasonInput) tsReasonInput.value = ""; if(tsMoodSelect) tsMoodSelect.value = ""; if(tsSharesInput) tsSharesInput.value = 1; // é‡ç½®è¡¨å–®
                    
                    // å¦‚æœç•¶å‰åœ¨ Dashboard æˆ– Portfolio é é¢ï¼Œåˆ·æ–°æ•¸æ“š
                    const currentView = window.location.hash.substring(1) || 'dashboard';
                    if (currentView === 'dashboard') loadDashboardData();
                    if (currentView === 'my_portfolio') loadMyPortfolioData();

                } else { alert('äº¤æ˜“å¤±æ•—: ' + (tradeResult ? tradeResult.message : 'æœªçŸ¥éŒ¯èª¤ã€‚')); }
            });
        }
        if (tsBuyTab) tsBuyTab.addEventListener('click', () => tsSwitchTab('buy'));
        if (tsSellTab) tsSellTab.addEventListener('click', () => tsSwitchTab('sell'));
        if (tsSharesInput) { tsSharesInput.addEventListener('input', tsUpdateTradeSummary); tsSharesInput.addEventListener('change', tsUpdateTradeSummary); }

        async function loadMyPortfolioData() {
            if (!currentUser || !mpPortfolioOverviewGridEl || !mpHoldingsTableBodyEl || !mpEmptyPortfolioMessageEl) return;

            const data = await fetchAPI(`{{ url_for('portfolio_data_api') }}`);
            if (!data || !data.success) { mpHoldingsTableBodyEl.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#9ca3af;">ç„¡æ³•è¼‰å…¥æŠ•è³‡çµ„åˆã€‚</td></tr>`; return; }

            const { overview, holdings, marketType } = data;
            userMarketType = marketType; // æ›´æ–°å…¨å±€å¸‚å ´é¡å‹
            updateUserMarketTypeDisplays(); // æ›´æ–°æ‰€æœ‰ç›¸é—œé¡¯ç¤º

            mpHoldingsTableBodyEl.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼
            if (holdings.length === 0) {
                mpEmptyPortfolioMessageEl.style.display = 'block'; // é¡¯ç¤ºç©ºçµ„åˆè¨Šæ¯
                const emptyPortfolioTradeLink = mpEmptyPortfolioMessageEl.querySelector('.empty-portfolio-trade-link');
                if (emptyPortfolioTradeLink) { 
                    emptyPortfolioTradeLink.replaceWith(emptyPortfolioTradeLink.cloneNode(true)); // ç§»é™¤èˆŠç›£è½å™¨
                    mpEmptyPortfolioMessageEl.querySelector('.empty-portfolio-trade-link').addEventListener('click', (e) => { e.preventDefault(); switchView('trade_stocks'); }); 
                }
            } else {
                mpEmptyPortfolioMessageEl.style.display = 'none'; // éš±è—ç©ºçµ„åˆè¨Šæ¯
                holdings.forEach(h => {
                    const row = mpHoldingsTableBodyEl.insertRow();
                    const stockDisplayMarket = h.ticker.includes('.TW') ? 'TW' : (userMarketType === 'US' ? 'US' : 'US');
                    row.innerHTML = `<td class="stock-name-cell">${h.name || h.ticker} <span class="ticker">${h.ticker}</span></td><td class="align-right">${h.shares}</td><td class="align-right">${formatCurrency(h.avgCost, true, stockDisplayMarket)}</td><td class="align-right">${formatCurrency(h.currentPrice, true, stockDisplayMarket)}</td><td class="align-right">${formatCurrency(h.marketValue, true, stockDisplayMarket)}</td><td class="align-right ${h.todayChangePercent >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(h.todayChangePercent)}</td><td class="align-right ${h.totalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(h.totalPL, true, stockDisplayMarket)} (${formatPercentage(h.totalPLPercent, false)})</td>`;
                });
            }
            // æ›´æ–°æŠ•è³‡çµ„åˆæ¦‚è¦½å¡ç‰‡
            mpPortfolioOverviewGridEl.innerHTML = `
                <div class="overview-metric-card"><span class="label">ç¸½æŠ•è³‡çµ„åˆåƒ¹å€¼ (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value">${formatCurrency(overview.totalPortfolioValue)}</div><div class="change ${overview.totalOverallPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(overview.totalOverallPLPercent, true).replace(' ', ` ${formatCurrency(overview.totalOverallPL, false)} `)} ç¸½ç›ˆè™§</div></div>
                <div class="overview-metric-card"><span class="label">ä»Šæ—¥ç›ˆè™§ (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(overview.todayTotalPL)}</div><div class="change ${overview.todayTotalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${formatPercentage(overview.todayTotalPLPercent)}</div></div>
                <div class="overview-metric-card"><span class="label">ç¾é‡‘é¤˜é¡ (<span class="user-market-type-display">${userMarketType}</span>)</span><div class="value">${formatCurrency(overview.cashBalance)}</div><div class="change" style="color: #6b7280;">å¯ç”¨æ–¼äº¤æ˜“</div>`;
        }

        function loadAiReportsView() {
            if(investmentReportOutputEl) { investmentReportOutputEl.textContent = 'é»æ“ŠæŒ‰éˆ•ä»¥ç”Ÿæˆå ±å‘Š...'; investmentReportOutputEl.style.display = 'none'; }
            if(behavioralAnalysisOutputEl) { behavioralAnalysisOutputEl.textContent = 'é»æ“ŠæŒ‰éˆ•ä»¥ç”Ÿæˆåˆ†æ...'; behavioralAnalysisOutputEl.style.display = 'none'; }
            updateUserMarketTypeDisplays();
        }

        async function generateAIReport(reportType) {
            let outputArea, loadingText, button;
            if (reportType === 'investment') { outputArea = investmentReportOutputEl; loadingText = 'æ­£åœ¨ç”ŸæˆæŠ•è³‡å ±å‘Š...'; button = generateInvestmentReportBtn; }
            else if (reportType === 'behavioral') { outputArea = behavioralAnalysisOutputEl; loadingText = 'æ­£åœ¨åˆ†æè¡Œç‚ºæ¨¡å¼...'; button = generateBehavioralReportBtn; }
            else return;
            if (!outputArea || !button) return;
            outputArea.style.display = 'block'; outputArea.textContent = loadingText; button.disabled = true; button.style.opacity = 0.7;
            const reportData = await fetchAPI("{{ url_for('generate_ai_report_api') }}", 'POST', { reportType: reportType });
            if (reportData && reportData.success) {
                // ç°¡å–®çš„ Markdown è½‰ HTML (ç²—é«”ã€æ–œé«”ã€é …ç›®ç¬¦è™Ÿ)
                let htmlContent = reportData.report_content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*[\*-]\s+(.*)/gm, '<li>$1</li>');
                if (htmlContent.includes('<li>')) { htmlContent = '<ul>' + htmlContent.replace(/<\/li>(\s*<li>)/g, '</li>$1') + '</ul>'; htmlContent = htmlContent.replace(/<\/li>\s*<br>/g, '</li>');} // åŒ…è£¹åˆ—è¡¨
                htmlContent = htmlContent.replace(/\n/g, '<br>'); // æ›è¡Œç¬¦è½‰ <br>
                outputArea.innerHTML = htmlContent;
            } else { outputArea.textContent = 'ç„¡æ³•ç”Ÿæˆå ±å‘Š: ' + (reportData ? reportData.message : 'æœªçŸ¥çš„ä¼ºæœå™¨éŒ¯èª¤ã€‚'); }
            button.disabled = false; button.style.opacity = 1;
        }
        if (generateInvestmentReportBtn) generateInvestmentReportBtn.addEventListener('click', () => generateAIReport('investment'));
        if (generateBehavioralReportBtn) generateBehavioralReportBtn.addEventListener('click', () => generateAIReport('behavioral'));

        function loadAiStockAnalysisView() {
            console.log("è¼‰å…¥ AI å€‹è‚¡åˆ†æè¦–åœ–...");
            if (aiStockAnalysisOutputArea) { aiStockAnalysisOutputArea.innerHTML = ''; aiStockAnalysisOutputArea.style.display = 'none'; }
            if (aiStockAnalysisTickerInput) {
                aiStockAnalysisTickerInput.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                aiStockAnalysisTickerInput.placeholder = "è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (ä¾‹: 2330.TW æˆ– AAPL)"; // é è¨­æç¤º
            }
            if (aiStockAnalysisIncludeGaCheckbox) { // é‡ç½® GA è¤‡é¸æ¡†
                aiStockAnalysisIncludeGaCheckbox.checked = false;
            }
        }

        if (aiStockAnalysisSubmitBtn) {
            aiStockAnalysisSubmitBtn.addEventListener('click', async () => {
                const ticker = aiStockAnalysisTickerInput.value.trim().toUpperCase();
                const includeGa = aiStockAnalysisIncludeGaCheckbox.checked; // ç²å– GA æª¢æŸ¥é¸é …
                if (!ticker) { alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚'); return; }

                aiStockAnalysisSubmitBtn.disabled = true;
                aiStockAnalysisSubmitBtn.innerHTML = `<svg class="animate-spin nav-icon" style="width:16px; height:16px; margin-right: 6px; vertical-align: middle;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>åˆ†æä¸­...`;
                aiStockAnalysisOutputArea.innerHTML = '<p style="text-align:center; color:#6b7280;">æ­£åœ¨ç²å– AI å€‹è‚¡åˆ†æå ±å‘Šï¼Œè«‹ç¨å€™...</p>';
                aiStockAnalysisOutputArea.style.display = 'block';

                try {
                    const response = await fetchAPI("{{ url_for('api_analyze_stock_on_demand') }}", 'POST', { 
                        ticker: ticker,
                        include_ga: includeGa // å°‡ include_ga åƒæ•¸å‚³éçµ¦å¾Œç«¯
                    });

                    if (response && response.success && response.data) {
                        const stockData = response.data;
                        let newsHtml = '<h4>ç›¸é—œæ–°è</h4>';
                        if (stockData.news && stockData.news.length > 0) {
                            newsHtml += '<ul class="news-list">';
                            stockData.news.slice(0, 5).forEach(n => { newsHtml += `<li><a href="${n.link}" target="_blank" rel="noopener noreferrer">${n.title}</a> <span class="news-source">(${n.source} - ${n.date})</span></li>`; });
                            newsHtml += '</ul>';
                        } else { newsHtml += '<p style="font-size:13px; color:#6b7280;">æš«ç„¡ç›¸é—œæ–°èã€‚</p>'; }

                        const formatDisplay = (value, unit = '', precision = 2, isPercentVal = false) => {
                            if (value === null || typeof value === 'undefined' || String(value).toUpperCase() === 'N/A') return 'N/A';
                            if (typeof value === 'number') { return isPercentVal ? (value * 100).toFixed(precision) + '%' : value.toFixed(precision) + unit; }
                            if (isPercentVal && String(value).endsWith('%')) return value; // å¦‚æœæœ¬èº«å°±æ˜¯ç™¾åˆ†æ¯”å­—ç¬¦ä¸²
                            return String(value) + unit;
                        };
                        const formatCurrencyOnDemand = (value, currencyCode = 'USD') => { // ç”¨æ–¼å€‹è‚¡åˆ†æé é¢çš„è²¨å¹£æ ¼å¼åŒ–
                             if (value === null || typeof value === 'undefined' || String(value).toUpperCase() === 'N/A') return 'N/A';
                             const num = Number(value); if (isNaN(num)) return 'N/A';
                             const symbol = currencyCode === 'TWD' ? 'NT$' : '$'; let numStr;
                             // æ ¹æ“šæ•¸å€¼å¤§å°è‡ªå‹•æ·»åŠ å–®ä½ (å…†ã€å„„ã€è¬ for TWD)
                             if (Math.abs(num) >= 1e12) numStr = (num / 1e12).toFixed(1) + 'å…†';
                             else if (Math.abs(num) >= 1e8) numStr = (num / 1e8).toFixed(1) + 'å„„';
                             else if (Math.abs(num) >= 1e4 && currencyCode === 'TWD') numStr = (num / 1e4).toFixed(1) + 'è¬';
                             else numStr = num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                             if (currencyCode === 'TWD' && numStr.includes('.') && numStr.endsWith('00') && !numStr.includes('å…†') && !numStr.includes('å„„') && !numStr.includes('è¬') ) { // å°å¹£æ•´æ•¸ä¸é¡¯ç¤ºå°æ•¸é»
                                numStr = numStr.substring(0, numStr.lastIndexOf('.00'));
                             }
                             return symbol + numStr;
                        };
                        const formatAIAnalysisText = (text) => { // æ ¼å¼åŒ– AI åˆ†ææ–‡æœ¬ (Markdown -> HTML)
                            if (!text) return 'ç„¡æ³•ç”Ÿæˆ AI åˆ†æå ±å‘Šã€‚';
                            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>'); // ç²—é«”å’Œæ–œé«”
                            html = html.replace(/(\n|^)\s*[\*-]\s+(.*)/g, '$1<li>$2</li>'); // é …ç›®ç¬¦è™Ÿ
                            html = html.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); // åŒ…è£¹åˆ—è¡¨
                            html = html.replace(/\n/g, '<br>').replace(/<br>\s*<ul>/g, '<ul>').replace(/<\/ul>\s*<br>/g, '</ul>'); // æ›è¡Œå’Œåˆ—è¡¨æ•´ç†
                            return html;
                        };
                        
                        let gaSignalHtml = ''; // åˆå§‹åŒ– GA ä¿¡è™Ÿ HTML
                        if (stockData.ga_signal_info) { // å¦‚æœå¾Œç«¯è¿”å›äº† GA ä¿¡è™Ÿä¿¡æ¯
                            gaSignalHtml = `<hr style="margin: 20px 0; border-top: 1px solid #eee;"><h4>GA ç­–ç•¥ä¿¡è™Ÿè©•ä¼°</h4>`;
                            gaSignalHtml += `<div class="ga-signal-output">`;
                            let signalClass = 'signal-neutral';
                            if (stockData.ga_signal_info.signal === 'BUY') signalClass = 'signal-buy';
                            else if (stockData.ga_signal_info.signal === 'SELL') signalClass = 'signal-sell'; // å¦‚æœå°‡ä¾†æœ‰è³£å‡ºä¿¡è™Ÿ
                            else if (stockData.ga_signal_info.signal === 'ERROR' || stockData.ga_signal_info.signal === 'N/A') signalClass = 'signal-error';

                            gaSignalHtml += `<p><strong>ç•¶å‰ä¿¡è™Ÿ:</strong> <span class="${signalClass}">${stockData.ga_signal_info.signal || 'N/A'}</span></p>`;
                            gaSignalHtml += `<p><strong>åˆ¤æ–·ä¾æ“š:</strong> ${stockData.ga_signal_info.reason || 'N/A'}</p>`;
                            // å¯ä»¥é¸æ“‡æ€§é¡¯ç¤ºåŸºå› ï¼Œä¾‹å¦‚ç”¨æ–¼èª¿è©¦
                            // if (stockData.ga_signal_info.gene_used) {
                            //    gaSignalHtml += `<p style="font-size:0.8em;color:#777;"><em>(ç­–ç•¥åŸºå› : ${JSON.stringify(stockData.ga_signal_info.gene_used)})</em></p>`;
                            // }
                            gaSignalHtml += `</div>`;
                        }

                        aiStockAnalysisOutputArea.innerHTML = `
                            <h2>${stockData.company_name || stockData.ticker} (${stockData.ticker}) - AI å³æ™‚åˆ†æ</h2>
                            <p style="font-size: 13px; color: #6b7280; margin-top:0; margin-bottom:15px;">ç›®å‰åƒ¹æ ¼: ${formatCurrencyOnDemand(stockData.current_price, stockData.currency)} | æ—¥æ¼²è·Œ: <span class="${parseFloat(stockData.price_change_value) >= 0 ? 'text-green-600' : 'text-red-600'}">${stockData.price_change || 'N/A'}</span> | æˆäº¤é‡: ${stockData.volume ? stockData.volume.toLocaleString() : 'N/A'}</p>
                            <div class="key-metrics-grid">
                                <div class="metric-item"><strong>æœ¬ç›Šæ¯”:</strong> ${formatDisplay(stockData.pe_ratio)}</div><div class="metric-item"><strong>å¸‚å€¼:</strong> ${formatCurrencyOnDemand(stockData.market_cap, stockData.currency)}</div>
                                <div class="metric-item"><strong>æ¯è‚¡ç›ˆé¤˜ (EPS):</strong> ${formatCurrencyOnDemand(stockData.eps, stockData.currency)}</div><div class="metric-item"><strong>è‚¡æ±æ¬Šç›Šå ±é…¬ç‡ (ROE):</strong> ${stockData.roe_display || 'N/A'}</div>
                                <div class="metric-item"><strong>æ·¨åˆ©ç‡:</strong> ${stockData.net_profit_margin || 'N/A'}</div><div class="metric-item"><strong>æµå‹•æ¯”ç‡:</strong> ${stockData.current_ratio || 'N/A'}</div>
                            </div>
                            <h4>AI åˆ†æçµè«–</h4><div class="ai-conclusion">${formatAIAnalysisText(stockData.analysis)}</div>
                            ${newsHtml}
                            <h4>æŠ€è¡“åˆ†æåœ– (ç°¡åŒ–ç‰ˆ)</h4>
                            ${stockData.chart_url ? `<iframe src="${stockData.chart_url}" class="chart-iframe" title="è‚¡ç¥¨ ${stockData.ticker} çš„æŠ€è¡“åœ–è¡¨"></iframe>` : '<p style="font-size:13px; color:#6b7280;">ç„¡æ³•è¼‰å…¥æŠ€è¡“åœ–è¡¨ (æˆ–åŠŸèƒ½æš«æœªé–‹æ”¾)ã€‚</p>'}
                            <p class="chart-disclaimer">åœ–è¡¨è³‡æ–™ä¾†è‡ª Yahoo Finance (è‹¥æœ‰)ã€‚</p>
                            ${gaSignalHtml}`; // åœ¨æ­¤è™•æ·»åŠ  GA ä¿¡è™Ÿçš„ HTML
                    } else { aiStockAnalysisOutputArea.innerHTML = `<p style="color: #dc2626; text-align:center;">åˆ†æå¤±æ•—: ${response ? response.message : 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨æˆ–åŠŸèƒ½å°šæœªå¯¦ä½œã€‚'}</p>`; }
                } catch (error) { 
                    console.error("ç²å– AI å€‹è‚¡åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤:", error); 
                    aiStockAnalysisOutputArea.innerHTML = '<p style="color: #dc2626; text-align:center;">è«‹æ±‚åˆ†ææ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚</p>';
                } finally {
                    aiStockAnalysisSubmitBtn.disabled = false;
                    aiStockAnalysisSubmitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width:16px; height:16px; margin-right: 6px;"><path fill-rule="evenodd" d="M9.405 2.222a.75.75 0 01.027.039V2.25l.001.001A3.75 3.75 0 0112 5.25v2.053a.75.75 0 001.5 0V5.25a5.25 5.25 0 00-5.25-5.25c-.73 0-1.422.153-2.039.434l-.001-.001V.75A.75.75 0 005.25 0h-1.5a.75.75 0 00-.75.75v1.652l-.001.001A5.25 5.25 0 001.5 7.622v6.628a5.25 5.25 0 005.25 5.25h6.5A5.25 5.25 0 0018.5 14.25V7.622a5.25 5.25 0 00-1.46-3.378l-.001-.001V2.25a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v2.053a.75.75 0 001.5 0V2.25a3.75 3.75 0 012.622-3.622l.001-.001A.75.75 0 0112.75 0H9.873a.75.75 0 01-.727.527l-1.048.067a.75.75 0 00-.62.62l-.067 1.048A.75.75 0 016.75 3H3.222L6.63 7.03a.75.75 0 01-.022 1.06L3.5 11.25V10.5A2.25 2.25 0 001.25 8.25V7.5a.75.75 0 00-1.5 0v.75A3.75 3.75 0 003.5 12v1.5L.37 16.607a.75.75 0 00.022 1.06L3.75 21.25h12.5l3.36-3.162a.75.75 0 00.023-1.06L16.25 14V7.5A3.75 3.75 0 0012.5 3.75H9.873L6.463 0H5.25a.75.75 0 00-.75.75v1.512L1.095 5.67a.75.75 0 01.027 1.038l3.405 4.016V12a.75.75 0 00.75.75H6V14.5H5.25a.75.75 0 00-.75.75v1.5c0 .092.017.182.048.265L2.25 19.5h15.5l-2.298-2.485a.75.75 0 00-.048-.265v-1.5a.75.75 0 00-.75-.75H14V12.75h.75a.75.75 0 00.75-.75V8.87l3.405-4.016a.75.75 0 01.027-1.038L15.527 2.25H12A3.75 3.75 0 009.405 2.222zM8.25 10.5a.75.75 0 000-1.5H6.375v1.5H8.25zm3.375-1.5a.75.75 0 00-1.5 0v1.5h1.5V9zm1.875 1.5a.75.75 0 01.75-.75h1.875v-1.5h-1.875a.75.75 0 01-.75-.75V6a.75.75 0 01.75-.75h1.5A.75.75 0 0117 6v1.5h.75a.75.75 0 000-1.5H17V3.75A.75.75 0 0016.25 3h-1.5a.75.75 0 00-.75.75V6H12A2.25 2.25 0 009.75 8.25V9H8.25V8.25A2.25 2.25 0 006 6V3.75A.75.75 0 005.25 3h-1.5A.75.75 0 003 3.75V6H1.25A.75.75 0 00.5 6.75V10.5h3.25v1.5H1.25v2.25H3.5V15H2.25a.75.75 0 000 1.5h1.25v2.25A.75.75 0 004.25 19.5h11.5a.75.75 0 00.75-.75V16.5h1.25a.75.75 0 000-1.5H16.25V14h1.875a.75.75 0 01.75.75v2.25h.875a.75.75 0 000-1.5h-.875V12a2.25 2.25 0 00-2.25-2.25H11.625V9z" clip-rule="evenodd"/></svg>åˆ†æå€‹è‚¡`;
                }
            });
        }

        function handleHashNavigation() {
            let hash = window.location.hash.substring(1);
            const defaultView = 'dashboard';
            const validViews = ['dashboard', 'trade_stocks', 'ai_stock_analysis', 'my_portfolio', 'ai_reports'];
            if (!validViews.includes(hash)) { // å¦‚æœ hash ç„¡æ•ˆï¼Œå‰‡è¨­ç‚ºé è¨­è¦–åœ–
                hash = defaultView;
                if (window.location.hash !== `#${hash}`) { window.location.hash = hash; return; } // è§¸ç™¼ hashchange
            }
            if (currentUser || hash === 'login' || hash === 'register') { // å¦‚æœå·²ç™»éŒ„ï¼Œæˆ–ç›®æ¨™æ˜¯ç™»éŒ„/è¨»å†Šé 
                switchView(hash); 
            }
            else { console.log("å»¶é²è¦–åœ–åˆ‡æ›ï¼Œç­‰å¾…ç”¨æˆ¶ sessionã€‚"); }
        }
        navItems.forEach(item => {
            const link = item.querySelector('a');
            if (link) {
                link.addEventListener('click', (event) => {
                    // event.preventDefault(); // ä¸éœ€è¦äº†ï¼Œå› ç‚º switchView æœƒè™•ç† hash
                    const viewId = link.dataset.view;
                    if (viewId) { if(window.location.hash !== `#${viewId}`) { window.location.hash = viewId; } else { switchView(viewId); /* å¦‚æœ hash ç›¸åŒï¼Œå¼·åˆ¶åˆ‡æ› */ }}
                });
            }
        });
        window.addEventListener('hashchange', handleHashNavigation);

        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm("æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿæ‚¨çš„æ¨¡æ“¬é€²åº¦å°‡æœƒå„²å­˜ã€‚")) {
                    const logoutResult = await fetchAPI("{{ url_for('logout_api') }}", 'POST');
                    if (logoutResult && logoutResult.success) { currentUser = null; alert("æ‚¨å·²æˆåŠŸç™»å‡ºã€‚"); window.location.href = "{{ url_for('finsimu_login_route') }}"; }
                    else { alert("ç™»å‡ºå¤±æ•—ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚"); }
                }
            });
        }
        async function fetchUserSession(doSwitchViewOnLoad = true) {
            console.log("æ­£åœ¨ç²å–ç”¨æˆ¶ session (å–®ä¸€å¸‚å ´)...");
            const sessionData = await fetchAPI("{{ url_for('get_user_session_api') }}");
            if (sessionData && sessionData.loggedIn && sessionData.currentUser) {
                currentUser = sessionData.currentUser;
                userMarketType = currentUser.marketType || 'N/A'; // å¾ session ç²å–å¸‚å ´é¡å‹

                console.log("ç”¨æˆ¶ session å·²è¼‰å…¥:", currentUser);
                console.log("ç”¨æˆ¶å¸‚å ´é¡å‹:", userMarketType);

                updateSidebarUser(); // æ›´æ–°å´é‚Šæ¬„ç”¨æˆ¶ä¿¡æ¯
                updateUserMarketTypeDisplays(); // æ›´æ–°æ‰€æœ‰å¸‚å ´é¡å‹é¡¯ç¤º
                if(doSwitchViewOnLoad) handleHashNavigation(); // æ ¹æ“š hash åˆ‡æ›è¦–åœ–
                return true;
            } else {
                // å¦‚æœä¸åœ¨ç™»éŒ„æˆ–è¨»å†Šé ï¼Œå‰‡é‡å®šå‘åˆ°ç™»éŒ„é 
                const currentPath = window.location.pathname;
                let loginPath = "{{ url_for('finsimu_login_route') }}"; // ç²å–ç™»éŒ„è·¯ç”±
                let registerPath = "{{ url_for('finsimu_register_route') }}"; // ç²å–è¨»å†Šè·¯ç”±

                // ç°¡åŒ–è·¯å¾‘æ¯”è¼ƒ (åªæ¯”è¼ƒæ–‡ä»¶åéƒ¨åˆ†)
                if (loginPath.includes('/')) loginPath = loginPath.substring(loginPath.lastIndexOf('/') + 1) || loginPath;
                if (registerPath.includes('/')) registerPath = registerPath.substring(registerPath.lastIndexOf('/') + 1) || registerPath;
                
                const currentFile = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);

                const onAuthPage = currentFile === loginPath || currentFile === registerPath;
                
                if (!onAuthPage) {
                    console.log("ç„¡æ´»å‹• sessionã€‚å¾:", window.location.pathname, "é‡å®šå‘åˆ°ç™»éŒ„é ");
                    window.location.href = "{{ url_for('finsimu_login_route') }}";
                } else {
                    console.log("ç„¡æ´»å‹• sessionï¼Œä½†å·²åœ¨èªè­‰é é¢ã€‚");
                }
                return false;
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM å®Œå…¨è¼‰å…¥ - V10.5 (PWA, RWD, GA Precalc, GA OnDemand)");
            const sessionIsValid = await fetchUserSession(true); // å‚³ true ä»¥åœ¨è¼‰å…¥æ™‚åˆ‡æ›è¦–åœ–
            if (sessionIsValid && currentUser) {
                // ç‚ºå¿«é€Ÿæ“ä½œæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
                quickActionButtons.forEach(button => button.addEventListener('click', () => {
                    const targetView = button.dataset.viewTarget; if (targetView) window.location.hash = targetView;
                }));
                // æ›´æ–°æœç´¢æ¡†çš„ placeholder
                if(tsStockSearchInput && userMarketType) {
                     tsStockSearchInput.placeholder = userMarketType === 'TW' ? "æœç´¢å°è‚¡ (ä¾‹å¦‚: 2330.TW)" : "æœç´¢ç¾è‚¡ (ä¾‹å¦‚: AAPL)";
                }
                 if(aiStockAnalysisTickerInput && userMarketType) { // ä¹Ÿæ›´æ–° AI åˆ†æé çš„ placeholder
                    aiStockAnalysisTickerInput.placeholder = "è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (ä¾‹: 2330.TW æˆ– AAPL)";
                }
            }

            // RWD Sidebar Toggle Logic
            if (hamburgerMenuBtn && appSidebar && sidebarCloseBtn && sidebarOverlay) {
                hamburgerMenuBtn.addEventListener('click', () => toggleSidebar(true));
                sidebarCloseBtn.addEventListener('click', () => toggleSidebar(false));
                sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
            }
        });

        function toggleSidebar(open) {
            if (appSidebar && sidebarOverlay && mainContentArea) {
                appSidebar.classList.toggle('open', open);
                sidebarOverlay.classList.toggle('active', open);
            }
        }


        if (fetchGaPotentialBuysBtn) {
            fetchGaPotentialBuysBtn.addEventListener('click', async () => {
                if (!currentUser || !userMarketType) {
                    alert("è«‹å…ˆç™»å…¥ä¸¦ç¢ºä¿å·²è¨­å®šæ‚¨çš„å¸‚å ´åå¥½ã€‚");
                    return;
                }

                gaPotentialBuysOutputEl.innerHTML = '<p style="text-align:center; color:#6b7280;">æ­£åœ¨æœç´¢ GA æ½›åŠ›è²·å…¥è‚¡ï¼Œè«‹ç¨å€™...</p>';
                fetchGaPotentialBuysBtn.disabled = true;
                fetchGaPotentialBuysBtn.style.opacity = 0.7;
                const btnIcon = fetchGaPotentialBuysBtn.querySelector('svg');
                if(btnIcon) btnIcon.classList.add('animate-spin');


                try {
                    const response = await fetchAPI(`{{ url_for('get_ga_potential_buys') }}?marketType=${userMarketType}`);

                    if (response && response.success) {
                        if (response.stocks && response.stocks.length > 0) {
                            let html = `<h4 style="margin-bottom:10px; color:#111827;">GA è­˜åˆ¥çš„ ${response.marketType} å¸‚å ´æ½›åŠ›è²·å…¥è‚¡:</h4><ul>`;
                            response.stocks.forEach(stock => {
                                html += `<li style="padding: 8px 10px; border-bottom: 1px solid #f0f2f5;">
                                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                                <div>
                                                    <strong style="color: #1e40af; font-size:15px;">${stock.name || stock.ticker} (${stock.ticker})</strong><br>
                                                    <small class="ga-buy-reason">åˆ¤æ–·ä¾æ“š: ${stock.reason || 'GAè²·å…¥ä¿¡è™Ÿï¼ˆç„¡è©³ç´°åŸå› ï¼‰'}</small>
                                                </div>
                                                <span style="font-weight:500; font-size:14px; white-space:nowrap; margin-left:10px;">${stock.current_price !== null ? formatCurrency(stock.current_price, true, response.marketType) : 'N/A'}</span>
                                            </div>
                                         </li>`;
                            });
                            html += `</ul><p class="disclaimer-note">å…è²¬è²æ˜ï¼šé€™äº›æ˜¯åŸºæ–¼è‡ªå‹•åŒ–ç­–ç•¥ä¿¡è™Ÿï¼ˆä½¿ç”¨æ­·å²æ•¸æ“šï¼‰çš„çµæœï¼Œä¸¦éè²¡å‹™å»ºè­°ã€‚æ•¸æ“šæˆªè‡³æœ€è¿‘çš„å¸‚å ´æ”¶ç›¤ã€‚é¡¯ç¤ºçš„è‚¡ç¥¨ä¾†è‡ªé å…ˆè¨“ç·´çš„ AI è§€å¯Ÿåˆ—è¡¨ã€‚</p>`;
                            gaPotentialBuysOutputEl.innerHTML = html;
                        } else {
                            gaPotentialBuysOutputEl.innerHTML = `<p style="text-align:center; color:#6b7280;">ç›®å‰åœ¨ ${response.marketType} å¸‚å ´çš„è§€å¯Ÿåˆ—è¡¨ä¸­æœªè­˜åˆ¥åˆ°å¼·çƒˆçš„ GA è²·å…¥ä¿¡è™Ÿã€‚</p>`;
                        }
                    } else {
                        gaPotentialBuysOutputEl.innerHTML = `<p style="color: #dc2626; text-align:center;">ç„¡æ³•ç²å– GA æ½›åŠ›è²·å…¥è‚¡: ${response ? response.message : 'ä¼ºæœå™¨éŒ¯èª¤æˆ– GA å¼•æ“ä¸å¯ç”¨ã€‚'}</p>`;
                    }
                } catch (error) {
                    console.error("ç²å– GA æ½›åŠ›è²·å…¥è‚¡æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    gaPotentialBuysOutputEl.innerHTML = '<p style="color: #dc2626; text-align:center;">ç²å– GA æ½›åŠ›è²·å…¥è‚¡æ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚</p>';
                } finally {
                    fetchGaPotentialBuysBtn.disabled = false;
                    fetchGaPotentialBuysBtn.style.opacity = 1;
                    if(btnIcon) btnIcon.classList.remove('animate-spin');
                }
            });
        }
        // =============================================
        //                JavaScript End
        // =============================================
    </script>

    <!-- Service Worker Registration Script -->
    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
          .then(function(registration) {
            console.log('FinSimU ServiceWorker è¨»å†ŠæˆåŠŸ, ç¯„åœ:', registration.scope);
          }, function(err) {
            console.error('FinSimU ServiceWorker è¨»å†Šå¤±æ•—:', err);
          });
      });
    }
    </script>
</body>
</html>
