<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>股票分析 - 股票智能助手</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0066ff;
      --secondary-color: #00cc88;
      --bg-color: #101827;
      --card-bg: rgba(16, 24, 39, 0.9);
      --text-primary: #f0f0f0;
      --text-secondary: #a0aec0;
      --border-color: rgba(255, 255, 255, 0.1);
      --shadow-small: 0 2px 5px rgba(0, 0, 0, 0.2);
      --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-strong: 0 8px 25px rgba(0, 0, 0, 0.4);
      --transition-normal: all 0.3s ease;
      --transition-slow: all 0.5s ease;
    }
    
    body {
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 102, 255, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(0, 204, 136, 0.05) 0%, transparent 20%),
        linear-gradient(135deg, rgba(16, 24, 39, 0.97) 0%, rgba(17, 24, 39, 0.98) 100%);
      background-attachment: fixed;
    }
    
    .analysis-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 15px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .back-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-normal);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-btn:hover {
      color: var(--primary-color);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    
    .stock-header {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-medium);
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stock-info h2 {
      margin: 0 0 10px 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    
    .stock-ticker {
      color: var(--text-secondary);
      font-size: 1.1rem;
      margin-bottom: 15px;
    }
    
    .stock-meta {
      display: flex;
      gap: 20px;
    }
    
    .meta-item {
      display: flex;
      flex-direction: column;
    }
    
    .meta-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    .meta-value {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .stock-price {
      text-align: right;
    }
    
    .current-price {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .price-change {
      font-size: 1.2rem;
      font-weight: 600;
      padding: 5px 15px;
      border-radius: 8px;
      display: inline-block;
    }
    
    .price-positive {
      background: rgba(0, 204, 136, 0.2);
      color: var(--secondary-color);
    }
    
    .price-negative {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .analysis-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px;
      box-shadow: var(--shadow-medium);
      border: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-header h3 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-header h3 i {
      color: var(--primary-color);
    }
    
    .chart-container {
      width: 100%;
      height: 500px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .indicator-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .indicator-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
    }
    
    .indicator-name {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .indicator-value {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .indicator-bullish {
      color: var(--secondary-color);
    }
    
    .indicator-bearish {
      color: #ff6b6b;
    }
    
    .pattern-list {
      margin-top: 20px;
    }
    
    .pattern-item {
      background: rgba(0, 102, 255, 0.1);
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .pattern-item i {
      color: var(--primary-color);
    }
    
    .financial-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
    }
    
    .financial-table th {
      color: var(--text-secondary);
      font-weight: 500;
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    .financial-table td {
      padding: 15px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .financial-table tr:last-child td {
      border-bottom: none;
    }
    
    .financial-metric {
      font-weight: 600;
    }
    
    .news-list {
      margin-top: 20px;
    }
    
    .news-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: var(--transition-normal);
    }
    
    .news-item:hover {
      background: rgba(0, 102, 255, 0.1);
      transform: translateY(-2px);
    }
    
    .news-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .news-meta {
      display: flex;
      justify-content: space-between;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .news-sentiment {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .sentiment-positive {
      background: rgba(0, 204, 136, 0.2);
      color: var(--secondary-color);
    }
    
    .sentiment-negative {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .sentiment-neutral {
      background: rgba(255, 204, 0, 0.2);
      color: #ffcc00;
    }
    
    .ai-analysis {
      white-space: pre-line;
      line-height: 1.6;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
    }
    
    .loading {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    .loading-text {
      margin-top: 20px;
      font-size: 1.2rem;
      color: var(--text-secondary);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    .action-btn {
      flex: 1;
      padding: 15px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-normal);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .buy-btn {
      background: linear-gradient(135deg, var(--secondary-color), rgba(0, 204, 136, 0.8));
      color: white;
    }
    
    .buy-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 204, 136, 0.3);
    }
    
    .sell-btn {
      background: linear-gradient(135deg, #ff6b6b, rgba(255, 107, 107, 0.8));
      color: white;
    }
    
    .sell-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
    }
    
    .watchlist-btn {
      background: linear-gradient(135deg, var(--primary-color), rgba(0, 102, 255, 0.8));
      color: white;
    }
    
    .watchlist-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 102, 255, 0.3);
    }
    
    @media (max-width: 992px) {
      .analysis-grid {
        grid-template-columns: 1fr;
      }
      
      .stock-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .stock-price {
        text-align: left;
        margin-top: 20px;
      }
      
      .indicator-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 576px) {
      .stock-meta {
        flex-direction: column;
        gap: 10px;
      }
      
      .indicator-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="analysis-container">
    <div class="header">
      <h1>股票分析</h1>
      <button class="back-btn" onclick="window.location.href='/'">
        <i class="fas fa-arrow-left"></i> 返回首頁
      </button>
    </div>
    
    <div id="loading-container" class="loading-container">
      <div class="loading"></div>
      <div class="loading-text">正在分析股票數據，請稍候...</div>
    </div>
    
    <div id="analysis-content" style="display: none;">
      <div class="stock-header">
        <div class="stock-info">
          <h2 id="company-name">公司名稱</h2>
          <div class="stock-ticker" id="ticker">股票代碼</div>
          <div class="stock-meta">
            <div class="meta-item">
              <div class="meta-label">市值</div>
              <div class="meta-value" id="market-cap">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">本益比</div>
              <div class="meta-value" id="pe-ratio">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">EPS</div>
              <div class="meta-value" id="eps">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">成交量</div>
              <div class="meta-value" id="volume">-</div>
            </div>
          </div>
        </div>
        <div class="stock-price">
          <div class="current-price" id="current-price">-</div>
          <div class="price-change" id="price-change">-</div>
        </div>
      </div>
      
      <div class="chart-container" id="chart-container">
        <!-- 圖表將在這裡顯示 -->
      </div>
      
      <div class="analysis-grid">
        <div class="analysis-card">
          <div class="card-header">
            <h3><i class="fas fa-chart-line"></i> 技術分析</h3>
          </div>
          
          <div class="indicator-grid">
            <div class="indicator-item">
              <div class="indicator-name">RSI (14)</div>
              <div class="indicator-value" id="rsi-value">-</div>
            </div>
            <div class="indicator-item">
              <div class="indicator-name">MACD</div>
              <div class="indicator-value" id="macd-value">-</div>
            </div>
            <div class="indicator-item">
              <div class="indicator-name">MACD Signal</div>
              <div class="indicator-value" id="macd-signal">-</div>
            </div>
            <div class="indicator-item">
              <div class="indicator-name">K值</div>
              <div class="indicator-value" id="k-value">-</div>
            </div>
            <div class="indicator-item">
              <div class="indicator-name">D值</div>
              <div class="indicator-value" id="d-value">-</div>
            </div>
            <div class="indicator-item">
              <div class="indicator-name">J值</div>
              <div class="indicator-value" id="j-value">-</div>
            </div>
          </div>
          
          <h4>技術形態</h4>
          <div class="pattern-list" id="pattern-list">
            <!-- 技術形態將在這裡顯示 -->
          </div>
        </div>
        
        <div class="analysis-card">
          <div class="card-header">
            <h3><i class="fas fa-file-invoice-dollar"></i> 基本面分析</h3>
          </div>
          
          <table class="financial-table">
            <tr>
              <td class="financial-metric">ROE</td>
              <td id="roe">-</td>
            </tr>
            <tr>
              <td class="financial-metric">淨利潤率</td>
              <td id="net-profit-margin">-</td>
            </tr>
            <tr>
              <td class="financial-metric">流動比率</td>
              <td id="current-ratio">-</td>
            </tr>
            <tr>
              <td class="financial-metric">市值</td>
              <td id="market-cap-2">-</td>
            </tr>
            <tr>
              <td class="financial-metric">本益比</td>
              <td id="pe-ratio-2">-</td>
            </tr>
            <tr>
              <td class="financial-metric">EPS</td>
              <td id="eps-2">-</td>
            </tr>
          </table>
        </div>
        
        <div class="analysis-card">
          <div class="card-header">
            <h3><i class="fas fa-newspaper"></i> 相關新聞</h3>
          </div>
          
          <div class="news-list" id="news-list">
            <!-- 新聞將在這裡顯示 -->
          </div>
        </div>
        
        <div class="analysis-card">
          <div class="card-header">
            <h3><i class="fas fa-robot"></i> AI 分析</h3>
          </div>
          
          <div class="ai-analysis" id="ai-analysis">
            <!-- AI 分析將在這裡顯示 -->
          </div>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn buy-btn" id="buy-btn">
          <i class="fas fa-shopping-cart"></i> 買入
        </button>
        <button class="action-btn sell-btn" id="sell-btn">
          <i class="fas fa-money-bill-wave"></i> 賣出
        </button>
        <button class="action-btn watchlist-btn" id="watchlist-btn">
          <i class="fas fa-star"></i> 加入追蹤
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 獲取URL參數
      const urlParams = new URLSearchParams(window.location.search);
      const ticker = window.location.pathname.split('/').pop();
      const market = urlParams.get('market') || 'TW';
      
      // 顯示載入中
      const loadingContainer = document.getElementById('loading-container');
      const analysisContent = document.getElementById('analysis-content');
      
      // 發送API請求獲取股票分析
      fetch('/api/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ticker: ticker,
          market: market
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // 隱藏載入中，顯示內容
          loadingContainer.style.display = 'none';
          analysisContent.style.display = 'block';
          
          // 填充數據
          populateStockData(data.data);
        } else {
          // 顯示錯誤
          loadingContainer.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle"></i> 分析失敗：${data.error}
            </div>
            <button class="back-btn" onclick="window.location.href='/'">
              <i class="fas fa-arrow-left"></i> 返回首頁
            </button>
          `;
        }
      })
      .catch(error => {
        console.error('分析股票時發生錯誤:', error);
        loadingContainer.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> 發生錯誤：${error.message}
          </div>
          <button class="back-btn" onclick="window.location.href='/'">
            <i class="fas fa-arrow-left"></i> 返回首頁
          </button>
        `;
      });
      
      // 填充股票數據
      function populateStockData(stockData) {
        // 基本信息
        document.getElementById('company-name').textContent = stockData.company_name;
        document.getElementById('ticker').textContent = stockData.ticker;
        document.getElementById('market-cap').textContent = stockData.market_cap;
        document.getElementById('pe-ratio').textContent = stockData.pe_ratio;
        document.getElementById('eps').textContent = stockData.eps;
        document.getElementById('volume').textContent = formatNumber(stockData.volume);
        
        // 價格信息
        document.getElementById('current-price').textContent = `${stockData.current_price.toFixed(2)} ${stockData.currency}`;
        
        const priceChange = document.getElementById('price-change');
        priceChange.textContent = stockData.price_change;
        if (stockData.price_change_value >= 0) {
          priceChange.className = 'price-change price-positive';
        } else {
          priceChange.className = 'price-change price-negative';
        }
        
        // 技術指標
        document.getElementById('rsi-value').textContent = stockData.rsi.toFixed(2);
        document.getElementById('macd-value').textContent = stockData.macd.toFixed(4);
        document.getElementById('macd-signal').textContent = stockData.macd_signal.toFixed(4);
        document.getElementById('k-value').textContent = stockData.k.toFixed(2);
        document.getElementById('d-value').textContent = stockData.d.toFixed(2);
        document.getElementById('j-value').textContent = stockData.j.toFixed(2);
        
        // 為技術指標添加顏色
        if (stockData.rsi > 70) {
          document.getElementById('rsi-value').className = 'indicator-value indicator-bearish';
        } else if (stockData.rsi < 30) {
          document.getElementById('rsi-value').className = 'indicator-value indicator-bullish';
        }
        
        if (stockData.k > stockData.d) {
          document.getElementById('k-value').className = 'indicator-value indicator-bullish';
          document.getElementById('d-value').className = 'indicator-value indicator-bullish';
        } else {
          document.getElementById('k-value').className = 'indicator-value indicator-bearish';
          document.getElementById('d-value').className = 'indicator-value indicator-bearish';
        }
        
        // 技術形態
        const patternList = document.getElementById('pattern-list');
        patternList.innerHTML = '';
        
        if (stockData.patterns && stockData.patterns.length > 0) {
          stockData.patterns.forEach(pattern => {
            const patternItem = document.createElement('div');
            patternItem.className = 'pattern-item';
            
            // 根據形態類型設置圖標
            let icon = 'fa-chart-line';
            if (pattern.includes('看漲')) {
              icon = 'fa-arrow-trend-up';
            } else if (pattern.includes('看跌')) {
              icon = 'fa-arrow-trend-down';
            }
            
            patternItem.innerHTML = `
              <i class="fas ${icon}"></i>
              <span>${pattern}</span>
            `;
            
            patternList.appendChild(patternItem);
          });
        } else {
          patternList.innerHTML = '<div class="text-secondary">未發現明顯技術形態</div>';
        }
        
        // 基本面數據
        document.getElementById('roe').textContent = stockData.roe;
        document.getElementById('net-profit-margin').textContent = stockData.net_profit_margin;
        document.getElementById('current-ratio').textContent = stockData.current_ratio;
        document.getElementById('market-cap-2').textContent = stockData.market_cap;
        document.getElementById('pe-ratio-2').textContent = stockData.pe_ratio;
        document.getElementById('eps-2').textContent = stockData.eps;
        
        // 新聞
        const newsList = document.getElementById('news-list');
        newsList.innerHTML = '';
        
        if (stockData.news && stockData.news.length > 0) {
          stockData.news.forEach(news => {
            let sentimentClass = 'sentiment-neutral';
            if (news.sentiment === 'Positive') sentimentClass = 'sentiment-positive';
            if (news.sentiment === 'Negative') sentimentClass = 'sentiment-negative';
            
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            newsItem.innerHTML = `
              <div class="news-title">${news.title}</div>
              <div class="news-meta">
                <span>${news.source} | ${news.date}</span>
                <span class="news-sentiment ${sentimentClass}">${news.sentiment}</span>
              </div>
            `;
            
            // 添加點擊事件
            newsItem.addEventListener('click', function() {
              window.open(news.link, '_blank');
            });
            
            newsList.appendChild(newsItem);
          });
        } else {
          newsList.innerHTML = '<div class="text-secondary">沒有找到相關新聞</div>';
        }
        
        // AI 分析
        document.getElementById('ai-analysis').textContent = stockData.analysis;
        
        // 圖表
        const chartContainer = document.getElementById('chart-container');
        chartContainer.innerHTML = `<iframe src="${stockData.chart_path}" width="100%" height="500" frameborder="0"></iframe>`;
        
        // 設置按鈕事件
        document.getElementById('buy-btn').addEventListener('click', function() {
          alert(`模擬買入 ${stockData.company_name} (${stockData.ticker}) 成功！`);
        });
        
        document.getElementById('sell-btn').addEventListener('click', function() {
          alert(`模擬賣出 ${stockData.company_name} (${stockData.ticker}) 成功！`);
        });
        
        document.getElementById('watchlist-btn').addEventListener('click', function() {
          addToWatchlist(stockData.ticker, stockData.company_name);
        });
      }
      
      // 添加到追蹤清單
      function addToWatchlist(ticker, name) {
        fetch('/api/watchlist/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ticker: ticker,
            name: name
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
          } else {
            alert('添加失敗：' + data.error);
          }
        })
        .catch(error => {
          console.error('添加到追蹤清單時發生錯誤:', error);
          alert('添加到追蹤清單時發生錯誤');
        });
      }
      
      // 格式化數字
      function formatNumber(num) {
        if (num >= 1000000000) {
          return (num / 1000000000).toFixed(2) + ' B';
        }
        if (num >= 1000000) {
          return (num / 1000000).toFixed(2) + ' M';
        }
        if (num >= 1000) {
          return (num / 1000).toFixed(2) + ' K';
        }
        return num;
      }
    });
  </script>
</body>
</html>
